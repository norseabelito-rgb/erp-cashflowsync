---
phase: 03-internal-settlement
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - src/lib/intercompany-service.ts
  - src/app/api/intercompany/generate/route.ts
  - src/app/(dashboard)/intercompany/page.tsx
autonomous: true

must_haves:
  truths:
    - "Settlement generates actual invoice in Oblio using dedicated series"
    - "IntercompanyInvoice record stores Oblio reference (oblioInvoiceId, oblioLink)"
    - "Settlement traceable: can see Oblio invoice link from settlement record"
    - "Error handling: clear message if Oblio series not configured"
  artifacts:
    - path: "src/lib/intercompany-service.ts"
      provides: "generateOblioIntercompanyInvoice function"
      exports: ["generateOblioIntercompanyInvoice"]
    - path: "src/app/api/intercompany/generate/route.ts"
      provides: "Settlement generation with Oblio invoice creation"
      exports: ["POST"]
  key_links:
    - from: "intercompany-service.ts"
      to: "oblio.ts"
      via: "createOblioClient and createInvoice"
      pattern: "createOblioClient.*createInvoice"
    - from: "IntercompanyInvoice"
      to: "Oblio"
      via: "oblioInvoiceId and oblioLink fields"
      pattern: "oblioInvoiceId|oblioLink"
---

<objective>
Integrate Oblio for actual internal invoice generation and complete the settlement flow.

Purpose: After preview confirmation, generate real invoice in Oblio. Store reference for traceability. Complete the decontare workflow.
Output: Full settlement flow with Oblio invoice creation and reference storage.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-internal-settlement/03-CONTEXT.md
@.planning/phases/03-internal-settlement/03-03-SUMMARY.md
@.planning/phases/02-invoice-series-fix/02-05-SUMMARY.md (Oblio integration patterns)

Source files:
@src/lib/intercompany-service.ts (add Oblio generation)
@src/lib/oblio.ts (existing Oblio client - createOblioClient, createOblioInvoiceItem)
@src/lib/invoice-service.ts (reference for Oblio invoice patterns)
@src/app/api/intercompany/generate/route.ts (extend to call Oblio)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Oblio invoice generation to intercompany service</name>
  <files>src/lib/intercompany-service.ts</files>
  <action>
Add function to generate actual Oblio invoice for intercompany settlement.

**Import Oblio utilities:**
```typescript
import {
  createOblioClient,
  createOblioInvoiceItem,
  formatDateForOblio,
  hasOblioCredentials,
  OblioInvoiceData,
} from "./oblio";
```

**Add new function** `generateOblioIntercompanyInvoice`:
```typescript
/**
 * Generează factura de decontare în Oblio
 * Apelat după ce preview-ul e confirmat și IntercompanyInvoice e creat
 */
export async function generateOblioIntercompanyInvoice(
  intercompanyInvoiceId: string
): Promise<{
  success: boolean;
  oblioInvoiceId?: string;
  oblioInvoiceNumber?: string;
  oblioSeriesName?: string;
  oblioLink?: string;
  error?: string;
}> {
  // 1. Fetch the intercompany invoice with relations
  const settlement = await prisma.intercompanyInvoice.findUnique({
    where: { id: intercompanyInvoiceId },
    include: {
      issuedByCompany: true,  // Aquaterra (primary)
      receivedByCompany: true, // Secondary company (client on invoice)
    },
  });

  if (!settlement) {
    return { success: false, error: "Factura intercompany nu a fost găsită" };
  }

  const issuingCompany = settlement.issuedByCompany;  // Aquaterra emite
  const receivingCompany = settlement.receivedByCompany;  // Firma secundară primește

  // 2. Validate Oblio configuration
  if (!hasOblioCredentials(issuingCompany)) {
    return {
      success: false,
      error: `Firma ${issuingCompany.name} nu are credențiale Oblio configurate`,
    };
  }

  const seriesName = issuingCompany.intercompanySeriesName;
  if (!seriesName) {
    return {
      success: false,
      error: `Firma ${issuingCompany.name} nu are serie de decontare configurată (intercompanySeriesName)`,
    };
  }

  // 3. Create Oblio client
  const oblio = createOblioClient(issuingCompany);
  if (!oblio) {
    return { success: false, error: "Nu s-a putut crea clientul Oblio" };
  }

  // 4. Parse line items from JSON
  const lineItems = JSON.parse(settlement.lineItems as string) as Array<{
    sku: string;
    title: string;
    quantity: number;
    unitCost: number;
    lineTotal: number;
  }>;

  // 5. Build Oblio invoice data
  const invoiceData: OblioInvoiceData = {
    cif: issuingCompany.oblioCif || issuingCompany.cif || "",
    seriesName: seriesName,
    client: {
      name: receivingCompany.name,
      cif: receivingCompany.cif || undefined,
      rc: receivingCompany.regCom || undefined,
      address: receivingCompany.address || undefined,
      city: receivingCompany.city || undefined,
      state: receivingCompany.county || undefined,
      country: receivingCompany.country || "România",
      email: receivingCompany.email || undefined,
      phone: receivingCompany.phone || undefined,
      isTaxPayer: true,  // B2B - plătitor TVA
      save: false,       // Don't save to nomenclator
    },
    issueDate: formatDateForOblio(new Date()),
    products: lineItems.map(item => createOblioInvoiceItem({
      sku: item.sku,
      title: item.title,
      quantity: item.quantity,
      price: item.lineTotal / item.quantity,  // Unit price with markup included
      vatRate: 19,  // Standard Romanian VAT
    })),
    mentions: buildSettlementMentions(settlement),
  };

  // 6. Call Oblio API
  console.log(`[Intercompany] Generating Oblio invoice for settlement ${settlement.invoiceNumber}`);
  const result = await oblio.createInvoice(invoiceData);

  if (!result.success) {
    console.error("[Intercompany] Oblio invoice creation failed:", result.error);
    return {
      success: false,
      error: result.error || "Eroare la crearea facturii în Oblio",
    };
  }

  // 7. Update IntercompanyInvoice with Oblio reference
  await prisma.intercompanyInvoice.update({
    where: { id: intercompanyInvoiceId },
    data: {
      oblioInvoiceId: result.invoiceId,
      oblioInvoiceNumber: result.invoiceNumber,
      oblioSeriesName: result.invoiceSeries || seriesName,
      oblioLink: result.link,
      status: "issued",  // Mark as issued
      issuedAt: new Date(),
    },
  });

  console.log(`[Intercompany] Oblio invoice created: ${result.invoiceSeries}${result.invoiceNumber}`);

  return {
    success: true,
    oblioInvoiceId: result.invoiceId,
    oblioInvoiceNumber: result.invoiceNumber,
    oblioSeriesName: result.invoiceSeries || seriesName,
    oblioLink: result.link,
  };
}

/**
 * Build mentions text for settlement invoice
 */
function buildSettlementMentions(settlement: {
  periodStart: Date;
  periodEnd: Date;
  invoiceNumber: string;
}): string {
  const startDate = settlement.periodStart.toLocaleDateString("ro-RO");
  const endDate = settlement.periodEnd.toLocaleDateString("ro-RO");

  return `Decontare internă perioada ${startDate} - ${endDate}. Ref: ${settlement.invoiceNumber}`;
}
```

**Update `generateIntercompanyInvoice`** to optionally call Oblio:
After creating the IntercompanyInvoice record, add:
```typescript
// After creating intercompanyInvoice in transaction...

// Generate Oblio invoice if company has series configured
const primaryCompany = await getPrimaryCompany();
if (primaryCompany?.intercompanySeriesName) {
  const oblioResult = await generateOblioIntercompanyInvoice(intercompanyInvoice.id);
  if (!oblioResult.success) {
    console.warn("[Intercompany] Oblio invoice failed:", oblioResult.error);
    // Don't fail the whole operation - settlement is created, just no Oblio invoice
    // The UI should show this and allow retry
  }
}
```
  </action>
  <verify>
Code compiles without errors:
```bash
npx tsc --noEmit src/lib/intercompany-service.ts
```
  </verify>
  <done>
Intercompany service can generate actual Oblio invoices using dedicated series, with full client data from receiving company.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update generate API and UI for Oblio integration</name>
  <files>
    src/app/api/intercompany/generate/route.ts
    src/app/(dashboard)/intercompany/page.tsx
  </files>
  <action>
**Update generate API route:**
```typescript
// src/app/api/intercompany/generate/route.ts

import {
  generateIntercompanyInvoice,
  generateOblioIntercompanyInvoice,
} from "@/lib/intercompany-service";

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { companyId, orderIds } = body;

    // Validate inputs
    if (!companyId) {
      return NextResponse.json(
        { success: false, error: "companyId este obligatoriu" },
        { status: 400 }
      );
    }

    // Generate the intercompany invoice (creates record + links orders)
    const result = await generateIntercompanyInvoice(companyId, orderIds);

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: result.error },
        { status: 400 }
      );
    }

    // Try to generate Oblio invoice
    let oblioResult = null;
    if (result.invoiceId) {
      oblioResult = await generateOblioIntercompanyInvoice(result.invoiceId);
    }

    return NextResponse.json({
      success: true,
      invoiceId: result.invoiceId,
      invoiceNumber: result.invoiceNumber,
      oblio: oblioResult ? {
        success: oblioResult.success,
        invoiceNumber: oblioResult.oblioInvoiceNumber,
        seriesName: oblioResult.oblioSeriesName,
        link: oblioResult.oblioLink,
        error: oblioResult.error,
      } : null,
    });
  } catch (error: any) {
    console.error("[Intercompany Generate] Error:", error);
    return NextResponse.json(
      { success: false, error: error.message || "Eroare la generarea facturii" },
      { status: 500 }
    );
  }
}
```

**Update intercompany page:**
1. Update generate mutation to pass orderIds:
```tsx
const generateMutation = useMutation({
  mutationFn: async ({ companyId, orderIds }: { companyId: string; orderIds: string[] }) => {
    const res = await fetch("/api/intercompany/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ companyId, orderIds }),
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    return data;
  },
  onSuccess: (data) => {
    queryClient.invalidateQueries({ queryKey: ["intercompany-invoices"] });

    // Show success with Oblio info
    let description = `Factura ${data.invoiceNumber} a fost generată.`;
    if (data.oblio?.success) {
      description += ` Oblio: ${data.oblio.seriesName}${data.oblio.invoiceNumber}`;
    } else if (data.oblio?.error) {
      description += ` Atenție: Factura Oblio nu s-a generat - ${data.oblio.error}`;
    }

    toast({ title: "Decontare generată", description });
    setIsPreviewOpen(false);
    setPreviewData(null);
    setSelectedOrderIds(new Set());
  },
  // ... error handler
});
```

2. Update generate button call:
```tsx
<Button
  onClick={() => previewData && generateMutation.mutate({
    companyId: previewData.companyId,
    orderIds: Array.from(selectedOrderIds),
  })}
  disabled={generateMutation.isPending}
>
  {generateMutation.isPending ? (
    <Loader2 className="h-4 w-4 animate-spin mr-2" />
  ) : (
    <FileText className="h-4 w-4 mr-2" />
  )}
  Generează Factură în Oblio
</Button>
```

3. Show Oblio link in invoices table:
Add column showing Oblio invoice status/link:
```tsx
<TableCell>
  {invoice.oblioLink ? (
    <a href={invoice.oblioLink} target="_blank" rel="noopener noreferrer"
       className="text-blue-600 hover:underline flex items-center gap-1">
      <ExternalLink className="h-3 w-3" />
      {invoice.oblioSeriesName}{invoice.oblioInvoiceNumber}
    </a>
  ) : (
    <Badge variant="outline" className="text-yellow-600">
      Doar intern
    </Badge>
  )}
</TableCell>
```
  </action>
  <verify>
Full workflow test:
1. Select company with intercompanySeriesName configured
2. Select orders in the table
3. Click "Preview Decontare"
4. Click "Generează Factură în Oblio"
5. Verify:
   - Success toast shows Oblio invoice number
   - Invoice appears in table with Oblio link
   - Link opens Oblio invoice view
  </verify>
  <done>
Settlement generation creates both internal record and actual Oblio invoice. UI shows Oblio invoice link for traceability.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add retry Oblio generation for failed settlements</name>
  <files>src/app/api/intercompany/invoices/[id]/oblio/route.ts</files>
  <action>
Create endpoint to retry Oblio invoice generation for settlements that failed.

**Create new file:**
```typescript
// src/app/api/intercompany/invoices/[id]/oblio/route.ts

import { NextResponse } from "next/server";
import { generateOblioIntercompanyInvoice } from "@/lib/intercompany-service";
import prisma from "@/lib/db";

export async function POST(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const { id } = params;

    // Check if settlement exists and doesn't already have Oblio invoice
    const settlement = await prisma.intercompanyInvoice.findUnique({
      where: { id },
      select: {
        id: true,
        oblioInvoiceId: true,
        invoiceNumber: true,
      },
    });

    if (!settlement) {
      return NextResponse.json(
        { success: false, error: "Decontarea nu a fost găsită" },
        { status: 404 }
      );
    }

    if (settlement.oblioInvoiceId) {
      return NextResponse.json(
        { success: false, error: "Factura Oblio există deja" },
        { status: 400 }
      );
    }

    // Generate Oblio invoice
    const result = await generateOblioIntercompanyInvoice(id);

    if (!result.success) {
      return NextResponse.json(
        { success: false, error: result.error },
        { status: 400 }
      );
    }

    return NextResponse.json({
      success: true,
      oblioInvoiceId: result.oblioInvoiceId,
      oblioInvoiceNumber: result.oblioInvoiceNumber,
      oblioSeriesName: result.oblioSeriesName,
      oblioLink: result.oblioLink,
    });
  } catch (error: any) {
    console.error("[Intercompany Oblio Retry] Error:", error);
    return NextResponse.json(
      { success: false, error: error.message || "Eroare la generarea facturii Oblio" },
      { status: 500 }
    );
  }
}
```

**Add retry button in intercompany page:**
In the invoices table, for rows without oblioLink:
```tsx
{!invoice.oblioLink && (
  <Button
    variant="outline"
    size="sm"
    onClick={() => retryOblioMutation.mutate(invoice.id)}
    disabled={retryOblioMutation.isPending}
  >
    {retryOblioMutation.isPending ? (
      <Loader2 className="h-4 w-4 animate-spin" />
    ) : (
      <RefreshCw className="h-4 w-4" />
    )}
    <span className="ml-1">Generează Oblio</span>
  </Button>
)}
```
  </action>
  <verify>
1. Create a settlement without Oblio series configured (should fail Oblio step)
2. Configure intercompanySeriesName in company settings
3. Click "Generează Oblio" retry button
4. Verify Oblio invoice is created and link appears
  </verify>
  <done>
Failed Oblio generations can be retried via dedicated endpoint and UI button.
  </done>
</task>

</tasks>

<verification>
1. Oblio integration: Settlement creates actual invoice in Oblio
2. Reference storage: IntercompanyInvoice has oblioInvoiceId and oblioLink populated
3. Traceability: Can click link in table to view Oblio invoice
4. Error handling: Missing series shows clear error message
5. Retry capability: Can retry Oblio generation for failed settlements
6. Full flow: Company select > Order select > Preview > Generate > Oblio invoice created
</verification>

<success_criteria>
- Settlement generation creates invoice in Oblio using intercompanySeriesName
- IntercompanyInvoice stores Oblio reference (oblioInvoiceId, oblioInvoiceNumber, oblioLink)
- UI shows Oblio invoice link in settlements table
- Clear error message if intercompanySeriesName not configured
- Retry endpoint allows regenerating failed Oblio invoices
- Complete audit trail: settlement > orders > Oblio invoice
</success_criteria>

<output>
After completion, create `.planning/phases/03-internal-settlement/03-04-SUMMARY.md`
</output>
