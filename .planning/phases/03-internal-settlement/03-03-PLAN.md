---
phase: 03-internal-settlement
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/app/(dashboard)/intercompany/page.tsx
  - src/app/(dashboard)/settings/companies/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of eligible orders with checkboxes for selection"
    - "Orders are pre-selected by default, user can exclude specific orders"
    - "Warning banner shows when products lack acquisition prices"
    - "Preview shows cost-based totals with markup"
    - "Company settings includes intercompany series configuration"
  artifacts:
    - path: "src/app/(dashboard)/intercompany/page.tsx"
      provides: "Order selection UI with pre-selection, warnings, and detailed columns"
      min_lines: 600
    - path: "src/app/(dashboard)/settings/companies/[id]/page.tsx"
      provides: "Intercompany series name configuration field"
      contains: "intercompanySeriesName"
  key_links:
    - from: "intercompany/page.tsx"
      to: "/api/intercompany/eligible-orders"
      via: "React Query fetch"
      pattern: "fetch.*eligible-orders"
    - from: "intercompany/page.tsx"
      to: "/api/intercompany/preview"
      via: "POST with selected orderIds"
      pattern: "POST.*preview"
---

<objective>
Build order selection UI with pre-selection workflow and company settings for intercompany series.

Purpose: User workflow per CONTEXT.md - pre-select all eligible orders, allow exclusions, show warnings for missing cost prices, require preview confirmation before generation.
Output: Enhanced intercompany page with selection workflow and company settings update.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-internal-settlement/03-CONTEXT.md
@.planning/phases/03-internal-settlement/03-02-SUMMARY.md

Source files:
@src/app/(dashboard)/intercompany/page.tsx (existing page - needs major enhancement)
@src/app/(dashboard)/settings/companies/[id]/page.tsx (company settings)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add intercompany series to company settings</name>
  <files>src/app/(dashboard)/settings/companies/[id]/page.tsx</files>
  <action>
Add field for intercompanySeriesName in the company settings page.

**In the Oblio tab** (or create "Decontare" tab if cleaner), add:
```tsx
<div className="space-y-2">
  <Label htmlFor="intercompanySeriesName">Serie Decontare Intercompany</Label>
  <Input
    id="intercompanySeriesName"
    value={formData.intercompanySeriesName || ""}
    onChange={(e) => setFormData({ ...formData, intercompanySeriesName: e.target.value })}
    placeholder="ex: DEC, DECONT"
  />
  <p className="text-sm text-muted-foreground">
    Seria din Oblio folosită pentru facturile de decontare internă.
    Trebuie creată manual în Oblio înainte de utilizare.
  </p>
</div>
```

**Update the save function** to include intercompanySeriesName in the API call.

**Update the API** (`/api/companies/[id]`) to accept and save intercompanySeriesName if not already handled.

Also ensure the fetch includes intercompanySeriesName when loading company data.
  </action>
  <verify>
1. Navigate to Settings > Companies > [Edit Company]
2. Find the "Serie Decontare Intercompany" field
3. Enter a value (e.g., "DEC") and save
4. Refresh page - value should persist
  </verify>
  <done>
Company settings includes field for configuring the Oblio series used for internal settlement invoices.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build order selection workflow in intercompany page</name>
  <files>src/app/(dashboard)/intercompany/page.tsx</files>
  <action>
Major enhancement to the intercompany page. Replace the current simple preview flow with full order selection.

**State management:**
```tsx
const [selectedCompanyId, setSelectedCompanyId] = useState<string>("");
const [eligibleOrders, setEligibleOrders] = useState<EligibleOrder[]>([]);
const [selectedOrderIds, setSelectedOrderIds] = useState<Set<string>>(new Set());
const [isLoadingOrders, setIsLoadingOrders] = useState(false);
const [previewData, setPreviewData] = useState<SettlementPreview | null>(null);
const [previewWarnings, setPreviewWarnings] = useState<string[]>([]);
```

**New workflow (3 steps):**

**Step 1: Select Company & Load Orders**
- User selects company from dropdown
- Automatically fetch eligible orders: `GET /api/intercompany/eligible-orders?companyId=X`
- Pre-select all orders (add all IDs to selectedOrderIds)
- Show orders in a table with checkboxes

**Step 2: Order Selection Table**
Display columns:
| [] | Nr. Comandă | Dată | Client | Produse | Total Client | Cost Achiziție | Tip Plată | Status |
- Checkbox for selection (checked = included)
- Nr. Comandă: orderNumber
- Dată: formatted date
- Client: customer name
- Produse: productCount
- Total Client: totalPrice (ce a plătit clientul)
- Cost Achiziție: costTotal (sumă prețuri achiziție)
- Tip Plată: Badge "COD" or "Online"
- Status: Warning icon if hasMissingCostPrice

**Selection controls:**
- "Selectează toate" button
- "Deselectează toate" button
- Counter: "X din Y comenzi selectate"

**Warning banner** (if any order has hasMissingCostPrice):
```tsx
<Alert variant="warning">
  <AlertTriangle className="h-4 w-4" />
  <AlertTitle>Atenție</AlertTitle>
  <AlertDescription>
    Unele produse nu au preț de achiziție configurat.
    Acestea vor fi calculate cu valoare 0.
  </AlertDescription>
</Alert>
```

**Step 3: Preview Button**
- Enabled only when selectedOrderIds.size > 0
- On click: `POST /api/intercompany/preview` with { companyId, orderIds: Array.from(selectedOrderIds) }
- Opens preview dialog with:
  - Summary cards (comenzi, subtotal cost achiziție, adaos %, total)
  - Warnings list (if any)
  - Aggregated products table
  - "Generează Factură" button

**Preview Dialog enhancements:**
- Show "Calculat la preț achiziție" label clearly
- Display warnings prominently if present
- Show markup percentage from company settings
- Button text: "Generează Factură în Oblio" (since it will create in Oblio)

**TypeScript interfaces:**
```tsx
interface EligibleOrder {
  id: string;
  orderNumber: string;
  date: string;
  client: string;
  totalPrice: number;
  productCount: number;
  costTotal: number;
  paymentType: "cod" | "online";
  hasMissingCostPrice: boolean;
}

interface SettlementPreview {
  companyId: string;
  companyName: string;
  companyCode: string;
  periodStart: string;
  periodEnd: string;
  orders: Array<{
    id: string;
    orderNumber: string;
    totalPrice: number;
    costTotal: number;
    processedAt: string;
    productCount: number;
    paymentType: "cod" | "online";
    selected: boolean;
  }>;
  lineItems: Array<{
    sku: string;
    title: string;
    quantity: number;
    unitCost: number;
    lineTotal: number;
    hasCostPrice: boolean;
  }>;
  totals: {
    orderCount: number;
    subtotal: number;
    markupPercent: number;
    markupAmount: number;
    total: number;
  };
  warnings: string[];
}
```
  </action>
  <verify>
Manual testing workflow:
1. Select a secondary company from dropdown
2. Eligible orders load and display in table
3. All orders pre-selected (checkboxes checked)
4. Uncheck some orders - selection count updates
5. Click "Preview Decontare" - preview dialog shows
6. Verify preview shows cost-based totals (different from customer totals)
7. Verify warnings appear if any products lack cost price
  </verify>
  <done>
Intercompany page shows eligible orders with selection checkboxes, pre-selects all, allows exclusions, displays warnings for missing cost prices, and generates preview for selected orders only.
  </done>
</task>

</tasks>

<verification>
1. Company settings: intercompanySeriesName field visible and saves correctly
2. Order loading: Selecting company loads eligible orders automatically
3. Pre-selection: All orders checked by default
4. Selection controls: Can select/deselect all, can toggle individual orders
5. Warning display: Orders with missing cost price show warning icon
6. Preview generation: Only selected orders included in preview calculation
7. Cost-based display: Preview clearly shows "preț achiziție" totals
</verification>

<success_criteria>
- Company settings has "Serie Decontare Intercompany" field that persists
- Intercompany page loads eligible orders when company selected
- Orders displayed with detailed columns including costTotal and paymentType
- All orders pre-selected, user can exclude by unchecking
- Warning banner appears when products lack cost price
- Preview generated only for selected orders
- Preview dialog clearly shows cost-based calculation with markup
</success_criteria>

<output>
After completion, create `.planning/phases/03-internal-settlement/03-03-SUMMARY.md`
</output>
