---
phase: 03-internal-settlement
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/intercompany-service.ts
  - src/app/api/intercompany/generate/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can select/exclude specific orders before generating settlement"
    - "Only selected orders are linked to generated IntercompanyInvoice"
    - "Non-selected orders remain with intercompanyStatus='pending'"
  artifacts:
    - path: "src/lib/intercompany-service.ts"
      provides: "generateIntercompanyInvoice with orderIds parameter"
      contains: "orderIds?: string[]"
    - path: "src/app/api/intercompany/generate/route.ts"
      provides: "API passes orderIds to service"
      contains: "generateIntercompanyInvoice(companyId, orderIds"
  key_links:
    - from: "src/app/api/intercompany/generate/route.ts"
      to: "generateIntercompanyInvoice"
      via: "orderIds parameter passthrough"
      pattern: "generateIntercompanyInvoice\\(companyId,\\s*orderIds"
    - from: "src/lib/intercompany-service.ts"
      to: "calculateSettlementFromOrders"
      via: "conditional call when orderIds provided"
      pattern: "calculateSettlementFromOrders\\(companyId,\\s*orderIds\\)"
---

<objective>
Wire order selection from UI through to settlement generation

Purpose: Close verification gap - UI sends orderIds but backend ignores them. User must be able to exclude orders.
Output: Modified generateIntercompanyInvoice and generate API to respect user's order selection
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-internal-settlement/03-VERIFICATION.md

# Source files to modify
@src/lib/intercompany-service.ts
@src/app/api/intercompany/generate/route.ts

# Reference - preview endpoint already correctly uses order selection
@src/app/api/intercompany/preview/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update generateIntercompanyInvoice to accept and use orderIds</name>
  <files>src/lib/intercompany-service.ts</files>
  <action>
    Modify the generateIntercompanyInvoice function signature and logic:

    1. Update function signature at line ~514:
       FROM: `generateIntercompanyInvoice(companyId: string, periodStart?: Date, periodEnd?: Date)`
       TO:   `generateIntercompanyInvoice(companyId: string, orderIds?: string[], periodStart?: Date, periodEnd?: Date)`

    2. Update function logic at line ~520:
       FROM: `const preview = await generateSettlementPreview(companyId, periodStart, periodEnd);`
       TO:
       ```typescript
       // Use selected orders if provided, otherwise fetch all eligible orders
       const preview = orderIds && orderIds.length > 0
         ? await calculateSettlementFromOrders(companyId, orderIds)
         : await generateSettlementPreview(companyId, periodStart, periodEnd);
       ```

    The `calculateSettlementFromOrders` function already exists (line ~218) and correctly:
    - Validates orders belong to companyId and have intercompanyStatus="pending"
    - Calculates using costPrice from InventoryItem
    - Returns SettlementPreviewExtended with orders array

    No other changes needed - the rest of the function (transaction, invoice creation, order linking) already iterates over `preview.orders` which will now be the selected orders only.
  </action>
  <verify>
    1. Check function signature: `grep -n "generateIntercompanyInvoice" src/lib/intercompany-service.ts | head -5`
    2. Check new logic: `grep -A5 "orderIds && orderIds.length" src/lib/intercompany-service.ts`
    3. TypeScript compile: `npx tsc --noEmit src/lib/intercompany-service.ts 2>&1 | head -20`
  </verify>
  <done>
    generateIntercompanyInvoice accepts optional orderIds array and uses calculateSettlementFromOrders when orderIds provided
  </done>
</task>

<task type="auto">
  <name>Task 2: Update generate API to pass orderIds to service</name>
  <files>src/app/api/intercompany/generate/route.ts</files>
  <action>
    Update the generate API route to pass orderIds to generateIntercompanyInvoice:

    At line ~45, change:
    FROM: `const result = await generateIntercompanyInvoice(companyId, periodStartDate, periodEndDate);`
    TO:   `const result = await generateIntercompanyInvoice(companyId, orderIds, periodStartDate, periodEndDate);`

    The orderIds is already extracted from request body at line 32:
    `const { companyId, orderIds, periodStart, periodEnd } = body;`

    No validation needed for orderIds - if undefined or empty, the service will fall back to generateSettlementPreview (all eligible orders). This matches current behavior when user clicks generate without explicit selection.
  </action>
  <verify>
    1. Check passthrough: `grep -n "generateIntercompanyInvoice" src/app/api/intercompany/generate/route.ts`
    2. Verify orderIds is passed: `grep -A2 "await generateIntercompanyInvoice" src/app/api/intercompany/generate/route.ts`
    3. TypeScript compile: `npx tsc --noEmit src/app/api/intercompany/generate/route.ts 2>&1 | head -20`
  </verify>
  <done>
    Generate API passes orderIds from request body to generateIntercompanyInvoice service function
  </done>
</task>

</tasks>

<verification>
After completing both tasks, verify the full flow:

1. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```
   Should pass with no errors.

2. **Code pattern verification:**
   ```bash
   # Service function accepts orderIds
   grep -n "orderIds?: string\[\]" src/lib/intercompany-service.ts

   # Service uses calculateSettlementFromOrders conditionally
   grep -B2 -A2 "calculateSettlementFromOrders" src/lib/intercompany-service.ts | grep -A2 "orderIds"

   # API passes orderIds
   grep "generateIntercompanyInvoice(companyId, orderIds" src/app/api/intercompany/generate/route.ts
   ```

3. **Key link verification:**
   - UI sends orderIds to /api/intercompany/generate (already works - page.tsx line 206-214)
   - API extracts orderIds from body (already works - route.ts line 32)
   - API passes orderIds to service (Task 2)
   - Service uses orderIds with calculateSettlementFromOrders (Task 1)
   - Only selected orders get linked to invoice (existing logic in service)
</verification>

<success_criteria>
1. generateIntercompanyInvoice function signature includes `orderIds?: string[]` parameter
2. When orderIds array is provided, only those orders are included in settlement
3. When orderIds is undefined/empty, all eligible orders are included (backward compatible)
4. TypeScript compiles without errors
5. Verification gap closed: "User can select/exclude specific orders before generating settlement"
</success_criteria>

<output>
After completion, create `.planning/phases/03-internal-settlement/03-05-SUMMARY.md`
</output>
