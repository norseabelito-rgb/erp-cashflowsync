---
phase: 03-internal-settlement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/app/api/intercompany/eligible-orders/route.ts
autonomous: true

must_haves:
  truths:
    - "Company model has intercompanySeriesName field for dedicated settlement series"
    - "IntercompanyInvoice model has Oblio reference fields"
    - "API returns eligible orders with payment type and cost price data"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Extended Company and IntercompanyInvoice models"
      contains: "intercompanySeriesName"
    - path: "src/app/api/intercompany/eligible-orders/route.ts"
      provides: "Endpoint to fetch eligible orders for settlement selection"
      exports: ["GET"]
  key_links:
    - from: "eligible-orders/route.ts"
      to: "prisma"
      via: "findMany with lineItems and inventoryItem includes"
      pattern: "prisma\\.order\\.findMany"
---

<objective>
Extend database schema and create eligible orders API for settlement selection workflow.

Purpose: Foundation for order selection UI - need schema fields for Oblio integration and API to fetch eligible orders with cost price data.
Output: Prisma schema migrations + new API endpoint returning orders with costPrice from InventoryItem.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-internal-settlement/03-CONTEXT.md
@.planning/phases/03-internal-settlement/03-RESEARCH.md

Source files:
@prisma/schema.prisma (Company model ~line 3077, IntercompanyInvoice ~line 3150)
@src/lib/intercompany-service.ts (existing getEligibleOrdersForSettlement function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema for Oblio integration</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following fields to the existing models:

**Company model** (around line 3124, after intercompanyMarkup):
```prisma
  // Serie dedicată pentru decontări intercompany în Oblio
  intercompanySeriesName String?  // ex: "DEC", "DECONT" - seria din Oblio pentru facturi decontare
```

**IntercompanyInvoice model** (around line 3180, after lineItems):
```prisma
  // Link to Oblio invoice (after generation)
  oblioInvoiceId     String?   // Oblio reference ID after generation
  oblioSeriesName    String?   // Series used in Oblio (e.g., "DEC")
  oblioInvoiceNumber String?   // Invoice number in Oblio
  oblioLink          String?   // Direct link to view invoice in Oblio

  // Markup used for this settlement
  markupPercent      Decimal? @db.Decimal(5, 2)  // Store the markup % used
```

Run `npx prisma db push` to apply changes (non-destructive for optional fields).
  </action>
  <verify>
Run: `npx prisma db push --accept-data-loss=false`
Verify no errors. Schema should apply cleanly since all new fields are optional.
  </verify>
  <done>
Schema updated with intercompanySeriesName on Company and Oblio reference fields on IntercompanyInvoice.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create eligible orders API endpoint</name>
  <files>src/app/api/intercompany/eligible-orders/route.ts</files>
  <action>
Create new API endpoint that returns eligible orders for settlement selection with:
- Orders from secondary companies (billingCompanyId != primary)
- With intercompanyStatus = "pending"
- Either AWB isCollected = true (COD) OR financialStatus = "paid" (online payment)
- Include line items with InventoryItem.costPrice lookup

Query parameters:
- `companyId` (required): Filter by specific secondary company
- `fromDate` (optional): Start of period
- `toDate` (optional): End of period

Response shape:
```typescript
{
  success: boolean;
  orders: Array<{
    id: string;
    orderNumber: string;
    date: Date;
    client: string;
    totalPrice: number;
    productCount: number;
    costTotal: number;        // Sum of costPrice * quantity
    paymentType: "cod" | "online";
    isAlreadyCollected: boolean;  // true if financialStatus = "paid"
    hasMissingCostPrice: boolean; // true if any product lacks costPrice
    lineItems: Array<{
      sku: string | null;
      title: string;
      quantity: number;
      price: number;          // Customer price
      costPrice: number | null; // From InventoryItem
    }>;
  }>;
  warnings: string[];  // Products without costPrice
}
```

Implementation notes:
- Use Prisma include to get lineItems -> masterProduct -> inventoryItem chain
- Batch-lookup InventoryItem by SKU for efficiency (avoid N+1)
- Calculate costTotal as sum of (costPrice || 0) * quantity per line item
- Set hasMissingCostPrice = true if any lineItem has null costPrice
- Generate warning messages for each product without costPrice
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Test with curl:
```bash
curl "http://localhost:3000/api/intercompany/eligible-orders?companyId=<secondary_company_id>"
```
Should return 200 with orders array (possibly empty if no eligible orders).
  </verify>
  <done>
API endpoint returns eligible orders with payment type classification and cost price data from InventoryItem.
  </done>
</task>

</tasks>

<verification>
1. Schema changes applied: `npx prisma db push` succeeds
2. New fields visible: `npx prisma studio` shows intercompanySeriesName on Company
3. API endpoint accessible: GET /api/intercompany/eligible-orders returns JSON
4. Orders include costPrice data from InventoryItem relation
</verification>

<success_criteria>
- Company model has intercompanySeriesName field for configuring Oblio series
- IntercompanyInvoice model has Oblio reference fields (oblioInvoiceId, oblioSeriesName, oblioInvoiceNumber, oblioLink)
- API endpoint /api/intercompany/eligible-orders returns orders with:
  - Payment type classification (cod vs online)
  - Cost price data from InventoryItem
  - Warnings for products without costPrice
</success_criteria>

<output>
After completion, create `.planning/phases/03-internal-settlement/03-01-SUMMARY.md`
</output>
