---
phase: 08-task-management-advanced
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/api/orders/process-all/route.ts
autonomous: true

must_haves:
  truths:
    - "Picking list creation automatically creates a picking task"
    - "Processing errors automatically create verification tasks"
    - "Auto-created tasks are assigned to appropriate role users"
    - "Assignees receive notifications for auto-created tasks"
  artifacts:
    - path: "src/app/api/orders/process-all/route.ts"
      provides: "Auto-task creation hooks for picking list and errors"
      contains: "createAutoTask"
  key_links:
    - from: "src/app/api/orders/process-all/route.ts"
      to: "src/lib/task-service.ts"
      via: "import createAutoTask"
      pattern: "import.*createAutoTask.*task-service"
    - from: "src/app/api/orders/process-all/route.ts"
      to: "createAutoTask"
      via: "function call after picking list creation"
      pattern: "createAutoTask\\(\"PICKING_LIST_CREATED\""
    - from: "src/app/api/orders/process-all/route.ts"
      to: "createAutoTask"
      via: "function call on processing error"
      pattern: "createAutoTask\\(\"ORDER_PROCESSING_ERROR\""
---

<objective>
Hook auto-task creation into the order processing flow for picking list creation and processing errors.

Purpose: System events automatically create related tasks (TASK-07 requirement).
Output: process-all/route.ts calls createAutoTask after picking list creation and on processing errors.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-task-management-advanced/08-RESEARCH.md

# File to modify - existing order processing
@src/app/api/orders/process-all/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-task creation hooks to process-all</name>
  <files>src/app/api/orders/process-all/route.ts</files>
  <action>
Update src/app/api/orders/process-all/route.ts to create tasks automatically:

1. Add import at top:
```typescript
import { createAutoTask } from "@/lib/task-service";
```

2. After picking list creation (after the pickingList is created and notifications are sent to pickers - around line 562):
   Find the block that creates the picking list and sends notifications.
   After the notification.createMany call, add:
```typescript
// Create auto-task for picking (TASK-07)
try {
  await createAutoTask(
    "PICKING_LIST_CREATED",
    {
      pickingListCode: pickingList.code,
      totalItems: pickingList.totalItems,
      timestamp: new Date().toISOString(),
    },
    userId // The user who triggered the processing
  );
} catch (taskError) {
  console.error("[process-all] Failed to create picking task:", taskError);
  // Don't fail the main operation if task creation fails
}
```

3. In the error handling block (when an order fails to process):
   Find where ProcessingError is created or where errors are collected.
   After recording the error, add:
```typescript
// Create auto-task for verification on error (TASK-07)
try {
  await createAutoTask(
    "ORDER_PROCESSING_ERROR",
    {
      orderId: order.id,
      orderNumber: order.shopifyOrderNumber || order.id,
      errorMessage: errorMessage, // The error that occurred
    },
    userId
  );
} catch (taskError) {
  console.error("[process-all] Failed to create error task:", taskError);
  // Don't fail the main operation if task creation fails
}
```

Important considerations:
- Wrap in try/catch to not break main flow if task creation fails
- Pass the userId from the session as createdByUserId
- Use the correct context variables available at each hook point
- Log failures but don't throw

Note: Read the existing process-all/route.ts carefully first to identify exact insertion points.
The file is complex (~600 lines). Look for:
- Where pickingList is created (for PICKING_LIST_CREATED hook)
- Where ProcessingError is created or errors are caught (for ORDER_PROCESSING_ERROR hook)
  </action>
  <verify>grep -n "createAutoTask" src/app/api/orders/process-all/route.ts shows at least 2 hook points</verify>
  <done>process-all/route.ts calls createAutoTask for picking list creation and processing errors</done>
</task>

<task type="auto">
  <name>Task 2: Update AUTO_TASK_CONFIG if needed based on actual context</name>
  <files>src/lib/task-service.ts</files>
  <action>
After reviewing process-all/route.ts, update AUTO_TASK_CONFIG in task-service.ts if the context variables need adjustment.

The config should match what's available at each hook point:
- PICKING_LIST_CREATED: pickingListCode, totalItems, timestamp
- ORDER_PROCESSING_ERROR: orderId, orderNumber, errorMessage

If the template placeholders don't match available context, update them.

Also ensure the linkedOrderId connection:
- For ORDER_PROCESSING_ERROR, the task should be linked to the order
- Update createAutoTask to handle linkedOrderId from context

Update the createAutoTask function data block:
```typescript
const task = await prisma.task.create({
  data: {
    title,
    description,
    type: config.taskType as any,
    priority: config.defaultPriority,
    deadline,
    assigneeId: assignee?.id || null,
    createdById: createdByUserId,
    linkedOrderId: context.orderId || null,  // Link to order if available
    linkedProductId: context.productId || null,
  },
});
```
  </action>
  <verify>
Verify AUTO_TASK_CONFIG contains PICKING_LIST_CREATED and ORDER_PROCESSING_ERROR:
grep -E 'PICKING_LIST_CREATED|ORDER_PROCESSING_ERROR' src/lib/task-service.ts

Verify linkedOrderId handling:
grep -A5 "linkedOrderId" src/lib/task-service.ts shows order linking is implemented
  </verify>
  <done>AUTO_TASK_CONFIG contains PICKING_LIST_CREATED and ORDER_PROCESSING_ERROR with correct templates, linkedOrderId is properly connected</done>
</task>

</tasks>

<verification>
1. createAutoTask is imported in process-all/route.ts
2. At least 2 calls to createAutoTask exist (picking list, error)
3. Calls are wrapped in try/catch to not break main flow
4. Context variables passed match what's available at hook points
5. linkedOrderId is set for error tasks
6. AUTO_TASK_CONFIG contains both PICKING_LIST_CREATED and ORDER_PROCESSING_ERROR
</verification>

<success_criteria>
- process-all/route.ts imports createAutoTask from task-service
- PICKING_LIST_CREATED task is created when picking list is generated
- ORDER_PROCESSING_ERROR task is created when processing fails
- Tasks are linked to orders via linkedOrderId where applicable
- Error handling prevents task failures from breaking order processing
- AUTO_TASK_CONFIG has entries for PICKING_LIST_CREATED and ORDER_PROCESSING_ERROR
</success_criteria>

<output>
After completion, create `.planning/phases/08-task-management-advanced/08-03-SUMMARY.md`
</output>
