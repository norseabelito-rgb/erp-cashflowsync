---
phase: 08-task-management-advanced
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/reports/activity/route.ts
  - src/app/(dashboard)/reports/activity/page.tsx
  - src/lib/permissions.ts
autonomous: true

must_haves:
  truths:
    - "Activity report shows completed tasks grouped by user"
    - "Report can filter by date range (default 7 days)"
    - "Report shows who completed what tasks and when"
    - "Only users with reports.view permission can access"
  artifacts:
    - path: "src/app/api/reports/activity/route.ts"
      provides: "Activity report API endpoint"
      exports: ["GET"]
    - path: "src/app/(dashboard)/reports/activity/page.tsx"
      provides: "Activity report UI page"
      min_lines: 100
  key_links:
    - from: "src/app/(dashboard)/reports/activity/page.tsx"
      to: "/api/reports/activity"
      via: "fetch in useEffect"
      pattern: "fetch.*api/reports/activity"
    - from: "src/app/api/reports/activity/route.ts"
      to: "prisma.task"
      via: "findMany query"
      pattern: "prisma\\.task\\.findMany"
---

<objective>
Create activity report API and UI page showing task completion statistics grouped by user.

Purpose: Activity reports show who completed what tasks and when (TASK-06 requirement).
Output: /api/reports/activity endpoint and /reports/activity page with aggregated task completion data.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-task-management-advanced/08-RESEARCH.md

# Existing patterns to follow
@src/lib/permissions.ts
@src/app/api/notifications/route.ts
@src/app/(dashboard)/orders/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity report API endpoint</name>
  <files>src/app/api/reports/activity/route.ts</files>
  <action>
Create src/app/api/reports/activity/route.ts:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import prisma from "@/lib/db";
import { hasPermission } from "@/lib/permissions";
import { subDays, startOfDay, endOfDay, format } from "date-fns";

/**
 * GET /api/reports/activity
 *
 * Returns task completion activity report.
 * Query params:
 * - days: Number of days to include (default: 7, max: 90)
 * - userId: Filter by specific user (optional)
 */
export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: "Neautorizat" }, { status: 401 });
    }

    const canViewReports = await hasPermission(session.user.id, "reports.view");
    if (!canViewReports) {
      return NextResponse.json({ error: "Fara permisiune pentru rapoarte" }, { status: 403 });
    }

    const { searchParams } = new URL(request.url);
    const days = Math.min(parseInt(searchParams.get("days") || "7"), 90);
    const filterUserId = searchParams.get("userId") || null;

    const startDate = startOfDay(subDays(new Date(), days));
    const endDate = endOfDay(new Date());

    // Query completed tasks in period
    // @ts-expect-error - prisma.task exists after prisma generate
    const completedTasks = await prisma.task.findMany({
      where: {
        completedAt: {
          gte: startDate,
          lte: endDate,
        },
        ...(filterUserId ? { completedById: filterUserId } : {}),
      },
      include: {
        completedBy: { select: { id: true, name: true, image: true } },
        assignee: { select: { id: true, name: true } },
      },
      orderBy: { completedAt: "desc" },
      take: 500, // Limit results
    });

    // Aggregate by user
    const byUser: Record<string, {
      userId: string;
      userName: string;
      userImage: string | null;
      tasks: number;
      types: Record<string, number>;
    }> = {};

    for (const task of completedTasks) {
      const userId = task.completedById || task.assigneeId || "system";
      const userName = task.completedBy?.name || task.assignee?.name || "Sistem (auto)";
      const userImage = task.completedBy?.image || null;

      if (!byUser[userId]) {
        byUser[userId] = { userId, userName, userImage, tasks: 0, types: {} };
      }
      byUser[userId].tasks++;
      byUser[userId].types[task.type] = (byUser[userId].types[task.type] || 0) + 1;
    }

    // Aggregate by day
    const byDay: Record<string, number> = {};
    for (const task of completedTasks) {
      if (task.completedAt) {
        const day = format(task.completedAt, "yyyy-MM-dd");
        byDay[day] = (byDay[day] || 0) + 1;
      }
    }

    // Aggregate by type
    const byType: Record<string, number> = {};
    for (const task of completedTasks) {
      byType[task.type] = (byType[task.type] || 0) + 1;
    }

    return NextResponse.json({
      success: true,
      period: {
        start: startDate.toISOString(),
        end: endDate.toISOString(),
        days,
      },
      stats: {
        totalCompleted: completedTasks.length,
        byUser: Object.values(byUser).sort((a, b) => b.tasks - a.tasks),
        byDay,
        byType,
      },
      recentTasks: completedTasks.slice(0, 50).map(t => ({
        id: t.id,
        title: t.title,
        type: t.type,
        completedAt: t.completedAt,
        completedBy: t.completedBy?.name || t.assignee?.name || "Sistem",
      })),
    });
  } catch (error: any) {
    console.error("Error fetching activity report:", error);
    return NextResponse.json(
      { error: error.message || "Eroare la generarea raportului" },
      { status: 500 }
    );
  }
}
```
  </action>
  <verify>File exists: ls -la src/app/api/reports/activity/route.ts</verify>
  <done>Activity report API endpoint exists with aggregation by user, day, and type</done>
</task>

<task type="auto">
  <name>Task 2: Create activity report UI page</name>
  <files>src/app/(dashboard)/reports/activity/page.tsx</files>
  <action>
Create src/app/(dashboard)/reports/activity/page.tsx:

```typescript
"use client";

import { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { BarChart3, Users, CheckCircle, Calendar } from "lucide-react";
import { format, parseISO } from "date-fns";
import { ro } from "date-fns/locale";

interface ActivityStats {
  totalCompleted: number;
  byUser: Array<{
    userId: string;
    userName: string;
    userImage: string | null;
    tasks: number;
    types: Record<string, number>;
  }>;
  byDay: Record<string, number>;
  byType: Record<string, number>;
}

interface RecentTask {
  id: string;
  title: string;
  type: string;
  completedAt: string;
  completedBy: string;
}

const TASK_TYPE_LABELS: Record<string, string> = {
  PICKING: "Picking",
  VERIFICARE: "Verificare",
  EXPEDIERE: "Expediere",
  BUSINESS: "Business",
};

const TASK_TYPE_COLORS: Record<string, string> = {
  PICKING: "bg-blue-100 text-blue-800",
  VERIFICARE: "bg-amber-100 text-amber-800",
  EXPEDIERE: "bg-green-100 text-green-800",
  BUSINESS: "bg-purple-100 text-purple-800",
};

export default function ActivityReportPage() {
  const [days, setDays] = useState("7");
  const [stats, setStats] = useState<ActivityStats | null>(null);
  const [recentTasks, setRecentTasks] = useState<RecentTask[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    fetchReport();
  }, [days]);

  async function fetchReport() {
    setLoading(true);
    setError(null);
    try {
      const res = await fetch(`/api/reports/activity?days=${days}`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Eroare la incarcarea raportului");
      setStats(data.stats);
      setRecentTasks(data.recentTasks);
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }

  if (error) {
    return (
      <div className="p-6">
        <Card className="border-destructive">
          <CardContent className="pt-6">
            <p className="text-destructive">{error}</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Raport Activitate</h1>
          <p className="text-muted-foreground">Cine a facut ce si cand</p>
        </div>
        <Select value={days} onValueChange={setDays}>
          <SelectTrigger className="w-[180px]">
            <SelectValue placeholder="Perioada" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="7">Ultimele 7 zile</SelectItem>
            <SelectItem value="14">Ultimele 14 zile</SelectItem>
            <SelectItem value="30">Ultimele 30 zile</SelectItem>
            <SelectItem value="90">Ultimele 90 zile</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">Total Finalizate</CardTitle>
            <CheckCircle className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {loading ? (
              <Skeleton className="h-8 w-20" />
            ) : (
              <div className="text-2xl font-bold">{stats?.totalCompleted || 0}</div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">Utilizatori Activi</CardTitle>
            <Users className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {loading ? (
              <Skeleton className="h-8 w-20" />
            ) : (
              <div className="text-2xl font-bold">{stats?.byUser.length || 0}</div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">Media/Zi</CardTitle>
            <Calendar className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {loading ? (
              <Skeleton className="h-8 w-20" />
            ) : (
              <div className="text-2xl font-bold">
                {stats ? Math.round(stats.totalCompleted / parseInt(days)) : 0}
              </div>
            )}
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">Tipuri Task</CardTitle>
            <BarChart3 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            {loading ? (
              <Skeleton className="h-8 w-20" />
            ) : (
              <div className="text-2xl font-bold">
                {stats ? Object.keys(stats.byType).length : 0}
              </div>
            )}
          </CardContent>
        </Card>
      </div>

      {/* By User Table */}
      <Card>
        <CardHeader>
          <CardTitle>Activitate per Utilizator</CardTitle>
        </CardHeader>
        <CardContent>
          {loading ? (
            <div className="space-y-2">
              {[...Array(5)].map((_, i) => (
                <Skeleton key={i} className="h-12 w-full" />
              ))}
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Utilizator</TableHead>
                  <TableHead className="text-right">Task-uri</TableHead>
                  <TableHead>Tipuri</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {stats?.byUser.map((user) => (
                  <TableRow key={user.userId}>
                    <TableCell className="font-medium">{user.userName}</TableCell>
                    <TableCell className="text-right">{user.tasks}</TableCell>
                    <TableCell>
                      <div className="flex gap-1 flex-wrap">
                        {Object.entries(user.types).map(([type, count]) => (
                          <Badge
                            key={type}
                            variant="secondary"
                            className={TASK_TYPE_COLORS[type] || ""}
                          >
                            {TASK_TYPE_LABELS[type] || type}: {count}
                          </Badge>
                        ))}
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
                {(!stats?.byUser || stats.byUser.length === 0) && (
                  <TableRow>
                    <TableCell colSpan={3} className="text-center text-muted-foreground">
                      Niciun task finalizat in aceasta perioada
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      {/* Recent Tasks */}
      <Card>
        <CardHeader>
          <CardTitle>Task-uri Recente Finalizate</CardTitle>
        </CardHeader>
        <CardContent>
          {loading ? (
            <div className="space-y-2">
              {[...Array(5)].map((_, i) => (
                <Skeleton key={i} className="h-12 w-full" />
              ))}
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>Task</TableHead>
                  <TableHead>Tip</TableHead>
                  <TableHead>Finalizat de</TableHead>
                  <TableHead>Data</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {recentTasks.map((task) => (
                  <TableRow key={task.id}>
                    <TableCell className="font-medium">{task.title}</TableCell>
                    <TableCell>
                      <Badge
                        variant="secondary"
                        className={TASK_TYPE_COLORS[task.type] || ""}
                      >
                        {TASK_TYPE_LABELS[task.type] || task.type}
                      </Badge>
                    </TableCell>
                    <TableCell>{task.completedBy}</TableCell>
                    <TableCell>
                      {format(parseISO(task.completedAt), "d MMM HH:mm", { locale: ro })}
                    </TableCell>
                  </TableRow>
                ))}
                {recentTasks.length === 0 && (
                  <TableRow>
                    <TableCell colSpan={4} className="text-center text-muted-foreground">
                      Niciun task finalizat in aceasta perioada
                    </TableCell>
                  </TableRow>
                )}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>File exists: ls -la "src/app/(dashboard)/reports/activity/page.tsx"</verify>
  <done>Activity report page exists with user aggregation, stats cards, and recent tasks table</done>
</task>

</tasks>

<verification>
1. src/app/api/reports/activity/route.ts exists with GET handler
2. API enforces reports.view permission
3. API returns stats grouped by user, day, and type
4. src/app/(dashboard)/reports/activity/page.tsx exists
5. UI shows summary cards, user table, and recent tasks
6. Period selector allows 7, 14, 30, 90 days
</verification>

<success_criteria>
- /api/reports/activity endpoint exists and requires reports.view permission
- Endpoint returns totalCompleted, byUser array, byDay, byType aggregations
- Report page displays at /reports/activity
- Page shows 4 summary cards (total, users, avg/day, types)
- Page shows per-user activity table with task type breakdown
- Page shows recent completed tasks with completion date
- Period selector works and refreshes data
</success_criteria>

<output>
After completion, create `.planning/phases/08-task-management-advanced/08-05-SUMMARY.md`
</output>
