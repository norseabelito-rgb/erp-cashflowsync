---
phase: 08-task-management-advanced
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/cron/task-reminders/route.ts
  - src/app/api/cron/run-all/route.ts
autonomous: true

must_haves:
  truths:
    - "Cron endpoint checks for tasks with deadlines in next 24 hours"
    - "Notifications are created for assignees of approaching deadline tasks"
    - "Duplicate notifications are prevented (same task, same day)"
    - "Task reminders cron is available in run-all orchestrator"
  artifacts:
    - path: "src/app/api/cron/task-reminders/route.ts"
      provides: "Deadline notification cron endpoint"
      exports: ["GET"]
    - path: "src/app/api/cron/run-all/route.ts"
      provides: "Updated orchestrator with task-reminders job"
      contains: "task-reminders"
  key_links:
    - from: "src/app/api/cron/task-reminders/route.ts"
      to: "prisma.task"
      via: "findMany query"
      pattern: "prisma\\.task\\.findMany"
    - from: "src/app/api/cron/task-reminders/route.ts"
      to: "prisma.notification"
      via: "createMany"
      pattern: "prisma\\.notification\\.createMany"
    - from: "src/app/api/cron/run-all/route.ts"
      to: "/api/cron/task-reminders"
      via: "callEndpoint"
      pattern: "task-reminders"
---

<objective>
Create cron endpoint for deadline notifications and integrate it into the run-all orchestrator.

Purpose: Users receive notifications for approaching deadlines (TASK-05 requirement).
Output: /api/cron/task-reminders endpoint that checks for tasks with deadlines in next 24 hours and creates notifications.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-task-management-advanced/08-RESEARCH.md

# Existing cron patterns to follow
@src/app/api/cron/run-all/route.ts
@src/app/api/cron/ads-alerts/route.ts
@src/lib/cron-lock.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task-reminders cron endpoint</name>
  <files>src/app/api/cron/task-reminders/route.ts</files>
  <action>
Create src/app/api/cron/task-reminders/route.ts following the ads-alerts pattern:

1. Import withCronLock from @/lib/cron-lock
2. Import prisma from @/lib/db
3. Import date-fns: addHours, startOfDay, format

4. GET handler:
   - Auth check: Bearer token must match CRON_SECRET
   - Use withCronLock("task-reminders", async () => { ... })

5. Inside the lock:
```typescript
const now = new Date();
const in24Hours = addHours(now, 24);
const todayStart = startOfDay(now);

// Find pending tasks with deadlines in next 24 hours that have assignees
const upcomingTasks = await prisma.task.findMany({
  where: {
    status: "PENDING",
    deadline: {
      gte: now,
      lte: in24Hours,
    },
    assigneeId: { not: null },
  },
  include: {
    assignee: { select: { id: true, name: true } },
  },
});

const notifications = [];
for (const task of upcomingTasks) {
  // Check if notification already sent today for this task
  const existing = await prisma.notification.findFirst({
    where: {
      userId: task.assigneeId!,
      type: "task_deadline_reminder",
      createdAt: { gte: todayStart },
      data: {
        path: ["taskId"],
        equals: task.id,
      },
    },
  });

  if (!existing) {
    const deadlineStr = format(task.deadline!, "d MMM, HH:mm", { locale: ro });
    notifications.push({
      userId: task.assigneeId!,
      type: "task_deadline_reminder",
      title: "Deadline apropiat",
      message: `Task "${task.title}" are deadline ${deadlineStr}`,
      actionUrl: `/tasks?highlight=${task.id}`,
      data: { taskId: task.id, deadline: task.deadline },
    });
  }
}

if (notifications.length > 0) {
  await prisma.notification.createMany({ data: notifications });
}

return { checked: upcomingTasks.length, notified: notifications.length };
```

6. Return JSON response with result

Note: Import date-fns/locale/ro for Romanian locale formatting.
If ro locale not available, use basic format without locale.
  </action>
  <verify>File exists: ls -la src/app/api/cron/task-reminders/route.ts</verify>
  <done>task-reminders cron endpoint exists with deadline checking and duplicate prevention logic</done>
</task>

<task type="auto">
  <name>Task 2: Add task-reminders to run-all orchestrator</name>
  <files>src/app/api/cron/run-all/route.ts</files>
  <action>
Update src/app/api/cron/run-all/route.ts to include task-reminders job:

1. Update the JSDoc comment at the top to add:
   * - GET /api/cron/run-all?job=task-reminders - Check task deadlines (every 15 min)

2. Add a new job block after sync-awb and before the final response:
```typescript
if (job === "task-reminders" || job === "all") {
  try {
    const data = await callEndpoint("/api/cron/task-reminders");
    results["task-reminders"] = { success: true, data };
    console.log(`[CRON RUN-ALL] task-reminders: SUCCESS`);
  } catch (err: unknown) {
    const error = err instanceof Error ? err.message : "Unknown error";
    results["task-reminders"] = { success: false, error };
    console.error(`[CRON RUN-ALL] task-reminders: FAILED -`, error);
  }
}
```

Place this after the sync-awb block to maintain logical grouping (task-reminders is a new feature).
  </action>
  <verify>grep -n "task-reminders" src/app/api/cron/run-all/route.ts shows the new job is added</verify>
  <done>run-all.ts includes task-reminders job and can be triggered via ?job=task-reminders</done>
</task>

</tasks>

<verification>
1. src/app/api/cron/task-reminders/route.ts exists
2. Endpoint uses withCronLock for concurrent execution prevention
3. Checks deadline within 24 hours
4. Prevents duplicate notifications (same task, same day)
5. run-all.ts includes task-reminders in job list
</verification>

<success_criteria>
- /api/cron/task-reminders endpoint exists and exports GET
- Endpoint uses withCronLock("task-reminders", ...)
- Queries tasks with deadline between now and now+24h, status PENDING
- Checks for existing notification before creating new one
- Creates notifications via prisma.notification.createMany
- run-all.ts can trigger task-reminders via ?job=task-reminders
</success_criteria>

<output>
After completion, create `.planning/phases/08-task-management-advanced/08-02-SUMMARY.md`
</output>
