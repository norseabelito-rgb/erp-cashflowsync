---
phase: 08-task-management-advanced
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/app/api/cron/task-reminders/route.ts
  - src/lib/task-service.ts
autonomous: true

must_haves:
  truths:
    - "PICKING tasks auto-complete when linked order has AWB created"
    - "EXPEDIERE tasks auto-complete when linked order AWB status is delivered"
    - "Auto-completion respects grace period (not recently modified)"
    - "Auto-completed tasks have completedAt timestamp set"
  artifacts:
    - path: "src/lib/task-service.ts"
      provides: "Auto-completion detection logic"
      exports: ["autoCompleteTasks"]
    - path: "src/app/api/cron/task-reminders/route.ts"
      provides: "Cron endpoint with auto-completion"
      contains: "autoCompleteTasks"
  key_links:
    - from: "src/app/api/cron/task-reminders/route.ts"
      to: "src/lib/task-service.ts"
      via: "import autoCompleteTasks"
      pattern: "import.*autoCompleteTasks.*task-service"
    - from: "src/lib/task-service.ts"
      to: "prisma.task"
      via: "update for auto-complete"
      pattern: "prisma\\.task\\.update.*status.*COMPLETED"
---

<objective>
Implement auto-completion logic that detects when linked entity state changes indicate task completion.

Purpose: Tasks auto-complete when system detects the underlying action was performed (TASK-09 requirement).
Output: autoCompleteTasks function in task-service.ts, integrated into task-reminders cron.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-task-management-advanced/08-RESEARCH.md

# Existing files to build on
@src/lib/task-service.ts
@src/app/api/cron/task-reminders/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add autoCompleteTasks function to task-service.ts</name>
  <files>src/lib/task-service.ts</files>
  <action>
Add autoCompleteTasks function to src/lib/task-service.ts:

```typescript
/**
 * Auto-complete tasks based on linked entity state changes
 * Called by cron job to detect when underlying actions are completed
 */
export async function autoCompleteTasks(): Promise<{ completed: number; details: string[] }> {
  const GRACE_PERIOD_MS = 5 * 60 * 1000; // 5 minutes - don't auto-complete recently modified tasks
  const gracePeriodCutoff = new Date(Date.now() - GRACE_PERIOD_MS);
  const details: string[] = [];
  let completedCount = 0;

  // Pattern 1: PICKING tasks - auto-complete when linked order has AWB
  // @ts-expect-error - prisma.task exists after prisma generate
  const pickingTasks = await prisma.task.findMany({
    where: {
      type: "PICKING",
      status: "PENDING",
      linkedOrderId: { not: null },
      updatedAt: { lt: gracePeriodCutoff }, // Grace period
    },
    include: {
      linkedOrder: {
        include: { awb: { select: { awbNumber: true } } },
      },
    },
  });

  for (const task of pickingTasks) {
    if (task.linkedOrder?.awb?.awbNumber) {
      // @ts-expect-error - prisma.task exists
      await prisma.task.update({
        where: { id: task.id },
        data: {
          status: "COMPLETED",
          completedAt: new Date(),
          // completedById is null for auto-completion (system)
        },
      });
      completedCount++;
      details.push(`PICKING task "${task.title}" auto-completed (AWB: ${task.linkedOrder.awb.awbNumber})`);
    }
  }

  // Pattern 2: EXPEDIERE tasks - auto-complete when AWB status is delivered
  // @ts-expect-error - prisma.task exists
  const expeditieTasks = await prisma.task.findMany({
    where: {
      type: "EXPEDIERE",
      status: "PENDING",
      linkedOrderId: { not: null },
      updatedAt: { lt: gracePeriodCutoff },
    },
    include: {
      linkedOrder: {
        include: { awb: { select: { awbNumber: true, currentStatus: true } } },
      },
    },
  });

  for (const task of expeditieTasks) {
    const status = task.linkedOrder?.awb?.currentStatus?.toLowerCase() || "";
    if (status.includes("livrat") || status.includes("delivered")) {
      // @ts-expect-error - prisma.task exists
      await prisma.task.update({
        where: { id: task.id },
        data: {
          status: "COMPLETED",
          completedAt: new Date(),
        },
      });
      completedCount++;
      details.push(`EXPEDIERE task "${task.title}" auto-completed (status: ${status})`);
    }
  }

  // Pattern 3: VERIFICARE tasks linked to orders that are now SHIPPED or DELIVERED
  // @ts-expect-error - prisma.task exists
  const verificareTasks = await prisma.task.findMany({
    where: {
      type: "VERIFICARE",
      status: "PENDING",
      linkedOrderId: { not: null },
      updatedAt: { lt: gracePeriodCutoff },
    },
    include: {
      linkedOrder: { select: { id: true, status: true } },
    },
  });

  for (const task of verificareTasks) {
    const orderStatus = task.linkedOrder?.status;
    // If order progressed past the issue, auto-complete the verification task
    if (orderStatus === "SHIPPED" || orderStatus === "DELIVERED" || orderStatus === "INVOICED") {
      // @ts-expect-error - prisma.task exists
      await prisma.task.update({
        where: { id: task.id },
        data: {
          status: "COMPLETED",
          completedAt: new Date(),
        },
      });
      completedCount++;
      details.push(`VERIFICARE task "${task.title}" auto-completed (order status: ${orderStatus})`);
    }
  }

  return { completed: completedCount, details };
}
```

Notes:
- Grace period prevents auto-completing tasks the user is currently editing
- completedById is left null for system auto-completions
- Logs details for debugging
  </action>
  <verify>grep -n "autoCompleteTasks" src/lib/task-service.ts shows the function exists</verify>
  <done>autoCompleteTasks function exists with PICKING, EXPEDIERE, and VERIFICARE patterns</done>
</task>

<task type="auto">
  <name>Task 2: Integrate autoCompleteTasks into task-reminders cron</name>
  <files>src/app/api/cron/task-reminders/route.ts</files>
  <action>
Update src/app/api/cron/task-reminders/route.ts to call autoCompleteTasks:

1. Add import:
```typescript
import { autoCompleteTasks } from "@/lib/task-service";
```

2. Inside the withCronLock callback, after the notification logic, add:
```typescript
// Auto-complete tasks based on linked entity state changes (TASK-09)
const autoCompleteResult = await autoCompleteTasks();
```

3. Update the return statement to include auto-complete stats:
```typescript
return {
  deadlines: {
    checked: upcomingTasks.length,
    notified: notifications.length,
  },
  autoComplete: {
    completed: autoCompleteResult.completed,
    details: autoCompleteResult.details,
  },
};
```

4. Update the final NextResponse to return the combined result.

This makes the task-reminders cron do two things:
1. Send deadline notifications
2. Auto-complete tasks based on linked entity state
  </action>
  <verify>grep -n "autoCompleteTasks" src/app/api/cron/task-reminders/route.ts shows the function is called</verify>
  <done>task-reminders cron calls autoCompleteTasks and returns combined results</done>
</task>

</tasks>

<verification>
1. autoCompleteTasks function exists in task-service.ts
2. Function handles PICKING, EXPEDIERE, VERIFICARE task types
3. Grace period check prevents auto-completing recently modified tasks
4. task-reminders cron imports and calls autoCompleteTasks
5. Cron response includes both deadline and auto-complete stats
</verification>

<success_criteria>
- autoCompleteTasks exported from task-service.ts
- PICKING tasks auto-complete when linkedOrder has awbNumber
- EXPEDIERE tasks auto-complete when AWB status contains "livrat" or "delivered"
- VERIFICARE tasks auto-complete when linked order progresses past error state
- 5-minute grace period prevents auto-completing recently modified tasks
- task-reminders cron integrates auto-completion and returns combined stats
</success_criteria>

<output>
After completion, create `.planning/phases/08-task-management-advanced/08-04-SUMMARY.md`
</output>
