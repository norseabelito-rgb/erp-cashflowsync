---
phase: 08-task-management-advanced
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/task-service.ts
  - src/types/prisma-enums.ts
  - src/lib/notification-utils.ts
autonomous: true

must_haves:
  truths:
    - "Auto-task creation function exists and can create tasks from system events"
    - "Auto-assignment finds users by role and assigns tasks"
    - "Task-related notifications can be created programmatically"
  artifacts:
    - path: "src/lib/task-service.ts"
      provides: "Auto-task creation, auto-assignment, event config"
      exports: ["createAutoTask", "AUTO_TASK_CONFIG", "findUserByRole"]
    - path: "src/lib/notification-utils.ts"
      provides: "Task notification helpers"
      exports: ["createTaskNotification", "createDeadlineReminder"]
    - path: "src/types/prisma-enums.ts"
      provides: "TASK EntityType and task ActionTypes"
      contains: "TASK = \"TASK\""
  key_links:
    - from: "src/lib/task-service.ts"
      to: "prisma.task"
      via: "create call"
      pattern: "prisma\\.task\\.create"
    - from: "src/lib/task-service.ts"
      to: "prisma.notification"
      via: "notification creation"
      pattern: "prisma\\.notification\\.create"
---

<objective>
Create the task service foundation with auto-task creation, auto-assignment by role, and notification utilities.

Purpose: Provides the core infrastructure that all other Phase 8 plans depend on for automated task management.
Output: task-service.ts with AUTO_TASK_CONFIG and createAutoTask(), notification-utils.ts with task notification helpers, updated prisma-enums.ts.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-task-management-advanced/08-RESEARCH.md

# Existing patterns to follow
@src/lib/activity-log.ts
@src/lib/permissions.ts
@src/app/api/tasks/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update prisma-enums.ts with TASK EntityType and ActionTypes</name>
  <files>src/types/prisma-enums.ts</files>
  <action>
Add TASK to the EntityType enum:
```typescript
export enum EntityType {
  // ... existing values ...
  TASK = "TASK",
}
```

Add task-related ActionTypes:
```typescript
export enum ActionType {
  // ... existing values ...
  CREATE_TASK = "CREATE_TASK",
  COMPLETE_TASK = "COMPLETE_TASK",
  ASSIGN_TASK = "ASSIGN_TASK",
  AUTO_COMPLETE_TASK = "AUTO_COMPLETE_TASK",
}
```

These will be used by activity-log.ts for task activity tracking.
  </action>
  <verify>grep -E "TASK|CREATE_TASK|COMPLETE_TASK" src/types/prisma-enums.ts shows the new values</verify>
  <done>EntityType.TASK and task ActionTypes exist in prisma-enums.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create task-service.ts with auto-task creation and assignment</name>
  <files>src/lib/task-service.ts</files>
  <action>
Create src/lib/task-service.ts with:

1. AUTO_TASK_CONFIG record defining configurations per event type:
```typescript
interface AutoTaskConfig {
  taskType: string;
  defaultAssigneeRole: string;
  titleTemplate: string;
  descriptionTemplate?: string;
  defaultPriority: "LOW" | "MEDIUM" | "HIGH" | "URGENT";
  deadlineOffset?: { hours?: number; days?: number };
}

export const AUTO_TASK_CONFIG: Record<string, AutoTaskConfig> = {
  AWB_BATCH_CREATED: {
    taskType: "PICKING",
    defaultAssigneeRole: "Picker",
    titleTemplate: "Picking pentru {awbCount} AWB-uri",
    descriptionTemplate: "Picking list {pickingListCode} generat la {timestamp}",
    defaultPriority: "HIGH",
    deadlineOffset: { hours: 4 },
  },
  ORDER_PROCESSING_ERROR: {
    taskType: "VERIFICARE",
    defaultAssigneeRole: "Manager",
    titleTemplate: "Eroare procesare comanda #{orderNumber}",
    defaultPriority: "URGENT",
  },
  PICKING_LIST_CREATED: {
    taskType: "PICKING",
    defaultAssigneeRole: "Picker",
    titleTemplate: "Picking list {pickingListCode}",
    descriptionTemplate: "{totalItems} produse de preluat",
    defaultPriority: "HIGH",
    deadlineOffset: { hours: 3 },
  },
};
```

2. findUserByRole(roleName: string) function:
- Query prisma.role with name filter
- Include users relation filtered by isActive: true
- Return first active user (fallback logic for no users)

3. createAutoTask(eventType, context, createdByUserId) function:
- Get config from AUTO_TASK_CONFIG
- Call findUserByRole for assignee
- Calculate deadline using deadlineOffset
- Interpolate title/description templates with context values
- Create task via prisma.task.create
- Create notification for assignee (if assigned)
- Return { taskId } or null

4. interpolateTemplate(template, context) helper:
- Replace {key} patterns with context[key] values

Use Romanian text without diacritics for user-facing strings.
Import prisma from @/lib/db.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit src/lib/task-service.ts 2>&1 | head -20</verify>
  <done>task-service.ts exists with AUTO_TASK_CONFIG, findUserByRole, and createAutoTask exported</done>
</task>

<task type="auto">
  <name>Task 3: Create notification-utils.ts with task notification helpers</name>
  <files>src/lib/notification-utils.ts</files>
  <action>
Create src/lib/notification-utils.ts with:

1. createTaskNotification(params) function:
```typescript
interface TaskNotificationParams {
  userId: string;
  type: "task_assigned" | "task_deadline_reminder" | "task_completed";
  taskId: string;
  taskTitle: string;
  message?: string;
}
```
- Create notification via prisma.notification.create
- Set actionUrl to `/tasks?highlight=${taskId}`
- Store taskId in data JSON field

2. createDeadlineReminder(params) function:
```typescript
interface DeadlineReminderParams {
  userId: string;
  taskId: string;
  taskTitle: string;
  deadline: Date;
}
```
- Format deadline using date-fns format()
- Create notification with type "task_deadline_reminder"
- Message: "Task '{taskTitle}' are deadline {formattedDeadline}"

3. createBulkNotifications(notifications) function:
- Accept array of notification params
- Use prisma.notification.createMany for efficiency

Use Romanian text without diacritics.
Import date-fns format function for deadline formatting.
Import prisma from @/lib/db.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit src/lib/notification-utils.ts 2>&1 | head -20</verify>
  <done>notification-utils.ts exists with createTaskNotification, createDeadlineReminder, createBulkNotifications exported</done>
</task>

</tasks>

<verification>
1. All three files exist and export the documented functions
2. TypeScript compiles without errors for all files
3. Imports are correct (prisma, date-fns)
4. AUTO_TASK_CONFIG has at least 3 event types defined
</verification>

<success_criteria>
- task-service.ts exports createAutoTask, AUTO_TASK_CONFIG, findUserByRole
- notification-utils.ts exports createTaskNotification, createDeadlineReminder, createBulkNotifications
- prisma-enums.ts has EntityType.TASK and task-related ActionTypes
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-task-management-advanced/08-01-SUMMARY.md`
</output>
