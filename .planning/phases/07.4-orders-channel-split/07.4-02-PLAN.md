---
phase: 07.4-orders-channel-split
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/orders/processing-errors-panel.tsx
  - src/app/(dashboard)/orders/page.tsx
autonomous: true

must_haves:
  truths:
    - "Error panel shows all channels' errors globally (not filtered by tab)"
    - "Error panel is collapsible"
    - "Each error shows channel badge (Shopify/Trendyol)"
    - "Order rows with errors show inline red badge"
  artifacts:
    - path: "src/components/orders/processing-errors-panel.tsx"
      provides: "Collapsible error panel for processing errors"
      exports: ["ProcessingErrorsPanel"]
    - path: "src/app/(dashboard)/orders/page.tsx"
      provides: "Orders page with error panel integration"
      contains: "ProcessingErrorsPanel"
  key_links:
    - from: "src/components/orders/processing-errors-panel.tsx"
      to: "Collapsible from @radix-ui"
      via: "Accordion or manual collapse state"
      pattern: "useState.*isCollapsed|Collapsible"
---

<objective>
Create a collapsible error panel that shows all processing errors across channels, plus inline error badges on order rows.

Purpose: Help users quickly identify and address processing errors regardless of which channel tab they're viewing.

Output: ProcessingErrorsPanel component with collapse functionality and channel badges on errors.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.4-orders-channel-split/07.4-CONTEXT.md

@src/app/(dashboard)/orders/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProcessingErrorsPanel component</name>
  <files>src/components/orders/processing-errors-panel.tsx</files>
  <action>
Create a new component for displaying processing errors with collapse functionality:

1. Props interface:
```typescript
interface ProcessingErrorsPanelProps {
  errors: ProcessError[];
  dbErrors: DBProcessingError[];
  isLoading: boolean;
  onRetryError: (errorId: string) => void;
  onSkipError: (errorId: string) => void;
  onRetryAll: () => void;
  onClearSessionErrors: () => void;
}
```

2. State:
   - isCollapsed: boolean (default false if errors > 0, true if 0)

3. UI structure:
   - Header bar (always visible):
     - Alert icon + "N erori de procesare" text
     - Channel breakdown: "Shopify: X | Trendyol: Y"
     - Collapse/expand button (ChevronDown/ChevronUp)
     - "Reîncearcă toate" button
     - Clear button (X) for session errors

   - Collapsible content:
     - Two sections: "Erori in sesiune" and "Erori persistente"
     - Each error card shows:
       - Order number with channel badge (Shopify blue, Trendyol orange)
       - Error type (INVOICE or AWB)
       - Error message truncated with tooltip for full
       - Retry and Skip buttons

4. Styling:
   - Container: bg-status-error/5 border border-status-error/20 rounded-lg
   - Header: flex justify-between, padding
   - Error cards: compact, grid layout for multiple
   - Channel badges: Same styling as order table (Shopify default, Trendyol orange-100)

5. Hide completely when no errors (errors.length === 0 && dbErrors.length === 0)

Import icons from lucide-react: AlertTriangle, ChevronDown, ChevronUp, RefreshCw, X
  </action>
  <verify>
File exists at src/components/orders/processing-errors-panel.tsx with:
- ProcessingErrorsPanel export
- isCollapsed state
- Channel badge rendering
- Collapse/expand functionality
  </verify>
  <done>
ProcessingErrorsPanel component renders collapsible error list with channel badges and action buttons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate error panel and add inline error badges to order rows</name>
  <files>src/app/(dashboard)/orders/page.tsx</files>
  <action>
Update orders page to use the new error panel and add inline error indicators:

1. Replace existing error display code:
   - Remove the inline error alert div (processErrors.length > 0 block)
   - Import and add ProcessingErrorsPanel above the tabs
   - Pass processErrors, dbErrors, handlers to the panel
   - Panel always shows ALL errors (not filtered by current tab)

2. Add inline error badges to order table rows:
   - In the order row mapping, check if order has processing error
   - Add condition:
     ```typescript
     const hasError = processErrors.some(e => e.orderId === order.id) ||
                      dbErrors.some(e => e.orderId === order.id && e.status !== 'RESOLVED' && e.status !== 'SKIPPED');
     ```
   - If hasError, show small red dot/badge in the "Status" or "Acțiuni" column
   - Use: `<span className="absolute -top-1 -right-1 h-2 w-2 bg-red-500 rounded-full" />`

3. Update error grouping for panel:
   - Count errors by source:
     ```typescript
     const errorsBySource = {
       shopify: [...processErrors, ...dbErrors].filter(e => {
         const order = orders.find(o => o.id === e.orderId);
         return order?.source === 'shopify';
       }).length,
       trendyol: [...processErrors, ...dbErrors].filter(e => {
         const order = orders.find(o => o.id === e.orderId);
         return order?.source === 'trendyol';
       }).length,
     };
     ```
   - Pass to ProcessingErrorsPanel

4. Connect the dbErrors query to always run (currently only runs when errors tab active):
   - Change `enabled: activeTab === "errors"` to `enabled: true` for the processing-errors query
   - Or keep separate and always fetch minimal count

5. Position the panel:
   - Place between PageHeader and filter Card
   - Use margin-bottom for spacing
  </action>
  <verify>
1. Create an order with a processing error (or mock one)
2. Verify error panel shows above filters
3. Collapse/expand works
4. Channel breakdown shows correct counts
5. Order row with error has visual indicator (red dot)
6. Panel shows errors from ALL channels regardless of active tab
  </verify>
  <done>
Orders page shows collapsible error panel with channel breakdown, and order rows with errors have inline visual indicators.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` - No TypeScript errors
2. Manual test: Verify error panel shows when errors exist
3. Manual test: Collapse/expand functionality works
4. Manual test: Channel badges display correctly
5. Manual test: Inline error indicator visible on affected order rows
6. Manual test: Error panel persists when switching tabs
</verification>

<success_criteria>
- Collapsible error panel shows above the order filters
- Panel displays channel breakdown (Shopify: X | Trendyol: Y)
- Each error card shows channel badge
- Order rows with errors have inline red indicator
- Error panel shows ALL errors regardless of active tab
- Panel auto-collapses when all errors resolved
</success_criteria>

<output>
After completion, create `.planning/phases/07.4-orders-channel-split/07.4-02-SUMMARY.md`
</output>
