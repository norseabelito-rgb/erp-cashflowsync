---
phase: 07.4-orders-channel-split
plan: 04
subsystem: api
tags: [shopify, draft-order, manual-order, api, next-auth]

# Dependency graph
requires:
  - phase: 07.4-01
    provides: Channel tabs with source filtering for order display
  - phase: 07.4-03
    provides: ManualOrderDialog UI that calls this API
provides:
  - POST /api/orders/manual endpoint for manual order creation
  - ShopifyClient.createDraftOrder method
  - ShopifyClient.completeDraftOrder method
  - CreateDraftOrderInput interface exported for reuse
affects: [07.4-06, orders-processing, shopify-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Shopify draft order workflow (create then complete)
    - Custom line items without inventory linkage
    - Romanian error messages for API responses

key-files:
  created:
    - src/app/api/orders/manual/route.ts
  modified:
    - src/lib/shopify.ts

key-decisions:
  - "Use custom line items (title/price) instead of variant_id lookup - avoids SKU resolution complexity"
  - "Draft order created then completed - ensures Shopify success before local DB save"
  - "Manual entry assumed validated (phoneValidation/addressValidation = PASSED)"
  - "source='manual' distinguishes from shopify/trendyol orders"
  - "Tags 'manual-erp', 'creat-din-erp' help identify ERP-created orders in Shopify admin"

patterns-established:
  - "Shopify-first pattern: External API success required before local DB write"
  - "Draft order workflow: Create draft -> Complete draft -> Save locally"

# Metrics
duration: 3min
completed: 2026-02-03
---

# Phase 07.4 Plan 04: Manual Order Shopify Push API Summary

**Shopify draft order API integration with create/complete workflow for manual orders, saving to local DB with source='manual' only after Shopify success**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-03T00:35:32Z
- **Completed:** 2026-02-03T00:37:52Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- Extended ShopifyClient with createDraftOrder and completeDraftOrder methods
- Created /api/orders/manual endpoint with full validation and error handling
- Ensured data consistency: local order created only after Shopify success
- All error messages in Romanian for user-facing responses

## Task Commits

Each task was committed atomically:

1. **Task 1: Add createDraftOrder and completeDraftOrder methods to ShopifyClient** - `6d6b24f` (feat)
2. **Task 2: Create /api/orders/manual endpoint** - `b9baeab` (feat)

## Files Created/Modified
- `src/lib/shopify.ts` - Added CreateDraftOrderInput interface, createDraftOrder and completeDraftOrder methods
- `src/app/api/orders/manual/route.ts` - New POST endpoint for manual order creation

## Decisions Made
- **Custom line items without variant_id:** Using Shopify's custom line item feature (title + price) instead of resolving SKU to variant_id. This avoids additional API calls to Shopify's product catalog and is acceptable for manual orders where inventory tracking is handled separately.
- **Draft order workflow:** Create draft first, then complete it. This ensures the Shopify order exists before we save to local DB. If draft creation fails, no local order is created. If completion fails, the draft can be handled manually.
- **Validation assumed passed:** Manual entries set phoneValidation and addressValidation to PASSED since the operator enters data directly (assumed correct).
- **Tags for identification:** Orders tagged with 'manual-erp' and 'creat-din-erp' for easy identification in Shopify admin.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing TypeScript errors in codebase (Prisma client out of sync) - not related to this plan's changes

## Next Phase Readiness
- Manual order creation API ready for use by ManualOrderDialog (Plan 03)
- Ready for Phase 07.4-06 gap closure testing
- Orders created via this API visible with source="manual" badge

---
*Phase: 07.4-orders-channel-split*
*Completed: 2026-02-03*
