---
phase: 07.4-orders-channel-split
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/orders/page.tsx
  - src/components/orders/channel-tabs.tsx
  - src/app/api/orders/route.ts
autonomous: true

must_haves:
  truths:
    - "Shopify tab shows only orders where source='shopify'"
    - "Trendyol tab shows only orders where source='trendyol'"
    - "Tab state persists in URL via ?tab= parameter"
    - "Switching tabs resets page to 1"
    - "Count badges show total orders per channel"
    - "Store dropdown filters to channel-relevant stores only"
  artifacts:
    - path: "src/components/orders/channel-tabs.tsx"
      provides: "ChannelTabs component with count badges"
      exports: ["ChannelTabs"]
    - path: "src/app/(dashboard)/orders/page.tsx"
      provides: "Orders page with tab-based channel filtering"
      contains: "ChannelTabs"
    - path: "src/app/api/orders/route.ts"
      provides: "Orders API with source counts"
      contains: "sourceCounts"
  key_links:
    - from: "src/components/orders/channel-tabs.tsx"
      to: "useSearchParams"
      via: "URL state persistence"
      pattern: "searchParams.*tab"
    - from: "src/app/(dashboard)/orders/page.tsx"
      to: "/api/orders"
      via: "React Query with source filter"
      pattern: "params.set.*source"
---

<objective>
Create a tab navigation system that splits the Orders page by sales channel (Shopify/Trendyol/Temu).

Purpose: Allow users to focus on orders from a specific channel, reducing error risk from mixing orders.

Output: ChannelTabs component with count badges, URL-persisted tab state, and source-filtered order queries.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.4-orders-channel-split/07.4-CONTEXT.md

@src/app/(dashboard)/orders/page.tsx
@src/app/api/orders/route.ts
@src/components/ui/tabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChannelTabs component with count badges</name>
  <files>src/components/orders/channel-tabs.tsx</files>
  <action>
Create a new ChannelTabs component that:

1. Accepts props:
   - `activeTab`: "shopify" | "trendyol" | "temu" (default: "shopify")
   - `counts`: { shopify: number; trendyol: number; temu: number }
   - `onTabChange`: (tab: string) => void

2. Uses the existing Tabs/TabsList/TabsTrigger from @/components/ui/tabs

3. Shows three tabs:
   - "Shopify" with count badge (e.g., "Shopify (24)")
   - "Trendyol" with count badge in orange styling
   - "Temu" with count badge (grayed out for placeholder)

4. Count badges use Badge component from @/components/ui/badge:
   - Shopify: default variant
   - Trendyol: secondary variant with orange-100 bg
   - Temu: neutral variant (disabled look)

5. Tab triggers have hover states and accessible focus rings

Export the component for use in orders page.
  </action>
  <verify>
File exists at src/components/orders/channel-tabs.tsx with:
- ChannelTabs export
- Tabs import from @/components/ui/tabs
- Badge import from @/components/ui/badge
- Props interface with activeTab, counts, onTabChange
  </verify>
  <done>
ChannelTabs component renders three tabs with count badges, styled appropriately per channel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update orders API to return source counts</name>
  <files>src/app/api/orders/route.ts</files>
  <action>
Modify the GET endpoint to also return order counts by source:

1. Add a parallel query to count orders by source (alongside the existing count/findMany):
```typescript
const sourceCounts = await prisma.order.groupBy({
  by: ['source'],
  _count: { _all: true },
  where: {
    // Apply same date/store filters but NOT source filter
    ...(startDate || endDate ? { createdAt: { ... } } : {}),
    ...(storeId && storeId !== "all" ? { storeId } : {}),
  }
});
```

2. Transform into object: { shopify: N, trendyol: M, temu: 0 }

3. Add to response:
```typescript
return NextResponse.json({
  orders,
  pagination: { ... },
  sourceCounts: {
    shopify: counts.find(c => c.source === 'shopify')?._count._all || 0,
    trendyol: counts.find(c => c.source === 'trendyol')?._count._all || 0,
    temu: 0, // Placeholder - no Temu orders yet
  }
});
```

Note: The sourceCounts should NOT be filtered by the source parameter (we need all channels' counts for the tabs).
  </action>
  <verify>
Test API response includes sourceCounts object:
```bash
curl -s "localhost:3000/api/orders?limit=1" | jq '.sourceCounts'
# Should return: { "shopify": N, "trendyol": M, "temu": 0 }
```
  </verify>
  <done>
API returns sourceCounts alongside orders and pagination, with counts unaffected by source filter.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ChannelTabs and update orders page filtering</name>
  <files>src/app/(dashboard)/orders/page.tsx</files>
  <action>
Update the Orders page to use tab-based channel filtering:

1. Replace existing sourceFilter dropdown with ChannelTabs:
   - Import ChannelTabs from @/components/orders/channel-tabs
   - Remove the source Select dropdown from filter bar
   - Add ChannelTabs above the filter card

2. Manage tab state via URL:
   - Use useSearchParams to read initial tab from URL (?tab=shopify)
   - Default to "shopify" if no tab parameter
   - On tab change, update URL via router.push() or setSearchParams

3. Update React Query to use tab as source filter:
   - Change sourceFilter state to be derived from URL tab parameter
   - Ensure page resets to 1 when tab changes

4. Pass sourceCounts from API response to ChannelTabs:
   - Extract sourceCounts from ordersData
   - Pass to ChannelTabs counts prop

5. Update store filter behavior:
   - When tab is "shopify", only show stores that are NOT from Trendyol (regular stores)
   - When tab is "trendyol", show TrendyolStores (need new query or filter)
   - When tab is "temu", show "All stores" only (placeholder)
   - Auto-clear store filter to "all" if current store doesn't match channel on tab switch

6. Remove the existing "Sursa" dropdown entirely (tabs replace it)

Key changes to state management:
```typescript
// Read tab from URL
const searchParams = useSearchParams();
const router = useRouter();
const activeTab = searchParams.get('tab') || 'shopify';

// Tab change handler
const handleTabChange = (tab: string) => {
  const params = new URLSearchParams(searchParams);
  params.set('tab', tab);
  params.delete('page'); // Reset to page 1
  // Check if current store is valid for new tab, clear if not
  router.push(`/orders?${params.toString()}`);
};

// Use activeTab instead of sourceFilter in query
queryKey: ["orders", statusFilter, storeFilter, activeTab, ...]
// In queryFn: params.set("source", activeTab === "temu" ? "__none__" : activeTab)
```
  </action>
  <verify>
1. Navigate to /orders - Shopify tab is active by default
2. Click Trendyol tab - URL updates to ?tab=trendyol, only Trendyol orders shown
3. Refresh page - tab state persists
4. Switch tabs - page resets to 1
5. Count badges show correct numbers for each channel
  </verify>
  <done>
Orders page uses ChannelTabs for channel filtering with URL persistence, source counts displayed as badges, and channel-appropriate store filtering.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` - No TypeScript errors
2. Manual test: Visit /orders, verify tabs render with counts
3. Manual test: Click each tab, verify URL changes and orders filter correctly
4. Manual test: Verify store dropdown shows appropriate stores per tab
5. Check: Refresh page on different tab - state persists
</verification>

<success_criteria>
- Three tabs visible at top of orders page: Shopify, Trendyol, Temu
- Each tab shows count badge with current filter's order count
- Clicking tab updates URL and filters orders to that source
- Store dropdown filters to channel-relevant stores
- Tab state persists on page refresh
- Temu tab shows 0 count (placeholder ready for future)
</success_criteria>

<output>
After completion, create `.planning/phases/07.4-orders-channel-split/07.4-01-SUMMARY.md`
</output>
