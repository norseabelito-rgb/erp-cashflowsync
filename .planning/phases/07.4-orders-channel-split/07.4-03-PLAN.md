---
phase: 07.4-orders-channel-split
plan: 03
type: execute
wave: 2
depends_on:
  - "07.4-01"
files_modified:
  - src/components/orders/manual-order-dialog.tsx
  - src/app/(dashboard)/orders/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dialog opens from 'Creare comanda' button on Shopify tab"
    - "Store selector shows only Shopify stores"
    - "Product search finds MasterProducts by SKU or name"
    - "Price auto-fills from MasterProduct.price (not editable)"
    - "Full customer address required for validation"
    - "Form validates before submit enabled"
  artifacts:
    - path: "src/components/orders/manual-order-dialog.tsx"
      provides: "Manual order creation dialog with product search"
      exports: ["ManualOrderDialog"]
    - path: "src/app/(dashboard)/orders/page.tsx"
      provides: "Orders page with manual order creation button"
      contains: "Creare comanda"
  key_links:
    - from: "src/components/orders/manual-order-dialog.tsx"
      to: "/api/products"
      via: "debounced search query"
      pattern: "fetch.*api/products.*search"
    - from: "src/components/orders/manual-order-dialog.tsx"
      to: "ManualOrderDialog submit"
      via: "form data passed to parent"
      pattern: "onSubmit|onCreate"
---

<objective>
Create a manual order creation dialog with product search, customer details, and validation.

Purpose: Allow operators to create orders manually for phone/offline sales that need to flow through the same invoice/AWB process as Shopify orders.

Output: ManualOrderDialog component with store selection, product search, customer form, and validation.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.4-orders-channel-split/07.4-CONTEXT.md

@src/app/(dashboard)/orders/page.tsx
@src/app/api/products/route.ts
@prisma/schema.prisma (MasterProduct model)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ManualOrderDialog component</name>
  <files>src/components/orders/manual-order-dialog.tsx</files>
  <action>
Create a comprehensive manual order creation dialog:

1. Props interface:
```typescript
interface ManualOrderDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  stores: Array<{ id: string; name: string }>;
  onCreateOrder: (data: ManualOrderData) => void;
  isCreating: boolean;
}

interface ManualOrderData {
  storeId: string;
  customerFirstName: string;
  customerLastName: string;
  customerEmail: string;
  customerPhone: string;
  shippingAddress1: string;
  shippingAddress2?: string;
  shippingCity: string;
  shippingProvince: string;
  shippingZip: string;
  lineItems: Array<{
    productId: string;
    sku: string;
    title: string;
    quantity: number;
    price: number;
  }>;
  note?: string;
}
```

2. Form state management:
   - Use React useState for form fields
   - Track validation errors per field
   - Track selected products list

3. Store selector:
   - Select dropdown at top
   - Required field
   - Label: "Magazin Shopify"

4. Product search section:
   - Search input with debounce (300ms)
   - Query /api/products?search=... on type
   - Show dropdown with results: SKU - Title (Pret: X RON)
   - On select, add to lineItems with quantity 1
   - Show selected products in table below:
     | SKU | Produs | Cantitate [+/-] | Pret (RON) | [X] |
   - Price comes from MasterProduct.price (readonly display)
   - Quantity editable with +/- buttons or input

5. Customer details section (all required):
   - First Name, Last Name (row)
   - Email, Phone (row)
   - Address 1 (full width)
   - Address 2 (optional)
   - City, Province (Judet), Zip (row)

6. Note section:
   - Textarea for order notes (optional)

7. Totals display:
   - Show subtotal calculated from lineItems
   - "Total: X RON"

8. Footer:
   - Cancel button
   - "Creare comanda" button (disabled until valid)

9. Validation:
   - All customer fields except address2 required
   - At least 1 product required
   - Store required
   - Phone: Romanian format validation (10 digits, starts with 0)
   - Email: basic email format

Use Dialog/DialogContent from @/components/ui/dialog
Use Input, Select, Button, Label from @/components/ui
Use useDebouncedValue or manual setTimeout for search debounce
  </action>
  <verify>
File exists at src/components/orders/manual-order-dialog.tsx with:
- ManualOrderDialog export
- ManualOrderData type export
- Product search functionality
- Customer form fields
- Validation logic
  </verify>
  <done>
ManualOrderDialog component provides full order creation form with product search, customer details, and validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate dialog into orders page with Shopify tab button</name>
  <files>src/app/(dashboard)/orders/page.tsx</files>
  <action>
Add the manual order creation dialog and trigger button:

1. Import ManualOrderDialog:
```typescript
import { ManualOrderDialog, ManualOrderData } from "@/components/orders/manual-order-dialog";
```

2. Add state for dialog:
```typescript
const [manualOrderDialogOpen, setManualOrderDialogOpen] = useState(false);
```

3. Add "Creare comanda" button:
   - Only visible when activeTab === "shopify"
   - Place in the PageHeader actions or in action bar above table
   - Icon: Plus or ShoppingCart
   - Text: "Creare comanda"
   - Wrapped in RequirePermission for orders.create

```tsx
{activeTab === 'shopify' && (
  <RequirePermission permission="orders.create">
    <Button onClick={() => setManualOrderDialogOpen(true)}>
      <Plus className="h-4 w-4 mr-2" />
      Creare comanda
    </Button>
  </RequirePermission>
)}
```

4. Filter stores for dialog:
   - Pass only Shopify stores (not TrendyolStores)
   - Current stores from storesData are all Shopify stores (no filtering needed)

5. Add placeholder mutation for order creation:
```typescript
const createManualOrderMutation = useMutation({
  mutationFn: async (data: ManualOrderData) => {
    const res = await fetch("/api/orders/manual", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    return res.json();
  },
  onSuccess: (data) => {
    if (data.success) {
      toast({ title: "Comanda creata", description: `Comanda #${data.orderNumber} a fost creata` });
      setManualOrderDialogOpen(false);
      queryClient.invalidateQueries({ queryKey: ["orders"] });
    } else {
      toast({ title: "Eroare", description: data.error, variant: "destructive" });
    }
  },
  onError: (error: any) => {
    toast({ title: "Eroare", description: error.message, variant: "destructive" });
  },
});
```

6. Render dialog:
```tsx
<ManualOrderDialog
  open={manualOrderDialogOpen}
  onOpenChange={setManualOrderDialogOpen}
  stores={stores}
  onCreateOrder={(data) => createManualOrderMutation.mutate(data)}
  isCreating={createManualOrderMutation.isPending}
/>
```

Note: The API endpoint /api/orders/manual will be created in Plan 04. This plan just sets up the UI.
  </action>
  <verify>
1. Navigate to /orders?tab=shopify
2. "Creare comanda" button visible
3. Click button, dialog opens
4. Search for product, add to list
5. Fill customer details
6. Form validates (submit disabled until valid)
7. Switch to Trendyol tab - button not visible
  </verify>
  <done>
Orders page has "Creare comanda" button on Shopify tab that opens ManualOrderDialog, with mutation ready to call API.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` - No TypeScript errors
2. Manual test: Button appears only on Shopify tab
3. Manual test: Dialog opens with all form fields
4. Manual test: Product search works (queries /api/products)
5. Manual test: Adding/removing products works
6. Manual test: Validation prevents submit until form is complete
7. Manual test: Dialog closes on cancel
</verification>

<success_criteria>
- "Creare comanda" button visible only on Shopify tab
- Dialog has store selector, product search, customer form
- Product search queries MasterProducts by SKU/name
- Price displays from MasterProduct (readonly)
- All required fields validate before submit enabled
- Form data passed to onCreateOrder callback
</success_criteria>

<output>
After completion, create `.planning/phases/07.4-orders-channel-split/07.4-03-SUMMARY.md`
</output>
