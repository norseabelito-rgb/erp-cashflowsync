---
phase: 07.4-orders-channel-split
plan: 04
type: execute
wave: 2
depends_on:
  - "07.4-01"
  - "07.4-03"
files_modified:
  - src/app/api/orders/manual/route.ts
  - src/lib/shopify.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/orders/manual creates draft order in Shopify, then completes it"
    - "Order saved to local DB with source='manual' only after Shopify success"
    - "Shopify order number linked to local order"
    - "Error returns Romanian message without creating partial data"
    - "Line items use custom line items with title/price (no variant_id lookup - inventory not linked)"
  artifacts:
    - path: "src/app/api/orders/manual/route.ts"
      provides: "API endpoint for manual order creation"
      exports: ["POST"]
    - path: "src/lib/shopify.ts"
      provides: "Shopify client with createDraftOrder method"
      contains: "createDraftOrder"
  key_links:
    - from: "src/app/api/orders/manual/route.ts"
      to: "ShopifyClient.createDraftOrder"
      via: "create then complete draft"
      pattern: "createDraftOrder|completeDraftOrder"
    - from: "src/app/api/orders/manual/route.ts"
      to: "prisma.order.create"
      via: "save after Shopify success"
      pattern: "prisma.order.create"
---

<objective>
Create the API endpoint for manual order creation that pushes to Shopify first, then saves locally.

Purpose: Ensure manual orders are created in Shopify (source of truth) before saving to local database, maintaining data consistency.

Output: /api/orders/manual endpoint with Shopify draft order creation and local database save.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.4-orders-channel-split/07.4-CONTEXT.md

@src/lib/shopify.ts
@src/app/api/orders/route.ts
@prisma/schema.prisma (Order model)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createDraftOrder and completeDraftOrder methods to ShopifyClient</name>
  <files>src/lib/shopify.ts</files>
  <action>
Extend the ShopifyClient class with methods for creating draft orders:

1. Add interface for draft order input:
```typescript
interface CreateDraftOrderInput {
  lineItems: Array<{
    sku: string;         // SKU for reference (included in Shopify line item but not for inventory)
    title: string;       // Product title displayed on order
    quantity: number;
    price: string;       // Price as string (Shopify format, e.g., "99.00")
  }>;
  customer: {
    firstName: string;
    lastName: string;
    email: string;
    phone?: string;
  };
  shippingAddress: {
    firstName: string;
    lastName: string;
    address1: string;
    address2?: string;
    city: string;
    province: string;
    country: string;
    zip: string;
    phone?: string;
  };
  note?: string;
  tags?: string[];
}
```

2. Add createDraftOrder method:

**Design decision:** Use Shopify custom line items (title + price) instead of variant_id lookup.
- Custom line items do NOT link to Shopify inventory
- This is acceptable because manual orders are for phone/offline sales where inventory tracking is handled separately
- Avoids complexity of SKU -> variant_id resolution (would require product API queries)
- Order still appears in Shopify admin with correct totals for reporting

```typescript
async createDraftOrder(input: CreateDraftOrderInput): Promise<{
  id: number;
  name: string;
  invoiceUrl: string;
  lineItems: Array<{ id: number; title: string; quantity: number; price: string }>;
}> {
  // Use custom line items with title/price (no variant_id lookup)
  const lineItems = input.lineItems.map((item) => ({
    title: item.title,
    quantity: item.quantity,
    price: item.price,
    sku: item.sku, // Include SKU for reference but not for inventory linkage
  }));

  const response = await this.client.post<{ draft_order: any }>("/draft_orders.json", {
    draft_order: {
      line_items: lineItems,
      customer: {
        first_name: input.customer.firstName,
        last_name: input.customer.lastName,
        email: input.customer.email,
        phone: input.customer.phone,
      },
      shipping_address: {
        first_name: input.shippingAddress.firstName,
        last_name: input.shippingAddress.lastName,
        address1: input.shippingAddress.address1,
        address2: input.shippingAddress.address2 || "",
        city: input.shippingAddress.city,
        province: input.shippingAddress.province,
        country: input.shippingAddress.country || "Romania",
        zip: input.shippingAddress.zip,
        phone: input.shippingAddress.phone,
      },
      note: input.note,
      tags: input.tags?.join(", ") || "manual-erp",
    },
  });

  return {
    id: response.data.draft_order.id,
    name: response.data.draft_order.name,
    invoiceUrl: response.data.draft_order.invoice_url,
    lineItems: response.data.draft_order.line_items.map((li: any) => ({
      id: li.id,
      title: li.title,
      quantity: li.quantity,
      price: li.price,
    })),
  };
}
```

3. Add completeDraftOrder method (converts draft to real order):
```typescript
async completeDraftOrder(draftOrderId: number, paymentPending: boolean = true): Promise<{
  id: number;
  order_number: number;
  name: string;
  totalPrice: string;
}> {
  const response = await this.client.put<{ draft_order: any }>(
    `/draft_orders/${draftOrderId}/complete.json`,
    { payment_pending: paymentPending }
  );

  const order = response.data.draft_order.order;
  return {
    id: order.id,
    order_number: order.order_number,
    name: order.name,
    totalPrice: order.total_price,
  };
}
```

Export CreateDraftOrderInput type for use in API route.
  </action>
  <verify>
File src/lib/shopify.ts contains:
- CreateDraftOrderInput interface
- createDraftOrder method
- completeDraftOrder method
No TypeScript errors on build.
  </verify>
  <done>
ShopifyClient extended with createDraftOrder and completeDraftOrder methods for manual order creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /api/orders/manual endpoint</name>
  <files>src/app/api/orders/manual/route.ts</files>
  <action>
Create the API endpoint for manual order creation:

1. Request validation:
```typescript
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import prisma from "@/lib/db";
import { hasPermission } from "@/lib/permissions";
import { ShopifyClient } from "@/lib/shopify";

interface ManualOrderRequest {
  storeId: string;
  customerFirstName: string;
  customerLastName: string;
  customerEmail: string;
  customerPhone: string;
  shippingAddress1: string;
  shippingAddress2?: string;
  shippingCity: string;
  shippingProvince: string;
  shippingZip: string;
  lineItems: Array<{
    productId: string;
    sku: string;
    title: string;
    quantity: number;
    price: number;
  }>;
  note?: string;
}
```

2. POST handler:
```typescript
export async function POST(request: NextRequest) {
  try {
    // Auth check
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: "Trebuie sa fii autentificat" }, { status: 401 });
    }

    // Permission check
    const canCreate = await hasPermission(session.user.id, "orders.create");
    if (!canCreate) {
      return NextResponse.json({ error: "Nu ai permisiunea de a crea comenzi" }, { status: 403 });
    }

    const body: ManualOrderRequest = await request.json();

    // Validate required fields
    if (!body.storeId || !body.customerFirstName || !body.customerLastName ||
        !body.customerEmail || !body.customerPhone || !body.shippingAddress1 ||
        !body.shippingCity || !body.shippingProvince || !body.shippingZip ||
        !body.lineItems || body.lineItems.length === 0) {
      return NextResponse.json({ error: "Toate campurile obligatorii trebuie completate" }, { status: 400 });
    }

    // Get store with credentials
    const store = await prisma.store.findUnique({
      where: { id: body.storeId },
      select: { id: true, shopifyDomain: true, accessToken: true, companyId: true }
    });

    if (!store || !store.accessToken) {
      return NextResponse.json({ error: "Magazinul nu are credentiale Shopify configurate" }, { status: 400 });
    }

    // Create Shopify client
    const shopify = new ShopifyClient(store.shopifyDomain, store.accessToken, store.id);

    // Calculate total
    const totalPrice = body.lineItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    // Create draft order in Shopify
    const draftOrder = await shopify.createDraftOrder({
      lineItems: body.lineItems.map(item => ({
        title: item.title,
        quantity: item.quantity,
        price: item.price.toFixed(2),
        sku: item.sku,
      })),
      customer: {
        firstName: body.customerFirstName,
        lastName: body.customerLastName,
        email: body.customerEmail,
        phone: body.customerPhone,
      },
      shippingAddress: {
        firstName: body.customerFirstName,
        lastName: body.customerLastName,
        address1: body.shippingAddress1,
        address2: body.shippingAddress2,
        city: body.shippingCity,
        province: body.shippingProvince,
        country: "Romania",
        zip: body.shippingZip,
        phone: body.customerPhone,
      },
      note: body.note,
      tags: ["manual-erp", "creat-din-erp"],
    });

    // Complete draft order (convert to real order)
    const shopifyOrder = await shopify.completeDraftOrder(draftOrder.id, true);

    // Save to local database
    const localOrder = await prisma.order.create({
      data: {
        shopifyOrderId: String(shopifyOrder.id),
        shopifyOrderNumber: shopifyOrder.name, // e.g., "#1234"
        source: "manual",
        storeId: body.storeId,
        customerEmail: body.customerEmail,
        customerPhone: body.customerPhone,
        customerFirstName: body.customerFirstName,
        customerLastName: body.customerLastName,
        shippingAddress1: body.shippingAddress1,
        shippingAddress2: body.shippingAddress2,
        shippingCity: body.shippingCity,
        shippingProvince: body.shippingProvince,
        shippingZip: body.shippingZip,
        totalPrice: totalPrice.toFixed(2),
        currency: "RON",
        status: "PENDING",
        phoneValidation: "PASSED", // Manual entry assumed validated
        addressValidation: "PASSED",
        lineItems: {
          create: body.lineItems.map((item, idx) => ({
            shopifyLineItemId: String(idx), // Placeholder
            title: item.title,
            sku: item.sku,
            quantity: item.quantity,
            price: item.price.toFixed(2),
            variantTitle: null,
          })),
        },
      },
      include: {
        store: { select: { name: true } },
        lineItems: true,
      },
    });

    return NextResponse.json({
      success: true,
      order: localOrder,
      orderNumber: shopifyOrder.name,
      shopifyOrderId: shopifyOrder.id,
    });

  } catch (error: any) {
    console.error("[Manual Order] Error:", error);

    // Shopify API errors
    if (error.response?.data?.errors) {
      const shopifyError = JSON.stringify(error.response.data.errors);
      return NextResponse.json({
        success: false,
        error: `Eroare Shopify: ${shopifyError}`,
      }, { status: 400 });
    }

    return NextResponse.json({
      success: false,
      error: error.message || "Eroare la crearea comenzii",
    }, { status: 500 });
  }
}
```

Key behaviors:
- First create draft in Shopify (rollback-safe)
- Complete draft to real order
- Only then save to local DB
- If Shopify fails, no local order created
- source field set to "manual"
- Tags help identify ERP-created orders in Shopify
  </action>
  <verify>
1. File exists at src/app/api/orders/manual/route.ts
2. `npm run build` passes
3. Test with curl (requires valid store):
```bash
curl -X POST http://localhost:3000/api/orders/manual \
  -H "Content-Type: application/json" \
  -d '{"storeId":"...","customerFirstName":"Test",...}'
```
  </verify>
  <done>
API endpoint creates order in Shopify first, then saves locally with source="manual", ensuring data consistency.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` - No TypeScript errors
2. Manual test: Create order via dialog (from Plan 03)
3. Verify: Order appears in Shopify admin
4. Verify: Order appears in local orders list with "manual" source badge
5. Verify: Line items correct in both Shopify and local
6. Error test: Invalid store shows Romanian error
7. Error test: Shopify API error returns without creating local order
</verification>

<success_criteria>
- POST /api/orders/manual creates draft order in Shopify, then completes it
- Local order saved with source="manual" only after Shopify success
- Shopify order number linked correctly to local order
- Error handling prevents partial data (no local order if Shopify fails)
- Line items use custom line items (title/price) without inventory linkage
- Manual orders visible in Shopify admin with "manual-erp" tag
</success_criteria>

<output>
After completion, create `.planning/phases/07.4-orders-channel-split/07.4-04-SUMMARY.md`
</output>
