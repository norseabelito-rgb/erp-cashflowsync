---
phase: 07.6-customers-page
plan: 03
type: execute
wave: 3
depends_on: ["07.6-01", "07.6-02"]
files_modified:
  - src/components/customers/customer-detail-modal.tsx
  - src/app/(dashboard)/customers/page.tsx
autonomous: false

must_haves:
  truths:
    - "Clicking customer row opens detail modal"
    - "Modal shows customer info, contact, address"
    - "Modal shows analytics: total spent, order count, average order value"
    - "Modal shows most ordered products"
    - "Modal shows complete order history with status and dates"
  artifacts:
    - path: "src/components/customers/customer-detail-modal.tsx"
      provides: "Customer detail modal component"
      min_lines: 150
  key_links:
    - from: "src/components/customers/customer-detail-modal.tsx"
      to: "/api/customers/[email]"
      via: "useQuery fetch on modal open"
      pattern: "fetch.*api/customers"
    - from: "src/app/(dashboard)/customers/page.tsx"
      to: "CustomerDetailModal"
      via: "component import and render"
      pattern: "CustomerDetailModal"
---

<objective>
Create Customer Detail Modal with order history, purchase analytics, and most ordered products.

Purpose: Allow users to view comprehensive customer information including all orders and purchase patterns.
Output: CustomerDetailModal component integrated into customers page, showing full customer details when row clicked.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.6-customers-page/07.6-RESEARCH.md
@.planning/phases/07.6-customers-page/07.6-01-SUMMARY.md
@.planning/phases/07.6-customers-page/07.6-02-SUMMARY.md

# Existing patterns
@src/components/ui/dialog.tsx
@src/app/(dashboard)/orders/page.tsx (view modal pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CustomerDetailModal component</name>
  <files>src/components/customers/customer-detail-modal.tsx</files>
  <action>
Create CustomerDetailModal component following the Orders page view modal pattern.

**Directory:** Create src/components/customers/ directory if it doesn't exist.

**Component structure:**

```typescript
"use client";

import { useQuery } from "@tanstack/react-query";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import {
  Users,
  Mail,
  Phone,
  MapPin,
  ShoppingCart,
  DollarSign,
  Package,
  Calendar,
  TrendingUp,
  ExternalLink,
} from "lucide-react";
import { formatCurrency, formatDate, cn } from "@/lib/utils";
import Link from "next/link";

interface CustomerDetailModalProps {
  customer: {
    email: string;
    firstName: string | null;
    lastName: string | null;
  } | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
  storeId?: string;
}

// Status badge mapping (from Orders page)
const statusConfig: Record<string, { label: string; variant: "default" | "success" | "warning" | "destructive" | "info" | "neutral" }> = {
  PENDING: { label: "In asteptare", variant: "warning" },
  VALIDATED: { label: "Validat", variant: "info" },
  VALIDATION_FAILED: { label: "Validare esuata", variant: "destructive" },
  INVOICED: { label: "Facturat", variant: "success" },
  SHIPPED: { label: "Expediat", variant: "info" },
  DELIVERED: { label: "Livrat", variant: "success" },
  RETURNED: { label: "Returnat", variant: "destructive" },
  CANCELLED: { label: "Anulat", variant: "neutral" },
};

export function CustomerDetailModal({
  customer,
  open,
  onOpenChange,
  storeId,
}: CustomerDetailModalProps) {
  // Fetch full details only when modal is open
  const { data, isLoading, isError } = useQuery({
    queryKey: ["customer-detail", customer?.email, storeId],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (storeId && storeId !== "all") params.set("storeId", storeId);
      const res = await fetch(
        `/api/customers/${encodeURIComponent(customer!.email)}?${params}`
      );
      if (!res.ok) throw new Error("Failed to fetch customer details");
      return res.json();
    },
    enabled: open && !!customer?.email,
  });

  const customerName = customer
    ? `${customer.firstName || ""} ${customer.lastName || ""}`.trim() || customer.email
    : "";

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Users className="h-5 w-5" />
            {customerName}
          </DialogTitle>
        </DialogHeader>

        {isLoading ? (
          <CustomerDetailSkeleton />
        ) : isError ? (
          <div className="text-center py-8 text-muted-foreground">
            Eroare la incarcarea datelor clientului.
          </div>
        ) : !data?.customer ? (
          <div className="text-center py-8 text-muted-foreground">
            Nu s-au gasit date pentru acest client.
          </div>
        ) : (
          <div className="space-y-6">
            {/* Customer Info + Analytics Row */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Contact Info */}
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm font-medium">Informatii contact</CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  <div className="flex items-center gap-2 text-sm">
                    <Mail className="h-4 w-4 text-muted-foreground" />
                    <span>{data.customer.email}</span>
                  </div>
                  {data.customer.phone && (
                    <div className="flex items-center gap-2 text-sm">
                      <Phone className="h-4 w-4 text-muted-foreground" />
                      <span>{data.customer.phone}</span>
                    </div>
                  )}
                  {data.customer.address?.city && (
                    <div className="flex items-start gap-2 text-sm">
                      <MapPin className="h-4 w-4 text-muted-foreground mt-0.5" />
                      <div>
                        {data.customer.address.address1 && (
                          <div>{data.customer.address.address1}</div>
                        )}
                        {data.customer.address.address2 && (
                          <div>{data.customer.address.address2}</div>
                        )}
                        <div>
                          {data.customer.address.city}
                          {data.customer.address.province && `, ${data.customer.address.province}`}
                          {data.customer.address.zip && ` ${data.customer.address.zip}`}
                        </div>
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Analytics Cards */}
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm font-medium">Statistici cumparaturi</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1">
                      <div className="flex items-center gap-1 text-xs text-muted-foreground">
                        <DollarSign className="h-3 w-3" />
                        Total cheltuit
                      </div>
                      <div className="text-lg font-semibold">
                        {formatCurrency(data.analytics.totalSpent)}
                      </div>
                    </div>
                    <div className="space-y-1">
                      <div className="flex items-center gap-1 text-xs text-muted-foreground">
                        <ShoppingCart className="h-3 w-3" />
                        Nr. comenzi
                      </div>
                      <div className="text-lg font-semibold">
                        {data.analytics.orderCount}
                      </div>
                    </div>
                    <div className="space-y-1">
                      <div className="flex items-center gap-1 text-xs text-muted-foreground">
                        <TrendingUp className="h-3 w-3" />
                        Medie comanda
                      </div>
                      <div className="text-lg font-semibold">
                        {formatCurrency(data.analytics.averageOrderValue)}
                      </div>
                    </div>
                    <div className="space-y-1">
                      <div className="flex items-center gap-1 text-xs text-muted-foreground">
                        <Calendar className="h-3 w-3" />
                        Client din
                      </div>
                      <div className="text-lg font-semibold">
                        {data.analytics.firstOrderDate
                          ? formatDate(data.analytics.firstOrderDate)
                          : "-"}
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Top Products */}
            {data.topProducts && data.topProducts.length > 0 && (
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm font-medium flex items-center gap-2">
                    <Package className="h-4 w-4" />
                    Produse cele mai comandate
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    {data.topProducts.map((product: any, index: number) => (
                      <div
                        key={product.sku || product.title}
                        className="flex items-center justify-between py-2 border-b last:border-0"
                      >
                        <div className="flex items-center gap-3">
                          <div className="w-6 h-6 rounded-full bg-muted flex items-center justify-center text-xs font-medium">
                            {index + 1}
                          </div>
                          <div>
                            <div className="font-medium text-sm">{product.title}</div>
                            {product.sku && (
                              <div className="text-xs text-muted-foreground">
                                SKU: {product.sku}
                              </div>
                            )}
                          </div>
                        </div>
                        <Badge variant="secondary">
                          {product.quantity} buc
                        </Badge>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>
            )}

            {/* Order History */}
            <Card>
              <CardHeader className="pb-2">
                <CardTitle className="text-sm font-medium flex items-center gap-2">
                  <ShoppingCart className="h-4 w-4" />
                  Istoric comenzi ({data.orders?.length || 0})
                </CardTitle>
              </CardHeader>
              <CardContent className="p-0">
                {!data.orders || data.orders.length === 0 ? (
                  <div className="p-4 text-center text-muted-foreground text-sm">
                    Nu exista comenzi pentru acest client.
                  </div>
                ) : (
                  <div className="divide-y max-h-[300px] overflow-y-auto">
                    {data.orders.map((order: any) => (
                      <div
                        key={order.id}
                        className="p-4 hover:bg-muted/50 flex items-center justify-between"
                      >
                        <div className="space-y-1">
                          <div className="flex items-center gap-2">
                            <span className="font-medium">
                              #{order.shopifyOrderNumber}
                            </span>
                            <Badge
                              variant={statusConfig[order.status]?.variant || "neutral"}
                            >
                              {statusConfig[order.status]?.label || order.status}
                            </Badge>
                          </div>
                          <div className="text-xs text-muted-foreground flex items-center gap-4">
                            <span className="flex items-center gap-1">
                              <Calendar className="h-3 w-3" />
                              {formatDate(order.createdAt)}
                            </span>
                            <span>{order.store?.name}</span>
                          </div>
                        </div>
                        <div className="text-right">
                          <div className="font-medium">
                            {formatCurrency(order.totalPrice)}
                          </div>
                          <div className="text-xs text-muted-foreground space-x-2">
                            {order.invoice?.invoiceNumber && (
                              <span>F: {order.invoice.invoiceNumber}</span>
                            )}
                            {order.awb?.awbNumber && (
                              <span>AWB: {order.awb.awbNumber}</span>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}

// Loading skeleton
function CustomerDetailSkeleton() {
  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <Card>
          <CardContent className="p-4 space-y-3">
            <Skeleton className="h-4 w-3/4" />
            <Skeleton className="h-4 w-1/2" />
            <Skeleton className="h-4 w-2/3" />
          </CardContent>
        </Card>
        <Card>
          <CardContent className="p-4">
            <div className="grid grid-cols-2 gap-4">
              {[...Array(4)].map((_, i) => (
                <div key={i} className="space-y-2">
                  <Skeleton className="h-3 w-20" />
                  <Skeleton className="h-6 w-24" />
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
      <Card>
        <CardContent className="p-4 space-y-3">
          {[...Array(3)].map((_, i) => (
            <Skeleton key={i} className="h-12 w-full" />
          ))}
        </CardContent>
      </Card>
    </div>
  );
}
```

**Important:**
- Fetch data only when modal is open (enabled: open && !!customer)
- Use loading skeleton while fetching
- Handle error and empty states
- Romanian text without diacritics
- Scrollable order history with max-height
- Status badges match Orders page config
  </action>
  <verify>
1. Verify file exists: ls src/components/customers/customer-detail-modal.tsx
2. Check for TypeScript errors: npx tsc --noEmit
3. Imports should be valid (verify Dialog, Card, Badge components exist)
  </verify>
  <done>CustomerDetailModal component created with customer info, analytics, top products, and order history.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CustomerDetailModal into customers page</name>
  <files>src/app/(dashboard)/customers/page.tsx</files>
  <action>
Update customers page to import and use CustomerDetailModal.

**Changes:**

1. Add import at top:
```typescript
import { CustomerDetailModal } from "@/components/customers/customer-detail-modal";
```

2. The selectedCustomer and detailOpen state should already exist from Plan 02.
   Verify these exist:
```typescript
const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null);
const [detailOpen, setDetailOpen] = useState(false);
```

3. The handleViewCustomer function should already exist:
```typescript
const handleViewCustomer = (customer: Customer) => {
  setSelectedCustomer(customer);
  setDetailOpen(true);
};
```

4. Add CustomerDetailModal at the end of the page JSX, just before the closing </div>:
```tsx
{/* Customer Detail Modal */}
<CustomerDetailModal
  customer={selectedCustomer}
  open={detailOpen}
  onOpenChange={setDetailOpen}
  storeId={storeFilter}
/>
```

**Where to place:** After the pagination section, before the final closing </div> of the page.
  </action>
  <verify>
1. npm run dev
2. Navigate to /customers
3. Click on any customer row
4. Verify modal opens with:
   - Customer name in header
   - Contact info (email, phone, address)
   - Analytics cards (total spent, order count, average, first order date)
   - Top products list
   - Order history with status badges
5. Close modal and verify page still works
6. Test with different stores filtered
  </verify>
  <done>CustomerDetailModal integrated into customers page, opening on row click with full customer details.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Customers Page with list view and detail modal</what-built>
  <how-to-verify>
1. Start dev server: npm run dev
2. Navigate to http://localhost:3000/customers

**Test Customer List:**
- [ ] Page loads with customer list showing name, email, phone, order count, total spent
- [ ] Search works (type customer name or email, wait 300ms)
- [ ] Store dropdown filters customers
- [ ] Pagination navigates through pages
- [ ] Sidebar shows "Clienti" under Vanzari section

**Test Customer Detail Modal:**
- [ ] Click any customer row - modal opens
- [ ] Modal shows customer contact info (email, phone, address)
- [ ] Analytics cards show: total spent, order count, average order value, first order date
- [ ] Top products section shows most ordered items with quantities
- [ ] Order history shows all orders with status badges, dates, amounts
- [ ] Invoice and AWB numbers visible where applicable
- [ ] Close modal and verify page state preserved

**Test Store Filtering:**
- [ ] Change store filter - customer list updates
- [ ] Open detail modal - analytics reflect store filter
- [ ] URL shows ?tab=storeId parameter
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. CustomerDetailModal component exists and exports correctly
2. Modal opens when clicking customer row
3. Modal shows customer info, analytics, top products, order history
4. Data fetches correctly from /api/customers/[email]
5. Loading and error states handled
6. Store filter passed to modal affects displayed data
</verification>

<success_criteria>
- Clicking customer row opens detail modal
- Modal displays customer contact info and address
- Analytics section shows total spent, order count, average order value
- Most ordered products displayed with quantities
- Complete order history with status badges and dates
- Modal respects current store filter
- Human verification confirms complete workflow
</success_criteria>

<output>
After completion, create `.planning/phases/07.6-customers-page/07.6-03-SUMMARY.md`
</output>
