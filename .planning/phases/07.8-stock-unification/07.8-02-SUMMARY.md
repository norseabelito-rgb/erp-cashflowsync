---
phase: 07.8-stock-unification
plan: 02
subsystem: api
tags: [invoice, stock, inventory, warehouse]

# Dependency graph
requires:
  - phase: 07.8-01
    provides: processInventoryStockForOrderFromPrimary function
provides:
  - Invoice generation uses NEW inventory stock system
  - Stock deductions from InventoryItem.currentStock via primary warehouse
  - InventoryStockMovement records for invoice stock operations
affects: [07.8-03, 07.8-04, 07.8-05]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Invoice stock deduction via processInventoryStockForOrderFromPrimary"
    - "Primary warehouse selection for stock operations"

key-files:
  created: []
  modified:
    - src/lib/invoice-service.ts

key-decisions:
  - "Non-blocking stock deduction - invoice success even if stock fails"
  - "Enhanced logging shows InventoryItem system vs OLD system"

patterns-established:
  - "Stock deduction pattern: Use processInventoryStockForOrderFromPrimary for all invoice-related stock operations"

# Metrics
duration: 4min
completed: 2025-02-05
---

# Phase 7.8 Plan 02: Invoice Stock Migration Summary

**Invoice generation now deducts stock from InventoryItem.currentStock via primary warehouse using processInventoryStockForOrderFromPrimary**

## Performance

- **Duration:** 4 min
- **Started:** 2025-02-05T22:00:00Z
- **Completed:** 2025-02-05T22:04:00Z
- **Tasks:** 3
- **Files modified:** 1

## Accomplishments

- Migrated invoice-service.ts from OLD stock system (Product.stockQuantity) to NEW stock system (InventoryItem.currentStock)
- Stock deductions now create InventoryStockMovement records with orderId and invoiceId references
- Enhanced logging clarifies which stock system is being used and shows warehouse name

## Task Commits

Each task was committed atomically:

1. **Task 1-3: Update import, replace function call, verify compilation** - `4526f92` (feat)

**Plan metadata:** Pending

## Files Created/Modified

- `src/lib/invoice-service.ts` - Changed stock deduction from processStockForOrder to processInventoryStockForOrderFromPrimary

## Decisions Made

- Kept non-blocking stock deduction pattern: Invoice is successful even if stock deduction fails (can be corrected manually)
- Enhanced logging to show "InventoryItem" system explicitly and warehouse name for debugging

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Pre-existing TypeScript errors in the codebase due to Prisma client being out of sync with schema (not related to this change)
- The migration changes compile correctly and introduce no new errors

## Next Phase Readiness

- Invoice generation fully migrated to NEW stock system
- Ready for 07.8-03: Goods Receipt Stock Migration (NIR flow)

---
*Phase: 07.8-stock-unification*
*Completed: 2025-02-05*
