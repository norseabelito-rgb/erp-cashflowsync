---
phase: 07.8-stock-unification
plan: 05
type: execute
wave: 3
depends_on: ["07.8-02", "07.8-03", "07.8-04"]
files_modified:
  - src/lib/stock.ts
  - prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql
autonomous: true

must_haves:
  truths:
    - "processStockForOrder() and processStockReturnForOrder() marked as @deprecated"
    - "Migration script creates InventoryItems for unmapped MasterProducts"
    - "Migration script sets MasterProduct.inventoryItemId for all products with SKU"
    - "Deprecation notes explain replacement functions"
  artifacts:
    - path: "src/lib/stock.ts"
      provides: "Legacy stock functions with deprecation markers"
      contains: "@deprecated"
    - path: "prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql"
      provides: "SQL script to map MasterProducts to InventoryItems"
      contains: "INSERT INTO InventoryItem"
  key_links:
    - from: "stock.ts deprecation comments"
      to: "inventory-stock.ts"
      via: "documentation reference"
      pattern: "@deprecated.*inventory-stock"
---

<objective>
Add deprecation markers to legacy stock functions and create migration script for MasterProduct->InventoryItem mapping.

Purpose: Mark the OLD stock functions as deprecated (but keep them for backward compatibility) and provide a migration script that ensures all MasterProducts are mapped to InventoryItems. This completes the stock unification by ensuring all products can use the NEW system.

Output: Deprecated legacy functions with clear migration guidance, and a SQL script for Railway CLI to map existing products.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.8-stock-unification/07.8-RESEARCH.md
@.planning/phases/07.8-stock-unification/07.8-02-SUMMARY.md
@.planning/phases/07.8-stock-unification/07.8-03-SUMMARY.md
@.planning/phases/07.8-stock-unification/07.8-04-SUMMARY.md

# Key source files
@src/lib/stock.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deprecation markers to stock.ts functions</name>
  <files>src/lib/stock.ts</files>
  <action>
Add JSDoc @deprecated tags to the legacy stock functions in stock.ts:

1. For processStockForOrder (around line 227):
```typescript
/**
 * @deprecated Since Phase 7.8 (Stock Unification).
 * Use `processInventoryStockForOrderFromPrimary()` from `@/lib/inventory-stock` instead.
 *
 * This function uses the legacy Product.stockQuantity system which doesn't sync with
 * InventoryItem.currentStock used by NIR/GoodsReceipt.
 *
 * Migration:
 * ```typescript
 * // Before
 * import { processStockForOrder } from "@/lib/stock";
 * await processStockForOrder(orderId, invoiceId);
 *
 * // After
 * import { processInventoryStockForOrderFromPrimary } from "@/lib/inventory-stock";
 * await processInventoryStockForOrderFromPrimary(orderId, invoiceId);
 * ```
 *
 * Procesează descărcarea stocului pentru o comandă (la emiterea facturii)
 */
export async function processStockForOrder(/* ... */)
```

2. For processStockReturnForOrder (around line 488):
```typescript
/**
 * @deprecated Since Phase 7.8 (Stock Unification).
 * Use `addInventoryStockForReturn()` from `@/lib/inventory-stock` instead.
 *
 * This function uses the legacy Product.stockQuantity system which doesn't sync with
 * InventoryItem.currentStock used by NIR/GoodsReceipt.
 *
 * Migration:
 * ```typescript
 * // Before
 * import { processStockReturnForOrder } from "@/lib/stock";
 * await processStockReturnForOrder(orderId, returnAwbId);
 *
 * // After
 * import { addInventoryStockForReturn } from "@/lib/inventory-stock";
 * await addInventoryStockForReturn(orderId, returnAwbId);
 * ```
 *
 * Procesează readăugarea stocului pentru o comandă returnată
 */
export async function processStockReturnForOrder(/* ... */)
```

3. For recordStockMovement (around line 146):
```typescript
/**
 * @deprecated Since Phase 7.8 (Stock Unification).
 * Stock movements should now be recorded via inventory-stock.ts functions which
 * automatically create InventoryStockMovement records.
 *
 * This function creates StockMovement records tied to Product.stockQuantity
 * which is the legacy system. New code should use the InventoryItem system.
 *
 * Înregistrează o mișcare de stoc
 */
export async function recordStockMovement(/* ... */)
```

IMPORTANT: Do NOT delete or modify the function implementations. Only add the JSDoc deprecation comments above each function declaration.
  </action>
  <verify>
`grep -c "@deprecated" src/lib/stock.ts` returns 3 or more
`grep "processInventoryStockForOrderFromPrimary" src/lib/stock.ts` shows deprecation reference
  </verify>
  <done>Deprecation markers added to processStockForOrder, processStockReturnForOrder, and recordStockMovement</done>
</task>

<task type="auto">
  <name>Task 2: Create MasterProduct->InventoryItem mapping migration script</name>
  <files>prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql</files>
  <action>
Create a SQL migration script that:
1. Creates InventoryItems for MasterProducts that don't have one
2. Sets the inventoryItemId relationship on MasterProduct
3. Initializes InventoryItem.currentStock from MasterProduct.stock

Script content:
```sql
-- Phase 7.8: Map MasterProducts to InventoryItems
-- Run this script via Railway CLI: railway run psql < prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql
-- Or via Prisma: npx prisma db execute --file prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql

-- Step 1: Create InventoryItems for MasterProducts that don't have one
-- Only for products with valid SKU

INSERT INTO "InventoryItem" (
  "id",
  "sku",
  "name",
  "description",
  "unit",
  "currentStock",
  "minStock",
  "costPrice",
  "isComposite",
  "isActive",
  "category",
  "createdAt",
  "updatedAt"
)
SELECT
  gen_random_uuid()::text,  -- Generate new UUID
  mp."sku",
  mp."title",
  mp."description",
  'buc',  -- Default unit
  COALESCE(mp."stock", 0),  -- Use MasterProduct stock as initial value
  5,  -- Default minStock
  COALESCE(mp."costPrice", 0),
  false,  -- Simple items by default
  mp."isActive",
  mp."category",
  NOW(),
  NOW()
FROM "MasterProduct" mp
WHERE mp."sku" IS NOT NULL
  AND mp."sku" != ''
  AND mp."inventoryItemId" IS NULL
  AND NOT EXISTS (
    SELECT 1 FROM "InventoryItem" ii WHERE ii."sku" = mp."sku"
  );

-- Step 2: Link MasterProducts to their InventoryItems by SKU
UPDATE "MasterProduct" mp
SET "inventoryItemId" = ii."id"
FROM "InventoryItem" ii
WHERE mp."sku" = ii."sku"
  AND mp."inventoryItemId" IS NULL;

-- Step 3: Report results
DO $$
DECLARE
  mapped_count INTEGER;
  unmapped_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO mapped_count
  FROM "MasterProduct"
  WHERE "inventoryItemId" IS NOT NULL;

  SELECT COUNT(*) INTO unmapped_count
  FROM "MasterProduct"
  WHERE "inventoryItemId" IS NULL AND "sku" IS NOT NULL AND "sku" != '';

  RAISE NOTICE 'Migration complete: % MasterProducts mapped to InventoryItems', mapped_count;
  RAISE NOTICE 'Remaining unmapped (no matching SKU): %', unmapped_count;
END $$;

-- Step 4: Create WarehouseStock entries for the primary warehouse
-- This ensures new InventoryItems have stock in the primary warehouse
INSERT INTO "WarehouseStock" (
  "id",
  "warehouseId",
  "itemId",
  "currentStock",
  "minStock",
  "createdAt",
  "updatedAt"
)
SELECT
  gen_random_uuid()::text,
  w."id",
  ii."id",
  ii."currentStock",
  ii."minStock",
  NOW(),
  NOW()
FROM "InventoryItem" ii
CROSS JOIN "Warehouse" w
WHERE w."isPrimary" = true
  AND NOT EXISTS (
    SELECT 1 FROM "WarehouseStock" ws
    WHERE ws."itemId" = ii."id" AND ws."warehouseId" = w."id"
  );
```

Place this file at: prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql

IMPORTANT: This script is ADDITIVE only:
- Creates new InventoryItems (doesn't modify existing)
- Links MasterProducts to InventoryItems (doesn't break existing links)
- Creates WarehouseStock entries (doesn't modify existing)
  </action>
  <verify>
`ls prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql`
`grep "INSERT INTO.*InventoryItem" prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql`
  </verify>
  <done>Migration script created to map MasterProducts to InventoryItems and create WarehouseStock entries</done>
</task>

<task type="auto">
  <name>Task 3: Verify all changes and document migration instructions</name>
  <files>src/lib/stock.ts, prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql</files>
  <action>
1. Verify TypeScript still compiles: `npx tsc --noEmit`
2. Verify deprecation markers are visible: `grep -A 5 "@deprecated" src/lib/stock.ts | head -20`
3. Verify migration script syntax (basic check)

Document in the summary:
- Which functions are deprecated
- How to run the migration script
- What the migration script does
- Any manual steps needed

Migration instructions to include in summary:
```
## Running the Migration

### Prerequisites
- All code changes from Plans 01-04 must be deployed
- Database access via Railway CLI or Prisma

### Steps
1. Deploy the code changes (Plans 01-04)
2. Run the migration script:
   ```bash
   # Via Prisma
   npx prisma db execute --file prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql

   # Or via Railway CLI
   railway run psql < prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql
   ```
3. Verify results - script outputs count of mapped products
4. Test by creating an invoice - should see "InventoryItem" in stock deduction logs
```
  </action>
  <verify>
`npx tsc --noEmit` completes without errors
`ls prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql` exists
  </verify>
  <done>All changes verified, migration script ready, deprecation markers in place</done>
</task>

</tasks>

<verification>
After completion:
1. `grep "@deprecated" src/lib/stock.ts | wc -l` returns 3 or more
2. `ls prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql` exists
3. `grep "INSERT INTO.*InventoryItem" prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql` returns matches
4. `grep "UPDATE.*MasterProduct.*inventoryItemId" prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql` returns a match
5. `npx tsc --noEmit` completes without errors
</verification>

<success_criteria>
- processStockForOrder marked @deprecated with migration guide
- processStockReturnForOrder marked @deprecated with migration guide
- recordStockMovement marked @deprecated
- Migration script exists at prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql
- Migration script creates InventoryItems for unmapped MasterProducts
- Migration script links MasterProduct.inventoryItemId to InventoryItems
- Migration script creates WarehouseStock entries for primary warehouse
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.8-stock-unification/07.8-05-SUMMARY.md`
</output>
