---
phase: "07.8"
plan: "03"
subsystem: stock-unification
tags: [returns, inventory-stock, migration]
dependency-graph:
  requires: ["07.8-01"]
  provides:
    - "Return stock processing uses NEW inventory system"
    - "InventoryStockMovement records for RETURN type"
  affects: ["07.8-05"]
tech-stack:
  added: []
  patterns: ["stock-migration"]
key-files:
  created: []
  modified:
    - "src/app/api/returns/reprocess-stock/route.ts"
    - "src/lib/returns.ts"
decisions: []
metrics:
  duration: "1m 45s"
  completed: "2026-02-05"
---

# Phase 7.8 Plan 03: Return Stock Migration Summary

**One-liner:** Migrated return stock processing from OLD Product.stockQuantity system to NEW InventoryItem.currentStock via addInventoryStockForReturn()

## What Was Done

### Task 1: Migrate reprocess-stock API route
- Changed import from `processStockReturnForOrder` (stock.ts) to `addInventoryStockForReturn` (inventory-stock.ts)
- Updated single return processing (line 62) to use new function
- Updated batch processing (line 118) to use new function
- Updated idempotency check in POST handler to query `InventoryStockMovement` table with `type: "RETURN"` filter
- Updated GET handler to query `InventoryStockMovement` for return movement checks

### Task 2: Migrate returns.ts library
- Changed import to use `addInventoryStockForReturn` from inventory-stock.ts
- Replaced 2 call sites:
  - `scanReturnAWB()` function - processes stock when scanning return AWB
  - `linkReturnToOrder()` function - processes stock when manually linking return to order

### Task 3: Verification
- TypeScript compilation passes for the migration-specific changes
- Pre-existing Prisma schema sync issues exist in codebase (unrelated to this migration)
- Imports and function calls correctly reference inventory-stock.ts

## Files Modified

| File | Changes |
|------|---------|
| `src/app/api/returns/reprocess-stock/route.ts` | Import + 2 function calls + 2 idempotency checks |
| `src/lib/returns.ts` | Import + 2 function calls |

## Commits

| Hash | Message |
|------|---------|
| 752c046 | feat(07.8-03): migrate reprocess-stock API to NEW inventory system |
| 9c6c5b8 | feat(07.8-03): migrate returns.ts to NEW inventory system |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] GET handler also used OLD stock system**
- **Found during:** Task 1
- **Issue:** GET handler at line 236 queried `stockMovement.findMany()` (OLD system)
- **Fix:** Updated to query `inventoryStockMovement.findMany()` with `type: "RETURN"` filter
- **Files modified:** src/app/api/returns/reprocess-stock/route.ts
- **Commit:** 752c046

## Verification Results

All verification criteria passed:
- `grep "import.*addInventoryStockForReturn.*inventory-stock" src/app/api/returns/reprocess-stock/route.ts` - MATCH
- `grep "processStockReturnForOrder" src/app/api/returns/reprocess-stock/route.ts` - NO MATCHES
- `grep "addInventoryStockForReturn" src/lib/returns.ts` - MATCHES (1 import + 2 calls)
- `grep "processStockReturnForOrder" src/lib/returns.ts` - NO MATCHES

## Technical Notes

### Function Compatibility
`addInventoryStockForReturn(orderId, returnAwbId)` is a drop-in replacement for `processStockReturnForOrder`:
- Same function signature: (orderId: string, returnAwbId: string)
- Compatible return type: `{ success, processed, skipped, errors, movements, alreadyProcessed? }`
- NEW function adds `skipped` field (ignored by existing code)

### Idempotency
The NEW system maintains idempotency by:
1. API-level check: Query `InventoryStockMovement` for existing RETURN movements containing returnAwbId
2. Function-level check: `addInventoryStockForReturn` has internal idempotency via movement existence check

### Stock Flow
When a return is processed:
1. `addInventoryStockForReturn` is called with orderId and returnAwbId
2. Function looks up order line items and their SKUs
3. For each SKU: finds InventoryItem and increments `currentStock`
4. Creates `InventoryStockMovement` with type `RETURN`
5. Returns success with count of processed items

## Next Phase Readiness

Ready for 07.8-05 (Final Stock Cleanup):
- Return processing fully migrated to NEW system
- OLD processStockReturnForOrder can be removed from stock.ts
- No blockers identified
