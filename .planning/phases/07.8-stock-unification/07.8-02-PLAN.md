---
phase: 07.8-stock-unification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/invoice-service.ts
autonomous: true

must_haves:
  truths:
    - "Invoice generation uses processInventoryStockForOrderFromPrimary() instead of processStockForOrder()"
    - "InventoryStockMovement records created when invoices are generated"
    - "Stock deduction uses primary warehouse and InventoryItem.currentStock"
    - "Products without inventoryItemId mapping are skipped (not blocking)"
  artifacts:
    - path: "src/lib/invoice-service.ts"
      provides: "Invoice generation with NEW stock system"
      contains: "processInventoryStockForOrderFromPrimary"
  key_links:
    - from: "src/lib/invoice-service.ts"
      to: "processInventoryStockForOrderFromPrimary"
      via: "import and function call"
      pattern: "import.*processInventoryStockForOrderFromPrimary.*from.*inventory-stock"
    - from: "invoice-service.ts:generateInvoice"
      to: "InventoryItem.currentStock"
      via: "processInventoryStockForOrderFromPrimary"
      pattern: "await processInventoryStockForOrderFromPrimary"
---

<objective>
Migrate invoice-service.ts to use the NEW stock system for stock deduction.

Purpose: Currently invoice generation calls processStockForOrder() which updates Product.stockQuantity (OLD system). This migrates to processInventoryStockForOrderFromPrimary() which updates InventoryItem.currentStock (NEW system), ensuring stock consistency with NIR/GoodsReceipt.

Output: invoice-service.ts uses the NEW inventory stock system for all invoice-related stock deductions.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.8-stock-unification/07.8-RESEARCH.md

# Key source files
@src/lib/invoice-service.ts
@src/lib/inventory-stock.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update import statement in invoice-service.ts</name>
  <files>src/lib/invoice-service.ts</files>
  <action>
Find the import statement for processStockForOrder from stock.ts and either:
1. Replace it with an import from inventory-stock.ts, OR
2. Add a new import for processInventoryStockForOrderFromPrimary

Current (around line 10-20):
```typescript
import { processStockForOrder } from "./stock";
```

Change to:
```typescript
import { processInventoryStockForOrderFromPrimary } from "./inventory-stock";
```

If other functions from stock.ts are still needed elsewhere in the file, keep those imports but remove processStockForOrder.

IMPORTANT: Do NOT remove the stock.ts import entirely if other functions are used. Only remove processStockForOrder from that import.
  </action>
  <verify>
`grep "processInventoryStockForOrderFromPrimary" src/lib/invoice-service.ts | grep import`
  </verify>
  <done>Import statement updated to use processInventoryStockForOrderFromPrimary from inventory-stock.ts</done>
</task>

<task type="auto">
  <name>Task 2: Replace processStockForOrder call with processInventoryStockForOrderFromPrimary</name>
  <files>src/lib/invoice-service.ts</files>
  <action>
Find the call to processStockForOrder (around line 725) and replace it with processInventoryStockForOrderFromPrimary.

Current code (lines 723-734):
```typescript
if (savedInvoice) {
  try {
    const stockResult = await processStockForOrder(order.id, savedInvoice.id);
    if (stockResult.success) {
      console.log(`[Invoice] Stoc descarcat: ${stockResult.processed} miscari`);
    } else {
      console.warn(`[Invoice] Erori la descarcarea stocului: ${stockResult.errors.join(", ")}`);
    }
  } catch (stockError) {
    // Non-blocking - factura a fost emisa cu succes, stocul poate fi corectat manual
    console.error("[Invoice] Eroare la descarcarea stocului:", stockError);
  }
}
```

Replace with:
```typescript
if (savedInvoice) {
  try {
    const stockResult = await processInventoryStockForOrderFromPrimary(order.id, savedInvoice.id);
    if (stockResult.success) {
      console.log(`[Invoice] Stoc descarcat (InventoryItem): ${stockResult.processed} articole, ${stockResult.skipped} sarite`);
      if (stockResult.warehouseName) {
        console.log(`[Invoice] Depozit: ${stockResult.warehouseName}`);
      }
    } else {
      console.warn(`[Invoice] Erori la descarcarea stocului: ${stockResult.errors.join(", ")}`);
    }
  } catch (stockError) {
    // Non-blocking - factura a fost emisa cu succes, stocul poate fi corectat manual
    console.error("[Invoice] Eroare la descarcarea stocului:", stockError);
  }
}
```

Note the enhanced logging:
- Shows "InventoryItem" to clarify which system is being used
- Shows skipped count (products without inventoryItemId mapping)
- Shows warehouse name from result
  </action>
  <verify>
`grep "processInventoryStockForOrderFromPrimary" src/lib/invoice-service.ts | grep -v import`
  </verify>
  <done>processStockForOrder call replaced with processInventoryStockForOrderFromPrimary, logging updated</done>
</task>

<task type="auto">
  <name>Task 3: Verify compilation and remove unused import</name>
  <files>src/lib/invoice-service.ts</files>
  <action>
1. Check if processStockForOrder is used anywhere else in the file: `grep "processStockForOrder" src/lib/invoice-service.ts`
2. If NOT used anywhere else, remove it from the import statement
3. Run TypeScript compilation: `npx tsc --noEmit src/lib/invoice-service.ts`
4. Fix any type errors if they appear (the return type structure is similar but may have additional fields like warehouseName)

After cleanup, the imports section should have:
- `import { processInventoryStockForOrderFromPrimary } from "./inventory-stock";`
- NO reference to processStockForOrder from "./stock" (unless other functions from stock.ts are still needed)
  </action>
  <verify>
`npx tsc --noEmit` completes without errors
`grep "processStockForOrder" src/lib/invoice-service.ts` returns no matches (only processInventoryStockForOrderFromPrimary)
  </verify>
  <done>TypeScript compiles, unused import removed, invoice-service.ts fully migrated to NEW stock system</done>
</task>

</tasks>

<verification>
After completion:
1. `grep "import.*processInventoryStockForOrderFromPrimary.*inventory-stock" src/lib/invoice-service.ts` returns a match
2. `grep "await processInventoryStockForOrderFromPrimary" src/lib/invoice-service.ts` returns a match
3. `grep "processStockForOrder" src/lib/invoice-service.ts` returns NO matches
4. `npx tsc --noEmit` completes without errors
</verification>

<success_criteria>
- invoice-service.ts imports processInventoryStockForOrderFromPrimary from inventory-stock.ts
- processStockForOrder replaced with processInventoryStockForOrderFromPrimary at the stock deduction call site
- Logging updated to show InventoryItem system usage and warehouse info
- TypeScript compiles without errors
- Invoice generation now uses InventoryItem.currentStock for stock deduction
</success_criteria>

<output>
After completion, create `.planning/phases/07.8-stock-unification/07.8-02-SUMMARY.md`
</output>
