---
phase: "07.8"
plan: "04"
subsystem: "picking"
tags: ["stock", "inventory", "picking", "warehouse"]

requires: ["07.8-01"]
provides: ["picking-new-stock-system"]
affects: ["07.8-05"]

tech-stack:
  patterns:
    - "Non-blocking stock deduction pattern"
    - "Legacy fallback for unmapped products"

key-files:
  modified:
    - "src/app/api/picking/[id]/route.ts"

decisions:
  - id: "07.8-04-01"
    description: "Non-blocking stock operations - picking succeeds even if stock deduction fails"
  - id: "07.8-04-02"
    description: "Legacy fallback to MasterProduct.stock for products not mapped to InventoryItem"
  - id: "07.8-04-03"
    description: "Stock restoration on reset uses addInventoryStockFromWarehouse"

metrics:
  completed: "2026-02-05"
  duration: "~4 minutes"
---

# Phase 07.8 Plan 04: Picking Stock Migration Summary

**One-liner:** Picking operations now deduct/restore stock via InventoryItem.currentStock and WarehouseStock with InventoryStockMovement audit trail, with non-blocking pattern for resilience.

## What Was Built

Migrated the picking list stock operations from the OLD system (direct MasterProduct.stock updates) to the NEW system (deductInventoryStockFromWarehouse/addInventoryStockFromWarehouse).

### Key Changes

1. **Scan Action Migration**
   - Stock deduction moved outside transaction (non-blocking pattern)
   - Uses deductInventoryStockFromWarehouse for mapped products
   - Creates InventoryStockMovement records for audit trail
   - Legacy fallback for unmapped products with warning log

2. **PickItem Action Migration**
   - Same non-blocking pattern as scan action
   - Stock deduction occurs after successful PickingListItem update
   - Errors caught and logged, never re-thrown

3. **ResetItem Action Migration**
   - Uses addInventoryStockFromWarehouse for stock restoration
   - Same non-blocking pattern - reset succeeds even if stock ops fail
   - Creates RETURN type InventoryStockMovement records

## Technical Details

### Non-Blocking Pattern

The key architectural decision was to make stock operations non-blocking:

```typescript
// Item update in transaction (must succeed)
const [updatedItem] = await prisma.$transaction(async (tx) => {
  // PickingListItem update
  return [updated];
});

// Stock deduction outside transaction (can fail)
if (quantityToDeduct > 0) {
  try {
    // Stock operations...
  } catch (stockError) {
    console.error("[Picking] Stock deduction error (non-blocking):", stockError);
    // DO NOT re-throw
  }
}
```

This ensures:
- Picking operations always complete if the item update succeeds
- Stock discrepancies can be corrected manually via inventory adjustments
- No blocking issues during high-volume picking operations

### Integration Points

| Function | Purpose |
|----------|---------|
| `deductInventoryStockFromWarehouse` | Deduct stock from primary warehouse |
| `addInventoryStockFromWarehouse` | Restore stock on reset |
| `getPrimaryWarehouse` | Get primary warehouse for stock operations |

## Files Modified

| File | Changes |
|------|---------|
| `src/app/api/picking/[id]/route.ts` | Added imports, migrated scan/pickItem/resetItem actions |

## Commits

| Hash | Description |
|------|-------------|
| `d5d08d3` | Add inventory-stock imports for picking route |
| `dfb6b79` | Migrate picking stock operations to NEW inventory system |

## Verification Results

All verification criteria passed:

1. Import statement present for deductInventoryStockFromWarehouse
2. Function calls present (2x deductInventoryStockFromWarehouse)
3. inventoryItemId checks present (3 locations)
4. Non-blocking error handling (catch stockError) present
5. Syntax validation passed (braces/parens/brackets balanced)
6. Legacy fallback with warning log present

## Deviations from Plan

**None** - plan executed exactly as written.

## Next Phase Readiness

### Prerequisites for 07.8-05 (Receipt Stock Migration)

- deductInventoryStockFromWarehouse: Available (created in 07.8-01)
- addInventoryStockFromWarehouse: Available (created in 07.8-01)
- Non-blocking pattern: Established (can be applied to receipt)

### Blockers

None identified.
