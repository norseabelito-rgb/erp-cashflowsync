---
phase: 07.8-stock-unification
plan: 05
subsystem: inventory
tags: [stock, deprecation, migration, sql, prisma, inventory]

# Dependency graph
requires:
  - phase: 07.8-01
    provides: NEW inventory stock functions (addInventoryStockFromWarehouse, addInventoryStockForReturn)
  - phase: 07.8-02
    provides: Invoice migration to processInventoryStockForOrderFromPrimary
  - phase: 07.8-03
    provides: Return migration to addInventoryStockForReturn
  - phase: 07.8-04
    provides: Picking migration to deductInventoryStockFromWarehouse
provides:
  - Legacy stock function deprecation markers with migration guides
  - SQL migration script for MasterProduct->InventoryItem mapping
  - WarehouseStock initialization for primary warehouse
affects: [future-maintenance, stock-migration, inventory-cleanup]

# Tech tracking
tech-stack:
  added: []
  patterns: [JSDoc deprecation with migration examples, manual SQL migrations]

key-files:
  created:
    - prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql
  modified:
    - src/lib/stock.ts

key-decisions:
  - "Deprecate but do not delete legacy functions for backward compatibility"
  - "Use RAISE NOTICE for migration result reporting in SQL"
  - "Initialize WarehouseStock for primary warehouse during migration"

patterns-established:
  - "Deprecation pattern: @deprecated tag with migration code example"
  - "Manual migration scripts in prisma/migrations/manual/"

# Metrics
duration: 5min
completed: 2026-02-06
---

# Phase 7.8 Plan 05: Legacy Deprecation Summary

**Deprecated legacy stock.ts functions with migration guides pointing to inventory-stock.ts, and created SQL migration script to map existing MasterProducts to InventoryItems**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-05T22:02:57Z
- **Completed:** 2026-02-05T22:08:00Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments
- Added @deprecated markers to processStockForOrder(), processStockReturnForOrder(), and recordStockMovement()
- Created SQL migration script that maps MasterProducts to InventoryItems by SKU
- Migration script also creates WarehouseStock entries for primary warehouse
- Deprecation comments include complete migration code examples

## Task Commits

Each task was committed atomically:

1. **Task 1: Add deprecation markers to stock.ts functions** - `02e4bd7` (chore)
2. **Task 2: Create MasterProduct->InventoryItem mapping migration script** - `55506b7` (chore)
3. **Task 3: Verify all changes and document migration instructions** - Verification only, no commit needed

## Files Created/Modified
- `src/lib/stock.ts` - Added @deprecated JSDoc tags to 3 legacy functions with migration guides
- `prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql` - SQL script to map products to inventory system

## Decisions Made
- **Deprecate, don't delete:** Keep legacy functions working for backward compatibility during transition period
- **Migration examples in deprecation:** Include complete before/after code examples to make migration self-documenting
- **RAISE NOTICE for reporting:** Use PostgreSQL NOTICE messages to report migration results without requiring separate queries

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing TypeScript errors in codebase (unrelated to this plan's changes) - verified stock.ts specifically has no errors

## User Setup Required

**Manual migration step required.** After deploying code changes from Plans 01-05:

```bash
# Via Prisma
npx prisma db execute --file prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql

# Or via Railway CLI
railway run psql < prisma/migrations/manual/map_masterproduct_to_inventoryitem.sql
```

The migration script will:
1. Create InventoryItems for MasterProducts that don't have one
2. Link MasterProduct.inventoryItemId to matching InventoryItems by SKU
3. Create WarehouseStock entries for the primary warehouse
4. Report results via NOTICE messages

## Next Phase Readiness
- Stock unification phase is COMPLETE
- All callers now use NEW inventory system (InventoryItem/WarehouseStock)
- Legacy functions preserved but marked deprecated
- Migration script ready for production execution
- After migration: All MasterProducts will be linked to InventoryItems

---
*Phase: 07.8-stock-unification*
*Completed: 2026-02-06*
