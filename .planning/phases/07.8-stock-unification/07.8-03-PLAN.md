---
phase: 07.8-stock-unification
plan: 03
type: execute
wave: 2
depends_on: ["07.8-01"]
files_modified:
  - src/app/api/returns/reprocess-stock/route.ts
  - src/lib/returns.ts
autonomous: true

must_haves:
  truths:
    - "Return stock processing uses addInventoryStockForReturn() instead of processStockReturnForOrder()"
    - "InventoryStockMovement records created with type RETURN when returns are processed"
    - "Batch reprocessing endpoint uses NEW stock system"
    - "Idempotency maintained - returns already processed are skipped"
  artifacts:
    - path: "src/app/api/returns/reprocess-stock/route.ts"
      provides: "Return stock reprocessing API with NEW stock system"
      contains: "addInventoryStockForReturn"
    - path: "src/lib/returns.ts"
      provides: "Return processing utilities with NEW stock system"
      contains: "addInventoryStockForReturn"
  key_links:
    - from: "src/app/api/returns/reprocess-stock/route.ts"
      to: "addInventoryStockForReturn"
      via: "import and function call"
      pattern: "import.*addInventoryStockForReturn.*from.*inventory-stock"
    - from: "returns.ts"
      to: "InventoryItem.currentStock"
      via: "addInventoryStockForReturn"
      pattern: "await addInventoryStockForReturn"
---

<objective>
Migrate return stock processing to use the NEW stock system.

Purpose: Currently return processing calls processStockReturnForOrder() which updates Product.stockQuantity (OLD system). This migrates to addInventoryStockForReturn() which updates InventoryItem.currentStock (NEW system), ensuring returned stock syncs with NIR/GoodsReceipt.

Output: All return stock processing uses InventoryItem.currentStock through the NEW inventory stock system.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.8-stock-unification/07.8-RESEARCH.md
@.planning/phases/07.8-stock-unification/07.8-01-SUMMARY.md

# Key source files
@src/app/api/returns/reprocess-stock/route.ts
@src/lib/returns.ts
@src/lib/inventory-stock.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update reprocess-stock API route to use addInventoryStockForReturn</name>
  <files>src/app/api/returns/reprocess-stock/route.ts</files>
  <action>
Update the /api/returns/reprocess-stock endpoint to use the NEW stock system.

1. Change the import (line 6):
   FROM: `import { processStockReturnForOrder } from "@/lib/stock";`
   TO: `import { addInventoryStockForReturn } from "@/lib/inventory-stock";`

2. Update the single return processing (around line 62):
   FROM: `const stockResult = await processStockReturnForOrder(returnAwb.orderId, returnAwbId);`
   TO: `const stockResult = await addInventoryStockForReturn(returnAwb.orderId, returnAwbId);`

3. Update the batch processing (around line 118):
   FROM: `const stockResult = await processStockReturnForOrder(returnAwb.orderId, returnAwb.id);`
   TO: `const stockResult = await addInventoryStockForReturn(returnAwb.orderId, returnAwb.id);`

4. Update the idempotency check query (around lines 99-101):
   The current check queries StockMovement table. We need to query InventoryStockMovement instead:
   FROM:
   ```typescript
   const existingMovement = await prisma.stockMovement.findFirst({
     where: { reference: `RETUR-${returnAwb.id}` },
   });
   ```
   TO:
   ```typescript
   const existingMovement = await prisma.inventoryStockMovement.findFirst({
     where: {
       type: "RETURN",
       reason: { contains: returnAwb.id }
     },
   });
   ```

Note: The addInventoryStockForReturn function has its own idempotency check, so the API-level check is now redundant but harmless as an early-exit optimization.
  </action>
  <verify>
`grep "addInventoryStockForReturn" src/app/api/returns/reprocess-stock/route.ts | head -3`
`grep "processStockReturnForOrder" src/app/api/returns/reprocess-stock/route.ts` returns no matches
  </verify>
  <done>reprocess-stock/route.ts migrated to use addInventoryStockForReturn, idempotency check updated</done>
</task>

<task type="auto">
  <name>Task 2: Update returns.ts if it calls processStockReturnForOrder</name>
  <files>src/lib/returns.ts</files>
  <action>
Check if src/lib/returns.ts calls processStockReturnForOrder and update if needed.

First, check if the file exists and uses the old function:
`grep "processStockReturnForOrder" src/lib/returns.ts`

If it does use processStockReturnForOrder:
1. Update the import to use addInventoryStockForReturn from inventory-stock.ts
2. Replace all calls to processStockReturnForOrder with addInventoryStockForReturn

If the file doesn't exist or doesn't use processStockReturnForOrder, document this in the summary.

Note: The RESEARCH.md mentions returns.ts:121-143 as a call site, so verify and update accordingly.
  </action>
  <verify>
`grep "addInventoryStockForReturn" src/lib/returns.ts` OR confirm file doesn't use stock processing
`grep "processStockReturnForOrder" src/lib/returns.ts` returns no matches
  </verify>
  <done>returns.ts checked and updated if needed, no references to processStockReturnForOrder remain</done>
</task>

<task type="auto">
  <name>Task 3: Verify TypeScript compilation and test the API</name>
  <files>src/app/api/returns/reprocess-stock/route.ts, src/lib/returns.ts</files>
  <action>
1. Run TypeScript compilation: `npx tsc --noEmit`
2. Verify the return type structure is compatible (addInventoryStockForReturn has similar structure to processStockReturnForOrder with alreadyProcessed, processed, errors, etc.)
3. If any type errors appear due to return type differences, adapt the code accordingly

The return types should be compatible:
- OLD: { success, processed, errors, movements, alreadyProcessed? }
- NEW: { success, processed, skipped, errors, movements, alreadyProcessed? }

The main difference is the addition of `skipped` field, which is safe to ignore in existing code.
  </action>
  <verify>
`npx tsc --noEmit` completes without errors
  </verify>
  <done>TypeScript compiles, return stock processing fully migrated to NEW stock system</done>
</task>

</tasks>

<verification>
After completion:
1. `grep "import.*addInventoryStockForReturn.*inventory-stock" src/app/api/returns/reprocess-stock/route.ts` returns a match
2. `grep "processStockReturnForOrder" src/app/api/returns/reprocess-stock/route.ts` returns NO matches
3. `grep "processStockReturnForOrder" src/lib/returns.ts` returns NO matches (or file doesn't use it)
4. `npx tsc --noEmit` completes without errors
</verification>

<success_criteria>
- reprocess-stock/route.ts uses addInventoryStockForReturn from inventory-stock.ts
- returns.ts updated if it used processStockReturnForOrder
- Idempotency check queries InventoryStockMovement table (not StockMovement)
- TypeScript compiles without errors
- Return processing now adds stock to InventoryItem.currentStock
</success_criteria>

<output>
After completion, create `.planning/phases/07.8-stock-unification/07.8-03-SUMMARY.md`
</output>
