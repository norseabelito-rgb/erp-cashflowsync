---
phase: 07.8-stock-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/inventory-stock.ts
autonomous: true

must_haves:
  truths:
    - "addInventoryStockFromWarehouse() adds stock to WarehouseStock and InventoryItem.currentStock"
    - "addInventoryStockForReturn() processes return orders and adds stock back"
    - "InventoryStockMovement records created with type RETURN for audit trail"
    - "Composite items have components' stock added correctly"
    - "Idempotency check prevents double processing of same return"
  artifacts:
    - path: "src/lib/inventory-stock.ts"
      provides: "addInventoryStockFromWarehouse and addInventoryStockForReturn functions"
      exports: ["addInventoryStockFromWarehouse", "addInventoryStockForReturn"]
  key_links:
    - from: "addInventoryStockForReturn"
      to: "addInventoryStockFromWarehouse"
      via: "function call for each line item"
      pattern: "addInventoryStockFromWarehouse\\("
    - from: "addInventoryStockFromWarehouse"
      to: "prisma.warehouseStock"
      via: "upsert in transaction"
      pattern: "tx\\.warehouseStock\\.upsert"
    - from: "addInventoryStockFromWarehouse"
      to: "prisma.inventoryStockMovement"
      via: "create movement record"
      pattern: "tx\\.inventoryStockMovement\\.create"
---

<objective>
Create the stock addition functions for the NEW inventory system to handle returns.

Purpose: The NEW stock system (InventoryItem.currentStock) has deduction functions but lacks addition functions for returns. This creates `addInventoryStockFromWarehouse()` and `addInventoryStockForReturn()` to mirror the existing deduction functions.

Output: Two new exported functions in inventory-stock.ts that add stock back to InventoryItem when returns are processed.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.8-stock-unification/07.8-RESEARCH.md

# Key source files
@src/lib/inventory-stock.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create addInventoryStockFromWarehouse() function</name>
  <files>src/lib/inventory-stock.ts</files>
  <action>
Add `addInventoryStockFromWarehouse()` function to inventory-stock.ts. This is the mirror of `deductInventoryStockFromWarehouse()` (lines 809-1042).

The function should:
1. Accept itemId, warehouseId, quantity, and options (orderId, reason, userId, userName)
2. Handle both simple items (add to WarehouseStock directly) and composite items (add to each component)
3. Use a transaction to ensure atomicity
4. For simple items:
   - Find or create WarehouseStock record
   - Calculate previousStock and newStock (previousStock + quantity)
   - Upsert WarehouseStock with newStock
   - Create InventoryStockMovement with type="RETURN" and positive quantity
   - Aggregate all WarehouseStock for this item and update InventoryItem.currentStock
5. For composite items:
   - Iterate through recipeComponents
   - For each component, apply the same logic with componentQuantity = comp.quantity * quantity
6. Return success/movements array with itemId, sku, quantity, previousStock, newStock, warehouseId

IMPORTANT: Follow the exact pattern from deductInventoryStockFromWarehouse() but:
- Use positive quantity values (addition, not deduction)
- Use type="RETURN" for InventoryStockMovement
- Remove the negative stock check (additions never fail for insufficient stock)

Place the function after deductInventoryStockFromWarehouse() (around line 1043).
  </action>
  <verify>
Verify the function is exported: `grep "export async function addInventoryStockFromWarehouse" src/lib/inventory-stock.ts`
Verify it creates movements with RETURN type: `grep -A 5 "type:.*RETURN" src/lib/inventory-stock.ts`
  </verify>
  <done>addInventoryStockFromWarehouse() exists, is exported, handles simple and composite items, creates RETURN type movements</done>
</task>

<task type="auto">
  <name>Task 2: Create addInventoryStockForReturn() function</name>
  <files>src/lib/inventory-stock.ts</files>
  <action>
Add `addInventoryStockForReturn()` function to inventory-stock.ts. This is the mirror of `processInventoryStockForOrderFromPrimary()` (lines 1068-1216).

The function should:
1. Accept orderId and returnAwbId
2. Return { success, processed, skipped, errors, movements[], alreadyProcessed? }
3. Implementation:
   a. Idempotency check: Query InventoryStockMovement for existing records with reason containing returnAwbId. If found, return { success: true, alreadyProcessed: true, processed: 0 }
   b. Get primary warehouse using getPrimaryWarehouse()
   c. Get lineItems from order
   d. For each lineItem with SKU:
      - Find MasterProduct with inventoryItem include
      - Skip if no inventoryItemId
      - Call addInventoryStockFromWarehouse() with the inventoryItemId, primaryWarehouse.id, lineItem.quantity
      - Options: { orderId, reason: `Retur - AWB ${returnAwbId}, Produs: ${lineItem.title}` }
   e. Aggregate results

IMPORTANT:
- Mirror the logging pattern from processInventoryStockForOrderFromPrimary() (console.log with box characters)
- The reason string MUST contain returnAwbId for idempotency checks
- Skip products without inventoryItemId (increment skipped counter, log warning)

Place the function after addInventoryStockFromWarehouse().
  </action>
  <verify>
Verify the function is exported: `grep "export async function addInventoryStockForReturn" src/lib/inventory-stock.ts`
Verify idempotency check: `grep -A 3 "alreadyProcessed" src/lib/inventory-stock.ts | grep -i return`
  </verify>
  <done>addInventoryStockForReturn() exists, is exported, has idempotency check, uses primary warehouse, processes line items via MasterProduct->InventoryItem mapping</done>
</task>

<task type="auto">
  <name>Task 3: Verify TypeScript compilation and exports</name>
  <files>src/lib/inventory-stock.ts</files>
  <action>
1. Run TypeScript compilation to verify no errors: `npx tsc --noEmit src/lib/inventory-stock.ts`
2. Verify both functions are properly exported by checking the file
3. If any TypeScript errors, fix them (likely type annotations or missing imports)

Expected exports at end of implementation:
- addInventoryStockFromWarehouse
- addInventoryStockForReturn

These join existing exports:
- processInventoryStockForOrderFromPrimary
- deductInventoryStockFromWarehouse
- getPrimaryWarehouse
- etc.
  </action>
  <verify>
`npx tsc --noEmit` completes without errors
`grep -c "export async function" src/lib/inventory-stock.ts` shows increased count
  </verify>
  <done>TypeScript compiles without errors, both new functions are exported and ready for use by other plans</done>
</task>

</tasks>

<verification>
After completion:
1. `grep "export async function addInventoryStockFromWarehouse" src/lib/inventory-stock.ts` returns a match
2. `grep "export async function addInventoryStockForReturn" src/lib/inventory-stock.ts` returns a match
3. `npx tsc --noEmit` completes without errors
4. The addInventoryStockFromWarehouse function creates InventoryStockMovement with type="RETURN"
5. The addInventoryStockForReturn function has idempotency check using returnAwbId
</verification>

<success_criteria>
- Two new functions added to inventory-stock.ts: addInventoryStockFromWarehouse and addInventoryStockForReturn
- Both functions are exported and TypeScript compiles without errors
- addInventoryStockFromWarehouse handles simple and composite items
- addInventoryStockForReturn has idempotency check and uses MasterProduct->InventoryItem mapping
- Movement records created with type="RETURN" for audit trail
</success_criteria>

<output>
After completion, create `.planning/phases/07.8-stock-unification/07.8-01-SUMMARY.md`
</output>
