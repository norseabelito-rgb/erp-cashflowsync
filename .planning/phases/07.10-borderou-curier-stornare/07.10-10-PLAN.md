---
phase: 07.10-borderou-curier-stornare
plan: 10
type: execute
wave: 4
depends_on: ["07.10-06", "07.10-07", "07.10-08"]
files_modified:
  - src/components/layout/Sidebar.tsx
  - src/app/(dashboard)/returns/page.tsx
autonomous: true

must_haves:
  truths:
    - "Sidebar has links to manifest and report pages"
    - "Returns page has Generate Manifest button"
    - "Returns page shows all returns with pagination (not limited to 100)"
    - "Navigation structure supports new workflow pages"
  artifacts:
    - path: "src/components/layout/Sidebar.tsx"
      provides: "Updated sidebar with manifest and report navigation"
      contains: "/returns/manifest"
    - path: "src/app/(dashboard)/returns/page.tsx"
      provides: "Returns page with manifest generation button and pagination UI"
      contains: "Genereaza Manifest"
  key_links:
    - from: "src/components/layout/Sidebar.tsx"
      to: "/returns/manifest"
      via: "navigation link"
      pattern: "returns/manifest"
    - from: "src/components/layout/Sidebar.tsx"
      to: "/reports/stuck-shipments"
      via: "navigation link"
      pattern: "stuck-shipments"
    - from: "src/app/(dashboard)/returns/page.tsx"
      to: "/api/returns"
      via: "fetch with offset and limit params"
      pattern: "offset=.*limit="
---

<objective>
Integrate manifest and report pages into sidebar navigation. Add manifest generation button to returns page. Ensure all new pages are accessible.

Purpose: Complete the UI integration so users can access all new workflow pages.
Output: Updated sidebar navigation and returns page with manifest button.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/components/layout/Sidebar.tsx
@src/app/(dashboard)/returns/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update sidebar navigation with new pages</name>
  <files>src/components/layout/Sidebar.tsx</files>
  <action>
Update src/components/layout/Sidebar.tsx to add links for:

1. Under "Expeditii" or AWB tracking section:
   - Add "Borderou Livrari" link to /reports/delivery-manifest
   - Add "Colete Blocate" link to /reports/stuck-shipments

2. Under "Retururi" or Returns section:
   - Add "Manifest Retururi" link to /returns/manifest

3. Under "Setari" section:
   - Add "Securitate" link to /settings/security (if not present)

Find the navigation items array/object and add the new entries. Example structure based on existing patterns:

```typescript
// In the returns/tracking section
{
  name: "Manifest Retururi",
  href: "/returns/manifest",
  icon: FileText, // or appropriate icon
  permission: "handover.scan" // same as returns
},

// In the reports section (create if not exists)
{
  name: "Rapoarte",
  icon: BarChart3,
  submenu: [
    {
      name: "Borderou Livrari",
      href: "/reports/delivery-manifest",
      permission: "invoices.view"
    },
    {
      name: "Colete Blocate",
      href: "/reports/stuck-shipments",
      permission: "tracking.view"
    }
  ]
}

// In settings section
{
  name: "Securitate",
  href: "/settings/security",
  icon: Shield,
  permission: "settings.security"
}
```

Import any new icons needed:
```typescript
import { FileText, BarChart3, Shield, Truck } from "lucide-react";
```

Position the new items logically:
- Manifest Retururi should be near/under Retururi
- Borderou Livrari can be under a Rapoarte section or near AWB tracking
- Colete Blocate under Rapoarte
- Securitate under Setari
  </action>
  <verify>
Sidebar shows new navigation items:
- /returns/manifest visible under returns section
- /reports/delivery-manifest visible
- /reports/stuck-shipments visible
- /settings/security visible under settings
  </verify>
  <done>Sidebar updated with navigation links to all new manifest and report pages</done>
</task>

<task type="auto">
  <name>Task 2: Add manifest generation button to returns page</name>
  <files>src/app/(dashboard)/returns/page.tsx</files>
  <action>
Update src/app/(dashboard)/returns/page.tsx to add a "Genereaza Manifest" button in the header area.

Add the following changes:

1. Add import for useRouter and necessary components:
```typescript
import { useRouter } from "next/navigation";
import { FileText, RefreshCw } from "lucide-react";
```

2. Add router in the component:
```typescript
const router = useRouter();
```

3. Add state for manifest generation:
```typescript
const [isGenerating, setIsGenerating] = useState(false);
```

4. Add manifest generation function:
```typescript
async function generateManifest() {
  setIsGenerating(true);
  try {
    const res = await fetch("/api/manifests/returns", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    const data = await res.json();

    if (data.success) {
      toast.success(`Manifest generat cu ${data.itemCount} AWB-uri`);
      router.push(`/returns/manifest?id=${data.manifestId}`);
    } else {
      toast.error(data.error || "Eroare la generarea manifestului");
    }
  } catch (err: any) {
    toast.error(err.message);
  } finally {
    setIsGenerating(false);
  }
}
```

5. Add the button in the page header area (typically next to other action buttons):
```tsx
<div className="flex gap-2">
  <Button
    variant="outline"
    onClick={generateManifest}
    disabled={isGenerating}
  >
    <FileText className="h-4 w-4 mr-2" />
    {isGenerating ? "Se genereaza..." : "Genereaza Manifest"}
  </Button>
  {/* existing buttons */}
</div>
```

6. Add link to view existing manifests:
```tsx
<Button
  variant="ghost"
  onClick={() => router.push("/returns/manifest")}
>
  Vezi Manifeste
</Button>
```
  </action>
  <verify>
- Returns page has "Genereaza Manifest" button
- Button calls POST /api/manifests/returns on click
- Success navigates to manifest detail page
- "Vezi Manifeste" link navigates to manifest list
  </verify>
  <done>Returns page updated with manifest generation button and link to manifests</done>
</task>

<task type="auto">
  <name>Task 3: Add pagination UI to returns page</name>
  <files>src/app/(dashboard)/returns/page.tsx</files>
  <action>
Update the returns page to use the new pagination from the API.

1. Add pagination state:
```typescript
const [offset, setOffset] = useState(0);
const [total, setTotal] = useState(0);
const limit = 50;
```

2. Update the fetch call to include pagination params (this is the critical fix for BORD-12):
```typescript
// CRITICAL: Pass offset and limit to API to fix the 100-item pagination bug
const res = await fetch(`/api/returns?limit=${limit}&offset=${offset}`);
```

3. Extract pagination from response:
```typescript
if (data.success) {
  setScannedReturns(data.data.scannedReturns);
  setPendingReturns(data.data.pendingReturns);
  setStats(data.data.stats);
  setTotal(data.data.pagination?.total || 0);
}
```

4. Add pagination controls at the bottom of the table:
```tsx
{total > limit && (
  <div className="flex items-center justify-between mt-4 px-4">
    <p className="text-sm text-muted-foreground">
      Afisare {offset + 1} - {Math.min(offset + limit, total)} din {total}
    </p>
    <div className="flex gap-2">
      <Button
        variant="outline"
        size="sm"
        onClick={() => setOffset(Math.max(0, offset - limit))}
        disabled={offset === 0}
      >
        Inapoi
      </Button>
      <Button
        variant="outline"
        size="sm"
        onClick={() => setOffset(offset + limit)}
        disabled={offset + limit >= total}
      >
        Inainte
      </Button>
    </div>
  </div>
)}
```

5. Add useEffect to refetch when offset changes:
```typescript
useEffect(() => {
  loadReturns();
}, [offset]);
```
  </action>
  <verify>
- Pagination controls appear when more than 50 returns exist
- Previous/Next buttons navigate between pages
- Page displays correct range (e.g., "Afisare 1 - 50 din 150")
- Fetch call includes offset and limit parameters
- More than 100 returns can now be displayed (fixing BORD-12)
  </verify>
  <done>Returns page updated with pagination controls. Fetch call now passes offset/limit to API, fixing the 100-item pagination bug (BORD-12)</done>
</task>

</tasks>

<verification>
1. Sidebar displays all new navigation links
2. Returns page has "Genereaza Manifest" button in header
3. Button creates manifest and navigates to detail page
4. Pagination controls work on returns page
5. All new pages are accessible via navigation
6. Permissions respected for each navigation item
</verification>

<success_criteria>
- Users can navigate to /returns/manifest from sidebar
- Users can navigate to /reports/delivery-manifest from sidebar
- Users can navigate to /reports/stuck-shipments from sidebar
- Users can navigate to /settings/security from sidebar
- Returns page allows manifest generation with one click
- Returns page shows all returns with pagination
</success_criteria>

<output>
After completion, create `.planning/phases/07.10-borderou-curier-stornare/07.10-10-SUMMARY.md`
</output>
