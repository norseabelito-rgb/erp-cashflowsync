---
phase: 07.10-borderou-curier-stornare
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/manual/add_courier_manifest_tables.sql
autonomous: true

must_haves:
  truths:
    - "CourierManifest table exists with type and status tracking"
    - "ManifestItem table links AWB to invoice for processing"
    - "PINApprovalRequest table tracks exception requests"
    - "Invoice model has cancellationSource and paymentSource fields"
    - "Settings model has pinHash field for PIN storage"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "CourierManifest, ManifestItem, PINApprovalRequest models + enums"
      contains: "model CourierManifest"
    - path: "prisma/migrations/manual/add_courier_manifest_tables.sql"
      provides: "SQL migration for new tables"
      min_lines: 50
  key_links:
    - from: "ManifestItem"
      to: "Invoice"
      via: "invoiceId FK"
      pattern: "invoiceId.*String"
    - from: "PINApprovalRequest"
      to: "Invoice"
      via: "invoiceId FK"
      pattern: "invoiceId.*String"
---

<objective>
Add database models for courier manifest processing: CourierManifest, ManifestItem, PINApprovalRequest, and extend Invoice and Settings models.

Purpose: Foundation for manifest-based invoice cancellation and payment marking with PIN exception approval.
Output: Prisma schema with new models and SQL migration file for Railway.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.10-borderou-curier-stornare/CONTEXT.md
@.planning/phases/07.10-borderou-curier-stornare/07.10-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add manifest enums and models to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following enums and models to prisma/schema.prisma:

**Enums (add after existing enums section):**
```prisma
enum ManifestType {
  RETURN      // Borderou retururi
  DELIVERY    // Borderou livrari
}

enum ManifestStatus {
  DRAFT               // Just created
  PENDING_VERIFICATION // Sent to Office
  CONFIRMED           // Office verified
  PROCESSED           // All invoices updated
}

enum ManifestItemStatus {
  PENDING     // Not yet processed
  PROCESSED   // Successfully processed
  ERROR       // Failed to process
}

enum PINApprovalType {
  STORNARE    // Cancel invoice
  INCASARE    // Mark as paid
}

enum PINApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum CancellationSource {
  MANIFEST_RETURN
  PIN_APPROVAL
}

enum PaymentSource {
  MANIFEST_DELIVERY
  PIN_APPROVAL
}
```

**Models (add after existing models):**
```prisma
model CourierManifest {
  id            String          @id @default(cuid())
  type          ManifestType    // RETURN or DELIVERY
  status        ManifestStatus  @default(DRAFT)
  documentDate  DateTime        // Date of the manifest/borderou
  courierRef    String?         // Reference from FanCourier (optional)
  createdAt     DateTime        @default(now())
  confirmedAt   DateTime?
  confirmedById String?
  confirmedBy   User?           @relation("ManifestConfirmedBy", fields: [confirmedById], references: [id])
  processedAt   DateTime?
  items         ManifestItem[]

  // For tracking which invoices were cancelled/paid from this manifest
  cancelledInvoices Invoice[] @relation("CancelledFromManifest")
  paidInvoices      Invoice[] @relation("PaidFromManifest")

  @@index([type, status])
  @@index([documentDate])
  @@map("courier_manifests")
}

model ManifestItem {
  id              String              @id @default(cuid())
  manifestId      String
  manifest        CourierManifest     @relation(fields: [manifestId], references: [id], onDelete: Cascade)
  awbNumber       String              // AWB number from manifest
  originalAwb     String?             // For returns: original outbound AWB
  invoiceId       String?             // Linked invoice
  invoice         Invoice?            @relation(fields: [invoiceId], references: [id])
  orderId         String?             // Direct link to order
  order           Order?              @relation(fields: [orderId], references: [id])
  processedAt     DateTime?
  status          ManifestItemStatus  @default(PENDING)
  errorMessage    String?

  @@index([manifestId])
  @@index([invoiceId])
  @@index([awbNumber])
  @@map("manifest_items")
}

model PINApprovalRequest {
  id            String              @id @default(cuid())
  type          PINApprovalType     // STORNARE or INCASARE
  status        PINApprovalStatus   @default(PENDING)
  invoiceId     String
  invoice       Invoice             @relation(fields: [invoiceId], references: [id])
  requestedById String
  requestedBy   User                @relation("PINRequestedBy", fields: [requestedById], references: [id])
  reason        String?             // Why manual operation is needed
  createdAt     DateTime            @default(now())
  expiresAt     DateTime            // 5 min from creation
  resolvedAt    DateTime?
  resolvedById  String?
  resolvedBy    User?               @relation("PINResolvedBy", fields: [resolvedById], references: [id])

  @@index([status])
  @@index([invoiceId])
  @@index([expiresAt])
  @@map("pin_approval_requests")
}
```

**Extend Invoice model (add fields after existing fields):**
```prisma
  // Source tracking for cancellations (manifest or PIN approval)
  cancellationSource  CancellationSource?
  cancelledFromManifestId String?
  cancelledFromManifest   CourierManifest? @relation("CancelledFromManifest", fields: [cancelledFromManifestId], references: [id])

  // Source tracking for payments (manifest or PIN approval)
  paymentSource       PaymentSource?
  paidFromManifestId  String?
  paidFromManifest    CourierManifest? @relation("PaidFromManifest", fields: [paidFromManifestId], references: [id])

  // Relations
  manifestItems       ManifestItem[]
  pinApprovals        PINApprovalRequest[]
```

**Extend Settings model (add field):**
```prisma
  // PIN for exception approvals (bcrypt hash)
  pinHash      String?
  pinChangedAt DateTime?
```

**Extend User model (add relations):**
```prisma
  // Courier Manifest relations
  manifestsConfirmed    CourierManifest[]    @relation("ManifestConfirmedBy")
  pinRequestsSubmitted  PINApprovalRequest[] @relation("PINRequestedBy")
  pinRequestsResolved   PINApprovalRequest[] @relation("PINResolvedBy")
```

**Extend Order model (add relation):**
```prisma
  manifestItems ManifestItem[]
```

Run `npx prisma format` after adding to ensure proper formatting.
  </action>
  <verify>Run `npx prisma validate` - should pass with no errors</verify>
  <done>Schema contains CourierManifest, ManifestItem, PINApprovalRequest models with all required enums and Invoice/Settings extensions</done>
</task>

<task type="auto">
  <name>Task 2: Create SQL migration file for Railway</name>
  <files>prisma/migrations/manual/add_courier_manifest_tables.sql</files>
  <action>
Create SQL migration file with the following content:

```sql
-- Migration: Add Courier Manifest Tables
-- Phase: 7.10 - Courier Manifest & Invoice Reconciliation
-- Date: 2026-02-07
-- Purpose: Enable manifest-based invoice cancellation and payment marking

-- Create enums
CREATE TYPE "ManifestType" AS ENUM ('RETURN', 'DELIVERY');
CREATE TYPE "ManifestStatus" AS ENUM ('DRAFT', 'PENDING_VERIFICATION', 'CONFIRMED', 'PROCESSED');
CREATE TYPE "ManifestItemStatus" AS ENUM ('PENDING', 'PROCESSED', 'ERROR');
CREATE TYPE "PINApprovalType" AS ENUM ('STORNARE', 'INCASARE');
CREATE TYPE "PINApprovalStatus" AS ENUM ('PENDING', 'APPROVED', 'REJECTED', 'EXPIRED');
CREATE TYPE "CancellationSource" AS ENUM ('MANIFEST_RETURN', 'PIN_APPROVAL');
CREATE TYPE "PaymentSource" AS ENUM ('MANIFEST_DELIVERY', 'PIN_APPROVAL');

-- Create courier_manifests table
CREATE TABLE "courier_manifests" (
    "id" TEXT NOT NULL,
    "type" "ManifestType" NOT NULL,
    "status" "ManifestStatus" NOT NULL DEFAULT 'DRAFT',
    "documentDate" TIMESTAMP(3) NOT NULL,
    "courierRef" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "confirmedAt" TIMESTAMP(3),
    "confirmedById" TEXT,
    "processedAt" TIMESTAMP(3),

    CONSTRAINT "courier_manifests_pkey" PRIMARY KEY ("id")
);

-- Create manifest_items table
CREATE TABLE "manifest_items" (
    "id" TEXT NOT NULL,
    "manifestId" TEXT NOT NULL,
    "awbNumber" TEXT NOT NULL,
    "originalAwb" TEXT,
    "invoiceId" TEXT,
    "orderId" TEXT,
    "processedAt" TIMESTAMP(3),
    "status" "ManifestItemStatus" NOT NULL DEFAULT 'PENDING',
    "errorMessage" TEXT,

    CONSTRAINT "manifest_items_pkey" PRIMARY KEY ("id")
);

-- Create pin_approval_requests table
CREATE TABLE "pin_approval_requests" (
    "id" TEXT NOT NULL,
    "type" "PINApprovalType" NOT NULL,
    "status" "PINApprovalStatus" NOT NULL DEFAULT 'PENDING',
    "invoiceId" TEXT NOT NULL,
    "requestedById" TEXT NOT NULL,
    "reason" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "expiresAt" TIMESTAMP(3) NOT NULL,
    "resolvedAt" TIMESTAMP(3),
    "resolvedById" TEXT,

    CONSTRAINT "pin_approval_requests_pkey" PRIMARY KEY ("id")
);

-- Add columns to invoices table
ALTER TABLE "invoices" ADD COLUMN "cancellationSource" "CancellationSource";
ALTER TABLE "invoices" ADD COLUMN "cancelledFromManifestId" TEXT;
ALTER TABLE "invoices" ADD COLUMN "paymentSource" "PaymentSource";
ALTER TABLE "invoices" ADD COLUMN "paidFromManifestId" TEXT;

-- Add columns to settings table
ALTER TABLE "settings" ADD COLUMN "pinHash" TEXT;
ALTER TABLE "settings" ADD COLUMN "pinChangedAt" TIMESTAMP(3);

-- Create indexes
CREATE INDEX "courier_manifests_type_status_idx" ON "courier_manifests"("type", "status");
CREATE INDEX "courier_manifests_documentDate_idx" ON "courier_manifests"("documentDate");
CREATE INDEX "manifest_items_manifestId_idx" ON "manifest_items"("manifestId");
CREATE INDEX "manifest_items_invoiceId_idx" ON "manifest_items"("invoiceId");
CREATE INDEX "manifest_items_awbNumber_idx" ON "manifest_items"("awbNumber");
CREATE INDEX "pin_approval_requests_status_idx" ON "pin_approval_requests"("status");
CREATE INDEX "pin_approval_requests_invoiceId_idx" ON "pin_approval_requests"("invoiceId");
CREATE INDEX "pin_approval_requests_expiresAt_idx" ON "pin_approval_requests"("expiresAt");

-- Add foreign keys
ALTER TABLE "courier_manifests" ADD CONSTRAINT "courier_manifests_confirmedById_fkey"
    FOREIGN KEY ("confirmedById") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE "manifest_items" ADD CONSTRAINT "manifest_items_manifestId_fkey"
    FOREIGN KEY ("manifestId") REFERENCES "courier_manifests"("id") ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "manifest_items" ADD CONSTRAINT "manifest_items_invoiceId_fkey"
    FOREIGN KEY ("invoiceId") REFERENCES "invoices"("id") ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE "manifest_items" ADD CONSTRAINT "manifest_items_orderId_fkey"
    FOREIGN KEY ("orderId") REFERENCES "orders"("id") ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE "pin_approval_requests" ADD CONSTRAINT "pin_approval_requests_invoiceId_fkey"
    FOREIGN KEY ("invoiceId") REFERENCES "invoices"("id") ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "pin_approval_requests" ADD CONSTRAINT "pin_approval_requests_requestedById_fkey"
    FOREIGN KEY ("requestedById") REFERENCES "users"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

ALTER TABLE "pin_approval_requests" ADD CONSTRAINT "pin_approval_requests_resolvedById_fkey"
    FOREIGN KEY ("resolvedById") REFERENCES "users"("id") ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE "invoices" ADD CONSTRAINT "invoices_cancelledFromManifestId_fkey"
    FOREIGN KEY ("cancelledFromManifestId") REFERENCES "courier_manifests"("id") ON DELETE SET NULL ON UPDATE CASCADE;

ALTER TABLE "invoices" ADD CONSTRAINT "invoices_paidFromManifestId_fkey"
    FOREIGN KEY ("paidFromManifestId") REFERENCES "courier_manifests"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- Verification query
DO $$
BEGIN
    RAISE NOTICE 'Migration completed successfully';
    RAISE NOTICE 'Tables created: courier_manifests, manifest_items, pin_approval_requests';
    RAISE NOTICE 'Columns added to invoices: cancellationSource, cancelledFromManifestId, paymentSource, paidFromManifestId';
    RAISE NOTICE 'Columns added to settings: pinHash, pinChangedAt';
END $$;
```
  </action>
  <verify>File exists and SQL syntax is valid (no syntax errors when reviewed)</verify>
  <done>SQL migration file created with all tables, enums, indexes, and foreign keys for courier manifest system</done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma client and verify schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Run the following commands to validate and generate the Prisma client:

1. Run `npx prisma format` to format schema
2. Run `npx prisma validate` to validate schema
3. Run `npx prisma generate` to generate client types

If there are any errors, fix them before proceeding. Common issues:
- Missing commas between model fields
- Duplicate relation names (use named relations with @relation)
- Missing @map for tables
  </action>
  <verify>
All three commands succeed:
- `npx prisma format` completes without errors
- `npx prisma validate` outputs "Prisma schema loaded"
- `npx prisma generate` outputs "Generated Prisma Client"
  </verify>
  <done>Prisma client generated with CourierManifest, ManifestItem, PINApprovalRequest types available</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx prisma generate` succeeds
3. SQL migration file exists at prisma/migrations/manual/add_courier_manifest_tables.sql
4. Schema includes all 7 new enums: ManifestType, ManifestStatus, ManifestItemStatus, PINApprovalType, PINApprovalStatus, CancellationSource, PaymentSource
5. Schema includes 3 new models: CourierManifest, ManifestItem, PINApprovalRequest
6. Invoice model extended with 4 new fields: cancellationSource, cancelledFromManifestId, paymentSource, paidFromManifestId
7. Settings model extended with 2 new fields: pinHash, pinChangedAt
</verification>

<success_criteria>
- CourierManifest model supports RETURN and DELIVERY types with DRAFT -> PENDING_VERIFICATION -> CONFIRMED -> PROCESSED workflow
- ManifestItem links AWB numbers to invoices and orders for processing
- PINApprovalRequest tracks exception approvals with 5-minute expiry
- Invoice tracks source of cancellation/payment (manifest or PIN approval)
- Settings stores bcrypt-hashed PIN for exception approvals
- SQL migration ready for Railway deployment
</success_criteria>

<output>
After completion, create `.planning/phases/07.10-borderou-curier-stornare/07.10-01-SUMMARY.md`
</output>
