---
phase: 07.10
plan: 01
subsystem: database
tags: [prisma, postgresql, manifest, invoice, pin-approval]
requires:
  - none
provides:
  - CourierManifest model
  - ManifestItem model
  - PINApprovalRequest model
  - Invoice cancellation/payment source tracking
  - Settings PIN hash storage
affects:
  - 07.10-02 (manifest API will use these models)
  - 07.10-03 (PIN service will use pinHash field)
  - 07.10-04 (return manifest processing)
  - 07.10-05 (delivery manifest processing)
tech-stack:
  added: []
  patterns:
    - "Enum-based status workflow (DRAFT -> PENDING_VERIFICATION -> CONFIRMED -> PROCESSED)"
    - "Nullable FK for optional relations (cancelledFromManifestId)"
    - "Named relations for multiple FKs to same model"
key-files:
  created:
    - prisma/migrations/manual/add_courier_manifest_tables.sql
  modified:
    - prisma/schema.prisma
decisions:
  - decision: "Used named relations for manifest-invoice links"
    why: "Invoice links to CourierManifest for both cancellation and payment source"
    impact: "Requires explicit relation names in Prisma queries"
  - decision: "PIN hash stored in Settings singleton"
    why: "Single PIN for exception approvals across the system"
    impact: "Simple model, no per-user PIN support"
  - decision: "ManifestItem links to both Invoice and Order"
    why: "Direct order link as fallback when invoice may not exist yet"
    impact: "Flexibility in manifest processing workflow"
metrics:
  duration: 3 minutes
  completed: 2026-02-07
---

# Phase 7.10 Plan 01: Database Models for Courier Manifest Summary

Database schema extended with CourierManifest, ManifestItem, PINApprovalRequest models plus Invoice/Settings extensions for manifest-based invoice cancellation and payment tracking.

## What Was Done

### Task 1: Add manifest enums and models to Prisma schema (d3154fb)

Added 7 new enums to support manifest workflow:
- `ManifestType` (RETURN, DELIVERY)
- `ManifestStatus` (DRAFT, PENDING_VERIFICATION, CONFIRMED, PROCESSED)
- `ManifestItemStatus` (PENDING, PROCESSED, ERROR)
- `PINApprovalType` (STORNARE, INCASARE)
- `PINApprovalStatus` (PENDING, APPROVED, REJECTED, EXPIRED)
- `CancellationSource` (MANIFEST_RETURN, PIN_APPROVAL)
- `PaymentSource` (MANIFEST_DELIVERY, PIN_APPROVAL)

Added 3 new models:
- `CourierManifest` - Represents a borderou (return or delivery)
- `ManifestItem` - Links AWB to invoice for processing
- `PINApprovalRequest` - Tracks exception approval workflow

Extended existing models:
- `Invoice` - Added cancellationSource, cancelledFromManifestId, paymentSource, paidFromManifestId, manifestItems, pinApprovals
- `Settings` - Added pinHash, pinChangedAt
- `User` - Added manifestsConfirmed, pinRequestsSubmitted, pinRequestsResolved
- `Order` - Added manifestItems

### Task 2: Create SQL migration file (ddfc8ca)

Created `prisma/migrations/manual/add_courier_manifest_tables.sql` (116 lines) with:
- 7 enum type definitions
- 3 table creations with proper columns and constraints
- 4 new columns on invoices table
- 2 new columns on settings table
- 8 indexes for query performance
- 9 foreign key constraints

### Task 3: Validate and format schema

- Ran `npx prisma format` - completed successfully
- Ran `npx prisma validate` - schema is valid
- Note: `npx prisma generate` failed due to root-owned files in node_modules/.prisma (infrastructure issue, not schema issue)

## Task Commits

| Task | Commit | Files Changed |
|------|--------|---------------|
| Task 1: Schema models | d3154fb | prisma/schema.prisma |
| Task 2: SQL migration | ddfc8ca | prisma/migrations/manual/add_courier_manifest_tables.sql |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

1. `npx prisma validate` - PASSED
2. SQL migration file exists - PASSED (116 lines > 50 required)
3. Schema includes all 7 new enums - PASSED
4. Schema includes 3 new models - PASSED
5. Invoice model extended with 4 new fields - PASSED
6. Settings model extended with 2 new fields - PASSED

## Next Phase Readiness

Ready for 07.10-02 (Manifest API routes):
- All database models in place
- SQL migration ready for Railway deployment
- Prisma client will generate correctly once permission issue is resolved

## Self-Check: PASSED
