---
phase: 07.9-reception-workflow
plan: 04
type: execute
wave: 2
depends_on: ["07.9-01"]
files_modified:
  - src/app/api/supplier-invoices/route.ts
  - src/app/api/supplier-invoices/[id]/route.ts
  - src/app/api/supplier-invoices/upload/route.ts
autonomous: true

must_haves:
  truths:
    - "Supplier invoices can be created with invoice details and linked to purchase orders"
    - "Invoice scans can be uploaded and stored"
    - "Payment status is tracked (NEPLATITA, PARTIAL_PLATITA, PLATITA)"
  artifacts:
    - path: "src/app/api/supplier-invoices/route.ts"
      provides: "Supplier invoice CRUD operations"
      exports: ["GET", "POST"]
    - path: "src/app/api/supplier-invoices/[id]/route.ts"
      provides: "Single invoice operations"
      exports: ["GET", "PUT", "DELETE"]
    - path: "src/app/api/supplier-invoices/upload/route.ts"
      provides: "Invoice document upload"
      exports: ["POST"]
  key_links:
    - from: "supplier-invoices/route.ts"
      to: "prisma.supplierInvoice"
      via: "database queries"
      pattern: "prisma\\.supplierInvoice"
    - from: "upload/route.ts"
      to: "file storage"
      via: "writeFile"
      pattern: "writeFile|mkdir"
---

<objective>
Create Supplier Invoices CRUD API with document upload capability and payment tracking.

Purpose: Track supplier invoices received during goods reception with payment status monitoring
Output: Complete API for supplier invoice management with document storage
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.9-reception-workflow/07.9-RESEARCH.md
@.planning/phases/07.9-reception-workflow/07.9-01-SUMMARY.md
@src/app/api/upload/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supplier Invoices CRUD API</name>
  <files>src/app/api/supplier-invoices/route.ts, src/app/api/supplier-invoices/[id]/route.ts</files>
  <action>
**src/app/api/supplier-invoices/route.ts:**

GET: List supplier invoices
- Pagination (page, limit)
- Filters:
  - supplierId
  - purchaseOrderId
  - paymentStatus (NEPLATITA, PARTIAL_PLATITA, PLATITA)
  - dateFrom, dateTo (invoiceDate range)
- Search by: invoiceNumber, invoiceSeries, supplier.name
- Include: supplier (name), purchaseOrder (documentNumber)
- Order by: invoiceDate DESC

Stats:
- Total count by payment status
- Sum of totalWithVat by payment status

POST: Create supplier invoice
- Accept:
  - supplierId (required)
  - purchaseOrderId (optional - link to PO)
  - invoiceNumber (required)
  - invoiceSeries (optional)
  - invoiceDate (required)
  - totalValue (required)
  - vatValue (optional)
  - totalWithVat (optional, auto-calc if vatValue provided)
  - paymentDueDate (optional)
  - notes (optional)
- Validate:
  - Supplier exists
  - If purchaseOrderId provided, PO exists and supplier matches
  - Unique constraint: supplierId + invoiceNumber + invoiceSeries
- Return created invoice with supplier

**src/app/api/supplier-invoices/[id]/route.ts:**

GET: Single invoice with full details
- Include: supplier, purchaseOrder, receptionReports, goodsReceipts

PUT: Update supplier invoice
- Can update: invoiceNumber, invoiceSeries, invoiceDate, totalValue, vatValue, totalWithVat, paymentStatus, paymentDueDate, paidAt, notes
- If paymentStatus changes to PLATITA, auto-set paidAt if not provided
- Validate unique constraint on update

DELETE: Delete supplier invoice
- Only if no receptionReports or goodsReceipts linked
- Error: "Factura este asociata cu documente de receptie"

Permission: inventory.edit for all operations

Error messages:
- "Furnizorul nu a fost gasit"
- "Numarul facturii este obligatoriu"
- "Data facturii este obligatorie"
- "Valoarea facturii este obligatorie"
- "Factura cu acest numar exista deja pentru acest furnizor"
- "Furnizorul de pe factura nu corespunde cu precomanda"
  </action>
  <verify>
    - POST creates invoice with supplier validation
    - Unique constraint prevents duplicates
    - GET returns list with stats
    - PUT updates payment status correctly
  </verify>
  <done>
    - Supplier invoices CRUD with validation
    - Payment status tracking
    - Stats by payment status
    - Linked to purchase orders
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Invoice Upload Endpoint</name>
  <files>src/app/api/supplier-invoices/upload/route.ts</files>
  <action>
POST: Upload invoice document scan

Accept FormData:
- file (required): PDF, JPG, PNG, WEBP
- supplierInvoiceId (required): ID of invoice to attach to

Validate:
- Invoice exists
- File type is allowed (pdf, jpg, jpeg, png, webp)
- File size < 10MB

Storage:
- Path: /uploads/facturi-furnizori/{supplierId}/{invoiceId}/{filename}
- Generate unique filename: {uuid}.{ext}
- Use existing UPLOAD_DIR from upload/route.ts

Update:
- Set supplierInvoice.documentPath = relative storage path

Return:
- success: true
- documentPath: stored path

Follow the upload pattern from src/app/api/upload/route.ts:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import prisma from "@/lib/db";
import { hasPermission } from "@/lib/permissions";
import { writeFile, mkdir } from "fs/promises";
import { join } from "path";
import { randomUUID } from "crypto";

const UPLOAD_DIR = process.env.UPLOAD_DIR || "./uploads";
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
const ALLOWED_TYPES = ['application/pdf', 'image/jpeg', 'image/png', 'image/webp'];
const ALLOWED_EXTENSIONS = ['pdf', 'jpg', 'jpeg', 'png', 'webp'];

export async function POST(request: NextRequest) {
  // Auth check
  // Permission check (inventory.edit)
  // Parse FormData
  // Validate file type and size
  // Get invoice, verify exists
  // Create directory if needed
  // Save file
  // Update invoice.documentPath
  // Return success
}
```

Error messages:
- "Factura nu a fost gasita"
- "Fisierul este obligatoriu"
- "Tip de fisier invalid. Acceptat: PDF, JPG, PNG"
- "Fisierul este prea mare. Maximum 10MB"
  </action>
  <verify>
    - Upload accepts PDF and images
    - File stored in correct path
    - Invoice.documentPath updated
    - Error on invalid file type
  </verify>
  <done>
    - Invoice documents can be uploaded and stored
    - Path stored in database for retrieval
    - Validation prevents invalid uploads
  </done>
</task>

</tasks>

<verification>
1. Create invoice: returns with generated ID and supplier
2. Upload document: file saved, documentPath updated
3. List invoices: pagination, filtering, stats work
4. Update payment: status changes, paidAt auto-set
5. Delete blocked when linked to reception
</verification>

<success_criteria>
- Supplier invoices track all invoice details
- Documents can be uploaded and stored
- Payment status tracked with timestamps
- Validation prevents duplicates and invalid data
- Linked to purchase orders with supplier matching
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-04-SUMMARY.md`
</output>
