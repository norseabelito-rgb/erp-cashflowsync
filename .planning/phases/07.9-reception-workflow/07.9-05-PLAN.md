---
phase: 07.9-reception-workflow
plan: 05
type: execute
wave: 2
depends_on: ["07.9-01"]
files_modified:
  - src/lib/reception-workflow.ts
  - src/app/api/goods-receipts/[id]/send-office/route.ts
  - src/app/api/goods-receipts/[id]/verify/route.ts
  - src/app/api/goods-receipts/[id]/approve/route.ts
  - src/app/api/goods-receipts/[id]/approve-differences/route.ts
  - src/app/api/goods-receipts/[id]/reject/route.ts
  - src/app/api/goods-receipts/[id]/transfer-stock/route.ts
autonomous: true

must_haves:
  truths:
    - "NIR workflow follows: GENERAT -> TRIMIS_OFFICE -> VERIFICAT -> APROBAT -> IN_STOC"
    - "Differences require manager approval before stock transfer"
    - "Stock transfer happens only at IN_STOC status"
    - "State transitions are validated with guards"
  artifacts:
    - path: "src/lib/reception-workflow.ts"
      provides: "State machine for NIR workflow"
      exports: ["transitionNIR", "NIR_TRANSITIONS"]
    - path: "src/app/api/goods-receipts/[id]/transfer-stock/route.ts"
      provides: "Final stock transfer on approval"
      exports: ["POST"]
  key_links:
    - from: "reception-workflow.ts"
      to: "goods-receipts API routes"
      via: "import transitionNIR"
      pattern: "transitionNIR"
    - from: "transfer-stock/route.ts"
      to: "inventory-stock.ts"
      via: "addInventoryStockFromWarehouse"
      pattern: "addInventoryStockFromWarehouse"
---

<objective>
Create NIR workflow API endpoints implementing the 6-state workflow with validation guards and stock transfer.

Purpose: Enable Office verification and manager approval workflow for goods receipts
Output: Complete NIR workflow from GENERAT to IN_STOC with stock operations
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.9-reception-workflow/07.9-RESEARCH.md
@.planning/phases/07.9-reception-workflow/07.9-01-SUMMARY.md
@src/lib/inventory-stock.ts
@src/app/api/goods-receipts/[id]/complete/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NIR workflow state machine</name>
  <files>src/lib/reception-workflow.ts</files>
  <action>
Create state machine for NIR workflow with validation guards:

```typescript
import prisma from "./db";
import { Prisma, GoodsReceiptStatus } from "@prisma/client";

// NIR status type for the new workflow
type NIRWorkflowStatus = 'GENERAT' | 'TRIMIS_OFFICE' | 'VERIFICAT' | 'APROBAT' | 'IN_STOC' | 'RESPINS';

export interface TransitionContext {
  userId: string;
  userName: string;
}

export interface TransitionResult {
  success: boolean;
  error?: string;
  nir?: any;
}

interface TransitionConfig {
  validFrom: NIRWorkflowStatus[];
  guard: (nir: any, context?: TransitionContext) => Promise<{ valid: boolean; error?: string }>;
  postAction?: (nir: any, tx: Prisma.TransactionClient, context?: TransitionContext) => Promise<void>;
}

export const NIR_TRANSITIONS: Record<NIRWorkflowStatus, TransitionConfig> = {
  GENERAT: {
    // Initial state - no transition TO this state
    validFrom: [],
    guard: async () => ({ valid: false, error: 'Status initial - nu se poate tranzitiona' })
  },
  TRIMIS_OFFICE: {
    validFrom: ['GENERAT'],
    guard: async (nir) => {
      if (!nir.supplierInvoiceId) {
        return { valid: false, error: 'Factura furnizor este obligatorie' };
      }
      return { valid: true };
    },
    postAction: async (nir, tx) => {
      await tx.goodsReceipt.update({
        where: { id: nir.id },
        data: { sentToOfficeAt: new Date() }
      });
    }
  },
  VERIFICAT: {
    validFrom: ['TRIMIS_OFFICE'],
    guard: async () => ({ valid: true }),
    postAction: async (nir, tx, context) => {
      await tx.goodsReceipt.update({
        where: { id: nir.id },
        data: {
          verifiedAt: new Date(),
          verifiedBy: context?.userId,
          verifiedByName: context?.userName
        }
      });
    }
  },
  APROBAT: {
    validFrom: ['VERIFICAT'],
    guard: async (nir) => {
      // If has differences, must have differences approved
      if (nir.hasDifferences && !nir.differencesApprovedBy) {
        return { valid: false, error: 'Diferentele trebuie aprobate de manager' };
      }
      return { valid: true };
    }
  },
  IN_STOC: {
    validFrom: ['APROBAT'],
    guard: async () => ({ valid: true }),
    postAction: async (nir, tx) => {
      await tx.goodsReceipt.update({
        where: { id: nir.id },
        data: { transferredToStockAt: new Date() }
      });
      // Actual stock transfer happens in transfer-stock/route.ts
    }
  },
  RESPINS: {
    validFrom: ['VERIFICAT'],
    guard: async () => ({ valid: true })
  }
};

/**
 * Transition NIR to a new status with validation
 */
export async function transitionNIR(
  nirId: string,
  targetStatus: NIRWorkflowStatus,
  context: TransitionContext
): Promise<TransitionResult> {
  const nir = await prisma.goodsReceipt.findUnique({
    where: { id: nirId },
    include: {
      items: { include: { item: true } },
      supplier: true
    }
  });

  if (!nir) {
    return { success: false, error: 'NIR nu a fost gasit' };
  }

  const transition = NIR_TRANSITIONS[targetStatus];
  if (!transition) {
    return { success: false, error: `Status invalid: ${targetStatus}` };
  }

  // Check if transition is valid from current status
  const currentStatus = nir.status as NIRWorkflowStatus;
  if (!transition.validFrom.includes(currentStatus)) {
    return {
      success: false,
      error: `Tranzitie invalida: ${currentStatus} -> ${targetStatus}`
    };
  }

  // Run guard
  const guardResult = await transition.guard(nir, context);
  if (!guardResult.valid) {
    return { success: false, error: guardResult.error };
  }

  // Execute transition in transaction
  const updatedNir = await prisma.$transaction(async (tx) => {
    const updated = await tx.goodsReceipt.update({
      where: { id: nirId },
      data: { status: targetStatus as GoodsReceiptStatus }
    });

    if (transition.postAction) {
      await transition.postAction(nir, tx, context);
    }

    return updated;
  });

  return { success: true, nir: updatedNir };
}

/**
 * Approve differences (manager action)
 */
export async function approveDifferences(
  nirId: string,
  context: TransitionContext
): Promise<TransitionResult> {
  const nir = await prisma.goodsReceipt.findUnique({
    where: { id: nirId }
  });

  if (!nir) {
    return { success: false, error: 'NIR nu a fost gasit' };
  }

  if (nir.status !== 'VERIFICAT') {
    return { success: false, error: 'NIR-ul trebuie sa fie in status VERIFICAT' };
  }

  if (!nir.hasDifferences) {
    return { success: false, error: 'NIR-ul nu are diferente de aprobat' };
  }

  const updated = await prisma.goodsReceipt.update({
    where: { id: nirId },
    data: {
      differencesApprovedBy: context.userId,
      differencesApprovedByName: context.userName,
      differencesApprovedAt: new Date()
    }
  });

  return { success: true, nir: updated };
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/reception-workflow.ts`</verify>
  <done>State machine with validation guards for all NIR status transitions</done>
</task>

<task type="auto">
  <name>Task 2: Create workflow API endpoints</name>
  <files>
    src/app/api/goods-receipts/[id]/send-office/route.ts
    src/app/api/goods-receipts/[id]/verify/route.ts
    src/app/api/goods-receipts/[id]/approve/route.ts
    src/app/api/goods-receipts/[id]/approve-differences/route.ts
    src/app/api/goods-receipts/[id]/reject/route.ts
  </files>
  <action>
Create API endpoints that use the state machine:

**send-office/route.ts:**
POST: Send NIR to office for verification (GENERAT -> TRIMIS_OFFICE)
- Uses transitionNIR(id, 'TRIMIS_OFFICE', context)
- Permission: inventory.edit
- Note: Notification creation happens in Plan 10

**verify/route.ts:**
POST: Office marks NIR as verified (TRIMIS_OFFICE -> VERIFICAT)
- Uses transitionNIR(id, 'VERIFICAT', context)
- Permission: reception.verify (new permission - add to constants)
- If hasDifferences = true, return warning that manager approval needed

**approve/route.ts:**
POST: Approve NIR for stock transfer (VERIFICAT -> APROBAT)
- Uses transitionNIR(id, 'APROBAT', context)
- Permission: reception.verify
- Will fail if hasDifferences and not approved by manager

**approve-differences/route.ts:**
POST: Manager approves differences (George action)
- Uses approveDifferences(id, context)
- Permission: reception.approve_differences (new permission)
- Only available when status = VERIFICAT and hasDifferences = true

**reject/route.ts:**
POST: Manager rejects NIR (VERIFICAT -> RESPINS)
- Uses transitionNIR(id, 'RESPINS', context)
- Permission: reception.approve_differences
- Accept: reason (optional text)
- Store rejection reason in notes field

Each endpoint follows this pattern:
```typescript
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return NextResponse.json({ error: "Neautorizat" }, { status: 401 });
  }

  const canDo = await hasPermission(session.user.id, "permission.name");
  if (!canDo) {
    return NextResponse.json({ error: "Nu ai permisiunea necesara" }, { status: 403 });
  }

  const result = await transitionNIR(
    params.id,
    'TARGET_STATUS',
    { userId: session.user.id, userName: session.user.name || session.user.email || '' }
  );

  if (!result.success) {
    return NextResponse.json({ success: false, error: result.error }, { status: 400 });
  }

  return NextResponse.json({ success: true, data: result.nir });
}
```
  </action>
  <verify>
    - Each endpoint returns appropriate success/error
    - Invalid transitions return 400 with error message
    - Permissions enforced
  </verify>
  <done>
    - NIR can be sent to office
    - Office can verify NIR
    - Manager can approve differences or reject
    - Normal approval for NIRs without differences
  </done>
</task>

<task type="auto">
  <name>Task 3: Create stock transfer endpoint</name>
  <files>src/app/api/goods-receipts/[id]/transfer-stock/route.ts</files>
  <action>
POST: Transfer NIR items to stock (APROBAT -> IN_STOC)

This is the final step that actually adds inventory.

Steps:
1. Validate NIR status is APROBAT
2. Get primary warehouse using getPrimaryWarehouse() from inventory-stock.ts
3. For each GoodsReceiptItem:
   - Use addInventoryStockFromWarehouse() to add stock
   - Movement type: 'INTRARE_NIR'
   - Reference: NIR receipt number
4. Transition to IN_STOC

```typescript
import { transitionNIR } from "@/lib/reception-workflow";
import { addInventoryStockFromWarehouse, getPrimaryWarehouse } from "@/lib/inventory-stock";

export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const session = await getServerSession(authOptions);
  // Auth and permission checks (reception.verify)

  const { id } = params;

  const nir = await prisma.goodsReceipt.findUnique({
    where: { id },
    include: {
      items: { include: { item: true } }
    }
  });

  if (!nir) {
    return NextResponse.json({ error: 'NIR nu a fost gasit' }, { status: 404 });
  }

  if (nir.status !== 'APROBAT') {
    return NextResponse.json({
      error: 'NIR-ul trebuie sa fie in status APROBAT'
    }, { status: 400 });
  }

  // Idempotency check
  if (nir.status === 'IN_STOC') {
    return NextResponse.json({
      success: true,
      message: 'Stocul a fost deja transferat',
      alreadyProcessed: true
    });
  }

  // Get primary warehouse
  const warehouse = await getPrimaryWarehouse();
  if (!warehouse) {
    return NextResponse.json({
      error: 'Nu exista depozit principal configurat'
    }, { status: 400 });
  }

  // Process stock transfer in transaction
  await prisma.$transaction(async (tx) => {
    for (const item of nir.items) {
      // Add stock using existing function
      await addInventoryStockFromWarehouse({
        itemId: item.itemId,
        warehouseId: warehouse.id,
        quantity: Number(item.quantity),
        reason: `Intrare NIR ${nir.receiptNumber}`,
        userId: session.user.id,
        userName: session.user.name || session.user.email || '',
        referenceType: 'receipt',
        referenceId: nir.id
      }, tx);
    }

    // Update NIR status
    await tx.goodsReceipt.update({
      where: { id },
      data: {
        status: 'IN_STOC',
        transferredToStockAt: new Date(),
        warehouseId: warehouse.id
      }
    });
  });

  return NextResponse.json({
    success: true,
    message: `Stocul a fost transferat din NIR ${nir.receiptNumber}`
  });
}
```

Note: The addInventoryStockFromWarehouse function already:
- Creates WarehouseStock record if needed
- Updates InventoryItem.currentStock
- Creates InventoryStockMovement for audit trail
  </action>
  <verify>
    - Stock transfer only works from APROBAT status
    - Idempotent (can be called again safely)
    - InventoryItem.currentStock increases
    - Movement records created
  </verify>
  <done>
    - Stock transfer uses existing inventory-stock.ts functions
    - All items added to primary warehouse
    - Audit trail via InventoryStockMovement
    - NIR warehouseId set after transfer
  </done>
</task>

</tasks>

<verification>
1. Full workflow: GENERAT -> TRIMIS_OFFICE -> VERIFICAT -> APROBAT -> IN_STOC
2. Differences flow: VERIFICAT requires approve-differences before APROBAT
3. Rejection flow: VERIFICAT -> RESPINS stops the process
4. Stock transfer: InventoryItem.currentStock increases correctly
5. Invalid transitions return appropriate errors
</verification>

<success_criteria>
- All 6 NIR statuses have clear transition paths
- Validation guards prevent invalid state changes
- Differences require explicit manager approval
- Stock transfer uses unified InventoryItem system
- State machine is reusable and testable
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-05-SUMMARY.md`
</output>
