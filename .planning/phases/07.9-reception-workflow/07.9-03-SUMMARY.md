---
phase: 07.9
plan: 03
subsystem: inventory/reception
tags: [api, reception-reports, photo-upload, nir-generation]
dependency-graph:
  requires:
    - "07.9-01: Schema Extensions"
  provides:
    - "Reception Reports CRUD API"
    - "Line Items batch update API"
    - "Photo upload by category API"
    - "Finalization with NIR generation"
  affects:
    - "07.9-07: Reception UI"
    - "07.9-10: Notifications"
tech-stack:
  added: []
  patterns:
    - "FormData handling for file upload"
    - "Transaction-based state machine workflow"
    - "Validation with aggregated errors"
key-files:
  created:
    - src/app/api/reception-reports/route.ts
    - src/app/api/reception-reports/[id]/route.ts
    - src/app/api/reception-reports/[id]/items/route.ts
    - src/app/api/reception-reports/[id]/photos/route.ts
    - src/app/api/reception-reports/[id]/finalize/route.ts
  modified: []
decisions:
  - id: "07.9-03-d1"
    title: "PV number format"
    summary: "Report numbers use PV-DD/MM/YYYY-NNNN format, reset daily"
  - id: "07.9-03-d2"
    title: "NIR number format"
    summary: "NIR numbers use NIR-DD/MM/YYYY-NNNN format, reset daily"
  - id: "07.9-03-d3"
    title: "Photo storage path structure"
    summary: "Photos stored at /uploads/receptii/{purchaseOrderId}/{receptionReportId}/{filename}"
  - id: "07.9-03-d4"
    title: "Status auto-transition to IN_COMPLETARE"
    summary: "Report status transitions to IN_COMPLETARE when first data or photo added"
  - id: "07.9-03-d5"
    title: "Validation aggregation"
    summary: "Finalization returns all validation errors at once, not stopping at first error"
metrics:
  duration: "3m 32s"
  completed: "2026-02-06"
---

# Phase 7.9 Plan 03: Reception Reports API Summary

**One-liner:** Complete Reception Reports API with photo upload by category and finalization that generates NIR with 7-point validation

## Objective Achieved

Created the full Reception Reports API enabling warehouse staff to document goods received vs expected with photo evidence. The finalization endpoint validates all requirements before generating the NIR (GoodsReceipt).

## Commits

| Hash | Type | Description |
|------|------|-------------|
| `124c03b` | feat | Create Reception Reports CRUD API with PO item copying |
| `eadf5c0` | feat | Create Line Items batch update and Photo Upload APIs |
| `c4ccadc` | feat | Create Finalization endpoint with NIR generation |

## Implementation Details

### Reception Reports CRUD (`/reception-reports`)

**GET - List reports:**
- Filters: status, purchaseOrderId, warehouseUserId
- Search: reportNumber, PO documentNumber, supplier name
- Includes: purchaseOrder with supplier, supplierInvoice, item/photo counts
- Stats per status (deschis, inCompletare, finalizat)

**POST - Create from purchase order:**
- Validates PO exists and is APROBATA or IN_RECEPTIE
- Prevents duplicate open reports for same PO
- Auto-copies items from PurchaseOrderItem to ReceptionReportItem
- Sets quantityExpected = quantityOrdered, quantityReceived = null
- Updates PO status to IN_RECEPTIE

### Single Report (`/reception-reports/[id]`)

**GET:** Full details with all relations (PO, supplier, invoice, items, photos, NIR)

**PUT:** Update metadata (supplierInvoiceId, signatureConfirmed) - only DESCHIS/IN_COMPLETARE

**DELETE:** Remove report - only DESCHIS, reverts PO status if no other reports

### Line Items (`/reception-reports/[id]/items`)

**GET:** List items with inventoryItem details (sku, name, unit, costPrice)

**PUT:** Batch update with validation:
- Updates quantityReceived, verified, observations
- Auto-calculates hasDifference when received != expected
- Requires observations for items with differences
- Updates report.hasDifferences aggregate
- Transitions status to IN_COMPLETARE when data entered

### Photo Upload (`/reception-reports/[id]/photos`)

**GET:** Photos grouped by category with counts

**POST:** Upload with FormData:
- Validates category (OVERVIEW, ETICHETE, DETERIORARI, FACTURA)
- Validates image type (JPEG, PNG, WebP, HEIC)
- Max size 10MB
- Storage: `/uploads/receptii/{poId}/{reportId}/{uuid}.{ext}`

**DELETE:** Remove photo with file cleanup

### Finalization (`/reception-reports/[id]/finalize`)

**POST:** Validates 7 requirements then generates NIR:

1. All items have quantityReceived filled
2. All items verified = true
3. Items with hasDifference have observations
4. Required photos: OVERVIEW, ETICHETE, FACTURA
5. DETERIORARI photo required if "deteriora" in observations
6. supplierInvoiceId is set
7. signatureConfirmed = true

**On success (atomic transaction):**
- Creates GoodsReceipt with status GENERAT
- Creates GoodsReceiptItem for each line
- Calculates totals (items, quantity, value)
- Updates ReceptionReport status to FINALIZAT
- Updates PurchaseOrder status to RECEPTIONATA

### Error Messages (Romanian)

```
"Completati cantitatea primita pentru toate produsele"
"Verificati toate liniile. Neverificate: {SKUs}"
"Completati observatii pentru: {SKUs}"
"Lipseste poza {category}"
"Exista deteriorari notate - poza obligatorie"
"Factura furnizor este obligatorie"
"Confirmati semnatura gestionar"
```

## API Endpoints Summary

| Method | Path | Purpose |
|--------|------|---------|
| GET | /reception-reports | List reports with filters |
| POST | /reception-reports | Create from purchase order |
| GET | /reception-reports/[id] | Get single report |
| PUT | /reception-reports/[id] | Update metadata |
| DELETE | /reception-reports/[id] | Delete (DESCHIS only) |
| GET | /reception-reports/[id]/items | List items |
| PUT | /reception-reports/[id]/items | Batch update items |
| GET | /reception-reports/[id]/photos | List photos by category |
| POST | /reception-reports/[id]/photos | Upload photo |
| DELETE | /reception-reports/[id]/photos?photoId= | Delete photo |
| POST | /reception-reports/[id]/finalize | Finalize and generate NIR |

## Verification Results

- Reception reports created from approved POs with copied items
- Items track expected vs received quantities
- Differences auto-detected and flagged
- Photos organized by category (OVERVIEW, ETICHETE, DETERIORARI, FACTURA)
- Finalization validates all 7 requirements
- NIR generated atomically with report finalization
- Status flow: PO APROBATA -> IN_RECEPTIE -> RECEPTIONATA
- All error messages in Romanian

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Ready for:**
- 07.9-07: Reception UI (warehouse dashboard, PV completion, photos)
- 07.9-10: Notifications (Office notified when NIR generated)

**Dependencies satisfied:**
- Schema from 07.9-01 used correctly
- API follows existing patterns (goods-receipts, upload)
