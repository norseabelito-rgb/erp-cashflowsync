---
phase: 07.9-reception-workflow
plan: 08
type: execute
wave: 3
depends_on: ["07.9-05"]
files_modified:
  - src/app/(dashboard)/inventory/receipts/office/page.tsx
  - src/app/(dashboard)/inventory/receipts/pending-approval/page.tsx
  - src/app/(dashboard)/inventory/receipts/[id]/page.tsx
  - src/components/inventory/NIRWorkflowActions.tsx
autonomous: true

must_haves:
  truths:
    - "Office dashboard shows NIRs pending verification"
    - "Manager approval page shows NIRs with differences"
    - "NIR detail page shows workflow actions based on status"
    - "Stock transfer can be triggered from approved NIR"
  artifacts:
    - path: "src/app/(dashboard)/inventory/receipts/office/page.tsx"
      provides: "Office verification dashboard"
      min_lines: 100
    - path: "src/app/(dashboard)/inventory/receipts/pending-approval/page.tsx"
      provides: "Manager approval page for differences"
      min_lines: 80
    - path: "src/components/inventory/NIRWorkflowActions.tsx"
      provides: "Workflow action buttons component"
      min_lines: 60
  key_links:
    - from: "office/page.tsx"
      to: "/api/goods-receipts"
      via: "fetch"
      pattern: "fetch.*api/goods-receipts"
    - from: "NIRWorkflowActions.tsx"
      to: "workflow API endpoints"
      via: "fetch"
      pattern: "fetch.*/verify|/approve|/transfer-stock"
---

<objective>
Create Office Dashboard and Manager Approval pages for NIR verification workflow.

Purpose: Enable Office (Denisa) to verify NIRs and Manager (George) to approve differences
Output: Complete verification and approval UI for NIR workflow
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.9-reception-workflow/07.9-RESEARCH.md
@.planning/phases/07.9-reception-workflow/07.9-05-SUMMARY.md
@src/app/(dashboard)/inventory/receipts/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Office Verification Dashboard</name>
  <files>src/app/(dashboard)/inventory/receipts/office/page.tsx</files>
  <action>
Create Office verification dashboard:

**Header:**
- Title: "Verificare NIR-uri" with icon (ClipboardCheck from lucide-react)

**Stats Cards Row:**
- Asteptare verificare (count of TRIMIS_OFFICE)
- Cu diferente (count of hasDifferences = true in TRIMIS_OFFICE or VERIFICAT)
- Verificate azi (count of VERIFICAT + APROBAT + IN_STOC from today)

**Pending Verification Section:**
- Title: "De verificat"
- Table of NIRs with status TRIMIS_OFFICE:
  - Nr. NIR (link to detail)
  - Furnizor
  - Data trimitere (sentToOfficeAt)
  - Valoare totala
  - Diferente badge (warning if hasDifferences)
  - Actiuni: "Verifica" button

**Verified Awaiting Approval Section:**
- Title: "Asteptare aprobare diferente"
- Table of NIRs with status VERIFICAT and hasDifferences = true and differencesApprovedBy = null
  - Shows these need George's approval before proceeding

**Ready for Stock Transfer Section:**
- Title: "Gata de transfer"
- Table of NIRs with status APROBAT
  - "Transfer in stoc" button

Fetch: GET /api/goods-receipts with status filters

For Office users (reception.verify permission), show all sections.
Highlight NIRs with hasDifferences using warning color.
  </action>
  <verify>
    - Dashboard shows correct NIR counts
    - Tables filter by status correctly
    - Links navigate to detail page
  </verify>
  <done>
    - Office can see all NIRs needing verification
    - Difference warnings clearly visible
    - Quick actions available from dashboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Manager Approval Page</name>
  <files>src/app/(dashboard)/inventory/receipts/pending-approval/page.tsx</files>
  <action>
Create Manager approval page for differences:

**Header:**
- Title: "Aprobare diferente" with icon (AlertTriangle from lucide-react)

**Info Alert:**
- Explain that these NIRs have quantity or price differences that need manager approval

**Pending Approval Table:**
- NIRs with status VERIFICAT and hasDifferences = true and differencesApprovedBy = null
- Columns:
  - Nr. NIR (link to detail)
  - Furnizor
  - Data verificare (verifiedAt)
  - Verificat de (verifiedByName)
  - Valoare totala
  - Actiuni: "Verifica detalii" button

**Detail expand or modal:**
- When clicking "Verifica detalii":
  - Show items with differences highlighted
  - Show observations for each difference
  - Show photos (especially DETERIORARI if exists)
  - Actions:
    - "Aproba diferentele" -> POST /approve-differences then /approve
    - "Respinge" -> opens reason modal -> POST /reject

**Approval flow:**
1. Review differences in detail
2. Approve differences: POST /api/goods-receipts/[id]/approve-differences
3. Then approve NIR: POST /api/goods-receipts/[id]/approve
4. Success: NIR moves to APROBAT, ready for stock transfer

**Rejection flow:**
1. Click "Respinge"
2. Enter reason (required)
3. POST /api/goods-receipts/[id]/reject with reason
4. Success: NIR moves to RESPINS

This page requires reception.approve_differences permission.
  </action>
  <verify>
    - Only NIRs with differences show
    - Approval updates difference fields and status
    - Rejection requires reason
    - Proper permission check
  </verify>
  <done>
    - Manager can review all NIRs with differences
    - Approve or reject with reason
    - Clear workflow for difference handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Create NIR Detail Page and Workflow Actions</name>
  <files>
    src/app/(dashboard)/inventory/receipts/[id]/page.tsx
    src/components/inventory/NIRWorkflowActions.tsx
  </files>
  <action>
**NIRWorkflowActions.tsx:**
Reusable component for NIR workflow actions:

Props:
- nir: GoodsReceipt (with status, hasDifferences, differencesApprovedBy, etc.)
- onAction: () => void (refetch callback)

Displays action buttons based on status:

GENERAT:
- "Trimite la Office" button -> POST /send-office

TRIMIS_OFFICE:
- "Verifica" button (Office) -> POST /verify
- Shows "Asteptare verificare Office" if user is not Office

VERIFICAT:
- If hasDifferences and not approved:
  - "Asteptare aprobare George" message
  - "Aproba diferentele" + "Respinge" (if Manager)
- If no differences or differences approved:
  - "Aproba" button -> POST /approve

APROBAT:
- "Transfer in stoc" button -> POST /transfer-stock
- Shows warning: "Aceasta actiune va adauga stocul"

IN_STOC:
- "Stocul a fost transferat" success message
- Date of transfer

RESPINS:
- "NIR respins" error message
- Rejection reason
- No further actions

Each action:
- Shows loading state during API call
- Shows success/error toast
- Calls onAction() to refetch NIR data

**[id]/page.tsx:**
NIR detail page:

**Header:**
- Back button
- NIR number and status badge
- Workflow status timeline (visual)

**Info Section:**
- Cards with: Supplier, Invoice, Reception Report link, Dates

**Items Table:**
- All GoodsReceiptItem records
- Columns: SKU, Denumire, Cantitate, Pret unitar, Total, Observatii
- Highlight rows with differences

**Photos Section (if from reception):**
- Display photos from linked ReceptionReport
- Grouped by category

**Workflow Actions:**
- NIRWorkflowActions component

**History/Audit Section:**
- Timeline of status changes with dates and users
- sentToOfficeAt, verifiedAt, differencesApprovedAt, transferredToStockAt
  </action>
  <verify>
    - Workflow actions appear based on status
    - Actions call correct API endpoints
    - Detail page shows all NIR information
    - Permission checks in place
  </verify>
  <done>
    - NIR detail page with full information
    - Workflow actions component reusable
    - Status-appropriate actions displayed
    - Audit trail visible
  </done>
</task>

</tasks>

<verification>
1. Office dashboard shows pending NIRs correctly
2. Manager page shows only NIRs with differences
3. Approve/reject flows work correctly
4. Stock transfer creates inventory movements
5. All actions respect permissions
</verification>

<success_criteria>
- Office can verify NIRs from dedicated dashboard
- Manager can approve/reject differences
- NIR detail shows complete information
- Workflow actions are context-aware
- Stock transfer is the final step
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-08-SUMMARY.md`
</output>
