---
phase: 07.9
plan: 05
subsystem: inventory/reception
tags: [api, workflow, state-machine, stock-transfer, nir]
dependency-graph:
  requires:
    - "07.9-01: Schema Extensions (GoodsReceipt extended fields)"
  provides:
    - "NIR workflow state machine (transitionNIR, approveDifferences)"
    - "Workflow API endpoints (send-office, verify, approve, reject)"
    - "Stock transfer endpoint (APROBAT -> IN_STOC)"
  affects:
    - "07.9-06: Purchase Orders UI (uses workflow status)"
    - "07.9-08: Office Dashboard (verify/approve actions)"
    - "07.9-10: Notifications (trigger on workflow transitions)"
tech-stack:
  added: []
  patterns:
    - "State machine with validation guards"
    - "Transition context for audit trail"
    - "Idempotent stock transfer"
key-files:
  created:
    - src/lib/reception-workflow.ts
    - src/app/api/goods-receipts/[id]/send-office/route.ts
    - src/app/api/goods-receipts/[id]/verify/route.ts
    - src/app/api/goods-receipts/[id]/approve/route.ts
    - src/app/api/goods-receipts/[id]/approve-differences/route.ts
    - src/app/api/goods-receipts/[id]/reject/route.ts
    - src/app/api/goods-receipts/[id]/transfer-stock/route.ts
  modified:
    - src/lib/permissions.ts
decisions:
  - id: "07.9-05-d1"
    title: "State machine validation guards"
    summary: "Each transition has guard functions that validate preconditions (e.g., supplierInvoice required for TRIMIS_OFFICE)"
  - id: "07.9-05-d2"
    title: "Difference approval separate from workflow"
    summary: "approveDifferences() is separate action, not a status transition. NIR stays in VERIFICAT until approved."
  - id: "07.9-05-d3"
    title: "Stock transfer uses RECEIPT movement type"
    summary: "Stock additions use InventoryMovementType.RECEIPT for consistency with existing complete/route.ts"
  - id: "07.9-05-d4"
    title: "New permissions for reception workflow"
    summary: "reception.verify (Office), reception.approve_differences (George), inventory.edit (extended)"
metrics:
  duration: "3m 34s"
  completed: "2026-02-06"
---

# Phase 7.9 Plan 05: NIR Workflow APIs Summary

**One-liner:** State machine with 6-status workflow + 7 API endpoints for complete NIR lifecycle from GENERAT to IN_STOC

## Objective Achieved

Created the complete NIR workflow implementation with validation guards, API endpoints for each workflow action, and stock transfer functionality using the unified InventoryItem system.

## Commits

| Hash | Type | Description |
|------|------|-------------|
| `dbf39b6` | feat | Create NIR workflow state machine (reception-workflow.ts) |
| `46dd961` | feat | Create NIR workflow API endpoints (5 endpoints) + permissions |
| `eb7f397` | feat | Create stock transfer endpoint |

## Implementation Details

### State Machine (src/lib/reception-workflow.ts)

**Workflow Flow:**
```
GENERAT -> TRIMIS_OFFICE -> VERIFICAT -> APROBAT -> IN_STOC
                                    \-> RESPINS
```

**Functions:**
- `transitionNIR(nirId, targetStatus, context)` - Execute validated status transition
- `approveDifferences(nirId, context)` - Manager approves differences
- `getAvailableTransitions(nirId)` - Get valid next statuses

**Validation Guards:**
- TRIMIS_OFFICE: Requires supplierInvoiceId
- APROBAT: Requires differencesApprovedBy if hasDifferences=true
- All others: No preconditions

### API Endpoints

| Endpoint | Method | Transition | Permission |
|----------|--------|------------|------------|
| `/api/goods-receipts/[id]/send-office` | POST | GENERAT -> TRIMIS_OFFICE | inventory.edit |
| `/api/goods-receipts/[id]/verify` | POST | TRIMIS_OFFICE -> VERIFICAT | reception.verify |
| `/api/goods-receipts/[id]/approve` | POST | VERIFICAT -> APROBAT | reception.verify |
| `/api/goods-receipts/[id]/approve-differences` | POST | (sets differencesApprovedBy) | reception.approve_differences |
| `/api/goods-receipts/[id]/reject` | POST | VERIFICAT -> RESPINS | reception.approve_differences |
| `/api/goods-receipts/[id]/transfer-stock` | POST | APROBAT -> IN_STOC | reception.verify |

### New Permissions Added

| Code | Name | Category |
|------|------|----------|
| `reception.view` | Vizualizare receptie | reception |
| `reception.verify` | Verificare NIR | reception |
| `reception.approve_differences` | Aprobare diferente | reception |
| `inventory.edit` | Editare inventar | inventory |

### Stock Transfer Details

The transfer-stock endpoint:
1. Validates NIR status is APROBAT
2. Gets primary warehouse via `getPrimaryWarehouse()`
3. For each GoodsReceiptItem:
   - Updates/creates WarehouseStock record
   - Updates InventoryItem.currentStock
   - Creates InventoryStockMovement with type RECEIPT
4. Updates NIR to IN_STOC with warehouseId and transferredToStockAt
5. Idempotent: Returns success if already IN_STOC

## Verification Results

- State machine exports: transitionNIR, NIR_TRANSITIONS, approveDifferences
- All 6 endpoints created with proper permission checks
- Stock transfer uses InventoryItem.currentStock (unified system)
- Validation guards prevent invalid transitions
- Note: TypeScript errors expected until prisma generate runs post-migration

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Ready for:**
- 07.9-06: Purchase Orders UI can display workflow status badges
- 07.9-08: Office Dashboard can call verify/approve endpoints
- 07.9-10: Notifications can be triggered in postAction callbacks

**Database migration required:**
Run `prisma/migrations/manual/add_reception_workflow.sql` and `npx prisma generate` before using these endpoints.
