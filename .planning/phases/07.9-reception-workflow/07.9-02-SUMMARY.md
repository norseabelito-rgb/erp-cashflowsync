---
phase: 07.9
plan: 02
subsystem: inventory
tags: ["purchase-orders", "api", "crud", "labels", "document-numbering"]

dependencies:
  requires: ["07.9-01"]
  provides: ["purchase-orders-api", "labels-api", "document-numbering"]
  affects: ["07.9-03", "07.9-06", "07.9-07"]

tech-stack:
  added: []
  patterns: ["daily-auto-increment", "transaction-client-support", "romanian-errors"]

files:
  created:
    - src/lib/document-numbering.ts
    - src/app/api/purchase-orders/route.ts
    - src/app/api/purchase-orders/[id]/route.ts
    - src/app/api/purchase-orders/[id]/approve/route.ts
    - src/app/api/purchase-orders/[id]/labels/route.ts
  modified: []

decisions:
  - id: "07.9-02-01"
    decision: "Document number format PC-DD/MM/YYYY-NNNN with daily auto-increment"
    rationale: "Matches Romanian document conventions, resets each day for manageable numbers"
  - id: "07.9-02-02"
    decision: "Label code format PO-{id8}-{timestamp36}-{random4}"
    rationale: "Unique, compact, includes PO reference for warehouse scanning"
  - id: "07.9-02-03"
    decision: "Labels can only be generated for APROBATA or IN_RECEPTIE orders"
    rationale: "Prevents printing labels for draft orders that may change"
  - id: "07.9-02-04"
    decision: "One label generated per line item (not per quantity)"
    rationale: "Each product type gets one label, quantity shown on label"
  - id: "07.9-02-05"
    decision: "Using any type for Prisma until client regenerated"
    rationale: "New models from 07.9-01 require npx prisma generate"

metrics:
  duration: "~4 minutes"
  completed: "2026-02-06"
---

# Phase 7.9 Plan 02: Purchase Orders CRUD API Summary

Purchase Orders API with document numbering, approval workflow, and label generation for warehouse scanning.

## One-Liner

CRUD API for purchase orders with PC-DD/MM/YYYY-NNNN numbering, DRAFT->APROBATA approval, and unique scannable labels.

## What Was Built

### 1. Document Numbering Utility (`src/lib/document-numbering.ts`)
- `generateDocumentNumber(prefix)` - generates PREFIX-DD/MM/YYYY-NNNN format
- Supports PC (purchase orders), PV (reception reports), NIR (goods receipts)
- Daily auto-increment (resets to 0001 each new day)
- Transaction client support for atomic operations
- `generateLabelCode(poId)` - unique scannable codes for labels

### 2. Purchase Orders CRUD API (`/api/purchase-orders`)
- **GET**: List orders with pagination, search, status/supplier filters
- **POST**: Create order with auto-generated document number
- Returns stats by status (draft, aprobata, in_receptie, receptionata, anulata)

### 3. Single Order Operations (`/api/purchase-orders/[id]`)
- **GET**: Full order details with supplier, items, labels, related reports
- **PUT**: Update order (only DRAFT status allowed)
- **DELETE**: Delete order (only DRAFT status allowed)

### 4. Approval Workflow (`/api/purchase-orders/[id]/approve`)
- **POST**: Transition from DRAFT to APROBATA
- Validates: supplier required, at least one product required
- Records approvedBy, approvedByName, approvedAt

### 5. Labels API (`/api/purchase-orders/[id]/labels`)
- **GET**: List labels with stats (total, printed, not printed)
- **POST**: Generate labels for approved orders (one per line item)
- **PUT**: Mark labels as printed with timestamp and user

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/purchase-orders` | GET | List with pagination and filters |
| `/api/purchase-orders` | POST | Create new purchase order |
| `/api/purchase-orders/[id]` | GET | Get single order with relations |
| `/api/purchase-orders/[id]` | PUT | Update (DRAFT only) |
| `/api/purchase-orders/[id]` | DELETE | Delete (DRAFT only) |
| `/api/purchase-orders/[id]/approve` | POST | Approve (DRAFT -> APROBATA) |
| `/api/purchase-orders/[id]/labels` | GET | List labels |
| `/api/purchase-orders/[id]/labels` | POST | Generate labels |
| `/api/purchase-orders/[id]/labels` | PUT | Mark as printed |

## Validation Rules

- **Supplier**: Required for create and approve
- **Items**: At least one product required
- **Status changes**: Only DRAFT can be edited/deleted
- **Labels**: Only APROBATA/IN_RECEPTIE can generate labels
- **Duplicate labels**: Prevented (error if already generated)

## Romanian Error Messages

- "Precomanda nu a fost gasita"
- "Doar precomenzile in status DRAFT pot fi modificate"
- "Doar precomenzile in status DRAFT pot fi sterse"
- "Furnizorul este obligatoriu"
- "Adaugati cel putin un produs"
- "Etichetele pot fi generate doar pentru precomenzile aprobate sau in receptie"

## Deviations from Plan

None - plan executed exactly as written.

## Commits

| Hash | Message |
|------|---------|
| 6f17b9b | feat(07.9-02): create document numbering utility |
| cb6b42e | feat(07.9-02): create Purchase Orders CRUD API |
| bf847e6 | feat(07.9-02): create Labels API for purchase orders |

## Next Phase Readiness

**Ready for:**
- 07.9-03: Reception Reports API (will use generateDocumentNumber('PV'))
- 07.9-06: Purchase Orders UI (API complete)

**Prerequisites met:**
- Document numbering reusable for PV and NIR
- Purchase orders can be created and approved
- Labels ready for warehouse scanning workflow

**Note:** Run `npx prisma generate` before testing to regenerate Prisma client with new models from 07.9-01.
