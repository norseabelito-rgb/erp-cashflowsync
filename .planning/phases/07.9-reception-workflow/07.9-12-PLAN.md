---
phase: 07.9-reception-workflow
plan: 12
type: execute
wave: 4
depends_on: ["07.9-01"]
files_modified:
  - src/lib/temu-stock-sync.ts
  - src/lib/trendyol-stock-sync.ts
autonomous: true

must_haves:
  truths:
    - "Temu stock sync uses InventoryItem.currentStock"
    - "Trendyol stock sync uses InventoryItem.currentStock"
    - "Stock sync does NOT use Product.stockQuantity or MasterProduct.stock"
  artifacts:
    - path: "src/lib/temu-stock-sync.ts"
      provides: "Temu stock synchronization"
      contains: "InventoryItem"
    - path: "src/lib/trendyol-stock-sync.ts"
      provides: "Trendyol stock synchronization"
      contains: "InventoryItem"
  key_links:
    - from: "temu-stock-sync.ts"
      to: "prisma.inventoryItem"
      via: "stock query"
      pattern: "inventoryItem.*currentStock"
    - from: "trendyol-stock-sync.ts"
      to: "prisma.inventoryItem"
      via: "stock query"
      pattern: "inventoryItem.*currentStock"
---

<objective>
Verify and ensure Temu and Trendyol stock sync correctly uses InventoryItem.currentStock after Phase 7.8 stock unification.

Purpose: Confirm marketplace integrations use unified stock system
Output: Verified stock sync for both marketplaces using InventoryItem
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.8-stock-unification/07.8-SUMMARY.md
@src/lib/temu/
@src/lib/trendyol/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Trendyol stock sync</name>
  <files>src/lib/trendyol-stock-sync.ts</files>
  <action>
Audit the Trendyol stock sync implementation:

1. Find stock sync code (likely in src/lib/trendyol/ or similar)
2. Search for:
   - How stock quantity is obtained for sync
   - Any usage of Product.stockQuantity
   - Any usage of MasterProduct.stock
   - Usage of InventoryItem.currentStock

Expected correct pattern:
```typescript
// CORRECT - uses InventoryItem
const item = await prisma.inventoryItem.findUnique({
  where: { sku },
  select: { currentStock: true }
});
const stockToSync = Number(item.currentStock);
```

If incorrect pattern found (using Product or MasterProduct):
```typescript
// WRONG - legacy pattern
const product = await prisma.product.findFirst({...});
const stock = product.stockQuantity;
```

Update to use InventoryItem.currentStock if needed.

If the sync already uses InventoryItem correctly (likely after Phase 7.8), document this and add a verification comment.

Typical file locations to check:
- src/lib/trendyol/sync.ts
- src/lib/trendyol/stock.ts
- src/app/api/trendyol/sync-stock/route.ts
  </action>
  <verify>
    - grep for "stockQuantity" in trendyol files - should not be used for sync
    - grep for "currentStock" - should be used
  </verify>
  <done>Trendyol stock sync verified or updated to use InventoryItem.currentStock</done>
</task>

<task type="auto">
  <name>Task 2: Audit Temu stock sync</name>
  <files>src/lib/temu-stock-sync.ts</files>
  <action>
Audit the Temu stock sync implementation:

1. Find stock sync code (likely in src/lib/temu/ or similar)
2. Search for:
   - How stock quantity is obtained for sync
   - Any usage of Product.stockQuantity
   - Any usage of MasterProduct.stock
   - Usage of InventoryItem.currentStock

Expected correct pattern:
```typescript
// CORRECT - uses InventoryItem
const item = await prisma.inventoryItem.findFirst({
  where: { sku: temuProduct.sku },
  select: { currentStock: true }
});
const stockToSync = Number(item?.currentStock || 0);
```

If the integration was added in Phase 7.7, it should already use InventoryItem since that was after stock issues were identified. Verify this.

If incorrect pattern found, update to:
1. Query InventoryItem by SKU (matching to MasterProduct/Product if needed)
2. Use currentStock field for the stock value to sync
3. Handle cases where InventoryItem doesn't exist (log warning, use 0)

Typical file locations:
- src/lib/temu/sync.ts
- src/lib/temu/stock.ts
- src/app/api/temu/sync-stock/route.ts
  </action>
  <verify>
    - grep for "stockQuantity" in temu files - should not be used for sync
    - grep for "currentStock" - should be used
  </verify>
  <done>Temu stock sync verified or updated to use InventoryItem.currentStock</done>
</task>

<task type="auto">
  <name>Task 3: Add verification comments and deprecation warnings</name>
  <files>
    src/lib/temu-stock-sync.ts
    src/lib/trendyol-stock-sync.ts
  </files>
  <action>
Add documentation comments to both sync implementations:

1. At the top of stock sync functions, add:
```typescript
/**
 * Stock sync for {Temu/Trendyol}
 *
 * IMPORTANT: Uses InventoryItem.currentStock as the source of truth.
 * DO NOT use Product.stockQuantity or MasterProduct.stock - these are deprecated.
 *
 * @see Phase 7.8 Stock Unification
 * @see .planning/phases/07.8-stock-unification/07.8-SUMMARY.md
 */
```

2. If any fallback to legacy stock exists, add warning:
```typescript
// DEPRECATED: This fallback uses legacy stock. Remove after confirming all products have InventoryItem.
if (!inventoryItem) {
  console.warn(`[DEPRECATED] Product ${sku} has no InventoryItem - using legacy stock`);
  // fallback code...
}
```

3. Create a simple verification script or test:
```typescript
// Add to a test file or verification endpoint
async function verifyStockSync() {
  // Sample check: get a few products and compare stock values
  const samples = await prisma.inventoryItem.findMany({
    take: 5,
    select: { sku: true, currentStock: true }
  });

  // For each, verify the marketplace sync would use the right value
  for (const item of samples) {
    console.log(`SKU ${item.sku}: InventoryItem.currentStock = ${item.currentStock}`);
  }
}
```

4. If everything is already correct, document this in the SUMMARY for this plan.
  </action>
  <verify>
    - Comments added to sync functions
    - No silent usage of deprecated stock fields
    - Clear deprecation warnings if fallbacks exist
  </verify>
  <done>
    - Stock sync implementations documented
    - Deprecation warnings in place for any legacy fallbacks
    - Verification that unified stock is used
  </done>
</task>

</tasks>

<verification>
1. Trendyol sync uses InventoryItem.currentStock
2. Temu sync uses InventoryItem.currentStock
3. No active usage of Product.stockQuantity for marketplace sync
4. Documentation/comments added for future maintainability
5. Any legacy fallbacks have clear deprecation warnings
</verification>

<success_criteria>
- Both marketplace integrations use unified stock
- Clear documentation of stock source
- Deprecation warnings for any legacy fallbacks
- Consistent with Phase 7.8 stock unification
- Stock changes from NIR (via transfer-stock) correctly sync to marketplaces
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-12-SUMMARY.md`
</output>
