---
phase: 07.9-reception-workflow
plan: 11
type: execute
wave: 4
depends_on: ["07.9-01"]
files_modified:
  - src/lib/dashboard-stats.ts
  - src/app/api/dashboard/route.ts
  - src/app/(dashboard)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Low stock alerts use InventoryItem.currentStock"
    - "Dashboard shows accurate low stock warnings"
    - "Product.stockQuantity is NOT used for alerts"
  artifacts:
    - path: "src/lib/dashboard-stats.ts"
      provides: "Dashboard statistics functions"
      contains: "InventoryItem"
    - path: "src/app/api/dashboard/route.ts"
      provides: "Dashboard API endpoint"
      contains: "lowStock"
  key_links:
    - from: "dashboard-stats.ts"
      to: "prisma.inventoryItem"
      via: "low stock query"
      pattern: "inventoryItem.*currentStock"
---

<objective>
Migrate dashboard low stock alerts to use InventoryItem.currentStock instead of legacy Product.stockQuantity.

Purpose: Ensure dashboard alerts use the unified stock system from Phase 7.8
Output: Dashboard shows accurate low stock warnings based on InventoryItem
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.8-stock-unification/07.8-SUMMARY.md
@src/lib/dashboard-stats.ts
@src/app/api/dashboard/route.ts
@src/app/(dashboard)/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit current low stock implementation</name>
  <files>src/lib/dashboard-stats.ts, src/app/api/dashboard/route.ts</files>
  <action>
First, audit where low stock is currently calculated:

1. Search for "stockQuantity" or "lowStock" in dashboard-related files
2. Identify all places where Product.stockQuantity is used for alerts
3. Document what needs to change

Expected locations:
- src/lib/dashboard-stats.ts (if exists)
- src/app/api/dashboard/route.ts
- Dashboard component files

For each location found, plan the migration:
- OLD: Product.stockQuantity < threshold
- NEW: InventoryItem.currentStock < threshold

Note: InventoryItem has minStockLevel field for threshold (if set).
If not using minStockLevel, use a configurable default (e.g., 10).
  </action>
  <verify>List all files using Product.stockQuantity for low stock alerts</verify>
  <done>Identified all locations needing migration from Product to InventoryItem</done>
</task>

<task type="auto">
  <name>Task 2: Update low stock query to use InventoryItem</name>
  <files>src/lib/dashboard-stats.ts, src/app/api/dashboard/route.ts</files>
  <action>
Update the low stock query to use InventoryItem.currentStock:

**Option A: If dashboard-stats.ts exists:**
Update or add function:

```typescript
export async function getLowStockItems(limit = 10) {
  const items = await prisma.inventoryItem.findMany({
    where: {
      isActive: true,
      OR: [
        // Items below their minStockLevel
        {
          minStockLevel: { gt: 0 },
          currentStock: { lt: prisma.inventoryItem.fields.minStockLevel }
        },
        // Items at zero (always flag these)
        { currentStock: { lte: 0 } }
      ]
    },
    select: {
      id: true,
      sku: true,
      name: true,
      currentStock: true,
      minStockLevel: true,
      unit: true,
    },
    orderBy: [
      { currentStock: 'asc' },
    ],
    take: limit
  });

  return items.map(item => ({
    id: item.id,
    sku: item.sku,
    name: item.name,
    currentStock: Number(item.currentStock),
    minStockLevel: Number(item.minStockLevel || 0),
    unit: item.unit,
    status: Number(item.currentStock) <= 0 ? 'out_of_stock' : 'low_stock'
  }));
}
```

**Option B: If directly in dashboard API route:**
Update the query in GET handler to use InventoryItem.

**Also add count for dashboard card:**
```typescript
export async function getLowStockCount() {
  return prisma.inventoryItem.count({
    where: {
      isActive: true,
      OR: [
        {
          minStockLevel: { gt: 0 },
          currentStock: { lt: prisma.inventoryItem.fields.minStockLevel }
        },
        { currentStock: { lte: 0 } }
      ]
    }
  });
}
```

**Important:** Do NOT delete the old Product-based code yet. Add the new InventoryItem-based code and switch to using it. The old code can be deprecated later.

If Prisma doesn't support comparing two fields directly:
```typescript
// Alternative using raw query
const lowStockItems = await prisma.$queryRaw`
  SELECT id, sku, name, current_stock, min_stock_level, unit
  FROM inventory_items
  WHERE is_active = true
    AND (
      (min_stock_level > 0 AND current_stock < min_stock_level)
      OR current_stock <= 0
    )
  ORDER BY current_stock ASC
  LIMIT ${limit}
`;
```
  </action>
  <verify>
    - Query returns items based on InventoryItem.currentStock
    - Items with currentStock < minStockLevel are included
    - Items with currentStock <= 0 always included
  </verify>
  <done>Low stock query uses InventoryItem.currentStock with minStockLevel threshold</done>
</task>

<task type="auto">
  <name>Task 3: Update Dashboard UI</name>
  <files>src/app/(dashboard)/page.tsx</files>
  <action>
Ensure the dashboard UI displays low stock alerts using the updated data:

1. Find the low stock card/section in the dashboard
2. Verify it's using the updated API response
3. Update the display if needed:

**Low Stock Card:**
- Title: "Stoc scazut"
- Count: number of items below threshold
- Click: navigates to inventory page filtered by low stock

**Low Stock List (if shown on dashboard):**
- Item SKU and name
- Current stock vs min level
- Visual indicator (red for out of stock, yellow for low)

If the dashboard already shows a low stock section, verify:
- It fetches from the correct endpoint
- It displays currentStock (not stockQuantity)
- The count matches the updated query

Add tooltip explaining the card:
"Articole cu stoc sub nivelul minim configurat sau la 0"
  </action>
  <verify>
    - Dashboard shows low stock count
    - Count matches InventoryItem query results
    - No references to Product.stockQuantity in dashboard
  </verify>
  <done>Dashboard low stock alerts use unified InventoryItem system</done>
</task>

</tasks>

<verification>
1. Query uses InventoryItem.currentStock
2. Dashboard shows correct low stock count
3. Items with currentStock < minStockLevel flagged
4. Out of stock items (currentStock <= 0) always flagged
5. No Product.stockQuantity usage for alerts
</verification>

<success_criteria>
- Dashboard low stock alerts use InventoryItem.currentStock
- minStockLevel threshold respected per item
- Accurate counts displayed
- Old Product-based code deprecated but not deleted
- Consistent with Phase 7.8 stock unification
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-11-SUMMARY.md`
</output>
