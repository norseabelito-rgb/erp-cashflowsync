---
phase: 07.9
plan: 01
subsystem: inventory/reception
tags: [prisma, database, schema, reception-workflow]
dependency-graph:
  requires: []
  provides:
    - "PurchaseOrder model with 5-state workflow"
    - "ReceptionReport model with 3-state workflow"
    - "SupplierInvoice model with payment tracking"
    - "ReceptionPhoto model for categorized uploads"
    - "GoodsReceipt extended with 9-state workflow"
  affects:
    - "07.9-02: Purchase Orders CRUD API"
    - "07.9-03: Reception Reports API"
    - "07.9-04: Supplier Invoices API"
    - "07.9-05: NIR Workflow APIs"
tech-stack:
  added: []
  patterns:
    - "Idempotent SQL migrations with IF NOT EXISTS"
    - "Extended enum pattern for backward compatibility"
key-files:
  created:
    - prisma/migrations/manual/add_reception_workflow.sql
  modified:
    - prisma/schema.prisma
decisions:
  - id: "07.9-01-d1"
    title: "Backward-compatible enum extension"
    summary: "Keep DRAFT and COMPLETED in GoodsReceiptStatus for backward compatibility with existing NIR records"
  - id: "07.9-01-d2"
    title: "Cascade delete for child models"
    summary: "PurchaseOrderItem, PurchaseOrderLabel, ReceptionReportItem, ReceptionPhoto use onDelete: Cascade"
  - id: "07.9-01-d3"
    title: "Unique constraint on reception_report_id"
    summary: "GoodsReceipt.receptionReportId is unique to enforce 1:1 relationship with ReceptionReport"
metrics:
  duration: "3m 26s"
  completed: "2026-02-06"
---

# Phase 7.9 Plan 01: Schema Extensions for Reception Workflow Summary

**One-liner:** 7 new Prisma models + 4 enums + extended GoodsReceipt for complete goods reception workflow foundation

## Objective Achieved

Created all Prisma models for the reception workflow: PurchaseOrder, ReceptionReport, SupplierInvoice, ReceptionPhoto, and extended GoodsReceipt with the 6-state workflow. This provides the foundation for the complete goods reception system.

## Commits

| Hash | Type | Description |
|------|------|-------------|
| `521c3fc` | feat | Add reception workflow models and enums to schema.prisma |
| `90f8069` | chore | Create SQL migration for reception workflow (443 lines) |
| `b3b251c` | style | Format schema.prisma with prisma format |

## Implementation Details

### New Enums (4)

1. **PurchaseOrderStatus** - DRAFT, APROBATA, IN_RECEPTIE, RECEPTIONATA, ANULATA
2. **ReceptionReportStatus** - DESCHIS, IN_COMPLETARE, FINALIZAT
3. **PaymentStatus** - NEPLATITA, PARTIAL_PLATITA, PLATITA
4. **PhotoCategory** - OVERVIEW, ETICHETE, DETERIORARI, FACTURA

### Extended Enum

**GoodsReceiptStatus** - Now has 9 values:
- DRAFT (deprecated - backward compat)
- GENERAT (NIR creat automat din PV)
- TRIMIS_OFFICE (Trimis la Office pentru verificare)
- VERIFICAT (Verificat de Office)
- APROBAT (Aprobat - direct sau dupa aprobare diferente)
- IN_STOC (Transferat in stoc)
- RESPINS (Respins de George - diferente neaprobate)
- COMPLETED (deprecated - backward compat)
- CANCELLED (Anulat)

### New Models (7)

| Model | Purpose | Key Relations |
|-------|---------|---------------|
| PurchaseOrder | Precomanda - initiaza fluxul | Supplier, items, labels, receptionReports |
| PurchaseOrderItem | Linie precomanda | PurchaseOrder, InventoryItem |
| PurchaseOrderLabel | Etichete scanabile | PurchaseOrder |
| ReceptionReport | PV Receptie - verificare | PurchaseOrder, SupplierInvoice, items, photos, goodsReceipt |
| ReceptionReportItem | Linie PV receptie | ReceptionReport, InventoryItem |
| ReceptionPhoto | Poze receptie | ReceptionReport |
| SupplierInvoice | Factura furnizor | Supplier, PurchaseOrder, receptionReports, goodsReceipts |

### Extended Models

**GoodsReceipt** - 11 new fields:
- receptionReportId, receptionReport (1:1 link)
- supplierInvoiceId, supplierInvoice (FK)
- hasDifferences (Boolean)
- differencesApprovedBy, differencesApprovedByName, differencesApprovedAt
- sentToOfficeAt, verifiedAt, verifiedBy, verifiedByName, transferredToStockAt

**InventoryItem** - 2 new relations:
- purchaseOrderItems
- receptionReportItems

**Supplier** - 2 new relations:
- purchaseOrders
- supplierInvoices

### SQL Migration

File: `prisma/migrations/manual/add_reception_workflow.sql` (443 lines)
- Idempotent (safe to run multiple times)
- Creates all enums with IF NOT EXISTS pattern
- Creates all tables with proper constraints
- Adds all foreign key relationships
- Creates all necessary indexes

## Verification Results

- `npx prisma validate` passes
- Schema formatted with `npx prisma format`
- 7 new models confirmed in schema
- 4 new enums confirmed in schema
- GoodsReceiptStatus has 9 values
- Migration file is 443 lines (above 100 minimum)

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

**Ready for:**
- 07.9-02: Purchase Orders CRUD API (can use PurchaseOrder, PurchaseOrderItem, PurchaseOrderLabel models)
- 07.9-03: Reception Reports API (can use ReceptionReport, ReceptionReportItem, ReceptionPhoto models)
- 07.9-04: Supplier Invoices API (can use SupplierInvoice model)
- 07.9-05: NIR Workflow APIs (can use extended GoodsReceipt model)

**Database migration required:**
Run `prisma/migrations/manual/add_reception_workflow.sql` on staging/production before deploying code that uses these models.
