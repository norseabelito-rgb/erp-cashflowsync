---
phase: 07.9-reception-workflow
plan: 10
type: execute
wave: 4
depends_on: ["07.9-05", "07.9-08"]
files_modified:
  - src/lib/notification-service.ts
  - src/app/api/goods-receipts/[id]/send-office/route.ts
  - src/app/api/goods-receipts/[id]/verify/route.ts
  - src/app/api/goods-receipts/[id]/transfer-stock/route.ts
  - src/lib/reception-workflow.ts
  - src/components/layout/NotificationBell.tsx
  - src/app/(dashboard)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Office is notified when NIR ready for verification"
    - "Manager is notified when differences need approval"
    - "Notifications appear in bell icon dropdown"
    - "Clicking notification navigates to relevant page"
  artifacts:
    - path: "src/lib/notification-service.ts"
      provides: "Notification creation service"
      exports: ["notifyOfficeNIRReady", "notifyGeorgeApprovalNeeded"]
    - path: "src/components/layout/NotificationBell.tsx"
      provides: "Bell icon with dropdown"
      min_lines: 80
  key_links:
    - from: "notification-service.ts"
      to: "prisma.notification"
      via: "createMany"
      pattern: "prisma\\.notification\\.createMany"
    - from: "send-office/route.ts"
      to: "notification-service.ts"
      via: "import notifyOfficeNIRReady"
      pattern: "notifyOfficeNIRReady"
---

<objective>
Implement in-app notification system for NIR workflow events: notify Office when NIR ready, notify Manager when differences need approval.

Purpose: Alert relevant users when action is needed without requiring manual checking
Output: Working notification system integrated into NIR workflow
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.9-reception-workflow/07.9-RESEARCH.md
@.planning/phases/07.9-reception-workflow/07.9-05-SUMMARY.md
@src/app/api/notifications/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Notification Service</name>
  <files>src/lib/notification-service.ts</files>
  <action>
Create notification service for workflow events:

```typescript
import prisma from "./db";

interface NotificationData {
  nirId: string;
  receiptNumber: string;
  supplierId?: string;
  hasDifferences?: boolean;
  [key: string]: any;
}

/**
 * Notify Office users that NIR is ready for verification
 * Called when NIR transitions to TRIMIS_OFFICE
 */
export async function notifyOfficeNIRReady(nirId: string): Promise<void> {
  const nir = await prisma.goodsReceipt.findUnique({
    where: { id: nirId },
    include: { supplier: true }
  });

  if (!nir) return;

  // Find users with reception.verify permission
  const officeUsers = await prisma.user.findMany({
    where: {
      isActive: true,
      userPermissions: {
        some: {
          permission: { code: 'reception.verify' }
        }
      }
    },
    select: { id: true }
  });

  if (officeUsers.length === 0) {
    console.warn('No users with reception.verify permission found for notification');
    return;
  }

  const differenceWarning = nir.hasDifferences ? ' ⚠️ DIFERENTE' : '';

  const notifications = officeUsers.map(user => ({
    userId: user.id,
    type: 'nir_ready_verification',
    title: `NIR ${nir.receiptNumber} - Verificare`,
    message: `NIR de la ${nir.supplier?.name || 'furnizor necunoscut'} asteapta verificare.${differenceWarning}`,
    data: {
      nirId: nir.id,
      receiptNumber: nir.receiptNumber,
      supplierId: nir.supplierId,
      hasDifferences: nir.hasDifferences
    } as NotificationData,
    actionUrl: `/inventory/receipts/${nir.id}`
  }));

  await prisma.notification.createMany({ data: notifications });
}

/**
 * Notify Manager (George) that NIR has differences needing approval
 * Called when NIR with differences transitions to VERIFICAT
 */
export async function notifyGeorgeApprovalNeeded(nirId: string): Promise<void> {
  const nir = await prisma.goodsReceipt.findUnique({
    where: { id: nirId },
    include: { supplier: true }
  });

  if (!nir || !nir.hasDifferences) return;

  // Find users with reception.approve_differences permission
  const approvers = await prisma.user.findMany({
    where: {
      isActive: true,
      userPermissions: {
        some: {
          permission: { code: 'reception.approve_differences' }
        }
      }
    },
    select: { id: true }
  });

  if (approvers.length === 0) {
    console.warn('No users with reception.approve_differences permission found');
    return;
  }

  const notifications = approvers.map(user => ({
    userId: user.id,
    type: 'nir_differences_approval',
    title: `⚠️ NIR ${nir.receiptNumber} - Diferente`,
    message: `NIR de la ${nir.supplier?.name || 'furnizor'} are diferente si necesita aprobare.`,
    data: {
      nirId: nir.id,
      receiptNumber: nir.receiptNumber,
      hasDifferences: true
    } as NotificationData,
    actionUrl: `/inventory/receipts/pending-approval`
  }));

  await prisma.notification.createMany({ data: notifications });
}

/**
 * Notify warehouse user that NIR was approved and stock transferred
 * Optional - for visibility
 */
export async function notifyNIRStockTransferred(nirId: string): Promise<void> {
  const nir = await prisma.goodsReceipt.findUnique({
    where: { id: nirId },
    include: {
      receptionReport: true
    }
  });

  if (!nir || !nir.receptionReport) return;

  // Notify the warehouse user who created the reception
  await prisma.notification.create({
    data: {
      userId: nir.receptionReport.warehouseUserId,
      type: 'nir_stock_transferred',
      title: `✅ NIR ${nir.receiptNumber} - Stoc transferat`,
      message: `Stocul din NIR ${nir.receiptNumber} a fost adaugat in inventar.`,
      data: {
        nirId: nir.id,
        receiptNumber: nir.receiptNumber
      },
      actionUrl: `/inventory/receipts/${nir.id}`
    }
  });
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Notification service with functions for all workflow events</done>
</task>

<task type="auto">
  <name>Task 2: Integrate notifications into workflow</name>
  <files>
    src/app/api/goods-receipts/[id]/send-office/route.ts
    src/lib/reception-workflow.ts
  </files>
  <action>
Update the workflow to trigger notifications:

**send-office/route.ts:**
After successful transition to TRIMIS_OFFICE, call notifyOfficeNIRReady:

```typescript
import { notifyOfficeNIRReady } from "@/lib/notification-service";

// ... after successful transitionNIR ...
if (result.success) {
  // Fire-and-forget notification (don't block response)
  notifyOfficeNIRReady(params.id).catch(err => {
    console.error('Failed to send notification:', err);
  });
}
```

**reception-workflow.ts:**
Update VERIFICAT transition to notify George if differences:

Add to VERIFICAT postAction:
```typescript
postAction: async (nir, tx, context) => {
  await tx.goodsReceipt.update({
    where: { id: nir.id },
    data: {
      verifiedAt: new Date(),
      verifiedBy: context?.userId,
      verifiedByName: context?.userName
    }
  });

  // Notify George if differences (outside transaction)
  if (nir.hasDifferences) {
    // Schedule notification after transaction commits
    setImmediate(async () => {
      const { notifyGeorgeApprovalNeeded } = await import("./notification-service");
      notifyGeorgeApprovalNeeded(nir.id).catch(console.error);
    });
  }
}
```

Or alternatively, update verify/route.ts to call notification after transitionNIR succeeds.

**transfer-stock/route.ts:**
After successful stock transfer, notify warehouse user:

```typescript
import { notifyNIRStockTransferred } from "@/lib/notification-service";

// After successful transfer
notifyNIRStockTransferred(params.id).catch(console.error);
```

Notifications are fire-and-forget (don't block the main action).
  </action>
  <verify>
    - Sending to office creates notification for Office users
    - Verifying NIR with differences notifies George
    - Stock transfer notifies warehouse user
  </verify>
  <done>
    - Notifications triggered at correct workflow points
    - Non-blocking (fire-and-forget)
    - Correct users receive correct notifications
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Notification Bell UI</name>
  <files>
    src/components/layout/NotificationBell.tsx
    src/app/(dashboard)/layout.tsx
  </files>
  <action>
**NotificationBell.tsx:**
Bell icon component with dropdown:

Features:
- Bell icon (Bell from lucide-react)
- Unread count badge (red dot with number)
- Click opens dropdown with notifications
- Mark as read on click
- Mark all as read button
- "Vezi toate" link to full notifications page (if exists)

Implementation:
```typescript
"use client";

import { useState } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Bell } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
  DropdownMenuSeparator,
} from "@/components/ui/dropdown-menu";
import { formatDistanceToNow } from "date-fns";
import { ro } from "date-fns/locale";
import Link from "next/link";
import { useRouter } from "next/navigation";

export function NotificationBell() {
  const router = useRouter();
  const queryClient = useQueryClient();

  const { data } = useQuery({
    queryKey: ["notifications"],
    queryFn: async () => {
      const res = await fetch("/api/notifications?limit=10");
      return res.json();
    },
    refetchInterval: 30000, // Poll every 30s
  });

  const markAsRead = useMutation({
    mutationFn: async (notificationId: string) => {
      await fetch("/api/notifications", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ notificationId }),
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["notifications"] });
    },
  });

  const markAllRead = useMutation({
    mutationFn: async () => {
      await fetch("/api/notifications", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ markAllRead: true }),
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["notifications"] });
    },
  });

  const notifications = data?.notifications || [];
  const unreadCount = data?.unreadCount || 0;

  const handleNotificationClick = async (notification: any) => {
    if (!notification.read) {
      await markAsRead.mutateAsync(notification.id);
    }
    if (notification.actionUrl) {
      router.push(notification.actionUrl);
    }
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" size="icon" className="relative">
          <Bell className="h-5 w-5" />
          {unreadCount > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
              {unreadCount > 9 ? "9+" : unreadCount}
            </span>
          )}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-80">
        <div className="flex justify-between items-center px-3 py-2">
          <span className="font-semibold">Notificari</span>
          {unreadCount > 0 && (
            <Button
              variant="ghost"
              size="sm"
              onClick={() => markAllRead.mutate()}
            >
              Marcheaza citite
            </Button>
          )}
        </div>
        <DropdownMenuSeparator />
        {notifications.length === 0 ? (
          <div className="px-3 py-4 text-center text-muted-foreground">
            Nicio notificare
          </div>
        ) : (
          notifications.map((notification: any) => (
            <DropdownMenuItem
              key={notification.id}
              onClick={() => handleNotificationClick(notification)}
              className={`cursor-pointer ${!notification.read ? "bg-blue-50" : ""}`}
            >
              <div className="flex flex-col gap-1">
                <span className="font-medium">{notification.title}</span>
                <span className="text-sm text-muted-foreground">
                  {notification.message}
                </span>
                <span className="text-xs text-muted-foreground">
                  {formatDistanceToNow(new Date(notification.createdAt), {
                    addSuffix: true,
                    locale: ro,
                  })}
                </span>
              </div>
            </DropdownMenuItem>
          ))
        )}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

**layout.tsx:**
Add NotificationBell to the dashboard header:
- Find the header section in the dashboard layout
- Add <NotificationBell /> next to user menu or in header actions area

If no header component exists, the bell should be added wherever user actions are (typically top-right of dashboard).
  </action>
  <verify>
    - Bell shows in dashboard header
    - Unread count displays
    - Clicking notification marks as read
    - Navigation works on click
  </verify>
  <done>
    - Notification bell integrated into dashboard
    - Unread count visible
    - Notifications clickable with navigation
    - Auto-refresh every 30 seconds
  </done>
</task>

</tasks>

<verification>
1. Send NIR to office creates notification for Office users
2. Verify NIR with differences creates notification for George
3. Bell icon shows unread count
4. Clicking notification navigates to correct page
5. Notifications mark as read on click
</verification>

<success_criteria>
- In-app notifications for NIR workflow events
- Correct users receive correct notifications based on permissions
- Bell icon with unread count in dashboard
- Notifications are actionable (navigate on click)
- Fire-and-forget pattern doesn't block main workflow
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-10-SUMMARY.md`
</output>
