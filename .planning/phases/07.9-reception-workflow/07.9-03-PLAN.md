---
phase: 07.9-reception-workflow
plan: 03
type: execute
wave: 2
depends_on: ["07.9-01"]
files_modified:
  - src/app/api/reception-reports/route.ts
  - src/app/api/reception-reports/[id]/route.ts
  - src/app/api/reception-reports/[id]/items/route.ts
  - src/app/api/reception-reports/[id]/photos/route.ts
  - src/app/api/reception-reports/[id]/finalize/route.ts
autonomous: true

must_haves:
  truths:
    - "Reception reports can be created from purchase orders"
    - "Line items track expected vs received quantities"
    - "Photos can be uploaded with categories (overview, etichete, deteriorari, factura)"
    - "Finalization validates all requirements before generating NIR"
  artifacts:
    - path: "src/app/api/reception-reports/route.ts"
      provides: "Reception report CRUD"
      exports: ["GET", "POST"]
    - path: "src/app/api/reception-reports/[id]/photos/route.ts"
      provides: "Photo upload for reception"
      exports: ["GET", "POST", "DELETE"]
    - path: "src/app/api/reception-reports/[id]/finalize/route.ts"
      provides: "Finalize PV and generate NIR"
      exports: ["POST"]
  key_links:
    - from: "reception-reports/route.ts"
      to: "prisma.receptionReport"
      via: "database queries"
      pattern: "prisma\\.receptionReport"
    - from: "finalize/route.ts"
      to: "prisma.goodsReceipt"
      via: "NIR creation"
      pattern: "prisma\\.goodsReceipt\\.create"
---

<objective>
Create Reception Reports API with line item management, photo upload, and finalization workflow that generates NIR.

Purpose: Enable warehouse staff to document goods received vs expected with photo evidence
Output: Complete API for reception verification including photo management and NIR generation
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07.9-reception-workflow/07.9-RESEARCH.md
@.planning/phases/07.9-reception-workflow/07.9-01-SUMMARY.md
@src/app/api/upload/route.ts
@src/app/api/awb/[id]/comments/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Reception Reports CRUD API</name>
  <files>src/app/api/reception-reports/route.ts, src/app/api/reception-reports/[id]/route.ts</files>
  <action>
**src/app/api/reception-reports/route.ts:**

GET: List reception reports
- Filter by: status, purchaseOrderId, warehouseUserId
- Search by: reportNumber, purchaseOrder.documentNumber
- Include: purchaseOrder (with supplier), items count, photos count
- Pagination like goods-receipts

POST: Create reception report from purchase order
- Accept: purchaseOrderId, supplierInvoiceId (optional)
- Validate:
  - Purchase order exists
  - PO status is APROBATA (then set to IN_RECEPTIE) or already IN_RECEPTIE
  - No existing open report for this PO (prevent duplicates)
- Auto-generate reportNumber using generateDocumentNumber('PV')
- Copy items from PurchaseOrderItem to ReceptionReportItem:
  - quantityExpected = purchaseOrderItem.quantityOrdered
  - quantityReceived = null (to be filled by gestionar)
  - verified = false
- Set warehouseUserId/warehouseUserName from session
- Update PurchaseOrder.status to IN_RECEPTIE if it was APROBATA
- Return created report with items

**src/app/api/reception-reports/[id]/route.ts:**

GET: Single reception report with full details
- Include: purchaseOrder (with supplier), supplierInvoice, items (with inventoryItem), photos, goodsReceipt

PUT: Update reception report metadata
- Only if status is DESCHIS or IN_COMPLETARE
- Can update: supplierInvoiceId, signatureConfirmed
- Cannot update items here (use /items endpoint)

DELETE: Delete reception report
- Only if status is DESCHIS (not started)
- Also revert PurchaseOrder.status to APROBATA if no other reports exist

Permission: inventory.edit for all operations
  </action>
  <verify>
    - POST creates report from PO with copied items
    - GET returns report with all relations
    - PO status transitions correctly
  </verify>
  <done>
    - Reception reports can be created from approved purchase orders
    - Items are auto-copied from PO with expected quantities
    - Report metadata can be updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Line Items API and Photo Upload</name>
  <files>src/app/api/reception-reports/[id]/items/route.ts, src/app/api/reception-reports/[id]/photos/route.ts</files>
  <action>
**src/app/api/reception-reports/[id]/items/route.ts:**

PUT: Update reception report items (batch update)
- Accept: items array of { itemId, quantityReceived, verified, observations }
- Validate:
  - Report status is DESCHIS or IN_COMPLETARE
  - If quantityReceived != quantityExpected, observations required
- For each item:
  - Update quantityReceived, verified, observations
  - Set hasDifference = true if quantityReceived != quantityExpected
- Update report.hasDifferences = any item has hasDifference
- Update report.status to IN_COMPLETARE if currently DESCHIS
- Return updated items

GET: List items for this report
- Include inventoryItem details (sku, name, unit)

**src/app/api/reception-reports/[id]/photos/route.ts:**

Follow the pattern from src/app/api/awb/[id]/comments/route.ts for file handling.

POST: Upload photo
- Accept: FormData with file and category (OVERVIEW, ETICHETE, DETERIORARI, FACTURA)
- Validate:
  - Report status is DESCHIS or IN_COMPLETARE
  - File is image (jpg, jpeg, png, webp, heic)
  - Category is valid enum value
- Storage path: /uploads/receptii/{purchaseOrderId}/{receptionReportId}/{filename}
- Create ReceptionPhoto record
- Return created photo with storagePath

GET: List photos for this report
- Group by category
- Include full details

DELETE: Delete photo
- Accept: photoId query param
- Only if report status is DESCHIS or IN_COMPLETARE
- Delete file from storage
- Delete database record

Use existing UPLOAD_DIR pattern from upload/route.ts.
  </action>
  <verify>
    - Items can be updated with received quantities
    - hasDifference auto-calculated
    - Photos upload to correct path
    - Photos grouped by category in GET
  </verify>
  <done>
    - Line items can be batch-updated with quantities and observations
    - Differences are automatically detected and flagged
    - Photos can be uploaded, listed, and deleted by category
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Finalization Endpoint</name>
  <files>src/app/api/reception-reports/[id]/finalize/route.ts</files>
  <action>
POST: Finalize reception report and generate NIR

Pre-validation checks (V4, V5, V6 from spec):
1. All items have quantityReceived filled (not null)
2. All items are marked verified = true
3. Items with hasDifference must have observations
4. Required photos exist (OVERVIEW, ETICHETE, FACTURA)
5. If any item has "deteriora" in observations, DETERIORARI photo required
6. supplierInvoiceId is set
7. signatureConfirmed = true

If any validation fails, return 400 with specific error messages:
- "Completati cantitatea primita pentru toate produsele"
- "Verificati toate liniile"
- "Completati observatii pentru: {SKUs with differences}"
- "Lipseste poza {category}"
- "Exista deteriorari notate - poza obligatorie"
- "Factura furnizor este obligatorie"
- "Confirmati semnatura gestionar"

On success (in transaction):
1. Update ReceptionReport:
   - status = FINALIZAT
   - finalizedAt = now()
   - finalizedBy, finalizedByName from session

2. Create GoodsReceipt (NIR):
   - receiptNumber using generateDocumentNumber('NIR') with DD/MM/YYYY format
   - supplierId from purchaseOrder
   - supplierInvoiceId from report
   - receptionReportId = report.id
   - status = GENERAT
   - hasDifferences from report
   - Calculate totals from items:
     - totalItems = count
     - totalQuantity = sum of quantityReceived
     - totalValue = sum of (quantityReceived * inventoryItem.costPrice)
   - Create GoodsReceiptItem for each line:
     - itemId = inventoryItemId
     - quantity = quantityReceived
     - unitCost = inventoryItem.costPrice
     - totalCost = quantity * unitCost
     - notes = observations

3. Update PurchaseOrder.status = RECEPTIONATA

Return:
- success: true
- data: created NIR with receiptNumber
- message: "NIR {number} generat cu succes"

Note: Notification to office happens in Plan 10 (notifications system).
  </action>
  <verify>
    - Finalize fails with specific errors when validations fail
    - Finalize creates NIR with correct data
    - PO status changes to RECEPTIONATA
    - Transaction ensures atomicity
  </verify>
  <done>
    - Finalization validates all 7 requirements
    - NIR auto-generated from PV with calculated totals
    - All status transitions happen atomically
    - Clear error messages guide user to fix issues
  </done>
</task>

</tasks>

<verification>
1. Create report from PO: items copied with expected quantities
2. Update items: differences detected, observations required
3. Upload photos: stored in correct path, grouped by category
4. Finalize: all validations enforced, NIR created on success
5. Status flow: PO APROBATA -> IN_RECEPTIE -> RECEPTIONATA
</verification>

<success_criteria>
- Reception reports track expected vs received quantities
- Differences require mandatory observations
- Photos organized by category with validation
- Finalization creates NIR only when all requirements met
- All errors in Romanian guide users to fix issues
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-03-SUMMARY.md`
</output>
