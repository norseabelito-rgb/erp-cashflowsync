---
phase: 07.9-reception-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/migrations/manual/add_reception_workflow.sql
autonomous: true

must_haves:
  truths:
    - "PurchaseOrder model exists with DRAFT/APROBATA/IN_RECEPTIE/RECEPTIONATA/ANULATA status"
    - "ReceptionReport model exists with DESCHIS/IN_COMPLETARE/FINALIZAT status"
    - "SupplierInvoice model exists with payment tracking"
    - "GoodsReceipt extended with 6-state workflow"
    - "ReceptionPhoto model supports categorized uploads"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "All reception workflow models"
      contains: "model PurchaseOrder"
    - path: "prisma/migrations/manual/add_reception_workflow.sql"
      provides: "SQL migration for new tables and enums"
      min_lines: 100
  key_links:
    - from: "PurchaseOrder"
      to: "Supplier"
      via: "supplierId FK"
      pattern: "supplierId.*Supplier"
    - from: "ReceptionReport"
      to: "PurchaseOrder"
      via: "purchaseOrderId FK"
      pattern: "purchaseOrderId.*PurchaseOrder"
    - from: "GoodsReceipt"
      to: "ReceptionReport"
      via: "receptionReportId FK"
      pattern: "receptionReportId.*ReceptionReport"
---

<objective>
Create all Prisma models for the reception workflow: PurchaseOrder, ReceptionReport, SupplierInvoice, ReceptionPhoto, and extend GoodsReceipt with the 6-state workflow.

Purpose: Foundation for the complete goods reception system - all subsequent plans depend on these models
Output: Updated schema.prisma and manual SQL migration script
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.9-reception-workflow/07.9-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Prisma enums and new models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following enums and models to schema.prisma (after the existing GoodsReceipt model section):

**New Enums:**
```prisma
// Purchase Order Status
enum PurchaseOrderStatus {
  DRAFT        // In editare
  APROBATA     // Aprobata, asteapta receptie
  IN_RECEPTIE  // Receptie in curs
  RECEPTIONATA // Finalizata
  ANULATA      // Anulata
}

// Reception Report Status
enum ReceptionReportStatus {
  DESCHIS       // Deschis, se completeaza
  IN_COMPLETARE // In completare cantitati
  FINALIZAT     // Finalizat, NIR generat
}

// Supplier Invoice Payment Status
enum PaymentStatus {
  NEPLATITA
  PARTIAL_PLATITA
  PLATITA
}

// Photo Categories for Reception
enum PhotoCategory {
  OVERVIEW     // Marfa pe paleti
  ETICHETE     // Close-up etichete
  DETERIORARI  // Damage photos
  FACTURA      // Invoice scan
}
```

**New Models:**

```prisma
// Precomanda - initiaza fluxul de receptie
model PurchaseOrder {
  id             String              @id @default(cuid())
  documentNumber String              @unique  // PC-DD/MM/YYYY-NNNN

  supplierId     String
  supplier       Supplier            @relation(fields: [supplierId], references: [id])

  status         PurchaseOrderStatus @default(DRAFT)

  expectedDate   DateTime?           // Data estimata livrare
  notes          String?             @db.Text

  // Totale calculate
  totalItems     Int                 @default(0)
  totalQuantity  Decimal             @default(0) @db.Decimal(10, 3)
  totalValue     Decimal             @default(0) @db.Decimal(12, 2)

  // Workflow tracking
  approvedBy     String?
  approvedByName String?
  approvedAt     DateTime?

  createdBy      String
  createdByName  String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  // Relations
  items            PurchaseOrderItem[]
  labels           PurchaseOrderLabel[]
  receptionReports ReceptionReport[]
  supplierInvoices SupplierInvoice[]

  @@index([status])
  @@index([supplierId])
  @@index([expectedDate])
  @@map("purchase_orders")
}

// Linie precomanda
model PurchaseOrderItem {
  id              String        @id @default(cuid())

  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  quantityOrdered Decimal       @db.Decimal(10, 3)
  unitPrice       Decimal?      @db.Decimal(10, 2)
  totalPrice      Decimal?      @db.Decimal(12, 2)

  notes           String?

  createdAt       DateTime      @default(now())

  @@unique([purchaseOrderId, inventoryItemId])
  @@index([purchaseOrderId])
  @@index([inventoryItemId])
  @@map("purchase_order_items")
}

// Etichete pentru scanare la depozit
model PurchaseOrderLabel {
  id              String        @id @default(cuid())

  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  labelCode       String        @unique  // Scannable barcode/QR value
  printed         Boolean       @default(false)
  printedAt       DateTime?
  printedBy       String?

  createdAt       DateTime      @default(now())

  @@index([purchaseOrderId])
  @@index([labelCode])
  @@map("purchase_order_labels")
}

// PV Receptie - documentul de verificare
model ReceptionReport {
  id               String                 @id @default(cuid())
  reportNumber     String                 @unique  // PV-DD/MM/YYYY-NNNN

  purchaseOrderId  String
  purchaseOrder    PurchaseOrder          @relation(fields: [purchaseOrderId], references: [id])

  supplierInvoiceId String?
  supplierInvoice   SupplierInvoice?      @relation(fields: [supplierInvoiceId], references: [id])

  status           ReceptionReportStatus  @default(DESCHIS)

  // Gestionar
  warehouseUserId  String
  warehouseUserName String

  // Difference tracking
  hasDifferences   Boolean                @default(false)

  // Finalization
  finalizedAt      DateTime?
  finalizedBy      String?
  finalizedByName  String?
  signatureConfirmed Boolean              @default(false)

  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  // Relations
  items            ReceptionReportItem[]
  photos           ReceptionPhoto[]
  goodsReceipt     GoodsReceipt?          // 1:1 - NIR generated from this PV

  @@index([status])
  @@index([purchaseOrderId])
  @@index([warehouseUserId])
  @@map("reception_reports")
}

// Linie PV receptie
model ReceptionReportItem {
  id                 String          @id @default(cuid())

  receptionReportId  String
  receptionReport    ReceptionReport @relation(fields: [receptionReportId], references: [id], onDelete: Cascade)

  inventoryItemId    String
  inventoryItem      InventoryItem   @relation(fields: [inventoryItemId], references: [id])

  quantityExpected   Decimal         @db.Decimal(10, 3)
  quantityReceived   Decimal?        @db.Decimal(10, 3)

  verified           Boolean         @default(false)
  hasDifference      Boolean         @default(false)
  observations       String?         @db.Text  // Required if hasDifference

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@unique([receptionReportId, inventoryItemId])
  @@index([receptionReportId])
  @@index([inventoryItemId])
  @@map("reception_report_items")
}

// Poze receptie
model ReceptionPhoto {
  id                String          @id @default(cuid())

  receptionReportId String
  receptionReport   ReceptionReport @relation(fields: [receptionReportId], references: [id], onDelete: Cascade)

  category          PhotoCategory
  filename          String          // Original filename
  storagePath       String          // /uploads/receptii/{poId}/{reportId}/filename
  mimeType          String
  size              Int             // bytes

  createdAt         DateTime        @default(now())

  @@index([receptionReportId])
  @@index([category])
  @@map("reception_photos")
}

// Factura furnizor
model SupplierInvoice {
  id               String        @id @default(cuid())

  supplierId       String
  supplier         Supplier      @relation(fields: [supplierId], references: [id])

  purchaseOrderId  String?
  purchaseOrder    PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  invoiceNumber    String
  invoiceSeries    String?
  invoiceDate      DateTime

  totalValue       Decimal       @db.Decimal(12, 2)
  vatValue         Decimal?      @db.Decimal(12, 2)
  totalWithVat     Decimal?      @db.Decimal(12, 2)

  paymentStatus    PaymentStatus @default(NEPLATITA)
  paymentDueDate   DateTime?
  paidAt           DateTime?

  // Document scan
  documentPath     String?       // Path to uploaded invoice scan

  notes            String?       @db.Text

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  receptionReports ReceptionReport[]
  goodsReceipts    GoodsReceipt[]

  @@unique([supplierId, invoiceNumber, invoiceSeries])
  @@index([supplierId])
  @@index([purchaseOrderId])
  @@index([paymentStatus])
  @@index([invoiceDate])
  @@map("supplier_invoices")
}
```

**Update existing models:**

1. Add to InventoryItem model:
```prisma
  // Reception relations
  purchaseOrderItems    PurchaseOrderItem[]
  receptionReportItems  ReceptionReportItem[]
```

2. Add to Supplier model:
```prisma
  purchaseOrders   PurchaseOrder[]
  supplierInvoices SupplierInvoice[]
```

3. Replace GoodsReceiptStatus enum:
```prisma
// Extended NIR Status for workflow
enum GoodsReceiptStatus {
  DRAFT         // Ciorna (deprecated - kept for backward compat)
  GENERAT       // NIR creat automat din PV
  TRIMIS_OFFICE // Trimis la Office pentru verificare
  VERIFICAT     // Verificat de Office
  APROBAT       // Aprobat (direct sau dupa aprobare diferente)
  IN_STOC       // Transferat in stoc
  RESPINS       // Respins de George (diferente neaprobate)
  COMPLETED     // (deprecated - kept for backward compat)
  CANCELLED     // Anulat
}
```

4. Add to GoodsReceipt model (after existing fields, before relations):
```prisma
  // Reception workflow link
  receptionReportId String?         @unique
  receptionReport   ReceptionReport? @relation(fields: [receptionReportId], references: [id])

  // Supplier invoice link
  supplierInvoiceId String?
  supplierInvoice   SupplierInvoice? @relation(fields: [supplierInvoiceId], references: [id])

  // Difference tracking
  hasDifferences          Boolean   @default(false)
  differencesApprovedBy   String?
  differencesApprovedByName String?
  differencesApprovedAt   DateTime?

  // Workflow timestamps
  sentToOfficeAt          DateTime?
  verifiedAt              DateTime?
  verifiedBy              String?
  verifiedByName          String?
  transferredToStockAt    DateTime?
```

5. Add index to GoodsReceipt:
```prisma
  @@index([receptionReportId])
  @@index([supplierInvoiceId])
```
  </action>
  <verify>Run `npx prisma validate` - should complete without errors</verify>
  <done>All new enums and models added to schema.prisma, existing models updated with new relations, prisma validate passes</done>
</task>

<task type="auto">
  <name>Task 2: Create manual SQL migration</name>
  <files>prisma/migrations/manual/add_reception_workflow.sql</files>
  <action>
Create SQL migration script that:
1. Creates all new enums (IF NOT EXISTS pattern)
2. Creates all new tables with proper constraints
3. Adds new columns to existing tables (IF NOT EXISTS checks)
4. Creates all necessary indexes

Use this pattern for enums:
```sql
DO $$ BEGIN
    CREATE TYPE "PurchaseOrderStatus" AS ENUM ('DRAFT', 'APROBATA', 'IN_RECEPTIE', 'RECEPTIONATA', 'ANULATA');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;
```

For adding columns to existing tables:
```sql
ALTER TABLE "goods_receipts" ADD COLUMN IF NOT EXISTS "reception_report_id" TEXT UNIQUE;
```

Include comments explaining each section. The migration should be idempotent (can be run multiple times safely).

Tables to create:
- purchase_orders
- purchase_order_items
- purchase_order_labels
- reception_reports
- reception_report_items
- reception_photos
- supplier_invoices

Columns to add to goods_receipts:
- reception_report_id (TEXT, UNIQUE, nullable)
- supplier_invoice_id (TEXT, nullable)
- has_differences (BOOLEAN, default false)
- differences_approved_by (TEXT, nullable)
- differences_approved_by_name (TEXT, nullable)
- differences_approved_at (TIMESTAMP, nullable)
- sent_to_office_at (TIMESTAMP, nullable)
- verified_at (TIMESTAMP, nullable)
- verified_by (TEXT, nullable)
- verified_by_name (TEXT, nullable)
- transferred_to_stock_at (TIMESTAMP, nullable)

Also update GoodsReceiptStatus enum to add new values (GENERAT, TRIMIS_OFFICE, VERIFICAT, APROBAT, IN_STOC, RESPINS).

Foreign key constraints:
- purchase_orders.supplier_id -> suppliers.id
- purchase_order_items.purchase_order_id -> purchase_orders.id (CASCADE DELETE)
- purchase_order_items.inventory_item_id -> inventory_items.id
- purchase_order_labels.purchase_order_id -> purchase_orders.id (CASCADE DELETE)
- reception_reports.purchase_order_id -> purchase_orders.id
- reception_reports.supplier_invoice_id -> supplier_invoices.id
- reception_report_items.reception_report_id -> reception_reports.id (CASCADE DELETE)
- reception_report_items.inventory_item_id -> inventory_items.id
- reception_photos.reception_report_id -> reception_reports.id (CASCADE DELETE)
- supplier_invoices.supplier_id -> suppliers.id
- supplier_invoices.purchase_order_id -> purchase_orders.id
- goods_receipts.reception_report_id -> reception_reports.id
- goods_receipts.supplier_invoice_id -> supplier_invoices.id
  </action>
  <verify>SQL syntax check: `psql -f prisma/migrations/manual/add_reception_workflow.sql --echo-errors` (dry run against local/staging)</verify>
  <done>Manual migration script created at prisma/migrations/manual/add_reception_workflow.sql with all tables, enums, columns, and foreign keys</done>
</task>

<task type="auto">
  <name>Task 3: Sync Prisma client and verify</name>
  <files>prisma/schema.prisma</files>
  <action>
Run prisma format and generate to ensure the schema is valid and client types are updated:

```bash
npx prisma format
npx prisma generate
```

Verify the generated types include:
- PurchaseOrder, PurchaseOrderItem, PurchaseOrderLabel
- ReceptionReport, ReceptionReportItem, ReceptionPhoto
- SupplierInvoice
- Updated GoodsReceipt with new fields
- All new enums (PurchaseOrderStatus, ReceptionReportStatus, PaymentStatus, PhotoCategory, updated GoodsReceiptStatus)
  </action>
  <verify>`npx prisma generate` completes without errors, `ls node_modules/.prisma/client` shows recent timestamp</verify>
  <done>Prisma client regenerated with all new types available for import</done>
</task>

</tasks>

<verification>
1. `npx prisma validate` passes
2. `npx prisma generate` completes without errors
3. Migration SQL file exists and has correct structure
4. New models can be imported from @prisma/client in TypeScript
</verification>

<success_criteria>
- All 7 new models defined in schema.prisma
- GoodsReceipt extended with 11 new fields
- GoodsReceiptStatus has 9 values (including backward-compat ones)
- 4 new enums created
- Manual SQL migration is idempotent
- Prisma client generates successfully
</success_criteria>

<output>
After completion, create `.planning/phases/07.9-reception-workflow/07.9-01-SUMMARY.md`
</output>
