---
phase: 02-invoice-series-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/settings/page.tsx
  - src/app/(dashboard)/settings/invoice-series/page.tsx
autonomous: true

must_haves:
  truths:
    - "Store edit dialog shows series dropdown grouped by company"
    - "Series selection is filtered by store's associated company"
    - "Mapping overview table shows all stores with their series status"
  artifacts:
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Store edit dialog with series selection"
      contains: "invoiceSeriesId"
    - path: "src/app/(dashboard)/settings/invoice-series/page.tsx"
      provides: "Mapping overview table"
      contains: "Sumar mapari"
  key_links:
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "/api/stores/[id]"
      via: "PATCH request with invoiceSeriesId"
      pattern: "invoiceSeriesId"
---

<objective>
Add invoice series selection to the store edit dialog and create a mapping overview table.

Purpose: Allow users to configure which invoice series each store uses, and provide visibility into the current mapping configuration.

Output:
- Enhanced store edit dialog with series dropdown (grouped by company)
- Mapping overview table in invoice-series page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-invoice-series-fix/02-CONTEXT.md
@.planning/phases/02-invoice-series-fix/02-RESEARCH.md
@src/app/(dashboard)/settings/page.tsx
@src/app/(dashboard)/settings/invoice-series/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add series selection to store edit dialog</name>
  <files>src/app/(dashboard)/settings/page.tsx</files>
  <action>
Enhance the store edit dialog in settings/page.tsx to include invoice series selection:

1. **Update StoreType interface** to include invoiceSeriesId:
```typescript
interface StoreType {
  id: string;
  name: string;
  shopifyDomain: string;
  isActive: boolean;
  createdAt: string;
  companyId: string | null;
  company: { id: string; name: string } | null;
  invoiceSeriesId: string | null;
  invoiceSeries: { id: string; name: string; prefix: string } | null;
  _count?: { orders: number };
}
```

2. **Add InvoiceSeries interface** and state:
```typescript
interface InvoiceSeriesOption {
  id: string;
  name: string;
  prefix: string;
  companyId: string;
  isDefault: boolean;
}

// Add to state in component
const [editStoreSeriesId, setEditStoreSeriesId] = useState<string | null>(null);
const [allSeries, setAllSeries] = useState<InvoiceSeriesOption[]>([]);
```

3. **Fetch invoice series data** - Add a query to fetch all active series:
```typescript
const { data: seriesData } = useQuery({
  queryKey: ["invoice-series-list"],
  queryFn: async () => {
    const res = await fetch("/api/invoice-series");
    if (!res.ok) throw new Error("Failed to fetch series");
    return res.json();
  },
});
```

4. **Update editingStore handler** to also set series:
```typescript
// When opening edit dialog
setEditStoreSeriesId(store.invoiceSeriesId || null);
```

5. **Add series dropdown to edit dialog** - After company selection, add:
```tsx
{/* Serie de facturare - doar daca firma este selectata */}
{editStoreCompanyId && (
  <div className="grid gap-2">
    <Label htmlFor="store-series">Serie de facturare</Label>
    <Select
      value={editStoreSeriesId || "default"}
      onValueChange={(value) => setEditStoreSeriesId(value === "default" ? null : value)}
    >
      <SelectTrigger id="store-series">
        <SelectValue placeholder="Selecteaza seria" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="default">
          <span className="text-muted-foreground">
            Foloseste seria default a firmei
          </span>
        </SelectItem>
        {seriesData?.series
          ?.filter((s: InvoiceSeriesOption) => s.companyId === editStoreCompanyId)
          .map((series: InvoiceSeriesOption) => (
            <SelectItem key={series.id} value={series.id}>
              {series.prefix} - {series.name}
              {series.isDefault && (
                <Badge variant="outline" className="ml-2 text-xs">Default</Badge>
              )}
            </SelectItem>
          ))}
      </SelectContent>
    </Select>
    <p className="text-xs text-muted-foreground">
      Toate facturile din acest magazin vor folosi aceasta serie
    </p>
  </div>
)}
```

6. **Clear series when company changes**:
```typescript
// In company select onValueChange
onValueChange={(value) => {
  setEditStoreCompanyId(value === "none" ? null : value);
  setEditStoreSeriesId(null); // Clear series when company changes
}}
```

7. **Update save mutation** to include invoiceSeriesId:
```typescript
// In the mutation body
body: JSON.stringify({
  companyId: editStoreCompanyId || null,
  invoiceSeriesId: editStoreSeriesId || null,
}),
```

8. **Update stores query** to include invoiceSeries in the API response
  </action>
  <verify>
1. Open settings page in browser
2. Edit a store that has a company assigned
3. Verify series dropdown appears with options from that company
4. Save changes and verify they persist
  </verify>
  <done>Store edit dialog includes series dropdown filtered by company, changes persist via API</done>
</task>

<task type="auto">
  <name>Task 2: Add mapping overview table to invoice-series page</name>
  <files>src/app/(dashboard)/settings/invoice-series/page.tsx</files>
  <action>
Add a mapping overview table to the invoice-series page that shows the current configuration per store:

1. **Ensure stores are fetched with full data** - The page already fetches stores. Update the query if needed to include company info:
```typescript
const { data: storesData } = useQuery({
  queryKey: ["stores-for-series"],
  queryFn: async () => {
    const res = await fetch("/api/stores?include=company,invoiceSeries");
    if (!res.ok) throw new Error("Failed to fetch stores");
    return res.json();
  },
});
```

2. **Add a new Card component** with the mapping overview table after the existing series cards:
```tsx
{/* Sumar mapari - Overview table */}
<Card className="mt-6">
  <CardHeader>
    <CardTitle className="flex items-center gap-2">
      <Store className="h-5 w-5" />
      Sumar mapari
    </CardTitle>
    <CardDescription>
      Configuratia curenta per magazin - verifica ca fiecare magazin are serie configurata
    </CardDescription>
  </CardHeader>
  <CardContent>
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Magazin</TableHead>
          <TableHead>Firma</TableHead>
          <TableHead>Serie</TableHead>
          <TableHead>Status</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {storesData?.stores?.map((store: StoreWithMapping) => {
          // Determine effective series (store-specific or company default)
          const effectiveSeries = store.invoiceSeries
            || store.company?.invoiceSeries?.find((s: any) => s.isDefault);
          const hasValidMapping = !!effectiveSeries;
          const isStoreSpecific = !!store.invoiceSeries;

          return (
            <TableRow key={store.id}>
              <TableCell className="font-medium">{store.name}</TableCell>
              <TableCell>
                {store.company?.name || (
                  <Badge variant="destructive">Neasociat</Badge>
                )}
              </TableCell>
              <TableCell>
                {effectiveSeries ? (
                  <span>
                    {effectiveSeries.prefix} - {effectiveSeries.name}
                    {!isStoreSpecific && (
                      <Badge variant="outline" className="ml-2 text-xs">Default firma</Badge>
                    )}
                  </span>
                ) : (
                  <Badge variant="destructive">Lipsa</Badge>
                )}
              </TableCell>
              <TableCell>
                {hasValidMapping ? (
                  <Badge variant="default" className="bg-green-500">OK</Badge>
                ) : (
                  <Badge variant="destructive">Configureaza</Badge>
                )}
              </TableCell>
            </TableRow>
          );
        })}
      </TableBody>
    </Table>
  </CardContent>
</Card>
```

3. **Add interface for the mapping view**:
```typescript
interface StoreWithMapping {
  id: string;
  name: string;
  shopifyDomain: string;
  invoiceSeriesId: string | null;
  invoiceSeries: { id: string; name: string; prefix: string } | null;
  company: {
    id: string;
    name: string;
    invoiceSeries?: { id: string; name: string; prefix: string; isDefault: boolean }[];
  } | null;
}
```

4. **Import Table components** if not already imported:
```typescript
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
```
  </action>
  <verify>
1. Navigate to Settings > Serii Facturare
2. Scroll down to see the mapping overview table
3. Verify it shows all stores with their company and series
4. Verify stores without series show "Configureaza" status
  </verify>
  <done>Mapping overview table displays all stores with their effective series and configuration status</done>
</task>

</tasks>

<verification>
1. Settings page loads without errors
2. Store edit dialog shows series dropdown when company is selected
3. Series dropdown only shows series from the selected company
4. Invoice-series page shows mapping overview table
5. Mapping table correctly identifies stores missing configuration
</verification>

<success_criteria>
- User can select invoice series in store edit dialog
- Series dropdown is filtered by store's company
- Series selection clears when company changes
- Mapping overview table shows all stores with their status
- Stores without valid series show clear "Configureaza" indication
</success_criteria>

<output>
After completion, create `.planning/phases/02-invoice-series-fix/02-02-SUMMARY.md`
</output>
