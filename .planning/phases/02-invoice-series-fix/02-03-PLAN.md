---
phase: 02-invoice-series-fix
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/lib/invoice-service.ts
autonomous: true

must_haves:
  truths:
    - "Invoice generation uses store-specific series when configured"
    - "Fallback to company default series when store has no series"
    - "Clear Romanian error when store has no series and no company default"
  artifacts:
    - path: "src/lib/invoice-service.ts"
      provides: "Invoice generation with store series priority"
      contains: "getInvoiceSeriesForStore"
  key_links:
    - from: "src/lib/invoice-service.ts"
      to: "src/lib/invoice-series.ts"
      via: "getInvoiceSeriesForStore import"
      pattern: "getInvoiceSeriesForStore"
    - from: "src/lib/invoice-service.ts"
      to: "src/lib/invoice-errors.ts"
      via: "getInvoiceErrorMessage import"
      pattern: "getInvoiceErrorMessage"
---

<objective>
Update invoice generation to automatically select the correct series based on the order's store configuration.

Purpose: Eliminate manual series selection by using the store→series mapping. The system will automatically use the store's configured series, or fall back to the company default.

Output:
- Modified invoice-service.ts that uses store-specific series
- Proper fallback chain: Store series → Company default series
- Romanian error messages for missing configuration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-invoice-series-fix/02-CONTEXT.md
@.planning/phases/02-invoice-series-fix/02-RESEARCH.md
@.planning/phases/02-invoice-series-fix/02-01-SUMMARY.md
@src/lib/invoice-service.ts
@src/lib/invoice-series.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update invoice-service imports and series resolution</name>
  <files>src/lib/invoice-service.ts</files>
  <action>
Update `src/lib/invoice-service.ts` to use store-specific series:

1. **Update imports** (around line 22):
Change:
```typescript
import { getNextInvoiceNumber, getInvoiceSeriesForCompany } from "./invoice-series";
```
To:
```typescript
import { getNextInvoiceNumber, getInvoiceSeriesForStore, getInvoiceSeriesForCompany } from "./invoice-series";
import { getInvoiceErrorMessage } from "./invoice-errors";
```

2. **Update the order query** (around line 174-187) to include store's invoiceSeries:
```typescript
const order = await prisma.order.findUnique({
  where: { id: orderId },
  include: {
    lineItems: true,
    store: {
      include: {
        company: true,
        invoiceSeries: true,  // ADD THIS LINE
      },
    },
    invoice: true,
    billingCompany: true,
    requiredTransfer: true,
  },
});
```

3. **Replace the series resolution logic** (around lines 274-283):

Current code:
```typescript
// 6. Obținem seria de facturare pentru această firmă
const invoiceSeries = await getInvoiceSeriesForCompany(company.id);

if (!invoiceSeries) {
  return {
    success: false,
    error: `Nu există serie de facturare configurată pentru firma "${company.name}". Adaugă o serie în Setări > Serii Facturare.`,
    errorCode: "NO_SERIES",
  };
}
```

Replace with:
```typescript
// 6. Obținem seria de facturare - prioritate: store > company default
let invoiceSeries = null;

// Priority 1: Store-specific series (already loaded in order.store.invoiceSeries)
if (order.store?.invoiceSeries && order.store.invoiceSeries.isActive) {
  invoiceSeries = order.store.invoiceSeries;
  console.log(`[Invoice] Folosesc seria magazinului: ${invoiceSeries.prefix} (${invoiceSeries.name})`);
}
// Priority 2: Company default series (existing behavior)
else if (company) {
  invoiceSeries = await getInvoiceSeriesForCompany(company.id);
  if (invoiceSeries) {
    console.log(`[Invoice] Folosesc seria default a firmei: ${invoiceSeries.prefix} (${invoiceSeries.name})`);
  }
}

if (!invoiceSeries) {
  const storeName = order.store?.name || 'necunoscut';
  return {
    success: false,
    error: getInvoiceErrorMessage("NO_SERIES",
      `Magazinul "${storeName}" nu are serie de facturare configurata. Mergi la Setari > Magazine pentru a configura.`),
    errorCode: "NO_SERIES",
  };
}
```

4. **Update other error messages** to use getInvoiceErrorMessage where applicable:
- Line ~190: ORDER_NOT_FOUND
- Line ~200: ALREADY_ISSUED
- Line ~210: TRANSFER_PENDING
- Line ~224: NO_COMPANY
- Line ~232: NO_CREDENTIALS
- Line ~244: NO_FACTURIS_CIF
- Line ~252: NO_LINE_ITEMS

For each, replace the hardcoded Romanian string with:
```typescript
error: getInvoiceErrorMessage("ERROR_CODE"),
```

This ensures consistent messaging and easier future translations.
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit src/lib/invoice-service.ts`
2. Check the console logs show correct series selection
3. Test invoice generation for a store with specific series
4. Test invoice generation for a store without series (should use company default)
  </verify>
  <done>Invoice generation uses store-specific series with fallback to company default, all errors use Romanian message system</done>
</task>

<task type="auto">
  <name>Task 2: Add series info to invoice generation result</name>
  <files>src/lib/invoice-service.ts</files>
  <action>
Enhance the invoice generation to return information about which series was used and why:

1. **Enhance IssueInvoiceResult interface** (around line 31) - add a field to indicate series source:
```typescript
export interface IssueInvoiceResult {
  success: boolean;
  invoiceNumber?: string;
  invoiceSeries?: string;
  invoiceKey?: string;
  companyId?: string;
  companyName?: string;
  seriesSource?: "store" | "company_default";  // ADD THIS
  error?: string;
  errorCode?: string;
}
```

2. **Track series source** - After the series resolution logic (added in Task 1), add tracking:
```typescript
const seriesSource: "store" | "company_default" =
  order.store?.invoiceSeries && order.store.invoiceSeries.isActive && order.store.invoiceSeries.id === invoiceSeries.id
    ? "store"
    : "company_default";
```

3. **Include in success response** - In the success return (around line ~480), add:
```typescript
return {
  success: true,
  invoiceNumber: formattedInvoice,
  invoiceSeries: facturisSeriesName,
  invoiceKey: facturisKey || undefined,
  companyId: company.id,
  companyName: company.name,
  seriesSource,  // ADD THIS
};
```

This information will be useful for the UI to show users which series was used and why.
  </action>
  <verify>
1. TypeScript compiles without errors
2. When issuing an invoice, the result includes seriesSource field
3. seriesSource correctly reflects whether store or company default was used
  </verify>
  <done>Invoice result includes seriesSource indicating whether store-specific or company default series was used</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes
2. Invoice generation uses store.invoiceSeries when available and active
3. Falls back to company default when store has no series
4. Returns clear Romanian error when no series is available
5. Console logs indicate which series source was used
6. Result includes seriesSource field
</verification>

<success_criteria>
- Store with configured series uses that series for invoices
- Store without series uses company default
- Store without series and no company default returns NO_SERIES error in Romanian
- IssueInvoiceResult includes seriesSource field
- All error messages come from invoice-errors.ts for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/02-invoice-series-fix/02-03-SUMMARY.md`
</output>
