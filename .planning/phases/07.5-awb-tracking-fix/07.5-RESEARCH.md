# Phase 7.5: AWB Tracking Fix - Research

**Researched:** 2026-02-03
**Domain:** AWB Status Tracking with FanCourier Integration
**Confidence:** HIGH

## Summary

This phase fixes the AWB tracking page to show accurate status counts with correct categorization. The core issues are:
1. Card counts don't sum to total (categorization gaps)
2. String-based status matching is fragile (typos, variations)
3. Deleted/Cancelled AWBs incorrectly categorized
4. Some statuses fall through without category assignment
5. Discrepancy between dashboard "Expediate" and tracking "In tranzit"

The research reveals that the codebase already has a solid foundation:
- `src/lib/fancourier-statuses.ts` contains a comprehensive status mapping with 52+ statuses and Romanian explanations
- `src/lib/awb-status.ts` provides categorization logic used by both dashboard and tracking page
- FanCourier API returns tracking events with `id` (status code like "S2") and `name` (human-readable description)

The solution requires extending the existing status mapping to be the single source of truth, using status codes (not string matching) for categorization, and ensuring all FanCourier statuses are mapped.

**Primary recommendation:** Refactor `awb-status.ts` to use the comprehensive `fancourier-statuses.ts` mapping as the source of truth, categorizing by status code rather than string matching, with a database table to track unknown statuses.

## Standard Stack

### Core (Already Installed)

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| next | 14.1.3 | App router, API routes | Already in use |
| prisma | 5.11.0 | Database ORM | Already in use, need new table for unknown status tracking |
| @tanstack/react-query | ^5.28.0 | Client-side data fetching | Used in tracking page |
| @radix-ui/react-dialog | ^1.0.5 | Modal for status explanations | Already installed |

### Supporting (Already Available)

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| lucide-react | ^0.344.0 | Icons for status cards | Already used |
| date-fns | ^3.3.1 | Date formatting | Already used |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Database enum for status codes | String field | Enum safer but requires migration; string more flexible for unknown statuses |
| External status API | Static mapping | API is authoritative but adds latency; static mapping faster but may become stale |

**Installation:** No new packages needed.

## Architecture Patterns

### Recommended Module Structure

```
src/lib/
├── awb-status.ts              # REFACTOR: Central categorization using fancourier-statuses
├── fancourier-statuses.ts     # EXISTING: Status mapping with codes, names, descriptions
└── dashboard-stats.ts         # EXISTING: Uses getCategoryFilterConditions - will inherit fixes

src/app/(dashboard)/tracking/
├── page.tsx                   # REFACTOR: Display individual status cards
├── status-card.tsx            # NEW: Reusable card component with click filtering
└── status-modal.tsx           # NEW: Modal showing status explanation + action

prisma/schema.prisma           # ADD: UnknownAWBStatus table for tracking
```

### Pattern 1: Status Code Based Categorization

**What:** Categorize AWBs by FanCourier status code (e.g., "S2") rather than string matching on name
**When to use:** All status categorization across dashboard and tracking
**Example:**
```typescript
// Source: Derived from existing fancourier-statuses.ts
import { FANCOURIER_STATUSES } from './fancourier-statuses';

export type StatusCategory =
  | "pickup"      // C* codes - being picked up
  | "transit"     // H* codes - in transit
  | "delivery"    // S1, S35, S46, S47 - out for delivery
  | "delivered"   // S2 - successfully delivered (FINAL)
  | "notice"      // S3, S11, S12, etc. - notification sent
  | "problem"     // S4, S5, S9, etc. - address issues
  | "return"      // S6, S7, S15, S16, S33, S43, S50 - returned (FINAL)
  | "cancelled"   // A* codes - cancelled (FINAL)
  | "unknown";    // Unmapped status

export function getStatusCategory(statusCode: string | null): StatusCategory {
  if (!statusCode) return "unknown";

  const status = FANCOURIER_STATUSES[statusCode];
  if (status) {
    return status.category; // Direct lookup, no string matching
  }

  // Log unknown status for later mapping
  logUnknownStatus(statusCode);
  return "unknown";
}
```

### Pattern 2: Status Card with Count and Click Filter

**What:** Individual card for each status showing count, clicking filters the AWB table
**When to use:** All status cards on tracking page
**Example:**
```typescript
// NEW: StatusCard component
interface StatusCardProps {
  statusCode: string;
  statusName: string;
  count: number;
  color: string;
  isSelected: boolean;
  onClick: () => void;
}

function StatusCard({ statusCode, statusName, count, color, isSelected, onClick }: StatusCardProps) {
  return (
    <Card
      className={cn(
        "cursor-pointer transition-all hover:shadow-md",
        isSelected && "ring-2 ring-primary",
        `bg-${color}/10 border-${color}/20`
      )}
      onClick={onClick}
    >
      <CardContent className="p-4 text-center">
        <p className={`text-2xl font-bold text-${color}`}>{count}</p>
        <p className={`text-xs text-${color}`}>{statusName}</p>
      </CardContent>
    </Card>
  );
}
```

### Pattern 3: Unknown Status Tracking

**What:** Log unknown status codes to database for admin review and manual mapping
**When to use:** When encountering a status code not in FANCOURIER_STATUSES
**Example:**
```typescript
// Prisma schema addition
model UnknownAWBStatus {
  id              String   @id @default(cuid())
  statusCode      String   @unique
  firstSeenAt     DateTime @default(now())
  lastSeenAt      DateTime @updatedAt
  seenCount       Int      @default(1)
  sampleAwbNumber String?  // For debugging
  mappedCategory  String?  // Admin can manually assign
  mappedName      String?  // Admin can add Romanian name

  @@map("unknown_awb_statuses")
}

// Usage in categorization
async function logUnknownStatus(statusCode: string, awbNumber?: string) {
  await prisma.unknownAWBStatus.upsert({
    where: { statusCode },
    create: { statusCode, sampleAwbNumber: awbNumber },
    update: { seenCount: { increment: 1 }, lastSeenAt: new Date() },
  });
}
```

### Pattern 4: Status Explanation Modal

**What:** Modal showing status explanation and recommended action in Romanian
**When to use:** When user clicks on a status card or individual AWB status
**Example:**
```typescript
// NEW: StatusExplanationModal
interface StatusExplanationModalProps {
  isOpen: boolean;
  onClose: () => void;
  status: {
    code: string;
    name: string;
    description: string;  // Romanian explanation
    action?: string;      // What user should do
  };
}

function StatusExplanationModal({ isOpen, onClose, status }: StatusExplanationModalProps) {
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Badge>{status.code}</Badge>
            {status.name}
          </DialogTitle>
        </DialogHeader>
        <div className="space-y-4">
          <div>
            <h4 className="font-medium text-sm mb-1">Ce inseamna?</h4>
            <p className="text-sm text-muted-foreground">{status.description}</p>
          </div>
          {status.action && (
            <div>
              <h4 className="font-medium text-sm mb-1">Ce trebuie sa faci?</h4>
              <p className="text-sm text-muted-foreground">{status.action}</p>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### Anti-Patterns to Avoid

- **String-based status matching:** Using `status.includes("tranzit")` is fragile - use status code lookup
- **Duplicate categorization logic:** Dashboard and tracking must use SAME function from awb-status.ts
- **Ignoring unknown statuses:** Every status must map to a category - log unknowns for review
- **Counting deleted as separate from cancelled:** A4 (deleted) should be grouped with cancelled (A*)
- **Assuming status name format:** FanCourier can return either code or name - handle both

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Status code mapping | Custom mapping | Extend FANCOURIER_STATUSES | Already has 52+ statuses with descriptions |
| Status color scheme | New color logic | Use existing categoryConfig in awb-status.ts | Consistent with current UI |
| Card components | Custom cards | Extend existing Card components with click handler | Design system compliance |
| Modal components | Custom modal | @radix-ui/react-dialog (already installed) | Accessible, tested |

**Key insight:** The codebase already has comprehensive status data in `fancourier-statuses.ts` - the fix is about USING this data properly rather than building new mappings.

## Common Pitfalls

### Pitfall 1: Status Code vs Status Name Confusion

**What goes wrong:** FanCourier tracking API returns both `id` (code) and `name` (description). Code assumes one format but gets the other.
**Why it happens:** AWB.currentStatus stores the name (human readable), not the code
**How to avoid:**
- Store both `currentStatus` (name) and `currentStatusCode` (code) in AWB table
- Categorize by code when available, fall back to name matching
**Warning signs:** Same status categorized differently in different parts of app

### Pitfall 2: Card Counts Don't Sum to Total

**What goes wrong:** Sum of individual status cards doesn't equal Total card
**Why it happens:** Some statuses fall through to "unknown" but unknown card not shown/counted
**How to avoid:**
- Ensure ALL AWBs are counted exactly once
- Show "Necunoscut" card even if count is 0
- Add verification: `if (sumOfCards !== total) console.error(...)`
**Warning signs:** Users report "numbers don't add up"

### Pitfall 3: Deleted vs Cancelled Ambiguity

**What goes wrong:** A4 (AWB sters) counted separately from A0-A3 (anulat)
**Why it happens:** Current code checks for "sters" separately from "anulat"
**How to avoid:**
- Treat all A* codes as cancelled category
- In display, A4 can show as "Sters din borderou" but count towards cancelled
**Warning signs:** Deleted AWBs appear in wrong category or are double-counted

### Pitfall 4: Dashboard/Tracking Mismatch

**What goes wrong:** Dashboard "In Tranzit" count differs from tracking page
**Why it happens:** Different categorization logic or filter scope
**How to avoid:**
- SINGLE function for categorization used by both
- Dashboard uses `getCategoryFilterConditions()` from awb-status.ts
- Tracking page uses `getStatusCategory()` from same file
- Verify they produce identical counts for same data
**Warning signs:** Users lose trust in dashboard numbers

### Pitfall 5: Unknown Status Handling

**What goes wrong:** New FanCourier status appears, app crashes or shows incorrect category
**Why it happens:** Status code not in mapping, no fallback handling
**How to avoid:**
- Always return "unknown" for unmapped codes (never throw)
- Log unknown status to database for admin review
- Show "Necunoscut" card on tracking page
**Warning signs:** Errors in logs about unhandled status, missing AWBs in counts

## Code Examples

### Existing Status Mapping (fancourier-statuses.ts)

```typescript
// Source: /src/lib/fancourier-statuses.ts (already exists)
export const FANCOURIER_STATUSES: Record<string, FanCourierStatus> = {
  "S2": {
    code: "S2",
    name: "Livrat",
    description: "Coletul a fost livrat cu succes destinatarului",
    category: "delivery",
    internalStatus: "DELIVERED",
    isFinal: true,
  },
  "S6": {
    code: "S6",
    name: "Refuz primire",
    description: "Destinatarul a refuzat sa primeasca coletul",
    category: "return",
    internalStatus: "RETURNED",
    isFinal: true,
  },
  // ... 50+ more statuses
};
```

### Current String-Based Categorization (to be refactored)

```typescript
// Source: /src/lib/awb-status.ts (current implementation - FRAGILE)
export function getStatusCategory(status: string | null): StatusCategory {
  if (!status) return "pending";
  const s = status.toLowerCase();

  // Problem: Relies on string matching which can fail for variations
  if (s.includes("tranzit") || s.includes("transit") || s.includes("livrare")) {
    return "in_transit";
  }
  // ... etc
}
```

### Dashboard Stats Query (uses shared categorization)

```typescript
// Source: /src/lib/dashboard-stats.ts
// Uses getCategoryFilterConditions which mirrors getStatusCategory logic
const inTransit = await prisma.aWB.count({
  where: {
    OR: getCategoryFilterConditions("in_transit") || [],
  },
});
```

### Tracking Page Stats Calculation (to be aligned)

```typescript
// Source: /src/app/(dashboard)/tracking/page.tsx
const stats = {
  total: allAWBs.length,
  inTransit: allAWBs.filter(a => getStatusCategory(a.currentStatus) === 'in_transit').length,
  // ... etc
};
```

## FanCourier Status Reference

Based on existing `fancourier-statuses.ts`, here are the key categories:

### Final Statuses (no further action)
- **Delivered:** S2
- **Returned:** S6, S7, S15, S16, S33, S43, S50
- **Cancelled:** A0, A1, A2, A3, A4

### In-Progress Statuses
- **Pickup:** C0, C1
- **Transit:** H0-H17
- **Out for Delivery:** S1, S35, S46, S47
- **Notice (avizat):** S3, S11, S12, S21, S22, S24, S30
- **Problem (adresa):** S4, S5, S9, S10, S14, S19, S20, S25, S27, S28, S42
- **Other:** S37, S38, S49

### Color Scheme (per CONTEXT.md decision)
| Category | Color | Hex |
|----------|-------|-----|
| Delivered | Green | #22c55e |
| Transit/Delivery | Blue | #3b82f6 |
| Return | Red | #dc2626 |
| Problem/Notice | Yellow | #f59e0b |
| Cancelled | Gray | #6b7280 |
| Unknown | Gray | #9ca3af |

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| String matching | Status code lookup | This phase | Robust categorization |
| Grouped categories | Individual status cards | This phase | Granular visibility |
| Silent failures | Unknown status logging | This phase | Admin can map new statuses |
| Dashboard-specific query | Shared awb-status.ts | Phase 7.3 | Consistency |

**Deprecated/outdated:**
- String-based status matching: Being replaced with code-based lookup
- Separate categorization logic: Being unified in awb-status.ts

## Database Schema Changes

### New Table: UnknownAWBStatus

```prisma
model UnknownAWBStatus {
  id              String   @id @default(cuid())
  statusCode      String   @unique
  statusName      String?  // The name FanCourier returned with this code
  firstSeenAt     DateTime @default(now())
  lastSeenAt      DateTime @updatedAt
  seenCount       Int      @default(1)
  sampleAwbNumber String?  // For debugging
  mappedCategory  String?  // Admin can manually assign category
  mappedName      String?  // Admin can provide Romanian name
  notes           String?  // Admin notes

  @@index([statusCode])
  @@map("unknown_awb_statuses")
}
```

### Optional: Add statusCode to AWB table

```prisma
// Consider adding to AWB model
currentStatusCode String? // The code (e.g., "S2") for reliable categorization
```

## Open Questions

1. **Store currentStatusCode in AWB?**
   - What we know: Currently only stores `currentStatus` (name/description)
   - What's unclear: Is it worth the migration to add `currentStatusCode`?
   - Recommendation: Yes - enables reliable categorization; add column, populate from tracking events

2. **How to handle status name variations?**
   - What we know: FanCourier may return slightly different names for same code
   - What's unclear: How much variation exists in practice?
   - Recommendation: Categorize by code when available, fall back to fuzzy name matching only as last resort

3. **Settings page for unknown status mapping?**
   - What we know: CONTEXT.md mentions admin settings page
   - What's unclear: Priority vs other plans
   - Recommendation: Create basic settings page in Wave 2 (07.5-04) after core fix

## Sources

### Primary (HIGH confidence)
- `/src/lib/fancourier-statuses.ts` - Existing comprehensive status mapping
- `/src/lib/awb-status.ts` - Current categorization logic to refactor
- `/src/lib/fancourier.ts` - FanCourier API integration (trackAWB method)
- `/src/app/(dashboard)/tracking/page.tsx` - Current tracking page implementation

### Secondary (MEDIUM confidence)
- `/src/lib/dashboard-stats.ts` - Dashboard stats using getCategoryFilterConditions
- `/src/lib/sync-service.ts` - AWB sync logic with status detection
- FanCourier API documentation (PDF) - Status code reference

### Tertiary (LOW confidence)
- WebSearch for FanCourier status codes - limited public documentation

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already installed
- Architecture: HIGH - Extending existing modules, clear patterns
- Pitfalls: HIGH - Identified from current bugs and codebase analysis

**Research date:** 2026-02-03
**Valid until:** 2026-03-03 (30 days - internal project, stable patterns)
