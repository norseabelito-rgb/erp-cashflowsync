---
phase: 07.5-awb-tracking-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/tracking/page.tsx
  - src/app/api/awb/stats/route.ts
autonomous: true

must_haves:
  truths:
    - "Tracking page displays individual FanCourier status cards (not category groups)"
    - "Each status card shows count of AWBs with that specific status code"
    - "Cards are ordered by count (highest first)"
    - "Sum of all status card counts equals Total card count exactly"
    - "Unknown status card shows count of AWBs with unmapped status codes"
  artifacts:
    - path: "src/app/(dashboard)/tracking/page.tsx"
      provides: "Refactored tracking page with individual status cards"
      min_lines: 400
    - path: "src/app/api/awb/stats/route.ts"
      provides: "API endpoint returning status counts grouped by fanCourierStatusCode"
      exports: ["GET"]
  key_links:
    - from: "src/app/(dashboard)/tracking/page.tsx"
      to: "/api/awb/stats"
      via: "fetch in useQuery"
      pattern: "fetch.*api/awb/stats"
    - from: "src/app/api/awb/stats/route.ts"
      to: "prisma.aWB.groupBy"
      via: "Prisma groupBy query on fanCourierStatusCode"
      pattern: "groupBy.*fanCourierStatusCode"
---

<objective>
Refactor tracking page to display individual FanCourier status cards instead of category groups, with a new API endpoint for status counts.

Purpose: Users want to see ALL FanCourier statuses individually with Romanian explanations, not grouped categories. The sum of cards must equal total for accurate tracking.

Output: Tracking page showing individual status cards ordered by count, with API backend for status statistics.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-awb-tracking-fix/07.5-CONTEXT.md
@.planning/phases/07.5-awb-tracking-fix/07.5-RESEARCH.md
@src/app/(dashboard)/tracking/page.tsx
@src/lib/fancourier-statuses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AWB stats API endpoint</name>
  <files>src/app/api/awb/stats/route.ts</files>
  <action>
Create src/app/api/awb/stats/route.ts that returns AWB counts grouped by fanCourierStatusCode:

```typescript
import { NextResponse } from "next/server";
import prisma from "@/lib/db";
import { FANCOURIER_STATUSES, formatStatusForDisplay } from "@/lib/fancourier-statuses";

export async function GET() {
  // Get counts grouped by fanCourierStatusCode
  const statusCounts = await prisma.aWB.groupBy({
    by: ["fanCourierStatusCode"],
    _count: { id: true },
  });

  // Get total count
  const total = await prisma.aWB.count();

  // Transform into structured response
  const statusStats: Array<{
    code: string;
    name: string;
    description: string;
    color: string;
    count: number;
    isFinal: boolean;
  }> = [];

  let unknownCount = 0;

  for (const item of statusCounts) {
    const code = item.fanCourierStatusCode;
    const count = item._count.id;

    if (!code) {
      // AWBs without status code - count as unknown/pending
      unknownCount += count;
      continue;
    }

    const statusInfo = FANCOURIER_STATUSES[code];
    if (statusInfo) {
      const display = formatStatusForDisplay(code);
      statusStats.push({
        code,
        name: statusInfo.name,
        description: statusInfo.description,
        color: display.color,
        count,
        isFinal: statusInfo.isFinal,
      });
    } else {
      // Unknown status code
      unknownCount += count;
    }
  }

  // Sort by count descending (most common first)
  statusStats.sort((a, b) => b.count - a.count);

  // Add unknown card if there are any
  if (unknownCount > 0) {
    statusStats.push({
      code: "UNKNOWN",
      name: "Necunoscut",
      description: "Statusuri care nu au fost inca mapate",
      color: "#9ca3af",
      count: unknownCount,
      isFinal: false,
    });
  }

  // Verify sum equals total (for debugging)
  const sumOfCounts = statusStats.reduce((sum, s) => sum + s.count, 0);
  if (sumOfCounts !== total) {
    console.warn(`[AWB Stats] Count mismatch: sum=${sumOfCounts}, total=${total}`);
  }

  return NextResponse.json({
    total,
    statusStats,
    sumVerified: sumOfCounts === total,
  });
}
```

This endpoint:
- Groups AWBs by fanCourierStatusCode
- Maps each code to display info from FANCOURIER_STATUSES
- Collects unknown/null codes into a single "Necunoscut" bucket
- Sorts by count descending
- Includes verification that sum equals total
  </action>
  <verify>Start dev server, call `curl http://localhost:3000/api/awb/stats` - should return JSON with statusStats array and total.</verify>
  <done>AWB stats API returns status counts grouped by fanCourierStatusCode with proper mapping.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor tracking page to use individual status cards</name>
  <files>src/app/(dashboard)/tracking/page.tsx</files>
  <action>
Refactor src/app/(dashboard)/tracking/page.tsx to:

1. Add new query for status stats from /api/awb/stats:
```typescript
const { data: statsData } = useQuery({
  queryKey: ["awb-stats"],
  queryFn: async () => {
    const res = await fetch("/api/awb/stats");
    return res.json();
  },
});
```

2. Replace the hardcoded 8-card stats grid with dynamic cards from statsData.statusStats:
   - Keep the Total card first (always visible)
   - Map through statusStats to render individual status cards
   - Each card shows: count (large), status name (small), appropriate color
   - Cards are clickable - clicking sets statusFilter to that code

3. Update filter logic - **CRITICAL WIRING**:
   - Change `categoryFilter` state to `statusFilter` (holds status code or "all")
   - Wire status filter to AWB list query by modifying the useQuery that fetches AWBs:
   ```typescript
   // Before: query fetched all AWBs and filtered client-side by category
   // After: query includes fanCourierStatusCode filter
   const { data: awbData } = useQuery({
     queryKey: ["awbs", statusFilter], // statusFilter as dependency
     queryFn: async () => {
       const params = new URLSearchParams();
       if (statusFilter !== "all") {
         params.set("statusCode", statusFilter); // Pass to API
       }
       const res = await fetch(`/api/awb?${params}`);
       return res.json();
     },
   });
   ```
   - If the AWB list is client-side filtered (not API-filtered), wire the filter in useMemo:
   ```typescript
   const filteredAwbs = useMemo(() => {
     if (!awbData?.awbs) return [];
     if (statusFilter === "all") return awbData.awbs;
     if (statusFilter === "UNKNOWN") {
       // Match AWBs where code is null or not in FANCOURIER_STATUSES
       return awbData.awbs.filter(awb =>
         !awb.fanCourierStatusCode || !FANCOURIER_STATUSES[awb.fanCourierStatusCode]
       );
     }
     return awbData.awbs.filter(awb => awb.fanCourierStatusCode === statusFilter);
   }, [awbData, statusFilter]);
   ```
   - Use `filteredAwbs` instead of raw `awbData.awbs` in the list rendering

4. Card styling:
   - Use color from statsData for background tint (color/10 for bg, color/20 for border)
   - Selected card has ring-2 ring-primary
   - Show ring in status color when selected

5. Grid layout:
   - Use responsive grid: grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8
   - Cards should wrap naturally as more statuses are added

6. Keep the existing AWB list rendering and expansion logic unchanged.

Key implementation notes:
- The filter now works on fanCourierStatusCode, not getStatusCategory result
- For "UNKNOWN" filter, match AWBs where fanCourierStatusCode is null or not in FANCOURIER_STATUSES
- Color should come from the API response, not hardcoded
  </action>
  <verify>
1. Start dev server and navigate to /tracking
2. Verify individual status cards appear (not category groups)
3. Verify sum of card counts equals Total
4. Click a status card - verify AWB list filters correctly
5. Verify cards are ordered by count (most common first)
  </verify>
  <done>Tracking page shows individual FanCourier status cards with dynamic filtering and correct counts.</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Visit /tracking page
2. Count the sum of all status card numbers - must equal Total card
3. Click on different status cards - AWB list should filter correctly
4. Verify cards are sorted by count (highest to lowest)
5. If there are AWBs with unknown status codes, verify "Necunoscut" card appears
6. Responsive check: cards should wrap properly on different screen sizes
</verification>

<success_criteria>
- /api/awb/stats endpoint exists and returns statusStats array
- Tracking page queries /api/awb/stats for card data
- Individual status cards displayed (not category groups)
- Sum of card counts equals Total exactly (verified in API)
- Cards ordered by count descending
- Clicking card filters AWB list by that specific status code
- "Necunoscut" card appears when there are unknown status codes
- Grid is responsive across screen sizes
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-awb-tracking-fix/07.5-02-SUMMARY.md`
</output>
