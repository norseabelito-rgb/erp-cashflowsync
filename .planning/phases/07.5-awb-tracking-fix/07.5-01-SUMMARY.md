---
phase: "07.5"
plan: "01"
subsystem: "awb-tracking"
tags: ["awb", "status", "fancourier", "categorization", "prisma"]

dependency-graph:
  requires: ["07.3-06"]
  provides: ["code-based-status-categorization", "unknown-status-logging", "action-recommendations"]
  affects: ["07.5-02", "07.5-03", "07.5-04"]

tech-stack:
  added: []
  patterns: ["code-lookup-with-string-fallback", "fire-and-forget-logging", "lazy-prisma-import"]

key-files:
  created:
    - prisma/migrations/manual/add_unknown_awb_status.sql
  modified:
    - prisma/schema.prisma
    - src/lib/awb-status.ts
    - src/lib/fancourier-statuses.ts

decisions:
  - id: "07.5-01-01"
    decision: "Use code-based lookup with string fallback for backward compatibility"
    rationale: "Legacy AWBs may not have statusCode, but new ones will use code lookup"
  - id: "07.5-01-02"
    decision: "Consolidate 'deleted' into 'cancelled' category"
    rationale: "A4 (sters) is categorized by FanCourier as 'cancel', not a separate category"
  - id: "07.5-01-03"
    decision: "Fire-and-forget pattern for unknown status logging"
    rationale: "Avoid slowing down status lookups for non-critical logging"
  - id: "07.5-01-04"
    decision: "Lazy Prisma import in awb-status.ts"
    rationale: "Avoid circular deps and allow graceful handling if model not yet migrated"

metrics:
  duration: "~6 min"
  completed: "2026-02-03"
---

# Phase 07.5 Plan 01: Code-Based Status Categorization Summary

**One-liner:** Code-based AWB status categorization using FANCOURIER_STATUSES lookup with unknown status logging to database.

## What Was Built

### 1. UnknownAWBStatus Model (Prisma)

Added database model to track unknown FanCourier status codes for admin review:

```prisma
model UnknownAWBStatus {
  id              String   @id @default(cuid())
  statusCode      String   @unique
  statusName      String?
  firstSeenAt     DateTime @default(now())
  lastSeenAt      DateTime @updatedAt
  seenCount       Int      @default(1)
  sampleAwbNumber String?
  mappedCategory  String?  // Admin can assign category
  mappedName      String?  // Admin can provide name
  notes           String?

  @@index([statusCode])
  @@map("unknown_awb_statuses")
}
```

### 2. Refactored awb-status.ts

**New exports:**

- `getStatusCategoryByCode(statusCode)` - Direct code lookup from FANCOURIER_STATUSES
- `logUnknownStatus(code, name?, awb?)` - Fire-and-forget DB logging
- `isKnownStatusCode(code)` - Check if code exists in mapping

**Enhanced exports:**

- `getStatusCategory(status, statusCode?)` - Now accepts optional code for priority lookup

**Category mapping (FanCourier -> StatusCategory):**

| FanCourier | StatusCategory | Notes |
|------------|----------------|-------|
| pickup | in_transit | C0, C1 = start of transit |
| transit | in_transit | H* codes |
| delivery | delivered/in_transit | S2 final, others in_transit |
| notice | pending | Avizat = waiting for action |
| problem | error | Address issues need intervention |
| return | returned | All refuz/retur codes |
| cancel | cancelled | A0-A4 including "deleted" |
| other | pending/error | Depends on isFinal |

### 3. Action Recommendations in fancourier-statuses.ts

Added `action?: string` field to FanCourierStatus interface with Romanian recommendations for 41 status codes:

```typescript
// Example
"S22": {
  code: "S22",
  name: "Avizat, nu are bani de ramburs",
  action: "Contactati clientul sa pregateasca suma pentru ramburs.",
  // ...
}
```

## Key Changes

1. **"deleted" consolidated into "cancelled"** - A4 (AWB sters) now returns "cancelled" not "deleted". The UI still shows categoryConfig.deleted for backward compat but the logic treats them the same.

2. **getCategoryFilterConditions updated** - The "cancelled" filter now includes "sters" and "deleted" patterns for DB queries.

3. **Non-blocking logging** - `logUnknownStatus` uses fire-and-forget pattern with error catching to avoid impacting status lookups.

## Verification Results

```
getStatusCategoryByCode("S2")  -> "delivered"   [PASS]
getStatusCategoryByCode("H4")  -> "in_transit"  [PASS]
getStatusCategoryByCode("A4")  -> "cancelled"   [PASS]
getStatusCategoryByCode("S6")  -> "returned"    [PASS]
getStatusCategoryByCode("UNKNOWN") -> "unknown" [PASS]

FANCOURIER_STATUSES["S4"].action -> contains address verification text [PASS]
Statuses with action: 41 >= 15 [PASS]
```

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 84ced32 | feat | Add UnknownAWBStatus model for status tracking |
| 64f88bc | feat | Refactor awb-status.ts to use code-based categorization |
| cfd38c5 | feat | Add action recommendations to FanCourier statuses |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Prisma client regeneration blocked by permissions**

- **Found during:** Task 2
- **Issue:** `npx prisma generate` failed with EACCES permission denied
- **Fix:** Used lazy dynamic import pattern with `any` type to allow code to work before/after migration
- **Files modified:** src/lib/awb-status.ts
- **Commit:** 64f88bc

## Migration Notes

**After deploying, run the migration:**

```sql
-- File: prisma/migrations/manual/add_unknown_awb_status.sql
-- Creates unknown_awb_statuses table
```

Then regenerate Prisma client:

```bash
npx prisma generate
```

## Next Phase Readiness

Ready for 07.5-02 (Update Status Display Components):

- getStatusCategoryByCode available for component use
- Action text accessible via FANCOURIER_STATUSES[code].action
- Status categorization consistent across the application
