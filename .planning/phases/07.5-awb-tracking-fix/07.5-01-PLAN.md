---
phase: 07.5-awb-tracking-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/awb-status.ts
  - prisma/schema.prisma
  - prisma/migrations/manual/add_unknown_awb_status.sql
autonomous: true

must_haves:
  truths:
    - "AWB status categorization uses status code lookup from FANCOURIER_STATUSES"
    - "Unknown status codes are logged to database for admin review"
    - "getStatusCategory returns category based on code, falls back to string matching only for legacy data"
    - "All FanCourier status codes map to exactly one category"
  artifacts:
    - path: "src/lib/awb-status.ts"
      provides: "Code-based status categorization with unknown status logging"
      exports: ["getStatusCategory", "getStatusCategoryByCode", "logUnknownStatus", "StatusCategory"]
    - path: "prisma/schema.prisma"
      provides: "UnknownAWBStatus model for tracking new statuses"
      contains: "model UnknownAWBStatus"
    - path: "prisma/migrations/manual/add_unknown_awb_status.sql"
      provides: "Migration script for unknown_awb_statuses table"
  key_links:
    - from: "src/lib/awb-status.ts"
      to: "src/lib/fancourier-statuses.ts"
      via: "FANCOURIER_STATUSES import for code lookup"
      pattern: "import.*FANCOURIER_STATUSES.*from"
---

<objective>
Refactor AWB status categorization to use FanCourier status code lookup instead of fragile string matching, and add database tracking for unknown statuses.

Purpose: Current string-based status matching is brittle and causes miscategorization. Using the comprehensive FANCOURIER_STATUSES mapping ensures reliable categorization. Unknown statuses need to be logged so admins can map new codes when FanCourier adds them.

Output: Robust status categorization module with unknown status tracking infrastructure.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.5-awb-tracking-fix/07.5-CONTEXT.md
@.planning/phases/07.5-awb-tracking-fix/07.5-RESEARCH.md
@src/lib/awb-status.ts
@src/lib/fancourier-statuses.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UnknownAWBStatus model to Prisma schema</name>
  <files>prisma/schema.prisma, prisma/migrations/manual/add_unknown_awb_status.sql</files>
  <action>
Add the UnknownAWBStatus model to prisma/schema.prisma:

```prisma
// Unknown AWB statuses for admin review and mapping
model UnknownAWBStatus {
  id              String   @id @default(cuid())
  statusCode      String   @unique  // The FanCourier status code (e.g., "S99")
  statusName      String?           // The name FanCourier returned with this code
  firstSeenAt     DateTime @default(now())
  lastSeenAt      DateTime @updatedAt
  seenCount       Int      @default(1)
  sampleAwbNumber String?           // For debugging - which AWB had this status
  mappedCategory  String?           // Admin can manually assign category
  mappedName      String?           // Admin can provide Romanian name
  notes           String?           // Admin notes

  @@index([statusCode])
  @@map("unknown_awb_statuses")
}
```

Create the manual migration script at prisma/migrations/manual/add_unknown_awb_status.sql:

```sql
-- Add unknown_awb_statuses table for tracking unrecognized FanCourier status codes
-- This allows admins to review and manually map new statuses

CREATE TABLE IF NOT EXISTS "unknown_awb_statuses" (
  "id" TEXT NOT NULL,
  "statusCode" TEXT NOT NULL,
  "statusName" TEXT,
  "firstSeenAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "lastSeenAt" TIMESTAMP(3) NOT NULL,
  "seenCount" INTEGER NOT NULL DEFAULT 1,
  "sampleAwbNumber" TEXT,
  "mappedCategory" TEXT,
  "mappedName" TEXT,
  "notes" TEXT,

  CONSTRAINT "unknown_awb_statuses_pkey" PRIMARY KEY ("id")
);

CREATE UNIQUE INDEX IF NOT EXISTS "unknown_awb_statuses_statusCode_key" ON "unknown_awb_statuses"("statusCode");
CREATE INDEX IF NOT EXISTS "unknown_awb_statuses_statusCode_idx" ON "unknown_awb_statuses"("statusCode");
```

Run `npx prisma generate` to update the Prisma client.
  </action>
  <verify>Run `npx prisma generate` - should complete without errors. Check that UnknownAWBStatus appears in node_modules/.prisma/client/index.d.ts.</verify>
  <done>UnknownAWBStatus model exists in schema and Prisma client is regenerated.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor awb-status.ts to use code-based categorization</name>
  <files>src/lib/awb-status.ts</files>
  <action>
Refactor src/lib/awb-status.ts to:

1. Import FANCOURIER_STATUSES from fancourier-statuses.ts
2. Add new function `getStatusCategoryByCode(statusCode: string | null)` that does direct lookup
3. Refactor `getStatusCategory(status: string | null, statusCode?: string | null)` to:
   - Use code lookup if statusCode is provided
   - Fall back to string matching only for legacy data without codes
4. Add `logUnknownStatus(statusCode: string, statusName?: string, awbNumber?: string)` function
5. Map FanCourier categories to StatusCategory enum:
   - "pickup" -> "in_transit" (ridcare is start of transit)
   - "transit" -> "in_transit"
   - "delivery" -> "in_transit" (out for delivery is still in transit)
   - "notice" -> "pending" (avizat = waiting for action)
   - "problem" -> "error" (address issues are errors)
   - "return" -> "returned"
   - "cancel" -> "cancelled" (includes A4 deleted)
   - "other" -> "pending" or "error" depending on isFinal

Key changes:
- Keep existing StatusCategory type unchanged for backward compatibility
- Consolidate "deleted" into "cancelled" (A4 is a cancellation type)
- Remove separate "deleted" handling - A4 should be "cancelled"
- Keep getCategoryFilterConditions as-is for DB queries (string matching needed there)

Implementation note: The logUnknownStatus function should be async and non-blocking - use fire-and-forget pattern with .catch() to avoid slowing down status lookups.
  </action>
  <verify>Run `npx tsc --noEmit` to check for TypeScript errors. Import and call getStatusCategory with various codes in a test script.</verify>
  <done>awb-status.ts uses code-based lookup from FANCOURIER_STATUSES, falls back to string matching for legacy, and logs unknown statuses.</done>
</task>

<task type="auto">
  <name>Task 3: Add action recommendations to fancourier-statuses.ts</name>
  <files>src/lib/fancourier-statuses.ts</files>
  <action>
Extend the FanCourierStatus interface and FANCOURIER_STATUSES to include action recommendations (what the user should do for each status):

1. Add `action?: string` field to FanCourierStatus interface

2. Add Romanian action recommendations to key statuses:
   - S2 (Livrat): No action needed - "Comanda livrata cu succes"
   - S3 (Avizat): "Destinatarul va fi contactat din nou. Asteptati."
   - S4/S5/S10 (Adresa problems): "Verificati adresa si contactati clientul"
   - S6/S7/S15 (Refuzuri): "Contactati clientul pentru clarificari"
   - S16 (Retur la termen): "Coletul se intoarce la expeditor"
   - S21 (Lipsa persoana): "Curierul va reincerca livrarea"
   - S22 (Nu are bani): "Contactati clientul sa pregateasca suma"
   - S30 (Nu raspunde): "Incercati sa contactati clientul telefonic"
   - A0-A4 (Anulat/Sters): "AWB anulat - nu mai necesita actiune"

Not all statuses need actions - transit statuses (H*, C*) typically just need "Asteptati".

This enables the status explanation modal to show actionable guidance.
  </action>
  <verify>Check that FanCourierStatus interface includes action field and at least 15 statuses have action text defined.</verify>
  <done>fancourier-statuses.ts includes action recommendations for key statuses.</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run `npx prisma generate` - should succeed
2. Run `npx tsc --noEmit` - no TypeScript errors
3. Import awb-status.ts and verify:
   - `getStatusCategoryByCode("S2")` returns "delivered"
   - `getStatusCategoryByCode("H4")` returns "in_transit"
   - `getStatusCategoryByCode("A4")` returns "cancelled" (not "deleted")
   - `getStatusCategoryByCode("S6")` returns "returned"
   - `getStatusCategoryByCode("UNKNOWN")` returns "unknown"
4. FANCOURIER_STATUSES["S4"].action should contain text about address verification
</verification>

<success_criteria>
- UnknownAWBStatus model in schema.prisma
- Migration script exists in prisma/migrations/manual/
- awb-status.ts imports and uses FANCOURIER_STATUSES
- getStatusCategoryByCode function exists and works
- logUnknownStatus function exists (async, non-blocking)
- At least 15 status codes have action text in fancourier-statuses.ts
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.5-awb-tracking-fix/07.5-01-SUMMARY.md`
</output>
