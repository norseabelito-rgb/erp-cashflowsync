---
phase: 07.5-awb-tracking-fix
plan: 02
subsystem: awb-tracking
tags: [awb, tracking, status-cards, api, fancourier]

dependency-graph:
  requires: [07.5-01]
  provides:
    - /api/awb/stats endpoint
    - Dynamic status cards from fanCourierStatusCode
    - Client-side filtering by status code
  affects: []

tech-stack:
  added: []
  patterns:
    - Prisma groupBy for status aggregation
    - Dynamic card rendering from API
    - useMemo for client-side filtering

key-files:
  created:
    - src/app/api/awb/stats/route.ts
  modified:
    - src/app/(dashboard)/tracking/page.tsx
    - src/app/api/awb/route.ts

decisions:
  - id: "07.5-02-01"
    decision: "Status cards use flexbox wrap instead of fixed grid"
    rationale: "Cards adapt to available space as more statuses appear"
  - id: "07.5-02-02"
    decision: "Filter uses client-side useMemo instead of API parameter"
    rationale: "All AWBs already loaded for total count, avoid redundant API calls"
  - id: "07.5-02-03"
    decision: "Colors applied via inline styles with hexToRgba helper"
    rationale: "Dynamic colors from API cannot be predefined in Tailwind classes"
  - id: "07.5-02-04"
    decision: "UNKNOWN card groups null codes and unmapped codes together"
    rationale: "Users need visibility into AWBs without proper status mapping"

metrics:
  duration: ~4 minutes
  completed: 2026-02-03
---

# Phase 7.5 Plan 02: Individual Status Cards Summary

**One-liner:** Dynamic status cards from fanCourierStatusCode with /api/awb/stats API and client-side filtering

## What Was Built

### API Endpoint: /api/awb/stats
Created a new API endpoint that aggregates AWB counts by `fanCourierStatusCode`:

- Uses Prisma `groupBy` to efficiently count AWBs per status code
- Maps each code to display info from `FANCOURIER_STATUSES`
- Collects unknown/null codes into a single "Necunoscut" bucket
- Sorts results by count descending (most common first)
- Includes `sumVerified` flag to detect count mismatches

### Tracking Page Refactor
Replaced the hardcoded 8-card stats grid with dynamic cards:

- Fetches status statistics from `/api/awb/stats` via useQuery
- Total card always appears first
- Dynamic status cards render for each unique fanCourierStatusCode
- Cards are clickable and set `statusFilter` state
- Client-side filtering via useMemo on `fanCourierStatusCode`
- UNKNOWN filter matches AWBs with null or unmapped codes
- Responsive flex-wrap layout adapts to screen size

### AWB API Enhancement
Added `fanCourierStatusCode` to the AWB API response:

- Field now included in select clause of `/api/awb` endpoint
- Enables client-side filtering by specific status code

## Key Implementation Details

### Status Card Styling
Cards use inline styles for dynamic colors:
```typescript
style={{
  backgroundColor: hexToRgba(stat.color, 0.1),
  borderColor: hexToRgba(stat.color, 0.2),
}}
```

### Client-Side Filtering
```typescript
const filteredAwbs = useMemo(() => {
  if (statusFilter === "all") return allAWBs;
  if (statusFilter === "UNKNOWN") {
    return allAWBs.filter(awb =>
      !awb.fanCourierStatusCode || !FANCOURIER_STATUSES[awb.fanCourierStatusCode]
    );
  }
  return allAWBs.filter(awb => awb.fanCourierStatusCode === statusFilter);
}, [allAWBs, statusFilter]);
```

## Files Changed

| File | Lines | Change |
|------|-------|--------|
| src/app/api/awb/stats/route.ts | 112 | Created - AWB stats API endpoint |
| src/app/(dashboard)/tracking/page.tsx | 615 | Refactored - Dynamic status cards |
| src/app/api/awb/route.ts | +1 | Added fanCourierStatusCode to response |

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 1a6c8cf | feat | Create AWB stats API endpoint |
| 192c587 | feat | Refactor tracking page with individual status cards |

## Verification

- [x] /api/awb/stats endpoint exists and returns statusStats array
- [x] Tracking page queries /api/awb/stats for card data
- [x] Individual status cards displayed (not category groups)
- [x] Sum of card counts equals Total (verified via sumVerified flag)
- [x] Cards ordered by count descending
- [x] Clicking card filters AWB list by specific status code
- [x] "Necunoscut" card appears when there are unknown status codes
- [x] Responsive flex-wrap layout adapts to screen sizes

## Deviations from Plan

None - plan executed exactly as written.

## Next Phase Readiness

Ready for 07.5-03: Filter wiring may need server-side filtering if performance becomes an issue with large AWB datasets.
