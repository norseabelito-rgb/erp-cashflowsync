---
phase: 07-task-management-core
plan: 04
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/components/tasks/task-form-dialog.tsx
  - src/app/(dashboard)/tasks/page.tsx
autonomous: true

must_haves:
  truths:
    - "Task create dialog opens with all required fields"
    - "Task edit dialog pre-fills existing values"
    - "Reassignment shows note field when assignee changes"
    - "Dialog closes on successful save"
    - "Task list refreshes after create/edit/complete"
  artifacts:
    - path: "src/components/tasks/task-form-dialog.tsx"
      provides: "Create/edit dialog component"
      exports: ["TaskFormDialog"]
    - path: "src/app/(dashboard)/tasks/page.tsx"
      provides: "Tasks page with dialog integration"
      contains: "TaskFormDialog"
  key_links:
    - from: "src/components/tasks/task-form-dialog.tsx"
      to: "/api/tasks"
      via: "fetch POST/PATCH"
      pattern: "fetch.*api/tasks"
    - from: "src/app/(dashboard)/tasks/page.tsx"
      to: "src/components/tasks/task-form-dialog.tsx"
      via: "import and render"
      pattern: "import.*TaskFormDialog"
---

<objective>
Create the task form dialog for creating and editing tasks, and wire it into the tasks page.

Purpose: Enable users to create new tasks and edit existing ones with full field support.
Output: TaskFormDialog component and updated tasks page with dialog integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-task-management-core/07-CONTEXT.md
@.planning/phases/07-task-management-core/07-RESEARCH.md
@.planning/phases/07-task-management-core/07-02-SUMMARY.md
@.planning/phases/07-task-management-core/07-03-SUMMARY.md
@src/app/(dashboard)/tasks/page.tsx
@src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task form dialog component</name>
  <files>src/components/tasks/task-form-dialog.tsx</files>
  <action>
Create `src/components/tasks/task-form-dialog.tsx`:

1. Props interface:
   - open: boolean
   - onOpenChange: (open: boolean) => void
   - task?: Task (if editing)
   - onSuccess?: () => void
   - users: Array<{ id: string; name: string }> (for assignee dropdown)

2. Form state (useState or react-hook-form):
   - title: string (required)
   - description: string
   - type: TaskType (default BUSINESS)
   - priority: TaskPriority (default MEDIUM)
   - deadline: Date | null
   - assigneeId: string | null
   - linkedOrderId: string | null (optional, for future use)
   - linkedProductId: string | null (optional, for future use)
   - linkedInvoiceId: string | null (optional, for future use)
   - reassignmentNote: string (shown only when assignee changes during edit)

3. Dialog structure:
   - DialogHeader with title: "Creeaza task" or "Editeaza task"
   - Form fields:
     a. Title input (required, label: "Titlu")
     b. Description textarea (label: "Descriere")
     c. Type select dropdown (label: "Tip")
     d. Priority select dropdown (label: "Prioritate")
     e. Deadline date picker (label: "Deadline")
     f. Assignee select dropdown (label: "Responsabil", include "Neasignat" option)
     g. Reassignment note textarea (label: "Nota de transfer", only visible when editing AND assignee changed from original)
   - DialogFooter with Cancel and Save buttons

4. Type options with Romanian labels (no diacritics):
   - PICKING: "Picking"
   - VERIFICARE: "Verificare"
   - EXPEDIERE: "Expediere"
   - MEETING: "Intalnire"
   - DEADLINE: "Deadline"
   - FOLLOW_UP: "Urmarire"
   - BUSINESS: "Business"
   - OTHER: "Altele"

5. Priority options:
   - LOW: "Scazuta"
   - MEDIUM: "Medie"
   - HIGH: "Ridicata"
   - URGENT: "Urgent"

6. Submit handler:
   - If creating: POST /api/tasks with form data
   - If editing: PATCH /api/tasks/[id] with form data
   - Validate: title required, reassignmentNote required if assignee changed
   - On success: call onSuccess callback, close dialog
   - On error: show error via useErrorModal or toast

7. Pre-fill logic (when task prop exists):
   - Set all fields from task object
   - Track original assigneeId to detect changes

Add ActionTooltip to form elements where helpful (e.g., "Selecteaza tipul task-ului").

Export TaskFormDialog as named export.
  </action>
  <verify>Run `npx tsc --noEmit` - should compile without errors</verify>
  <done>TaskFormDialog exports with create/edit mode, all fields, and reassignment validation</done>
</task>

<task type="auto">
  <name>Task 2: Integrate dialog into tasks page</name>
  <files>src/app/(dashboard)/tasks/page.tsx</files>
  <action>
Update `src/app/(dashboard)/tasks/page.tsx` to integrate the TaskFormDialog:

1. Add imports:
   - Import TaskFormDialog from @/components/tasks/task-form-dialog

2. Add dialog state:
   - isCreateDialogOpen: boolean
   - editingTask: Task | null

3. Add handlers:
   - openCreateDialog: () => setIsCreateDialogOpen(true)
   - openEditDialog: (task: Task) => setEditingTask(task)
   - handleDialogSuccess: () => {
       queryClient.invalidateQueries({ queryKey: ["tasks"] });
       setIsCreateDialogOpen(false);
       setEditingTask(null);
       toast({ title: editingTask ? "Task actualizat" : "Task creat" });
     }

4. Update "Creeaza task" button in header:
   - onClick={openCreateDialog}
   - Add ActionTooltip: action="Creeaza task", consequence="Deschide formularul pentru un task nou"

5. Update dropdown menu "Editeaza" option:
   - onClick={() => openEditDialog(task)}
   - Add appropriate icon (Pencil)

6. Update dropdown menu to include actions:
   - Editeaza (edit dialog)
   - Finalizeaza / Redeschide (toggle complete)
   - Each with ActionTooltip wrapper on trigger

7. Render dialogs at bottom of component:
   - TaskFormDialog for create (open={isCreateDialogOpen}, onOpenChange={setIsCreateDialogOpen})
   - TaskFormDialog for edit (open={!!editingTask}, onOpenChange={(open) => !open && setEditingTask(null)}, task={editingTask})
   - Pass users list to both dialogs

8. Ensure all mutations invalidate ["tasks"] query key

Apply ActionTooltip to all new buttons following Phase 6 convention (Romanian text without diacritics).
  </action>
  <verify>Run `npm run build` - should compile. Test create/edit flow in browser.</verify>
  <done>Tasks page has working create and edit dialogs with proper form validation</done>
</task>

<task type="auto">
  <name>Task 3: Add sidebar navigation entry for Tasks</name>
  <files>src/components/sidebar.tsx</files>
  <action>
Update `src/components/sidebar.tsx` to add Tasks navigation item:

1. Find the sidebar navigation items array/config
2. Add Tasks entry with:
   - Label: "Task-uri"
   - Icon: ClipboardList from lucide-react
   - Href: "/tasks"
   - Place after a logical position (e.g., after Orders or Invoices)

3. If the sidebar uses permission checks, add "tasks.view" permission requirement

This ensures users can navigate to the new Tasks page from the main sidebar.
  </action>
  <verify>Check sidebar in browser - Tasks link should appear and navigate to /tasks</verify>
  <done>Sidebar has "Task-uri" navigation item that links to /tasks</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. "Creeaza task" button opens dialog with all fields
3. Create flow: fill form, save, dialog closes, task appears in list
4. Edit flow: click Editeaza in dropdown, dialog opens with pre-filled values
5. Reassignment: changing assignee shows "Nota de transfer" field
6. All buttons have ActionTooltip
7. Tasks link appears in sidebar navigation
</verification>

<success_criteria>
- TaskFormDialog renders with all required fields
- Create mode: empty form, saves new task
- Edit mode: pre-filled form, updates existing task
- Reassignment validation: note required when changing assignee
- Dialog closes on success and list refreshes
- Sidebar navigation includes Tasks entry
- All interactive elements have Romanian tooltips
</success_criteria>

<output>
After completion, create `.planning/phases/07-task-management-core/07-04-SUMMARY.md`
</output>
