---
phase: 07-task-management-core
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/api/tasks/route.ts
  - src/app/api/tasks/[id]/route.ts
  - src/app/api/tasks/[id]/complete/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/tasks returns list of tasks with filtering support"
    - "POST /api/tasks creates a new task with all required fields"
    - "PATCH /api/tasks/[id] updates task and validates reassignment note"
    - "POST /api/tasks/[id]/complete toggles task completion status"
    - "All endpoints require authentication and check permissions"
  artifacts:
    - path: "src/app/api/tasks/route.ts"
      provides: "Task list and create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/tasks/[id]/route.ts"
      provides: "Task detail, update, delete endpoints"
      exports: ["GET", "PATCH", "DELETE"]
    - path: "src/app/api/tasks/[id]/complete/route.ts"
      provides: "Task completion toggle endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/tasks/route.ts"
      to: "prisma.task"
      via: "database query"
      pattern: "prisma\\.task\\.(findMany|create)"
    - from: "src/app/api/tasks/[id]/route.ts"
      to: "prisma.task"
      via: "database query"
      pattern: "prisma\\.task\\.(findUnique|update|delete)"
    - from: "src/app/api/tasks/[id]/complete/route.ts"
      to: "prisma.task"
      via: "database update"
      pattern: "prisma\\.task\\.update"
---

<objective>
Create the Task API routes for CRUD operations and completion toggling.

Purpose: Provide the backend endpoints that the task list UI will consume.
Output: Three API route files handling list, detail, create, update, delete, and completion toggle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-task-management-core/07-CONTEXT.md
@.planning/phases/07-task-management-core/07-RESEARCH.md
@.planning/phases/07-task-management-core/07-01-SUMMARY.md
@src/app/api/invoices/route.ts
@src/lib/permissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create task list and create API route</name>
  <files>src/app/api/tasks/route.ts</files>
  <action>
Create `src/app/api/tasks/route.ts` following the pattern from `/api/invoices/route.ts`:

**GET handler:**
1. Authenticate with getServerSession, return 401 if not authenticated
2. Check hasPermission for "tasks.view", return 403 if denied
3. Parse query params: type, status, assigneeId, preset (today, overdue, this_week, my_tasks), search
4. Build where clause:
   - If preset === "today": deadline between start and end of today, status: PENDING
   - If preset === "overdue": deadline < start of today, status: PENDING
   - If preset === "this_week": deadline between today and end of week, status: PENDING
   - If preset === "my_tasks": assigneeId equals current user
   - Apply type, status, assigneeId filters if provided
   - If search: title contains search string (case-insensitive)
5. Query tasks with includes:
   - assignee: { select: { id, name, image } }
   - createdBy: { select: { id, name } }
   - linkedOrder: { select: { id, shopifyOrderNumber } }
   - linkedProduct: { select: { id, title } }
   - linkedInvoice: { select: { id, invoiceNumber } }
   - _count: { attachments: true }
6. Sort by: status ASC (PENDING first), then priority DESC (use raw: CASE WHEN for enum ordering), then deadline ASC NULLS LAST
7. Return { tasks, count: tasks.length }

**POST handler:**
1. Authenticate, return 401 if not authenticated
2. Check hasPermission for "tasks.create", return 403 if denied
3. Parse body: title (required), description, type, priority, deadline, assigneeId, linkedOrderId, linkedProductId, linkedInvoiceId
4. Validate title is not empty
5. Create task with createdById from session.user.id
6. Return created task with 201 status

Use Romanian error messages (e.g., "Trebuie sa fii autentificat", "Nu ai permisiunea de a crea task-uri", "Titlul este obligatoriu").
  </action>
  <verify>Run `npx tsc --noEmit` - file should compile without errors</verify>
  <done>GET /api/tasks and POST /api/tasks endpoints work with authentication, permissions, and filtering</done>
</task>

<task type="auto">
  <name>Task 2: Create task detail, update, delete API route</name>
  <files>src/app/api/tasks/[id]/route.ts</files>
  <action>
Create `src/app/api/tasks/[id]/route.ts`:

**GET handler:**
1. Authenticate, return 401 if not authenticated
2. Check hasPermission for "tasks.view", return 403 if denied
3. Extract id from params
4. Query task with full includes:
   - assignee, createdBy, completedBy (with name, image)
   - linkedOrder, linkedProduct, linkedInvoice
   - attachments (with uploadedBy)
5. Return 404 if not found: "Task-ul nu a fost gasit"
6. Return { task }

**PATCH handler:**
1. Authenticate, return 401 if not authenticated
2. Check hasPermission for "tasks.edit", return 403 if denied
3. Extract id from params, parse body
4. Query existing task
5. Return 404 if not found
6. **Reassignment validation (per CONTEXT.md):**
   - If assigneeId is changing AND new assigneeId !== old assigneeId:
   - Require reassignmentNote in body
   - Return 400 if missing: "Nota de transfer este obligatorie la reasignare"
7. Build update data from body fields (title, description, type, priority, deadline, assigneeId, reassignmentNote, linkedOrderId, linkedProductId, linkedInvoiceId)
8. Update task, return { task }

**DELETE handler:**
1. Authenticate, return 401 if not authenticated
2. Check hasPermission for "tasks.delete", return 403 if denied
3. Extract id from params
4. Delete task (cascade will handle attachments)
5. Return { success: true }

Use Romanian error messages throughout.
  </action>
  <verify>Run `npx tsc --noEmit` - file should compile without errors</verify>
  <done>GET, PATCH, DELETE /api/tasks/[id] endpoints work with reassignment validation</done>
</task>

<task type="auto">
  <name>Task 3: Create task completion toggle API route</name>
  <files>src/app/api/tasks/[id]/complete/route.ts</files>
  <action>
Create `src/app/api/tasks/[id]/complete/route.ts`:

**POST handler:**
1. Authenticate, return 401 if not authenticated
2. Check hasPermission for "tasks.edit", return 403 if denied
3. Extract id from params
4. Query existing task (select id, status)
5. Return 404 if not found: "Task-ul nu a fost gasit"
6. Toggle status:
   - If current status === PENDING:
     - Update to COMPLETED
     - Set completedAt to new Date()
     - Set completedById to session.user.id
   - If current status === COMPLETED:
     - Update to PENDING
     - Set completedAt to null
     - Set completedById to null
7. Return { task } with updated fields

This enables the single-click completion flow specified in CONTEXT.md.
  </action>
  <verify>Run `npx tsc --noEmit` - file should compile without errors</verify>
  <done>POST /api/tasks/[id]/complete toggles task between PENDING and COMPLETED</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for all new files
2. All API routes follow authentication pattern from existing endpoints
3. Romanian error messages used throughout
4. Reassignment requires note (validated in PATCH)
5. Completion toggle sets/clears completedAt and completedById
</verification>

<success_criteria>
- GET /api/tasks returns tasks array with filter support (type, status, preset, assigneeId, search)
- POST /api/tasks creates task with createdById from session
- PATCH /api/tasks/[id] validates reassignment note requirement
- DELETE /api/tasks/[id] removes task
- POST /api/tasks/[id]/complete toggles completion status
- All endpoints return 401 without auth, 403 without permission
</success_criteria>

<output>
After completion, create `.planning/phases/07-task-management-core/07-02-SUMMARY.md`
</output>
