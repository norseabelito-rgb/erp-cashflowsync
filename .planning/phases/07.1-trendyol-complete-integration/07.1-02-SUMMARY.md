---
phase: 7.1
plan: 02
subsystem: orders-integration
tags: [trendyol, orders, sync, multi-source]
dependency-graph:
  requires: [07.1-01]
  provides: [unified-order-table, trendyol-order-sync, source-filter]
  affects: [07.1-03, 07.1-04, 07.1-05, 07.1-06]
tech-stack:
  added: []
  patterns: [multi-source-orders, virtual-stores]
key-files:
  created:
    - src/lib/trendyol-order-sync.ts
  modified:
    - prisma/schema.prisma
    - src/app/api/trendyol/webhook/route.ts
    - src/app/(dashboard)/orders/page.tsx
    - src/app/api/orders/route.ts
decisions:
  - id: 07.1-02-001
    decision: Keep shopifyOrderId/shopifyOrderNumber field names for backward compatibility
    rationale: Avoid large migration; Trendyol uses same fields with different source value
  - id: 07.1-02-002
    decision: Virtual store per Trendyol supplier ID
    rationale: Store is required for Order; one virtual store per Trendyol account
  - id: 07.1-02-003
    decision: Trendyol orders default to PASSED validation status
    rationale: Trendyol marketplace validates addresses/phones before forwarding orders
  - id: 07.1-02-004
    decision: Source field with default "shopify" for backward compat
    rationale: All existing orders are from Shopify; no data migration needed
metrics:
  duration: ~8 min
  completed: 2026-01-30
---

# Phase 7.1 Plan 02: Order Table Integration Summary

**One-liner:** Multi-source order support with Trendyol sync service and unified order list

## What Was Accomplished

### Task 1: Order Schema Extension
Extended the Order model with a `source` field to distinguish between order origins:
- Added `source` field with default "shopify"
- Added index for efficient source filtering
- Backward compatible - no data migration needed

### Task 2-4: Trendyol Order Sync Service
Created comprehensive sync service (`src/lib/trendyol-order-sync.ts`):
- `syncTrendyolOrderToMainOrder()` - Creates/updates Order from TrendyolOrder
- `findOrCreateTrendyolStore()` - Virtual store management
- `syncAllTrendyolOrdersToMain()` - Batch sync utility
- `updateOrderStatusFromTrendyol()` - Status update helper
- Name extraction (first/last from full name)
- Currency handling (keeps original EUR/TRY)
- Status mapping using existing `mapTrendyolToInternalStatus()`

### Task 5: Webhook Handler Enhancement
Updated webhook handler to sync orders to main Order table:
- OrderCreated: Syncs TrendyolOrder to Order table
- OrderStatusChanged: Updates both TrendyolOrder and linked Order
- OrderCancelled/OrderReturned: Updates Order status to CANCELLED/RETURNED
- ShipmentDelivered: Updates Order status to DELIVERED

### Task 6: Orders Page Multi-Source UI
Added source awareness to orders page:
- Source filter dropdown (Toate sursele / Shopify / Trendyol)
- Source badge with distinct styling for Trendyol (orange)
- Updated filter state and query keys
- Clear filters includes source reset

### Task 7: Orders API Source Filter
Added source filter support to orders API:
- `source` query parameter parsing
- Filter by shopify, trendyol, or manual sources

## Commits

| Commit | Description |
|--------|-------------|
| 38fed07 | Add source field to Order schema |
| 126bc6d | Create Trendyol order sync service |
| 4e9effc | Update webhook handler for order sync |
| 678abf5 | Add source filter and badge to orders page |
| 1327973 | Add source filter to orders API |

## Technical Decisions

1. **Field naming (07.1-02-001):** Kept `shopifyOrderId` and `shopifyOrderNumber` names for backward compatibility. Trendyol orders use these same fields with `source: "trendyol"`.

2. **Virtual stores (07.1-02-002):** Each Trendyol supplier ID gets one virtual store. Store is required for Order relation, and this approach keeps things clean.

3. **Validation defaults (07.1-02-003):** Trendyol orders default to `PASSED` for phone/address validation since Trendyol marketplace validates these before forwarding.

4. **Source default (07.1-02-004):** Default value "shopify" means no data migration needed - all existing orders are implicitly Shopify orders.

## Deviations from Plan

None - plan executed exactly as written.

## Migration Required

After this plan, run:
```bash
npx prisma migrate dev --name add_order_source_field
# or for production:
npx prisma migrate deploy
```

Then regenerate the Prisma client:
```bash
npx prisma generate
```

## Verification Status

- [x] New Trendyol orders create corresponding Order records (webhook handler)
- [x] Order list shows both Shopify and Trendyol orders (source badge)
- [x] Source filter works correctly (API + UI)
- [x] Source badge displays correctly (orange for Trendyol)
- [x] LineItems are created for Trendyol orders (sync service)
- [x] Company is correctly set from Trendyol settings
- [x] Status mapping works for all Trendyol statuses

## Next Phase Readiness

Ready for:
- **07.1-03:** Invoice auto-send to Trendyol (can now find linked TrendyolOrder from Order)
- **07.1-04:** AWB tracking auto-send (same linkage available)
- **07.1-05:** Stock/price sync (can identify Trendyol products)
- **07.1-06:** Unified dashboard (source filtering available)

## Files Changed

| File | Change Type | Description |
|------|-------------|-------------|
| prisma/schema.prisma | Modified | Added source field with index |
| src/lib/trendyol-order-sync.ts | Created | Complete sync service |
| src/app/api/trendyol/webhook/route.ts | Modified | Order sync on webhooks |
| src/app/(dashboard)/orders/page.tsx | Modified | Source filter + badge |
| src/app/api/orders/route.ts | Modified | Source filter support |
