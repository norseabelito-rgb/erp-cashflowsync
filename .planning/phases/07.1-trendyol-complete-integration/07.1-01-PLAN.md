# Plan 07.1-01: Webhook Receiver & Company Association

## Overview

**Phase**: 7.1 - Trendyol Complete Integration
**Plan**: 01 of 06
**Wave**: 1 (Foundation)
**Depends on**: Nothing (first plan)
**Estimated complexity**: Medium

## Goal

Enable real-time order notifications from Trendyol via webhooks and allow associating Trendyol accounts with specific companies for multi-company support.

## Context

Currently:
- Orders are fetched via manual polling (button click)
- No webhook endpoint exists
- Trendyol settings are global, not company-specific
- Settings table has Trendyol fields but lacks `trendyolWebhookSecret`

Trendyol webhooks support events: Created, Picking, Invoiced, Shipped, Delivered, Cancelled, Returned

## Tasks

### Task 1: Extend Settings Schema for Webhook & Company

**File**: `prisma/schema.prisma`

Add to Settings model:
```prisma
// In Settings model, add:
trendyolWebhookSecret  String?   // HMAC secret for webhook validation
trendyolCompanyId      String?   // Company associated with this Trendyol account
trendyolCompany        Company?  @relation("TrendyolCompany", fields: [trendyolCompanyId], references: [id])
```

Add to Company model:
```prisma
// In Company model, add relation:
trendyolSettings       Settings? @relation("TrendyolCompany")
```

### Task 2: Create Webhook Receiver Endpoint

**File**: `src/app/api/trendyol/webhook/route.ts` (new)

```typescript
// POST /api/trendyol/webhook
// 1. Validate HMAC signature using trendyolWebhookSecret
// 2. Parse webhook payload
// 3. Handle event types:
//    - OrderCreated: Queue for sync
//    - OrderStatusChanged: Update TrendyolOrder.status
//    - OrderCancelled: Mark as cancelled
// 4. Return 200 OK quickly (process async if needed)
```

Validation logic:
```typescript
function validateTrendyolWebhook(
  payload: string,
  signature: string,
  secret: string
): boolean {
  const hmac = crypto.createHmac('sha256', secret);
  hmac.update(payload);
  const expectedSignature = hmac.digest('hex');
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

### Task 3: Create Webhook Registration Helper

**File**: `src/lib/trendyol.ts`

Add methods to TrendyolClient:
```typescript
// Register webhook with Trendyol
async registerWebhook(callbackUrl: string, events: string[]): Promise<TrendyolApiResponse<{ webhookId: string }>>

// List registered webhooks
async listWebhooks(): Promise<TrendyolApiResponse<{ webhooks: Array<{ id: string; url: string; events: string[] }> }>>

// Delete webhook
async deleteWebhook(webhookId: string): Promise<TrendyolApiResponse<void>>
```

### Task 4: Update Settings UI for Webhook & Company

**File**: `src/app/(dashboard)/settings/page.tsx`

In Trendyol tab, add:
1. **Company dropdown**: Select which company this Trendyol account belongs to
2. **Webhook Secret field**: Auto-generated or manual input
3. **Webhook URL display**: Show the webhook URL to register in Trendyol panel
4. **Webhook Status**: Show if webhook is registered (with register/unregister buttons)

UI additions:
```tsx
// Company selection
<Select value={trendyolCompanyId} onValueChange={setTrendyolCompanyId}>
  <SelectTrigger><SelectValue placeholder="Selecteaza firma" /></SelectTrigger>
  <SelectContent>
    {companies.map(c => <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>)}
  </SelectContent>
</Select>

// Webhook secret (auto-generate button)
<div className="flex gap-2">
  <Input value={webhookSecret} readOnly />
  <Button onClick={generateWebhookSecret}>Genereaza</Button>
</div>

// Webhook URL (copy button)
<div className="flex gap-2">
  <Input value={`${baseUrl}/api/trendyol/webhook`} readOnly />
  <Button onClick={copyToClipboard}>Copiaza</Button>
</div>
```

### Task 5: API Endpoint for Webhook Management

**File**: `src/app/api/trendyol/route.ts`

Add actions:
```typescript
case "generateWebhookSecret":
  // Generate crypto.randomBytes(32).toString('hex')
  // Save to settings
  // Return secret

case "registerWebhook":
  // Call TrendyolClient.registerWebhook()
  // Store webhook ID in settings

case "unregisterWebhook":
  // Call TrendyolClient.deleteWebhook()
  // Clear webhook ID from settings
```

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `prisma/schema.prisma` | MODIFY | Add trendyolWebhookSecret, trendyolCompanyId to Settings |
| `src/app/api/trendyol/webhook/route.ts` | CREATE | Webhook receiver endpoint |
| `src/lib/trendyol.ts` | MODIFY | Add webhook registration methods |
| `src/app/(dashboard)/settings/page.tsx` | MODIFY | Add company dropdown, webhook config UI |
| `src/app/api/trendyol/route.ts` | MODIFY | Add webhook management actions |

## Verification

- [ ] Webhook endpoint returns 200 for valid HMAC signature
- [ ] Webhook endpoint returns 401 for invalid signature
- [ ] Company can be selected in Settings UI
- [ ] Webhook secret can be generated and saved
- [ ] Webhook URL is displayed and copyable
- [ ] Webhook registration with Trendyol API works (if supported)

## Notes

- Webhook secret should be cryptographically random (32+ bytes)
- Use timing-safe comparison for HMAC validation
- Process webhook events asynchronously to return 200 quickly
- Log all incoming webhooks for debugging
- Consider rate limiting on webhook endpoint
