# Plan 07.1-06: Unified Dashboard & Gap Closure

## Overview

**Phase**: 7.1 - Trendyol Complete Integration
**Plan**: 06 of 06
**Wave**: 5 (Finalization)
**Depends on**: 07.1-01 through 07.1-05
**Estimated complexity**: Medium

## Goal

Create a unified dashboard experience showing Trendyol alongside Shopify, close any gaps in the integration, and ensure the complete flow works end-to-end.

## Context

After previous plans:
- Trendyol orders are in main Order table
- Invoice/AWB send to Trendyol works
- Stock sync works

Gaps to close:
- Trendyol orders page still exists separately
- No unified dashboard metrics
- Process-all flow needs to handle Trendyol orders
- Return handling for Trendyol orders

## Tasks

### Task 1: Add Trendyol Metrics to Main Dashboard

**File**: `src/app/(dashboard)/page.tsx` or dashboard component

```tsx
// Fetch Trendyol stats alongside Shopify
const [trendyolStats, setTrendyolStats] = useState({
  ordersToday: 0,
  revenue: 0,
  pendingOrders: 0
});

useEffect(() => {
  // Fetch from /api/trendyol/stats
  fetch("/api/trendyol/stats")
    .then(r => r.json())
    .then(data => setTrendyolStats(data));
}, []);

// Display in dashboard
<div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
  {/* Existing Shopify cards */}
  <Card>
    <CardHeader>
      <CardTitle>Comenzi Shopify</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="text-2xl font-bold">{shopifyStats.ordersToday}</div>
    </CardContent>
  </Card>

  {/* Trendyol cards */}
  <Card>
    <CardHeader>
      <CardTitle>Comenzi Trendyol</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="text-2xl font-bold">{trendyolStats.ordersToday}</div>
    </CardContent>
  </Card>

  {/* Combined card */}
  <Card>
    <CardHeader>
      <CardTitle>Total Comenzi Azi</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="text-2xl font-bold">
        {shopifyStats.ordersToday + trendyolStats.ordersToday}
      </div>
    </CardContent>
  </Card>
</div>
```

### Task 2: Update Trendyol Orders Page as Secondary View

**File**: `src/app/(dashboard)/trendyol/orders/page.tsx`

Convert from primary to secondary/detailed view:
```tsx
// Add notice that orders are also in main Orders page
<Alert>
  <InfoIcon className="h-4 w-4" />
  <AlertDescription>
    Comenzile Trendyol apar si in <Link href="/orders">lista principala de comenzi</Link>.
    Aceasta pagina ofera detalii specifice Trendyol.
  </AlertDescription>
</Alert>

// Show Trendyol-specific info not in main orders:
// - shipmentPackageId
// - Trendyol status (original, not mapped)
// - Invoice/AWB send status
// - Link to Trendyol seller panel
```

### Task 3: Integrate Trendyol into Process-All Flow

**File**: `src/app/api/orders/process-all/route.ts` (or equivalent)

```typescript
// Process-all should handle both Shopify and Trendyol orders
const ordersToProcess = await prisma.order.findMany({
  where: {
    status: "PENDING",
    // Include both sources
    OR: [
      { source: "shopify" },
      { source: "trendyol" }
    ]
  }
});

// For each order, process normally
// The invoice/AWB hooks will automatically send to Trendyol if needed
```

### Task 4: Add Trendyol Sync Button to Orders Page

**File**: `src/app/(dashboard)/orders/page.tsx`

```tsx
// Add button to sync new Trendyol orders
const [syncingTrendyol, setSyncingTrendyol] = useState(false);

const handleSyncTrendyol = async () => {
  setSyncingTrendyol(true);
  try {
    const response = await fetch("/api/trendyol/orders", {
      method: "POST"
    });
    const result = await response.json();
    toast.success(`Sincronizat ${result.imported} comenzi noi`);
    // Refresh order list
    refetchOrders();
  } catch (error) {
    toast.error("Eroare la sincronizare Trendyol");
  } finally {
    setSyncingTrendyol(false);
  }
};

// In toolbar
<Button variant="outline" onClick={handleSyncTrendyol} disabled={syncingTrendyol}>
  {syncingTrendyol ? (
    <Loader2 className="h-4 w-4 animate-spin" />
  ) : (
    <RefreshCw className="h-4 w-4" />
  )}
  <span className="ml-2">Sync Trendyol</span>
</Button>
```

### Task 5: Handle Trendyol Returns

**File**: `src/lib/trendyol-returns.ts` (new)

```typescript
/**
 * Handle return notifications from Trendyol webhook
 */
export async function handleTrendyolReturn(
  trendyolOrderId: string,
  returnReason: string
): Promise<void> {
  // 1. Find the TrendyolOrder and linked Order
  const trendyolOrder = await prisma.trendyolOrder.findFirst({
    where: { trendyolOrderId },
    include: { order: true }
  });

  if (!trendyolOrder?.order) {
    console.warn(`[Trendyol] Return for unknown order: ${trendyolOrderId}`);
    return;
  }

  // 2. Update TrendyolOrder status
  await prisma.trendyolOrder.update({
    where: { id: trendyolOrder.id },
    data: { status: "Returned" }
  });

  // 3. Update Order status
  await prisma.order.update({
    where: { id: trendyolOrder.order.id },
    data: { status: "CANCELLED" } // Or RETURNED if we add that status
  });

  // 4. Create a ReturnAWB record if applicable
  // (Uses existing return AWB infrastructure from q002)

  // 5. Log for audit
  await prisma.auditLog.create({
    data: {
      actionType: "UPDATE",
      entityType: "Order",
      entityId: trendyolOrder.order.id,
      details: {
        action: "trendyol_return",
        reason: returnReason,
        trendyolOrderId
      }
    }
  });
}
```

### Task 6: Update Webhook Handler for All Events

**File**: `src/app/api/trendyol/webhook/route.ts`

Complete the webhook handler for all event types:
```typescript
switch (event.type) {
  case "OrderCreated":
    await syncTrendyolOrderToMainOrder(event.data, settings);
    break;

  case "OrderStatusChanged":
    await updateOrderStatus(event.data.orderId, event.data.newStatus);
    break;

  case "OrderCancelled":
    await handleTrendyolCancellation(event.data.orderId);
    break;

  case "OrderReturned":
    await handleTrendyolReturn(event.data.orderId, event.data.returnReason);
    break;

  case "OrderDelivered":
    await markOrderDelivered(event.data.orderId);
    break;

  default:
    console.log(`[Trendyol Webhook] Unhandled event type: ${event.type}`);
}
```

### Task 7: Add Trendyol Status Column to Orders Table

**File**: `src/app/(dashboard)/orders/page.tsx`

```tsx
// Add column showing Trendyol-specific status
<TableHead>Status Trendyol</TableHead>

// In row
<TableCell>
  {order.source === "trendyol" && order.trendyolOrder && (
    <div className="flex flex-col gap-1">
      <Badge variant="outline">{order.trendyolOrder.status}</Badge>
      <div className="flex gap-1">
        {order.trendyolOrder.invoiceSentToTrendyol && (
          <Tooltip content="Factura trimisa">
            <FileText className="h-3 w-3 text-green-500" />
          </Tooltip>
        )}
        {order.trendyolOrder.trackingSentToTrendyol && (
          <Tooltip content="AWB trimis">
            <Truck className="h-3 w-3 text-green-500" />
          </Tooltip>
        )}
      </div>
    </div>
  )}
</TableCell>
```

### Task 8: Update Sidebar Navigation

**File**: `src/components/sidebar.tsx`

Organize Trendyol pages under a section:
```tsx
// Add Trendyol section
{
  title: "Trendyol",
  icon: ShoppingBag, // Or Trendyol logo
  children: [
    { title: "Produse", href: "/trendyol" },
    { title: "Mapare Categorii", href: "/trendyol/mapping" },
    { title: "Publicare", href: "/trendyol/publish" },
    { title: "Comenzi Detalii", href: "/trendyol/orders" },
  ]
}
```

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `src/app/(dashboard)/page.tsx` | MODIFY | Add Trendyol metrics |
| `src/app/(dashboard)/trendyol/orders/page.tsx` | MODIFY | Convert to detail view |
| `src/app/api/orders/process-all/route.ts` | MODIFY | Include Trendyol orders |
| `src/app/(dashboard)/orders/page.tsx` | MODIFY | Add sync button, status column |
| `src/lib/trendyol-returns.ts` | CREATE | Return handling |
| `src/app/api/trendyol/webhook/route.ts` | MODIFY | Complete all events |
| `src/components/sidebar.tsx` | MODIFY | Organize navigation |

## Verification (End-to-End Flow)

- [ ] Webhook receives order â†’ Order appears in main list
- [ ] Order can be processed (validate, invoice, AWB)
- [ ] Invoice is sent to Trendyol automatically
- [ ] AWB tracking is sent to Trendyol automatically
- [ ] Order status updates reflect in both Order and TrendyolOrder
- [ ] Returns/cancellations are handled
- [ ] Dashboard shows combined Shopify + Trendyol metrics
- [ ] Trendyol orders appear in unified order list with source badge

## Success Criteria for Phase 7.1

After all 6 plans are complete:

1. **Real-time sync**: Webhook receives Trendyol orders instantly
2. **Unified view**: Orders from both channels in one list
3. **Full workflow**: Invoice + AWB generation works for Trendyol
4. **Feedback loop**: Invoice link + tracking sent back to Trendyol
5. **Stock sync**: Product updates reflect on Trendyol
6. **Company support**: Trendyol account linked to specific company
7. **Returns**: Handled via webhook or manual process

## Notes

- Test end-to-end flow with a real Trendyol test order
- Monitor webhook for missed events
- Consider rate limits on Trendyol API
- Document any Trendyol-specific quirks for user training
