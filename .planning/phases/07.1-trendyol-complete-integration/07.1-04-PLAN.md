# Plan 07.1-04: AWB Tracking Integration

## Overview

**Phase**: 7.1 - Trendyol Complete Integration
**Plan**: 04 of 06
**Wave**: 3 (Invoice & AWB)
**Depends on**: 07.1-02 (orders must be in main Order table)
**Estimated complexity**: Medium

## Goal

When an AWB is generated for a Trendyol order (FanCourier/Sameday), automatically send the tracking number back to Trendyol so customers can track their packages.

## Context

Current state:
- AWB generation works for orders via FanCourier/Sameday
- `updateTrackingNumber()` method exists in TrendyolClient but is not called
- TrendyolOrder has `shipmentPackageId` and `cargoTrackingNumber` fields
- No automatic trigger after AWB creation

Desired state:
- After AWB is created for a Trendyol order, send tracking number to Trendyol
- Track AWB send status on TrendyolOrder
- Map local courier names to Trendyol cargo provider names

## Tasks

### Task 1: Extend TrendyolOrder Schema for AWB Tracking

**File**: `prisma/schema.prisma`

```prisma
model TrendyolOrder {
  // ... existing fields

  // AWB tracking (add if not exists)
  trackingSentToTrendyol  Boolean   @default(false)
  trackingSentAt          DateTime?
  trackingSendError       String?
  localAwbNumber          String?   // AWB from FanCourier/Sameday
  localCarrier            String?   // "fancourier" | "sameday" | etc.
}
```

### Task 2: Create Courier Mapping

**File**: `src/lib/trendyol-courier-map.ts` (new)

```typescript
/**
 * Maps local courier names to Trendyol cargo provider names
 *
 * Note: Trendyol International (EU) supports different carriers than Turkey.
 * These mappings are for Romania market.
 */
export const COURIER_TO_TRENDYOL: Record<string, string> = {
  // Romanian carriers
  "fancourier": "FAN Courier",
  "sameday": "Sameday",
  "dpd": "DPD",
  "gls": "GLS",
  "cargus": "Cargus",

  // Generic fallback
  "other": "Other"
};

export function getTrendyolCargoProvider(localCarrier: string): string {
  const normalized = localCarrier.toLowerCase().trim();
  return COURIER_TO_TRENDYOL[normalized] || COURIER_TO_TRENDYOL["other"];
}

/**
 * Generates tracking URL for Romanian carriers
 */
export function getTrackingUrl(carrier: string, awbNumber: string): string {
  const urls: Record<string, (awb: string) => string> = {
    "fancourier": (awb) => `https://www.fancourier.ro/awb-tracking/?awb=${awb}`,
    "sameday": (awb) => `https://www.sameday.ro/tracking?awb=${awb}`,
    "dpd": (awb) => `https://tracking.dpd.ro/?parcelNumber=${awb}`,
    "gls": (awb) => `https://gls-group.com/RO/ro/tracking/${awb}`,
    "cargus": (awb) => `https://www.cargus.ro/tracking-colet?t=${awb}`,
  };

  const normalized = carrier.toLowerCase().trim();
  return urls[normalized]?.(awbNumber) || "";
}
```

### Task 3: Create AWB Send Service

**File**: `src/lib/trendyol-awb.ts` (new)

```typescript
import { TrendyolClient } from "./trendyol";
import { prisma } from "./prisma";
import { getTrendyolCargoProvider, getTrackingUrl } from "./trendyol-courier-map";

interface SendTrackingResult {
  success: boolean;
  error?: string;
}

/**
 * Sends AWB tracking number to Trendyol after AWB creation
 */
export async function sendTrackingToTrendyol(
  orderId: string,
  awbNumber: string,
  carrier: string
): Promise<SendTrackingResult> {
  // 1. Get the TrendyolOrder linked to this Order
  const trendyolOrder = await prisma.trendyolOrder.findFirst({
    where: { orderId }
  });

  if (!trendyolOrder) {
    return { success: true }; // Not a Trendyol order, skip
  }

  if (!trendyolOrder.shipmentPackageId) {
    return {
      success: false,
      error: "Missing shipmentPackageId - cannot send tracking to Trendyol"
    };
  }

  // 2. Get Trendyol settings
  const settings = await prisma.settings.findFirst();
  if (!settings?.trendyolApiKey || !settings?.trendyolApiSecret) {
    return {
      success: false,
      error: "Trendyol API credentials not configured"
    };
  }

  // 3. Map carrier to Trendyol provider name
  const cargoProviderName = getTrendyolCargoProvider(carrier);

  // 4. Send tracking to Trendyol
  const client = new TrendyolClient({
    supplierId: settings.trendyolSupplierId!,
    apiKey: settings.trendyolApiKey,
    apiSecret: settings.trendyolApiSecret,
    isTestMode: settings.trendyolIsTestMode
  });

  try {
    const result = await client.updateTrackingNumber(
      parseInt(trendyolOrder.shipmentPackageId),
      awbNumber,
      cargoProviderName
    );

    if (result.success) {
      // Update TrendyolOrder with success
      await prisma.trendyolOrder.update({
        where: { id: trendyolOrder.id },
        data: {
          trackingSentToTrendyol: true,
          trackingSentAt: new Date(),
          localAwbNumber: awbNumber,
          localCarrier: carrier,
          cargoTrackingNumber: awbNumber,
          cargoProviderName: cargoProviderName,
          cargoTrackingLink: getTrackingUrl(carrier, awbNumber),
          trackingSendError: null
        }
      });

      console.log(`[Trendyol] Tracking sent for order ${trendyolOrder.trendyolOrderNumber}: ${awbNumber}`);
      return { success: true };
    } else {
      await prisma.trendyolOrder.update({
        where: { id: trendyolOrder.id },
        data: {
          localAwbNumber: awbNumber,
          localCarrier: carrier,
          trackingSendError: result.error || "Unknown error"
        }
      });

      return { success: false, error: result.error };
    }
  } catch (error) {
    const errorMsg = error instanceof Error ? error.message : "Unknown error";

    await prisma.trendyolOrder.update({
      where: { id: trendyolOrder.id },
      data: {
        localAwbNumber: awbNumber,
        localCarrier: carrier,
        trackingSendError: errorMsg
      }
    });

    return { success: false, error: errorMsg };
  }
}
```

### Task 4: Hook into AWB Creation Flow

**File**: `src/app/api/awb/route.ts` (or wherever AWBs are created)

After successful AWB creation:
```typescript
// After creating AWB with FanCourier/Sameday
const awb = await generateAWB(orderData, courier);

// If this is a Trendyol order, send tracking to Trendyol
if (order.source === "trendyol") {
  sendTrackingToTrendyol(order.id, awb.awbNumber, courier).catch(err => {
    console.error("[Trendyol] Failed to send tracking:", err);
    // Don't throw - AWB was created successfully
  });
}
```

### Task 5: Add Tracking Status to Order Detail UI

**File**: `src/app/(dashboard)/orders/[id]/page.tsx` or Order detail component

```tsx
// Extend Trendyol status card
{order.source === "trendyol" && order.trendyolOrder && (
  <Card>
    <CardHeader>
      <CardTitle className="text-sm">Status Trendyol</CardTitle>
    </CardHeader>
    <CardContent className="space-y-2">
      {/* Invoice status */}
      <div className="flex items-center gap-2">
        <span>Factura trimisa:</span>
        {/* ... existing invoice status */}
      </div>

      {/* AWB status */}
      <div className="flex items-center gap-2">
        <span>AWB trimis:</span>
        {order.trendyolOrder.trackingSentToTrendyol ? (
          <Badge variant="success">Da ({order.trendyolOrder.localAwbNumber})</Badge>
        ) : order.trendyolOrder.trackingSendError ? (
          <div className="flex items-center gap-1">
            <Tooltip content={order.trendyolOrder.trackingSendError}>
              <Badge variant="destructive">Eroare</Badge>
            </Tooltip>
            <Button size="sm" variant="ghost" onClick={() => retryTracking(order.id)}>
              Reincearca
            </Button>
          </div>
        ) : order.awb ? (
          <Badge variant="secondary">In asteptare</Badge>
        ) : (
          <Badge variant="outline">N/A</Badge>
        )}
      </div>
    </CardContent>
  </Card>
)}
```

### Task 6: API Endpoint for Manual Retry

**File**: `src/app/api/trendyol/route.ts`

```typescript
case "retrySendTracking":
  const { orderId: trackingOrderId } = await request.json();

  const order = await prisma.order.findUnique({
    where: { id: trackingOrderId },
    include: { awb: true }
  });

  if (!order?.awb) {
    return NextResponse.json(
      { success: false, error: "No AWB found for this order" },
      { status: 400 }
    );
  }

  const carrier = order.awb.courier || "fancourier"; // Default
  const retryTrackingResult = await sendTrackingToTrendyol(
    trackingOrderId,
    order.awb.awbNumber,
    carrier
  );

  return NextResponse.json(retryTrackingResult);
```

### Task 7: Update Order Status to Shipped

**File**: `src/lib/trendyol-awb.ts`

After successfully sending tracking, also update order status on Trendyol:
```typescript
// After sending tracking, update order status to "Shipped"
// Some Trendyol implementations require this as a separate call
// The updateTrackingNumber call should handle this, but verify behavior
```

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `prisma/schema.prisma` | MODIFY | Add tracking fields to TrendyolOrder |
| `src/lib/trendyol-courier-map.ts` | CREATE | Courier name mapping |
| `src/lib/trendyol-awb.ts` | CREATE | AWB send service |
| `src/app/api/awb/route.ts` | MODIFY | Hook into AWB creation |
| `src/app/(dashboard)/orders/[id]/page.tsx` | MODIFY | Show tracking status |
| `src/app/api/trendyol/route.ts` | MODIFY | Add retry endpoint |

## Verification

- [ ] Tracking number is sent to Trendyol after AWB creation
- [ ] Courier name is correctly mapped to Trendyol provider
- [ ] Success is tracked on TrendyolOrder
- [ ] Errors are logged and stored for debugging
- [ ] Tracking status is visible in order detail
- [ ] Manual retry works for failed sends
- [ ] Non-Trendyol orders are not affected

## Notes

- AWB send should be non-blocking (don't fail if Trendyol API is down)
- Courier mapping may need adjustment based on Trendyol's accepted values
- Test with real orders to verify cargo provider names are accepted
- Consider background job for retries
