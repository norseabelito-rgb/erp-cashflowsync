# Plan 07.1-03: Invoice Integration & Auto-Send to Trendyol

## Overview

**Phase**: 7.1 - Trendyol Complete Integration
**Plan**: 03 of 06
**Wave**: 3 (Invoice & AWB)
**Depends on**: 07.1-02 (orders must be in main Order table)
**Estimated complexity**: Medium

## Goal

When an invoice is generated for a Trendyol order via Oblio, automatically send the invoice link back to Trendyol so customers can access it from their Trendyol account.

## Context

Current state:
- Invoice generation works for Shopify orders via Oblio
- `sendInvoiceLink()` method exists in TrendyolClient but is not called
- TrendyolOrder has `shipmentPackageId` needed for API call
- No automatic trigger after invoice creation

Desired state:
- After Oblio invoice is created for a Trendyol order, send link to Trendyol
- Track invoice send status on TrendyolOrder
- Handle errors gracefully (don't block invoice flow)

## Tasks

### Task 1: Extend TrendyolOrder Schema for Invoice Tracking

**File**: `prisma/schema.prisma`

```prisma
model TrendyolOrder {
  // ... existing fields

  // Invoice tracking
  invoiceSentToTrendyol   Boolean   @default(false)
  invoiceSentAt           DateTime?
  invoiceSendError        String?
  oblioInvoiceLink        String?   // The public link sent to Trendyol
}
```

### Task 2: Create Invoice Send Service

**File**: `src/lib/trendyol-invoice.ts` (new)

```typescript
import { TrendyolClient } from "./trendyol";
import { prisma } from "./prisma";

interface SendInvoiceResult {
  success: boolean;
  error?: string;
}

/**
 * Sends the invoice link to Trendyol after Oblio invoice creation
 */
export async function sendInvoiceToTrendyol(
  orderId: string,
  invoiceLink: string
): Promise<SendInvoiceResult> {
  // 1. Get the TrendyolOrder linked to this Order
  const trendyolOrder = await prisma.trendyolOrder.findFirst({
    where: { orderId },
    include: { order: { include: { store: true } } }
  });

  if (!trendyolOrder) {
    return { success: true }; // Not a Trendyol order, skip
  }

  if (!trendyolOrder.shipmentPackageId) {
    return {
      success: false,
      error: "Missing shipmentPackageId - cannot send invoice to Trendyol"
    };
  }

  // 2. Get Trendyol settings
  const settings = await prisma.settings.findFirst();
  if (!settings?.trendyolApiKey || !settings?.trendyolApiSecret) {
    return {
      success: false,
      error: "Trendyol API credentials not configured"
    };
  }

  // 3. Send invoice link to Trendyol
  const client = new TrendyolClient({
    supplierId: settings.trendyolSupplierId!,
    apiKey: settings.trendyolApiKey,
    apiSecret: settings.trendyolApiSecret,
    isTestMode: settings.trendyolIsTestMode
  });

  try {
    const result = await client.sendInvoiceLink(
      parseInt(trendyolOrder.shipmentPackageId),
      invoiceLink
    );

    if (result.success) {
      // Update TrendyolOrder with success
      await prisma.trendyolOrder.update({
        where: { id: trendyolOrder.id },
        data: {
          invoiceSentToTrendyol: true,
          invoiceSentAt: new Date(),
          oblioInvoiceLink: invoiceLink,
          invoiceSendError: null
        }
      });

      console.log(`[Trendyol] Invoice link sent for order ${trendyolOrder.trendyolOrderNumber}`);
      return { success: true };
    } else {
      // Update with error
      await prisma.trendyolOrder.update({
        where: { id: trendyolOrder.id },
        data: {
          invoiceSendError: result.error || "Unknown error"
        }
      });

      return { success: false, error: result.error };
    }
  } catch (error) {
    const errorMsg = error instanceof Error ? error.message : "Unknown error";

    await prisma.trendyolOrder.update({
      where: { id: trendyolOrder.id },
      data: { invoiceSendError: errorMsg }
    });

    return { success: false, error: errorMsg };
  }
}
```

### Task 3: Hook into Invoice Creation Flow

**File**: `src/app/api/invoices/route.ts` (or wherever invoices are created)

After successful Oblio invoice creation:
```typescript
// After creating invoice in Oblio
const invoice = await createOblioInvoice(orderData);

// Get public invoice link from Oblio
const invoiceLink = invoice.publicUrl || `https://oblio.eu/facturi/${invoice.seriesName}${invoice.number}`;

// Send to Trendyol (non-blocking)
if (order.source === "trendyol") {
  sendInvoiceToTrendyol(order.id, invoiceLink).catch(err => {
    console.error("[Trendyol] Failed to send invoice link:", err);
    // Don't throw - invoice was created successfully
  });
}
```

### Task 4: Add Retry Mechanism for Failed Sends

**File**: `src/lib/trendyol-invoice.ts`

```typescript
/**
 * Retry sending invoice for orders that failed previously
 */
export async function retryFailedInvoiceSends(): Promise<{
  total: number;
  success: number;
  failed: number;
}> {
  const failedOrders = await prisma.trendyolOrder.findMany({
    where: {
      invoiceSentToTrendyol: false,
      invoiceSendError: { not: null },
      oblioInvoiceLink: { not: null } // Has link but failed to send
    },
    include: { order: { include: { invoice: true } } }
  });

  let success = 0;
  let failed = 0;

  for (const trendyolOrder of failedOrders) {
    if (trendyolOrder.oblioInvoiceLink) {
      const result = await sendInvoiceToTrendyol(
        trendyolOrder.orderId!,
        trendyolOrder.oblioInvoiceLink
      );

      if (result.success) success++;
      else failed++;
    }
  }

  return { total: failedOrders.length, success, failed };
}
```

### Task 5: Add Invoice Status to Order Detail UI

**File**: `src/app/(dashboard)/orders/[id]/page.tsx` or Order detail component

```tsx
// Show Trendyol invoice status
{order.source === "trendyol" && order.trendyolOrder && (
  <Card>
    <CardHeader>
      <CardTitle className="text-sm">Status Trendyol</CardTitle>
    </CardHeader>
    <CardContent>
      <div className="flex items-center gap-2">
        <span>Factura trimisa:</span>
        {order.trendyolOrder.invoiceSentToTrendyol ? (
          <Badge variant="success">Da</Badge>
        ) : order.trendyolOrder.invoiceSendError ? (
          <Tooltip content={order.trendyolOrder.invoiceSendError}>
            <Badge variant="destructive">Eroare</Badge>
          </Tooltip>
        ) : (
          <Badge variant="secondary">Nu</Badge>
        )}
      </div>
    </CardContent>
  </Card>
)}
```

### Task 6: API Endpoint for Manual Retry

**File**: `src/app/api/trendyol/route.ts`

```typescript
case "retrySendInvoice":
  const { orderId: retryOrderId } = await request.json();

  const trendyolOrder = await prisma.trendyolOrder.findFirst({
    where: { orderId: retryOrderId },
    include: { order: { include: { invoice: true } } }
  });

  if (!trendyolOrder?.oblioInvoiceLink) {
    return NextResponse.json(
      { success: false, error: "No invoice link available" },
      { status: 400 }
    );
  }

  const retryResult = await sendInvoiceToTrendyol(
    retryOrderId,
    trendyolOrder.oblioInvoiceLink
  );

  return NextResponse.json(retryResult);
```

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `prisma/schema.prisma` | MODIFY | Add invoice tracking fields to TrendyolOrder |
| `src/lib/trendyol-invoice.ts` | CREATE | Invoice send service |
| `src/app/api/invoices/route.ts` | MODIFY | Hook into invoice creation |
| `src/app/(dashboard)/orders/[id]/page.tsx` | MODIFY | Show invoice status |
| `src/app/api/trendyol/route.ts` | MODIFY | Add retry endpoint |

## Verification

- [ ] Invoice link is sent to Trendyol after Oblio invoice creation
- [ ] Success is tracked on TrendyolOrder
- [ ] Errors are logged and stored for debugging
- [ ] Invoice status is visible in order detail
- [ ] Manual retry works for failed sends
- [ ] Non-Trendyol orders are not affected

## Notes

- Invoice send should be non-blocking (don't fail if Trendyol API is down)
- Oblio invoice needs to have a public URL - verify this exists
- Consider background job for retries instead of manual button
- Log all API calls for debugging
