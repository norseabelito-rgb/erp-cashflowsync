# Plan 07.1-02: Order Table Integration

## Overview

**Phase**: 7.1 - Trendyol Complete Integration
**Plan**: 02 of 06
**Wave**: 2 (Order Integration)
**Depends on**: 07.1-01 (webhook foundation)
**Estimated complexity**: High

## Goal

Integrate Trendyol orders into the main Order table so they can use the existing invoice/AWB workflow. Orders from Trendyol should appear in the unified order list alongside Shopify orders.

## Context

Current state:
- TrendyolOrder is a separate table with its own lineItems
- TrendyolOrder has `orderId` field linking to Order (but not populated)
- Order table uses `shopifyOrderId` and `shopifyOrderNumber` fields
- No `source` field exists to distinguish order origin

Desired state:
- Trendyol orders create corresponding Order records
- Unified order list shows both Shopify and Trendyol orders
- Same workflow for invoice/AWB generation

## Tasks

### Task 1: Extend Order Schema for Multi-Source

**File**: `prisma/schema.prisma`

```prisma
model Order {
  // Rename for clarity (or keep for backward compat)
  externalOrderId     String   // Was shopifyOrderId - now generic
  externalOrderNumber String   // Was shopifyOrderNumber - now generic
  source              String   @default("shopify") // "shopify" | "trendyol" | "manual"

  // Keep existing shopify fields as aliases (for backward compat)
  // OR migrate data and rename

  // ... rest unchanged
}
```

**Migration strategy**:
1. Add `source` column with default "shopify"
2. Keep `shopifyOrderId`/`shopifyOrderNumber` for now (rename later if desired)
3. For Trendyol orders, store trendyolOrderNumber in shopifyOrderNumber field

### Task 2: Create Order Sync Service

**File**: `src/lib/trendyol-order-sync.ts` (new)

```typescript
/**
 * Syncs a TrendyolOrder to the main Order table
 * Called from:
 * - Webhook handler (real-time)
 * - Manual import button
 */
export async function syncTrendyolOrderToMainOrder(
  trendyolOrder: TrendyolOrder,
  settings: Settings
): Promise<Order> {
  // 1. Find or create Store for Trendyol (virtual store)
  const store = await findOrCreateTrendyolStore(settings);

  // 2. Check if Order already exists
  const existingOrder = await prisma.order.findFirst({
    where: {
      shopifyOrderId: trendyolOrder.trendyolOrderId,
      source: "trendyol"
    }
  });

  if (existingOrder) {
    // Update status only
    return updateOrderFromTrendyol(existingOrder, trendyolOrder);
  }

  // 3. Create new Order
  const order = await prisma.order.create({
    data: {
      shopifyOrderId: trendyolOrder.trendyolOrderId,
      shopifyOrderNumber: trendyolOrder.trendyolOrderNumber,
      source: "trendyol",
      storeId: store.id,
      billingCompanyId: settings.trendyolCompanyId,

      // Customer data
      customerEmail: trendyolOrder.customerEmail,
      customerPhone: trendyolOrder.customerPhone,
      customerFirstName: extractFirstName(trendyolOrder.customerName),
      customerLastName: extractLastName(trendyolOrder.customerName),

      // Shipping address
      shippingAddress1: trendyolOrder.customerAddress,
      shippingCity: trendyolOrder.customerCity,
      shippingProvince: trendyolOrder.customerDistrict,
      shippingZip: trendyolOrder.customerPostalCode,
      shippingCountry: "RO", // or from Trendyol data

      // Financial
      totalPrice: trendyolOrder.totalPrice,
      subtotalPrice: trendyolOrder.totalPrice, // Calculate from items if needed
      totalShipping: 0, // Trendyol handles shipping cost separately
      totalTax: 0, // Calculate from items
      currency: convertCurrency(trendyolOrder.currency), // EUR -> RON

      // Status mapping
      status: mapTrendyolStatusToOrderStatus(trendyolOrder.status),
      financialStatus: "paid", // Trendyol orders are always prepaid

      // Timestamps
      shopifyCreatedAt: trendyolOrder.orderDate,
      shopifyUpdatedAt: trendyolOrder.orderDate,

      // Store raw data
      rawData: { trendyol: trendyolOrder }
    }
  });

  // 4. Create LineItems
  await createLineItemsFromTrendyol(order.id, trendyolOrder.lineItems);

  // 5. Link TrendyolOrder to Order
  await prisma.trendyolOrder.update({
    where: { id: trendyolOrder.id },
    data: { orderId: order.id }
  });

  return order;
}
```

### Task 3: Create Virtual Store for Trendyol

**File**: `src/lib/trendyol-order-sync.ts`

```typescript
async function findOrCreateTrendyolStore(settings: Settings): Promise<Store> {
  const storeName = `Trendyol ${settings.trendyolStoreFrontCode || "RO"}`;

  let store = await prisma.store.findFirst({
    where: {
      name: storeName,
      type: "trendyol" // Need to add this field or use naming convention
    }
  });

  if (!store) {
    store = await prisma.store.create({
      data: {
        name: storeName,
        shopifyDomain: `trendyol-${settings.trendyolSupplierId}`, // Placeholder
        shopifyAccessToken: "", // Not used for Trendyol
        isActive: true,
        companyId: settings.trendyolCompanyId,
        // ... other required fields
      }
    });
  }

  return store;
}
```

### Task 4: Status Mapping Utility

**File**: `src/lib/trendyol-order-sync.ts`

```typescript
function mapTrendyolStatusToOrderStatus(trendyolStatus: string): OrderStatus {
  const mapping: Record<string, OrderStatus> = {
    "Created": "PENDING",
    "Picking": "PROCESSING",
    "Invoiced": "PROCESSING",
    "Shipped": "SHIPPED",
    "Delivered": "COMPLETED",
    "Cancelled": "CANCELLED",
    "UnDelivered": "FAILED",
    "Returned": "CANCELLED",
    "Repack": "PROCESSING",
    "UnSupplied": "CANCELLED",
  };

  return mapping[trendyolStatus] || "PENDING";
}
```

### Task 5: Update Webhook Handler to Sync Orders

**File**: `src/app/api/trendyol/webhook/route.ts`

```typescript
// In webhook handler, after validating:
case "OrderCreated":
  // Fetch full order details
  const client = new TrendyolClient(settings);
  const orderDetails = await client.getOrder(payload.orderId);

  // Sync to main Order table
  await syncTrendyolOrderToMainOrder(orderDetails, settings);
  break;

case "OrderStatusChanged":
  // Update TrendyolOrder status
  await prisma.trendyolOrder.update({
    where: { trendyolOrderId: payload.orderId },
    data: { status: payload.newStatus }
  });

  // Update linked Order status
  const trendyolOrder = await prisma.trendyolOrder.findUnique({
    where: { trendyolOrderId: payload.orderId },
    include: { order: true }
  });

  if (trendyolOrder?.order) {
    await prisma.order.update({
      where: { id: trendyolOrder.order.id },
      data: { status: mapTrendyolStatusToOrderStatus(payload.newStatus) }
    });
  }
  break;
```

### Task 6: Update Orders Page for Multi-Source

**File**: `src/app/(dashboard)/orders/page.tsx`

Add source filter:
```tsx
// Add to filters
<Select value={sourceFilter} onValueChange={setSourceFilter}>
  <SelectTrigger><SelectValue placeholder="Sursa" /></SelectTrigger>
  <SelectContent>
    <SelectItem value="all">Toate</SelectItem>
    <SelectItem value="shopify">Shopify</SelectItem>
    <SelectItem value="trendyol">Trendyol</SelectItem>
  </SelectContent>
</Select>

// Show source badge in table
<TableCell>
  <Badge variant={order.source === "trendyol" ? "secondary" : "default"}>
    {order.source === "trendyol" ? "Trendyol" : "Shopify"}
  </Badge>
</TableCell>
```

### Task 7: Update Orders API for Source Filter

**File**: `src/app/api/orders/route.ts`

```typescript
// Add source to query
const source = searchParams.get("source");

const where: Prisma.OrderWhereInput = {
  // ... existing filters
  ...(source && source !== "all" && { source }),
};
```

## File Changes Summary

| File | Action | Description |
|------|--------|-------------|
| `prisma/schema.prisma` | MODIFY | Add source field to Order |
| `src/lib/trendyol-order-sync.ts` | CREATE | Order sync service |
| `src/app/api/trendyol/webhook/route.ts` | MODIFY | Add order sync on webhook |
| `src/app/(dashboard)/orders/page.tsx` | MODIFY | Add source filter & badge |
| `src/app/api/orders/route.ts` | MODIFY | Support source filter |

## Verification

- [ ] New Trendyol orders create corresponding Order records
- [ ] Order list shows both Shopify and Trendyol orders
- [ ] Source filter works correctly
- [ ] Source badge displays correctly
- [ ] LineItems are created for Trendyol orders
- [ ] Company is correctly set from Trendyol settings
- [ ] Status mapping works for all Trendyol statuses

## Notes

- Currency conversion: Trendyol uses EUR, Order uses RON - apply conversion
- Customer name split: Trendyol provides full name, need to split first/last
- Virtual store: Create one Store per Trendyol account (by supplierId)
- Backward compatibility: Keep shopifyOrderId field name for now
