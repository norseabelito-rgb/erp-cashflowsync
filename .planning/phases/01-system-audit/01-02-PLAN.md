---
phase: 01-system-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/01-system-audit/audit-output/api/orders-api.md
  - .planning/phases/01-system-audit/audit-output/api/invoices-api.md
  - .planning/phases/01-system-audit/audit-output/api/products-api.md
  - .planning/phases/01-system-audit/audit-output/api/awb-api.md
  - .planning/phases/01-system-audit/audit-output/api/sync-api.md
  - .planning/phases/01-system-audit/audit-output/api/integrations-api.md
  - .planning/phases/01-system-audit/audit-output/api/remaining-api.md
autonomous: true

must_haves:
  truths:
    - "Every API endpoint has been cataloged with purpose, inputs, outputs, validation status"
    - "Auth and permission requirements documented for each endpoint"
    - "Missing validation and security gaps identified"
    - "Integration endpoints (Facturis, FanCourier, Shopify) documented in detail"
  artifacts:
    - path: ".planning/phases/01-system-audit/audit-output/api/orders-api.md"
      provides: "Orders API endpoints catalog"
      contains: "### GET /api/orders"
    - path: ".planning/phases/01-system-audit/audit-output/api/invoices-api.md"
      provides: "Invoices API endpoints including /issue"
      contains: "### POST /api/invoices/issue"
    - path: ".planning/phases/01-system-audit/audit-output/api/integrations-api.md"
      provides: "External integration APIs (Facturis, FanCourier, Shopify)"
      contains: "## Facturis"
  key_links:
    - from: "audit-output/api/*.md"
      to: "src/app/api/*/route.ts"
      via: "source file reference"
      pattern: "Base Path:.*\\/api\\/"
---

<objective>
Audit all API endpoints in the ERP system, documenting purpose, auth, validation, and issues.

Purpose: Catalog the complete API surface before any modifications. Focus on endpoints that support critical business flows (orders, invoices, AWB) and external integrations (Facturis, FanCourier, Shopify). Identify missing validation and security gaps.

Output: Per-resource API audit documents following the template from 01-RESEARCH.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-system-audit/01-CONTEXT.md
@.planning/phases/01-system-audit/01-RESEARCH.md
@.planning/codebase/STRUCTURE.md
@.planning/codebase/CONCERNS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Orders and Invoices API endpoints</name>
  <files>
    .planning/phases/01-system-audit/audit-output/api/orders-api.md
    .planning/phases/01-system-audit/audit-output/api/invoices-api.md
    src/app/api/orders/
    src/app/api/invoices/
  </files>
  <action>
Scan all route.ts files in src/app/api/orders/ and src/app/api/invoices/.

For each endpoint, document using template from 01-RESEARCH.md:

**Orders API (src/app/api/orders/):**
Document each endpoint with:
| Aspect | Detalii |
|--------|---------|
| Scop | [what it does] |
| Auth | [Yes/No - permission required] |
| Permisiune | [permission code] |
| Parametri/Body | [input structure] |
| Response | [output structure] |
| Validare | [Zod schema / Manual / Lipsa] |
| Side Effects | [what else happens] |
| Status | [OK / Probleme: ...] |

Expected endpoints to find:
- GET /api/orders (list with filters)
- GET /api/orders/[id] (detail)
- POST /api/orders/sync (sync single order)
- POST /api/orders/process (invoice + AWB generation)
- And any others discovered

Cross-reference CONCERNS.md:
- "No Transaction Handling for Multi-Step Operations" in /process
- "Missing Input Validation in API Routes"

**Invoices API (src/app/api/invoices/):**
Document:
- GET /api/invoices (list)
- POST /api/invoices/issue (create invoice via Facturis)
- Any cancel/void endpoints
- Invoice series endpoints if here

Note Facturis integration points and error handling.

Write in Romanian where appropriate (business terms).
  </action>
  <verify>
Two files exist:
- .planning/phases/01-system-audit/audit-output/api/orders-api.md
- .planning/phases/01-system-audit/audit-output/api/invoices-api.md

orders-api.md contains documentation for GET /api/orders and POST /api/orders/process.
invoices-api.md contains documentation for POST /api/invoices/issue.
Each endpoint has Auth, Validare, and Status fields documented.
  </verify>
  <done>
Orders and Invoices API fully cataloged. Transaction handling gap in /process documented. Validation status noted for each endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit Products, AWB, and Sync API endpoints</name>
  <files>
    .planning/phases/01-system-audit/audit-output/api/products-api.md
    .planning/phases/01-system-audit/audit-output/api/awb-api.md
    .planning/phases/01-system-audit/audit-output/api/sync-api.md
    src/app/api/products/
    src/app/api/awb/
    src/app/api/sync/
    src/app/api/fancourier/
  </files>
  <action>
**Products API (src/app/api/products/):**
Document:
- GET /api/products (list)
- POST /api/products (create)
- POST /api/products/sync-images (image sync - KNOWN BUG: unique constraint)
- POST /api/products/sync-stock (stock sync)
- POST /api/products/bulk (bulk operations - minimal validation per CONCERNS.md)

Flag the known bug: "Image Sync Unique Constraint Violation"

**AWB API (src/app/api/awb/ and src/app/api/fancourier/):**
Document:
- Shipping label creation endpoints
- Tracking endpoints
- Batch printing endpoints
- FanCourier SOAP integration points

Note from CONCERNS.md: Token caching without expiration validation

**Sync API (src/app/api/sync/):**
Document:
- POST /api/sync/full (full sync trigger)
- Any scheduled sync endpoints
- Sync history/logging endpoints

Note from CONCERNS.md: "Synchronization Operations Block Request Handler"

For each endpoint: Auth, Permission, Input, Output, Validation status, Known issues.
  </action>
  <verify>
Three files exist:
- .planning/phases/01-system-audit/audit-output/api/products-api.md (includes sync-images bug)
- .planning/phases/01-system-audit/audit-output/api/awb-api.md (includes fancourier endpoints)
- .planning/phases/01-system-audit/audit-output/api/sync-api.md

products-api.md mentions unique constraint issue in sync-images.
  </verify>
  <done>
Products, AWB, and Sync APIs cataloged. Known bugs (image sync, token caching) documented. Blocking sync operations flagged.
  </done>
</task>

<task type="auto">
  <name>Task 3: Audit Integration APIs and remaining endpoints</name>
  <files>
    .planning/phases/01-system-audit/audit-output/api/integrations-api.md
    .planning/phases/01-system-audit/audit-output/api/remaining-api.md
    src/app/api/webhooks/
    src/app/api/cron/
    src/app/api/settings/
    src/app/api/invoice-series/
  </files>
  <action>
**Integrations API (create consolidated document):**

Section: Facturis Integration
- Document all Facturis-related endpoints
- Invoice series sync endpoints (src/app/api/invoice-series/)
- Note the auto-correct logic issues from CONCERNS.md

Section: Shopify Integration
- Webhook handler: src/app/api/webhooks/shopify/route.ts
- Order sync endpoints
- Product sync endpoints

Section: FanCourier/SelfAWB Integration
- Already covered in awb-api.md, add cross-reference
- Document courier account configuration endpoints

Section: Ads Integrations (Meta/TikTok)
- src/app/api/ads/ endpoints
- src/app/api/webhooks/meta/ (notification spam bug from CONCERNS.md)
- Flag usage status question for user

**Remaining APIs (create consolidated document):**
Briefly document all remaining API directories:
- src/app/api/activity/
- src/app/api/admin/
- src/app/api/auth/ (NextAuth handlers)
- src/app/api/backup/
- src/app/api/categories/
- src/app/api/channels/
- src/app/api/companies/
- src/app/api/cron/ (background jobs)
- src/app/api/goods-receipts/
- src/app/api/handover/
- src/app/api/health/
- src/app/api/intercompany/
- src/app/api/inventory/
- src/app/api/notifications/
- src/app/api/picking/
- src/app/api/print-*/ (printing endpoints)
- src/app/api/rbac/
- src/app/api/settings/
- src/app/api/stats/
- src/app/api/stock/
- src/app/api/stores/
- src/app/api/suppliers/
- src/app/api/tracking/
- src/app/api/transfers/
- src/app/api/trendyol/
- src/app/api/upload/
- src/app/api/user/
- src/app/api/warehouses/

For each: one-line purpose, auth requirement, validation status (OK/Missing/Partial).

Flag any that appear unused or related to dead code (FreshSales, BaseLinker).
  </action>
  <verify>
Two files exist:
- .planning/phases/01-system-audit/audit-output/api/integrations-api.md
- .planning/phases/01-system-audit/audit-output/api/remaining-api.md

integrations-api.md has sections for Facturis, Shopify, FanCourier, Ads.
remaining-api.md covers 20+ API directories with auth/validation status.
  </verify>
  <done>
All API endpoints cataloged. Integration APIs documented in detail. Remaining endpoints have brief coverage with validation status. Dead code API candidates flagged.
  </done>
</task>

</tasks>

<verification>
- [ ] All route.ts files in src/app/api/ have been scanned
- [ ] Core APIs (orders, invoices, products, awb, sync) have detailed documentation
- [ ] Each endpoint documents: Auth, Permission, Input, Output, Validation, Status
- [ ] Known bugs from CONCERNS.md are referenced in relevant API docs
- [ ] Integration APIs (Facturis, Shopify, FanCourier) documented separately
- [ ] Missing validation gaps identified and flagged
- [ ] Security concerns noted (webhook verification, rate limiting gaps)
</verification>

<success_criteria>
1. Every API endpoint in src/app/api/ is cataloged (40+ directories)
2. Core business APIs have detailed endpoint-by-endpoint documentation
3. Validation status (Zod/Manual/Missing) documented for each endpoint
4. Known issues from CONCERNS.md linked to specific endpoints
5. Integration endpoints clearly documented for later phases
</success_criteria>

<output>
After completion, create `.planning/phases/01-system-audit/01-02-SUMMARY.md`
</output>
