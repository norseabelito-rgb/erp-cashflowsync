---
phase: 01-system-audit
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-02
files_modified:
  - .planning/phases/01-system-audit/audit-output/flows/order-to-delivery.md
  - .planning/phases/01-system-audit/audit-output/flows/internal-settlement.md
  - .planning/phases/01-system-audit/audit-output/flows/stock-management.md
autonomous: false

must_haves:
  truths:
    - "The complete order-to-delivery flow (order > factura > AWB > livrare > incasare) has been traced E2E"
    - "Each step in the flow documents: trigger, actor, actions, data changes, API calls, validation, failure points"
    - "Integration touchpoints (Facturis, FanCourier, Shopify) are mapped in each flow"
    - "User has verified flow documentation matches actual production behavior"
  artifacts:
    - path: ".planning/phases/01-system-audit/audit-output/flows/order-to-delivery.md"
      provides: "Complete E2E flow documentation with Mermaid diagram"
      contains: "flowchart TD"
    - path: ".planning/phases/01-system-audit/audit-output/flows/internal-settlement.md"
      provides: "Decontare interna flow documentation"
      contains: "## Etape Detaliate"
    - path: ".planning/phases/01-system-audit/audit-output/flows/stock-management.md"
      provides: "Stock and inventory flow documentation"
      contains: "## Diagrama Flow"
  key_links:
    - from: "flows/order-to-delivery.md"
      to: "API endpoints and pages"
      via: "cross-reference to audit docs"
      pattern: "Vezi:.*audit-output"
---

<objective>
Trace and document complete E2E business flows from start to finish.

Purpose: Understand how data moves through the system from order creation to delivery completion. This is the critical path that users execute daily. The flow documentation will reveal integration touchpoints, failure modes, and data consistency requirements.

Output: Flow documentation with Mermaid diagrams, step-by-step details, and user-verified behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-system-audit/01-CONTEXT.md
@.planning/phases/01-system-audit/01-RESEARCH.md
@.planning/phases/01-system-audit/01-01-SUMMARY.md
@.planning/phases/01-system-audit/01-02-SUMMARY.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document complete Order-to-Delivery flow</name>
  <files>
    .planning/phases/01-system-audit/audit-output/flows/order-to-delivery.md
    src/lib/invoice-service.ts
    src/lib/awb-service.ts
    src/lib/sync-service.ts
    src/app/api/orders/process/route.ts
  </files>
  <action>
Create comprehensive E2E flow documentation using template from 01-RESEARCH.md.

**Flow: Comandă → Factură → AWB → Livrare → Încasare**

1. Create Mermaid flowchart diagram showing all steps and decision points

2. Document each stage in detail:

**Etapa 1: Import Comandă din Shopify**
- Trigger: Webhook sau sync manual
- Actor: Sistem (webhook) sau User (sync button)
- Actiuni: Ce se întâmplă pas cu pas
- Date modificate: Order created, status set
- API Calls: Shopify API, /api/orders/sync
- Validari: Ce se verifică
- Puncte de Esec: Ce poate merge greșit

**Etapa 2: Generare Factură**
- Trigger: User clicks "Process" sau "Generate Invoice"
- Actor: User
- Actiuni: Series selection, Facturis API call, invoice record creation
- Date modificate: Invoice created, Order.invoiceId set
- API Calls: /api/invoices/issue, Facturis API
- Validari: Series valid, amounts correct
- Puncte de Esec: Facturis errors, series issues (MAJOR PAIN POINT)

**Etapa 3: Generare AWB**
- Trigger: After invoice (same process) or separate action
- Actor: User
- Actiuni: FanCourier/SelfAWB API call, AWB record creation
- Date modificate: AWB created, Order.awbId set
- API Calls: /api/awb/create, FanCourier SOAP
- Validari: Address valid, courier account configured
- Puncte de Esec: Courier API errors, address issues

**Etapa 4: Livrare (Tracking)**
- Trigger: Courier status webhook sau manual tracking
- Actor: Sistem (webhook) sau User (refresh)
- Actiuni: Status update from courier
- Date modificate: AWB.status, Order status
- API Calls: FanCourier tracking API
- Validari: Status transitions valid

**Etapa 5: Încasare (Collection)**
- Trigger: Delivery confirmed + payment received
- Actor: User marks as collected
- Actiuni: Status update to collected/paid
- Date modificate: Order.status to completed/collected
- Validari: Cannot mark collected before delivered

3. Document exceptions and edge cases:
- Ce se întâmplă dacă factura eșuează dar AWB e deja generat?
- Ce se întâmplă la retur?
- Transfer sheet blocking (mentioned in requirements)

4. Cross-reference audit docs:
- Link to orders-api.md for /process endpoint details
- Link to invoices-api.md for /issue endpoint
- Link to orders.md for UI actions

Write in Romanian.
  </action>
  <verify>
File exists at .planning/phases/01-system-audit/audit-output/flows/order-to-delivery.md with:
- Mermaid flowchart diagram
- At least 5 stages documented (Import, Factura, AWB, Livrare, Incasare)
- Each stage has: Trigger, Actor, Actiuni, Date modificate, API Calls, Puncte de Esec
- Cross-references to API and page audit docs
  </verify>
  <done>
Complete Order-to-Delivery flow documented with Mermaid diagram, 5+ stages, failure points, and cross-references to audit docs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document Internal Settlement and Stock Management flows</name>
  <files>
    .planning/phases/01-system-audit/audit-output/flows/internal-settlement.md
    .planning/phases/01-system-audit/audit-output/flows/stock-management.md
    src/lib/intercompany-service.ts
    src/lib/inventory-stock.ts
    src/lib/stock.ts
  </files>
  <action>
**Flow: Decontare Internă (Internal Settlement)**

Document the flow for secondary company orders (per requirements INV-03 through INV-06):

1. Create Mermaid diagram showing:
   - Secondary company order identification
   - Collection tracking
   - Weekly settlement calculation
   - Internal invoice generation

2. Document stages:
- Identificare comenzi secundar: How orders from secondary company stores are flagged
- Tracking "încasat": How collection status is tracked
- Calcul decontare: Acquisition price + 10% calculation
- Generare factură internă: Invoice from Aquaterra to secondary company

3. Note current state:
- Is this flow implemented?
- What's manual vs automated?
- What's missing?

**Flow: Gestiune Stoc (Stock Management)**

Document stock-related flows:

1. Create Mermaid diagram showing:
   - Stock receipt (goods receipt)
   - Stock reservation on order
   - Stock transfer between warehouses
   - Stock sync with Shopify

2. Document key processes:
- Intrare marfă: How stock enters system
- Rezervare: How stock is reserved for orders
- Transfer: Inter-warehouse transfers
- Sync stoc: Shopify stock updates

3. Cross-reference:
- inventory-stock.ts for calculation logic
- Products API for sync endpoints
- Known N+1 query issues from CONCERNS.md

Write in Romanian.
  </action>
  <verify>
Two files exist:
- .planning/phases/01-system-audit/audit-output/flows/internal-settlement.md
- .planning/phases/01-system-audit/audit-output/flows/stock-management.md

Each has Mermaid diagram and Etape Detaliate section.
Internal settlement notes current implementation status.
  </verify>
  <done>
Internal Settlement and Stock Management flows documented. Current implementation status noted. Cross-references to code and audit docs included.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete E2E business flow documentation:
1. Order-to-Delivery (Comandă → Factură → AWB → Livrare → Încasare) - the critical daily workflow
2. Internal Settlement (Decontare Internă) - secondary company settlement process
3. Stock Management (Gestiune Stoc) - inventory flows

Each flow has Mermaid diagram, stage-by-stage documentation, failure points, and cross-references.
  </what-built>
  <how-to-verify>
**For Order-to-Delivery flow:**
1. Read .planning/phases/01-system-audit/audit-output/flows/order-to-delivery.md
2. Walk through one real order in production (https://erp.cashflowgrup.net/orders):
   - Find an order that has been fully processed (has invoice + AWB + delivered)
   - Verify each stage matches documented behavior
   - Note any differences

3. Specific questions:
   - Does the diagram accurately show your daily workflow?
   - Are there steps missing?
   - Are failure points correctly identified?
   - Is the invoice series selection the biggest pain point?

**For Internal Settlement flow:**
1. Read .planning/phases/01-system-audit/audit-output/flows/internal-settlement.md
2. Clarify:
   - Is this flow currently implemented in the system?
   - If not, how do you handle it today (manual)?
   - What's the secondary company name?

**For Stock Management flow:**
1. Read .planning/phases/01-system-audit/audit-output/flows/stock-management.md
2. Verify:
   - Do you use stock reservation?
   - Do you do inter-warehouse transfers?
   - How often does Shopify stock sync run?
  </how-to-verify>
  <resume-signal>
Reply with:
- "approved" if flows are accurate
- OR corrections in format: "[flow]: [correction]"
- AND answers to clarification questions above
  </resume-signal>
</task>

</tasks>

<verification>
- [ ] Order-to-Delivery flow complete with all 5 stages
- [ ] Mermaid diagrams render correctly (valid flowchart syntax)
- [ ] Each stage documents: trigger, actor, actions, data changes, failure points
- [ ] Integration touchpoints (Facturis, FanCourier, Shopify) clearly marked
- [ ] Cross-references to Plan 01 (pages) and Plan 02 (APIs) audit docs
- [ ] Internal Settlement flow documents current state (implemented or not)
- [ ] User has verified flows match production reality
</verification>

<success_criteria>
1. Order-to-Delivery flow traced from Shopify order to collected payment
2. Each stage documents API calls and failure modes
3. Integration touchpoints mapped for later phases
4. Internal Settlement current state clarified
5. User confirms flows match their daily workflow
</success_criteria>

<output>
After completion, create `.planning/phases/01-system-audit/01-03-SUMMARY.md`
</output>
