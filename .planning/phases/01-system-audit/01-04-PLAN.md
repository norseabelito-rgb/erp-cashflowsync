---
phase: 01-system-audit
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - .planning/phases/01-system-audit/audit-output/tech-debt.md
  - .planning/phases/01-system-audit/audit-output/database-schema.md
  - .planning/phases/01-system-audit/audit-output/dead-code.md
autonomous: true

must_haves:
  truths:
    - "Tech debt and refactoring needs have been identified and prioritized"
    - "Database schema has been reviewed with model relationships documented"
    - "Dead code candidates are confirmed and cataloged"
    - "Issues are prioritized by business impact (Blochează/Deranjează/Cosmetic)"
  artifacts:
    - path: ".planning/phases/01-system-audit/audit-output/tech-debt.md"
      provides: "Consolidated tech debt inventory extending CONCERNS.md"
      contains: "## Prioritizare"
    - path: ".planning/phases/01-system-audit/audit-output/database-schema.md"
      provides: "Database schema review with model relationships"
      contains: "## Modele Principale"
    - path: ".planning/phases/01-system-audit/audit-output/dead-code.md"
      provides: "Confirmed dead code catalog"
      contains: "## FreshSales"
  key_links:
    - from: "tech-debt.md"
      to: ".planning/codebase/CONCERNS.md"
      via: "extends and updates"
      pattern: "Sursa: CONCERNS\\.md"
---

<objective>
Complete architecture and tech debt audit, extending existing CONCERNS.md analysis.

Purpose: Consolidate all technical issues discovered during audit, review database schema for correctness, and confirm dead code for removal. This provides the prioritized backlog for Phase 5 (Known Bug Fixes) and future refactoring.

Output: Tech debt inventory with business-impact prioritization, database schema documentation, confirmed dead code list.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-system-audit/01-CONTEXT.md
@.planning/phases/01-system-audit/01-RESEARCH.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/ARCHITECTURE.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate and prioritize tech debt</name>
  <files>
    .planning/phases/01-system-audit/audit-output/tech-debt.md
    .planning/codebase/CONCERNS.md
  </files>
  <action>
Create consolidated tech debt inventory that extends CONCERNS.md with audit findings.

**Structure:**

## Surse
- CONCERNS.md (existing analysis)
- Page audit findings (from Plan 01)
- API audit findings (from Plan 02)
- Flow audit findings (from Plan 03)

## Tech Debt - Categorii

### 1. Componente Monolitice
From CONCERNS.md:
- meta-ads.ts (2536 lines)
- orders/page.tsx (2301 lines)
- settings/page.tsx (1624 lines)
- fancourier.ts (1235 lines)

Assess impact:
- Does monolithic orders/page.tsx slow down development?
- Is it causing performance issues?
- Priority: [Blochează/Deranjează/Cosmetic]

### 2. Validare Lipsă
From CONCERNS.md "Missing Input Validation":
- List each API route without Zod schema
- Assess security/stability risk
- Priority by endpoint criticality

### 3. Tranzacții Lipsă
From CONCERNS.md "No Transaction Handling":
- Order processing creates invoice then AWB without transaction
- Document the partial failure scenarios
- Priority: HIGH (data consistency risk)

### 4. Securitate
From CONCERNS.md:
- Webhook token timing attack vulnerability
- Credentials in request bodies
- No rate limiting
- RBAC permission gaps

### 5. Performanță
From CONCERNS.md:
- N+1 query patterns
- Blocking sync operations
- Expensive permission queries

### 6. Dependențe
From CONCERNS.md:
- NextAuth.js v4 (out of support)
- Prisma v5 (evolving)
- Deprecated iconv-lite

## Prioritizare

Create prioritized list using classification:

| ID | Issue | Categorie | Impact | Prioritate |
|----|-------|-----------|--------|------------|
| TD-01 | Order processing no transaction | Integritate | Data inconsistency | Blochează munca |
| TD-02 | Invoice series edge cases | Facturare | Wrong invoices | Blochează munca |
| TD-03 | N+1 queries in lists | Performanță | Slow pages | Deranjează |
| ... | ... | ... | ... | ... |

Write in Romanian where business terms apply.
  </action>
  <verify>
File exists at .planning/phases/01-system-audit/audit-output/tech-debt.md with:
- Reference to CONCERNS.md as source
- At least 5 categories of tech debt
- Prioritizare section with impact table
- Issues classified as Blochează/Deranjează/Cosmetic
  </verify>
  <done>
Tech debt consolidated from CONCERNS.md and audit findings. Issues prioritized by business impact. Ready for Phase 5 planning.
  </done>
</task>

<task type="auto">
  <name>Task 2: Review database schema</name>
  <files>
    .planning/phases/01-system-audit/audit-output/database-schema.md
    prisma/schema.prisma
  </files>
  <action>
Read prisma/schema.prisma (1700+ lines) and document key aspects.

**Structure:**

## Schema Overview
- Total models count
- Key enums defined
- General patterns used (timestamps, soft delete, etc.)

## Modele Principale (Core Models)

For each critical model (Order, Invoice, AWB, Product, User, Store, Company):

### Model: Order
- Câmpuri cheie: list important fields
- Relații: what it connects to
- Enums folosite: OrderStatus values
- Indecși: any defined indexes
- Observații: any issues or notes

### Model: Invoice
...

### Model: AWB
...

### Model: Product / MasterProduct / InventoryProduct
- Document the product hierarchy
- Explain relationship between MasterProduct and InventoryProduct

### Model: User / Role / Permission
- Document RBAC structure
- Store-level permissions

### Model: Store / Company
- Document multi-company structure
- Store-to-company relationships (critical for invoice series)

## Relații Critice

Document key relationships that affect business logic:
- Order → Invoice (one-to-one?)
- Order → AWB (one-to-one?)
- Order → Store → Company (for invoice series selection)
- User → Store assignments (for RBAC)

## Potențiale Probleme

Note any schema concerns:
- Missing indexes that could affect query performance
- Nullable fields that should be required
- Relationships that seem incorrect
- Fields that appear unused (dead columns)

## Enums

List all enums with their values:
- OrderStatus: [values]
- InvoiceStatus: [values]
- AWBStatus: [values]
- etc.

Write in Romanian where business terms apply.
  </action>
  <verify>
File exists at .planning/phases/01-system-audit/audit-output/database-schema.md with:
- Schema Overview with model count
- Modele Principale section covering Order, Invoice, AWB, Product, User, Store
- Relații Critice documented
- Enums listed with values
  </verify>
  <done>
Database schema reviewed. Core models documented with relationships. Potential issues identified. Enums cataloged for reference.
  </done>
</task>

<task type="auto">
  <name>Task 3: Confirm dead code candidates</name>
  <files>
    .planning/phases/01-system-audit/audit-output/dead-code.md
    src/lib/
    src/app/api/
  </files>
  <action>
Based on user context (FreshSales/BaseLinker not used) and audit findings, create confirmed dead code catalog.

**Structure:**

## Cod Mort Confirmat

### FreshSales Integration
- Fișiere: List all files containing FreshSales references
- Linii cod: Approximate lines
- Dependențe: What depends on this code
- Decizie recomandată: Remove / Keep for future / Needs user confirmation

Search for: "freshsales", "FreshSales", "fresh_sales" in codebase.

### BaseLinker Integration
- Fișiere: List all files
- Linii cod: Approximate
- Dependențe: Dependencies
- Decizie recomandată: Remove / Keep / Confirm

Search for: "baselinker", "BaseLinker", "base_linker"

## Cod Posibil Mort (Necesită Confirmare)

### Ads Module (Meta/TikTok)
- Fișiere: src/lib/meta-ads.ts (2536 lines), src/lib/tiktok-ads.ts, etc.
- Status: User needs to confirm if actively used
- Note: Large codebase investment, don't remove without confirmation

### Trendyol Integration
- Fișiere: src/app/(dashboard)/trendyol/, src/app/api/trendyol/, src/lib/trendyol.ts
- Status: Full integration exists, usage unclear
- Note: User mentioned future Trendyol/Temu, might be in testing

### Other Candidates
- Any features flagged during page/API audit as unused
- UI elements that user said "nu folosesc"

## Recomandări

| Categorie | Fișiere | Linii | Decizie |
|-----------|---------|-------|---------|
| FreshSales | [list] | ~N | Remove |
| BaseLinker | [list] | ~N | Remove |
| Ads Module | [list] | ~2600 | Confirm with user |
| Trendyol | [list] | ~N | Confirm with user |

## Impact Ștergere

For confirmed dead code (FreshSales, BaseLinker):
- Dependencies that would break
- Tests that reference this code
- Configuration that needs cleanup

Write in Romanian.
  </action>
  <verify>
File exists at .planning/phases/01-system-audit/audit-output/dead-code.md with:
- FreshSales section with file list
- BaseLinker section with file list
- Ads Module and Trendyol marked for user confirmation
- Recommendations table with Remove/Confirm decisions
  </verify>
  <done>
Dead code catalog created. FreshSales and BaseLinker documented for removal. Ads and Trendyol flagged for user confirmation. Impact analysis included.
  </done>
</task>

</tasks>

<verification>
- [ ] Tech debt consolidated from all audit sources
- [ ] Issues prioritized by business impact (Blochează/Deranjează/Cosmetic)
- [ ] Database schema reviewed with core models documented
- [ ] Relationships critical to business logic mapped
- [ ] Dead code candidates cataloged with removal recommendations
- [ ] FreshSales and BaseLinker confirmed as dead code
- [ ] Ads and Trendyol marked for user confirmation
</verification>

<success_criteria>
1. Tech debt inventory extends CONCERNS.md with audit findings
2. Issues are prioritized and ready for Phase 5 planning
3. Database schema documentation covers all core models
4. Dead code is cataloged with clear removal/keep recommendations
5. All user-confirmation items clearly flagged
</success_criteria>

<output>
After completion, create `.planning/phases/01-system-audit/01-04-SUMMARY.md`
</output>
