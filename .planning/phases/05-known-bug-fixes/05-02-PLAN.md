---
phase: 05-known-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/orders/page.tsx
autonomous: true

must_haves:
  truths:
    - "Order detail dialog shows line items as cards with product image"
    - "Each card shows product name, SKU, quantity, unit price, VAT, line total"
    - "Quick action buttons available: View Product, Check Stock"
    - "Check Stock shows current stock in tooltip"
    - "Empty line items shows yellow warning about sync issue"
  artifacts:
    - path: "src/app/(dashboard)/orders/page.tsx"
      provides: "Card-based line item display in order detail dialog"
      contains: "LineItemCard"
  key_links:
    - from: "src/app/(dashboard)/orders/page.tsx"
      to: "viewOrder.lineItems"
      via: "map to Card components"
      pattern: "lineItems\\.map.*Card"
---

<objective>
Transform order detail line items from table to card layout with product images and quick actions.

Purpose: Order details currently show line items as a basic table without images or actions. Transform to card layout per user decisions for better visual presentation and warehouse staff verification.

Output:
- Card-based line item display with images
- Quick actions for View Product and Check Stock
- Empty state warning for missing line items
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-known-bug-fixes/05-CONTEXT.md
@.planning/phases/05-known-bug-fixes/05-RESEARCH.md
@src/app/(dashboard)/orders/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LineItemCard component and update order detail display</name>
  <files>src/app/(dashboard)/orders/page.tsx</files>
  <action>
Find the order detail dialog section (around lines 1932-1985) and replace the table-based line items display with card-based layout:

1. Add imports at the top of the file if not already present:
```typescript
import { Card, CardContent } from "@/components/ui/card";
import { Package, ExternalLink, BoxIcon } from "lucide-react";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
```

2. Create a helper function to format currency if not already available in the file.

3. Replace the existing line items section (the table) with card-based layout:

```typescript
{/* Produse comandÄƒ */}
<div>
  <h4 className="font-semibold mb-3 flex items-center gap-2">
    <Package className="h-4 w-4" />
    Produse ({viewOrder.lineItems?.length || 0})
  </h4>

  {/* Empty state warning */}
  {viewOrder.lineItems && viewOrder.lineItems.length === 0 && (
    <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm flex items-center gap-2">
      <AlertTriangle className="h-4 w-4 flex-shrink-0" />
      <span>Comanda nu are produse. Aceasta poate indica o problema de sincronizare.</span>
    </div>
  )}

  {/* Line items as cards */}
  {viewOrder.lineItems && viewOrder.lineItems.length > 0 && (
    <div className="space-y-3">
      {viewOrder.lineItems.map((item: any) => (
        <Card key={item.id} className="overflow-hidden">
          <CardContent className="p-4">
            <div className="flex gap-4">
              {/* Product image */}
              <div className="flex-shrink-0">
                {item.imageUrl ? (
                  <img
                    src={item.imageUrl}
                    alt={item.title}
                    className="w-16 h-16 object-cover rounded-md border"
                  />
                ) : (
                  <div className="w-16 h-16 bg-muted rounded-md border flex items-center justify-center">
                    <Package className="h-6 w-6 text-muted-foreground" />
                  </div>
                )}
              </div>

              {/* Product info */}
              <div className="flex-1 min-w-0">
                <h5 className="font-medium text-sm line-clamp-2">{item.title}</h5>
                {item.variantTitle && item.variantTitle !== "Default Title" && (
                  <p className="text-xs text-muted-foreground">{item.variantTitle}</p>
                )}
                <p className="font-mono text-xs text-muted-foreground mt-1">
                  SKU: {item.sku || '-'}
                </p>
              </div>

              {/* Quantity and price */}
              <div className="text-right flex-shrink-0">
                <p className="font-medium">{item.quantity}x</p>
                <p className="text-sm text-muted-foreground">
                  {formatCurrency(parseFloat(item.price), viewOrder.currency)}
                </p>
                <p className="text-sm font-medium mt-1">
                  {formatCurrency(parseFloat(item.price) * item.quantity, viewOrder.currency)}
                </p>
              </div>
            </div>

            {/* Quick actions */}
            <div className="flex gap-2 mt-3 pt-3 border-t">
              {item.sku && (
                <>
                  <Button
                    variant="outline"
                    size="sm"
                    className="text-xs h-7"
                    onClick={() => {
                      // Navigate to products page with search
                      window.location.href = `/products?search=${encodeURIComponent(item.sku)}`;
                    }}
                  >
                    <ExternalLink className="h-3 w-3 mr-1" />
                    Vezi Produs
                  </Button>

                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <Button
                          variant="outline"
                          size="sm"
                          className="text-xs h-7"
                        >
                          <BoxIcon className="h-3 w-3 mr-1" />
                          Stoc
                        </Button>
                      </TooltipTrigger>
                      <TooltipContent>
                        <StockTooltipContent sku={item.sku} />
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                </>
              )}
            </div>
          </CardContent>
        </Card>
      ))}

      {/* Total row */}
      <div className="flex justify-end pt-2 border-t">
        <div className="text-right">
          <span className="text-sm text-muted-foreground mr-2">Total produse:</span>
          <span className="font-semibold">
            {formatCurrency(
              viewOrder.lineItems.reduce((sum: number, item: any) =>
                sum + parseFloat(item.price) * item.quantity, 0
              ),
              viewOrder.currency
            )}
          </span>
        </div>
      </div>
    </div>
  )}
</div>
```

4. Add a StockTooltipContent component that fetches and displays stock info:

```typescript
// Add this component inside the file or extract to separate component
function StockTooltipContent({ sku }: { sku: string }) {
  const { data, isLoading } = useQuery({
    queryKey: ['stock-check', sku],
    queryFn: async () => {
      const res = await fetch(`/api/inventory-items?search=${encodeURIComponent(sku)}&limit=1`);
      const json = await res.json();
      return json.data?.[0] || null;
    },
    staleTime: 30000, // Cache for 30 seconds
  });

  if (isLoading) {
    return <p className="text-xs">Se incarca...</p>;
  }

  if (!data) {
    return <p className="text-xs text-muted-foreground">Nu s-a gasit in inventar</p>;
  }

  return (
    <div className="text-xs">
      <p className="font-medium">{data.name}</p>
      <p className="mt-1">
        Stoc: <span className={data.currentStock > 0 ? "text-green-600" : "text-red-600"}>
          {data.currentStock} {data.unit || 'buc'}
        </span>
      </p>
      {data.reorderPoint && data.currentStock <= data.reorderPoint && (
        <p className="text-yellow-600 mt-1">Stoc scazut!</p>
      )}
    </div>
  );
}
```

5. Ensure the formatCurrency function handles different currencies:
```typescript
// If not already defined, add:
function formatCurrency(amount: number, currency: string = 'RON'): string {
  return new Intl.NumberFormat('ro-RO', {
    style: 'currency',
    currency: currency,
  }).format(amount);
}
```
  </action>
  <verify>
Run `npm run dev` and navigate to Orders page:
1. Click "Detalii" on any order to open the detail dialog
2. Verify line items display as cards with:
   - Product image (or placeholder if no image)
   - Product name, variant, SKU
   - Quantity and prices
   - View Product and Stock buttons
3. Hover over "Stoc" button to verify tooltip shows stock info
4. Click "Vezi Produs" to verify navigation works
5. Test an order with no line items to verify yellow warning appears
  </verify>
  <done>
Order detail dialog shows line items as cards with images, product info, prices, and quick action buttons. Stock tooltip shows current inventory level. Empty state shows sync warning.
  </done>
</task>

</tasks>

<verification>
After task complete:
1. Build passes: `npm run build`
2. Order detail shows card layout for line items
3. Quick actions work (View Product navigates, Stock shows tooltip)
4. Empty line items shows yellow warning
</verification>

<success_criteria>
1. Line items display as cards, not table rows
2. Each card shows image (or placeholder), name, SKU, quantity, prices
3. "Vezi Produs" button navigates to products page with SKU search
4. "Stoc" button shows current stock in tooltip
5. Orders with no line items show yellow warning banner
</success_criteria>

<output>
After completion, create `.planning/phases/05-known-bug-fixes/05-02-SUMMARY.md`
</output>
