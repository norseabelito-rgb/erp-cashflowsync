---
phase: 05-known-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/products/sync-images/route.ts
  - src/app/api/inventory-items/route.ts
  - src/app/(dashboard)/products/page.tsx
autonomous: true

must_haves:
  truths:
    - "Image sync skips existing URLs instead of deleting all and recreating"
    - "Image sync shows progress indicator during operation"
    - "Image sync shows summary of failures at end if any"
    - "SKU dropdown shows Available section at top with selectable items"
    - "SKU dropdown shows Already Assigned section (collapsed) with disabled items"
    - "Already Assigned SKUs show which product owns them with link"
    - "Empty available SKUs shows yellow warning banner"
  artifacts:
    - path: "src/app/api/products/sync-images/route.ts"
      provides: "Idempotent image sync with skip logic"
      contains: "existingUrls"
    - path: "src/app/api/inventory-items/route.ts"
      provides: "Grouped inventory response with available and assigned"
      contains: "assignedTo"
    - path: "src/app/(dashboard)/products/page.tsx"
      provides: "Grouped SKU dropdown with Collapsible assigned section"
      contains: "CommandGroup"
  key_links:
    - from: "src/app/api/products/sync-images/route.ts"
      to: "prisma.masterProductImage"
      via: "findMany for existing URLs before create"
      pattern: "existingUrls\\.has"
    - from: "src/app/(dashboard)/products/page.tsx"
      to: "/api/inventory-items"
      via: "fetch with grouped response"
      pattern: "available.*assigned"
---

<objective>
Fix image sync unique constraint violations and SKU dropdown showing assigned SKUs.

Purpose: Resolve two documented bugs that prevent reliable product management - image sync fails on existing images, and SKU dropdown shows already-used SKUs making assignment confusing.

Output:
- Idempotent image sync that skips existing URLs
- Progress indicator during sync
- Grouped SKU dropdown with Available/Already Assigned sections
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-known-bug-fixes/05-CONTEXT.md
@.planning/phases/05-known-bug-fixes/05-RESEARCH.md
@src/app/api/products/sync-images/route.ts
@src/app/api/inventory-items/route.ts
@src/app/(dashboard)/products/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix image sync to skip existing URLs</name>
  <files>src/app/api/products/sync-images/route.ts</files>
  <action>
Refactor the POST handler to use idempotent upsert pattern instead of delete-all-recreate:

1. Before processing images, fetch existing images for the product:
```typescript
const existing = await prisma.masterProductImage.findMany({
  where: { productId: product.id },
  select: { url: true, position: true }
});
const existingUrls = new Set(existing.map(img => img.url));
let nextPosition = Math.max(0, ...existing.map(img => img.position)) + 1;
```

2. Remove the delete-all logic (lines 231-236 currently).

3. For each drive image, check if URL exists before creating:
```typescript
const imageUrl = getPublicImageUrl(driveImg.id);
if (existingUrls.has(imageUrl)) {
  result.imagesSkipped++;
  continue;
}
```

4. Add `imagesSkipped` to the SyncResult interface:
```typescript
interface SyncResult {
  // ... existing fields
  imagesSkipped: number;
  errors: string[];
}
```

5. Track errors per image instead of failing entire product:
```typescript
try {
  await prisma.masterProductImage.create({ ... });
  result.imagesAdded++;
} catch (error: any) {
  result.errors.push(`${driveImg.name}: ${error.message}`);
}
```

6. Update stats to include skipped count and show errors in response:
```typescript
const stats = {
  // ... existing
  imagesSkipped: results.reduce((sum, r) => sum + r.imagesSkipped, 0),
  errors: results.flatMap(r => r.errors).slice(0, 20), // First 20 errors
};
```

7. Update console logs to show progress:
```typescript
console.log(`  [${index + 1}/${folders.length}] ${product.sku}: ${driveImages.length} images found, ${skipped} skipped, ${added} added`);
```
  </action>
  <verify>
Run `npm run build` to verify TypeScript compiles without errors.
Test manually: Call POST /api/products/sync-images twice for same product - second call should skip all images (imagesSkipped > 0, imagesAdded = 0).
  </verify>
  <done>
Image sync no longer fails on existing images. Second sync of same product shows imagesSkipped count matching previous imagesAdded. No unique constraint errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add grouped response to inventory-items API</name>
  <files>src/app/api/inventory-items/route.ts</files>
  <action>
Extend the GET handler to support a new `grouped=true` parameter that returns both available and assigned items:

1. Add new query param parsing:
```typescript
const grouped = searchParams.get("grouped") === "true";
```

2. When grouped=true, return both available and assigned with mapping info:
```typescript
if (grouped) {
  const [availableItems, assignedItems] = await Promise.all([
    prisma.inventoryItem.findMany({
      where: {
        ...baseWhere,
        mappedProducts: { none: {} }
      },
      select: {
        id: true,
        sku: true,
        name: true,
        currentStock: true,
      },
      orderBy: { sku: 'asc' },
      take: 200, // Limit for performance
    }),
    prisma.inventoryItem.findMany({
      where: {
        ...baseWhere,
        mappedProducts: { some: {} }
      },
      include: {
        mappedProducts: {
          select: {
            id: true,
            title: true,
          },
          take: 1,
        }
      },
      orderBy: { sku: 'asc' },
      take: 200,
    })
  ]);

  return NextResponse.json({
    success: true,
    data: {
      available: availableItems,
      assigned: assignedItems.map(item => ({
        id: item.id,
        sku: item.sku,
        name: item.name,
        currentStock: item.currentStock,
        assignedTo: item.mappedProducts[0]
          ? { productId: item.mappedProducts[0].id, productName: item.mappedProducts[0].title }
          : null
      }))
    }
  });
}
```

3. The existing `excludeMapped` logic continues to work for backward compatibility.
  </action>
  <verify>
Test API endpoint:
```bash
curl "http://localhost:3000/api/inventory-items?grouped=true" | jq '.data | keys'
```
Should return `["available", "assigned"]`. Assigned items should have `assignedTo` with productId and productName.
  </verify>
  <done>
API returns grouped response with available and assigned arrays. Assigned items include product reference info for UI display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SKU dropdown with grouped sections</name>
  <files>src/app/(dashboard)/products/page.tsx</files>
  <action>
Find the SKU selection dropdown in the product creation/edit dialog and refactor to use grouped Command with Collapsible:

1. Import Collapsible components:
```typescript
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
```

2. Update the inventory items fetch to use grouped=true:
```typescript
const { data: inventoryData } = useQuery({
  queryKey: ['inventory-items-grouped'],
  queryFn: async () => {
    const res = await fetch('/api/inventory-items?grouped=true');
    const json = await res.json();
    return json.data; // { available: [], assigned: [] }
  },
});
```

3. Replace the current Command dropdown structure with grouped sections:
```typescript
<Command shouldFilter={true}>
  <CommandInput placeholder="Cauta SKU..." />
  <CommandList>
    {/* Empty state warning */}
    {inventoryData?.available?.length === 0 && (
      <div className="p-3 bg-yellow-50 border-b border-yellow-200 text-yellow-800 text-sm">
        <AlertTriangle className="inline h-4 w-4 mr-2" />
        Toate SKU-urile sunt asignate. Creeaza mai multe in Inventar.
      </div>
    )}

    {/* Available section */}
    <CommandGroup heading="Disponibile">
      {inventoryData?.available?.map((item) => (
        <CommandItem
          key={item.id}
          value={item.sku}
          onSelect={() => handleSelectSku(item)}
        >
          <span className="font-mono">{item.sku}</span>
          <span className="text-muted-foreground ml-2">{item.name}</span>
        </CommandItem>
      ))}
    </CommandGroup>

    {/* Assigned section - collapsed by default */}
    {inventoryData?.assigned?.length > 0 && (
      <Collapsible defaultOpen={false}>
        <CollapsibleTrigger className="w-full px-2 py-1.5 text-sm font-medium text-muted-foreground hover:bg-muted flex items-center justify-between">
          <span>Deja asignate ({inventoryData.assigned.length})</span>
          <ChevronDown className="h-4 w-4" />
        </CollapsibleTrigger>
        <CollapsibleContent>
          {inventoryData.assigned.map((item) => (
            <CommandItem
              key={item.id}
              value={item.sku}
              disabled
              className="opacity-60 cursor-not-allowed"
            >
              <span className="font-mono">{item.sku}</span>
              <span className="text-muted-foreground ml-2 flex-1">{item.name}</span>
              {item.assignedTo && (
                <Link
                  href={`/products?search=${item.assignedTo.productId}`}
                  className="text-xs text-blue-600 hover:underline"
                  onClick={(e) => e.stopPropagation()}
                >
                  {item.assignedTo.productName?.substring(0, 20)}...
                </Link>
              )}
            </CommandItem>
          ))}
        </CollapsibleContent>
      </Collapsible>
    )}
  </CommandList>
</Command>
```

4. Add missing imports (AlertTriangle, ChevronDown from lucide-react).

5. Ensure the form can still be submitted without SKU (warning only, not blocking) - this should already be the case.
  </action>
  <verify>
Run `npm run dev` and navigate to Products page:
1. Open create product dialog
2. Click SKU dropdown
3. Verify "Disponibile" section shows at top with selectable items
4. Verify "Deja asignate" section is collapsed, expands on click
5. Verify assigned items are disabled and show product link
6. If all SKUs assigned, verify yellow warning banner appears
  </verify>
  <done>
SKU dropdown has two sections: Available (selectable) and Already Assigned (collapsed, disabled, shows owner). Yellow warning appears when no available SKUs. Form remains submittable without SKU.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Build passes: `npm run build`
2. Image sync idempotent: Run sync twice, second run shows skipped > 0
3. SKU dropdown grouped: Available and Assigned sections visible in UI
4. No regressions: Existing product creation still works
</verification>

<success_criteria>
1. Image sync no longer throws unique constraint errors on re-sync
2. Image sync shows progress and failure summary
3. SKU dropdown shows grouped Available/Assigned sections
4. Assigned SKUs show product owner with link
5. Empty available SKUs shows warning banner
</success_criteria>

<output>
After completion, create `.planning/phases/05-known-bug-fixes/05-01-SUMMARY.md`
</output>
