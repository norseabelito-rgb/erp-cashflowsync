---
phase: 07.3
plan: 06
subsystem: dashboard
tags: [status-categorization, awb-tracking, dashboard-metrics, shared-module]
depends_on: ["07.3-02", "07.3-05"]
provides: ["shared-awb-status-module", "consistent-transit-counts"]
affects: ["07.5-awb-tracking-fix"]
tech-stack:
  patterns: ["shared-module-extraction", "db-filter-generation"]
key-files:
  created: ["src/lib/awb-status.ts"]
  modified: ["src/lib/dashboard-stats.ts", "src/app/(dashboard)/dashboard/page.tsx", "src/app/(dashboard)/tracking/page.tsx"]
decisions:
  - id: "awb-based-transit-count"
    description: "Dashboard 'In Tranzit' counts AWBs by currentStatus patterns, not Order.status"
  - id: "shared-categorization-module"
    description: "Status categorization logic extracted to awb-status.ts for DRY"
  - id: "db-level-filtering"
    description: "getCategoryFilterConditions provides Prisma OR clauses for efficient queries"
metrics:
  duration: ~4 minutes
  completed: 2026-02-03
---

# Phase 7.3 Plan 06: AWB Status Alignment Summary

**One-liner:** Shared awb-status.ts module ensures dashboard "In Tranzit" matches tracking page count exactly.

## What Was Done

### Task 1: Extract status categorization to shared module
- Created `src/lib/awb-status.ts` (185 lines)
- Exported `StatusCategory` type for consistent typing
- Exported `getStatusCategory(status)` function matching tracking page logic
- Exported `categoryConfig` for UI display consistency
- Exported `getCategoryFilterConditions(category)` for efficient Prisma queries

### Task 2: Update dashboard stats to count AWBs in transit
- Imported `getCategoryFilterConditions` from awb-status.ts
- Renamed `shipped` to `inTransit` in DashboardStats interface
- Changed query from `Order.status === "SHIPPED"` to AWB.currentStatus pattern matching
- Uses same keywords: tranzit, transit, livrare, preluat, ridicat, sortare, depozit, expedit

### Task 3: Update dashboard page to use inTransit stat
- Changed card title from "Expediate" to "In Tranzit"
- Changed `stats.shipped` to `stats.inTransit`
- Updated tooltip: "AWB-uri in tranzit - egaleaza 'In tranzit' din pagina Tracking"
- Added status filter to href: `/tracking?status=in_transit`

### Task 4: Update tracking page to use shared module
- Removed local `getStatusCategory` function (46 lines)
- Removed local `StatusCategory` type definition
- Added import from `@/lib/awb-status`
- Kept local `categoryConfig` (extended with UI-specific icons/colors)

## Technical Decisions

### 1. AWB-based Transit Counting
**Decision:** Count AWBs by `currentStatus` patterns, not by `Order.status === "SHIPPED"`

**Rationale:**
- Order.status is set to SHIPPED when AWB is created, not when package moves
- AWB.currentStatus reflects actual carrier status updates
- Tracking page already categorizes by AWB status - now dashboard matches

### 2. Shared Module Pattern
**Decision:** Extract categorization to `src/lib/awb-status.ts`

**Benefits:**
- Single source of truth for status categorization
- Changes automatically apply to both pages
- Reduces code duplication (removed 46 lines from tracking page)

### 3. Database-Level Filtering
**Decision:** Provide `getCategoryFilterConditions()` for Prisma OR clauses

**Why:**
- More efficient than loading all AWBs and filtering in JS
- Prisma can optimize the query
- Same patterns used in dashboard-stats.ts returns query

## Files Changed

| File | Change Type | Lines Changed |
|------|-------------|---------------|
| `src/lib/awb-status.ts` | Created | +185 |
| `src/lib/dashboard-stats.ts` | Modified | +12/-7 |
| `src/app/(dashboard)/dashboard/page.tsx` | Modified | +5/-5 |
| `src/app/(dashboard)/tracking/page.tsx` | Modified | +2/-52 |

## Commits

| Hash | Message |
|------|---------|
| `5081057` | feat(07.3-06): create shared awb-status.ts module |
| `04635bf` | feat(07.3-06): update dashboard stats to count AWBs in transit |
| `938beac` | feat(07.3-06): update dashboard to use inTransit stat |
| `10bb0ba` | refactor(07.3-06): use shared awb-status.ts in tracking page |

## Deviations from Plan

None - plan executed exactly as written.

## Verification

1. [x] `awb-status.ts` created with exported functions
2. [x] `dashboard-stats.ts` imports and uses shared module
3. [x] Dashboard page uses `stats.inTransit` (not `stats.shipped`)
4. [x] Tracking page imports from shared module
5. [x] No TypeScript errors in modified files

## Next Phase Readiness

**Phase 7.3 Complete:** All 6 plans executed successfully.

**Foundation for Phase 7.5:**
- Shared awb-status.ts module ready for AWB tracking page improvements
- getCategoryFilterConditions can be used for more granular filtering
- Status categorization logic centralized and tested

**Remaining Pre-existing Issues:**
- Prisma client needs regeneration (source field not recognized)
- These are environment/build issues, not code issues
