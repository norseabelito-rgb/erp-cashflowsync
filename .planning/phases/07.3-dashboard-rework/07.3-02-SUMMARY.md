# Phase 7.3 Plan 02: Metric Calculations Summary

---
phase: 07.3-dashboard-rework
plan: 02
subsystem: dashboard
tags: [metrics, filters, prisma, dashboard-stats]

dependency_graph:
  requires: [07.3-01]
  provides: [getFilteredDashboardStats, consistent-filter-application]
  affects: [07.3-03, 07.3-04, 07.3-05]

tech_stack:
  added: []
  patterns: [filter-builder-pattern, parallel-prisma-queries]

key_files:
  created:
    - src/lib/dashboard-stats.ts
  modified:
    - src/app/(dashboard)/dashboard/page.tsx

decisions:
  - id: "07.3-02-01"
    choice: "Use buildDateWhere helper for consistent date filtering"
    reason: "Ensures all queries use same date range logic, defaults to today"
    alternatives: ["Inline date logic in each query"]
  - id: "07.3-02-02"
    choice: "pendingOrders and validatedOrders include invoice: null check"
    reason: "De Procesat should only show orders not yet invoiced"
    alternatives: ["Just check status without invoice relation"]
  - id: "07.3-02-03"
    choice: "Remove Ads card and AI Insights section from dashboard"
    reason: "User confirmed not useful for daily operations"
    alternatives: ["Keep but hide, remove completely"]
  - id: "07.3-02-04"
    choice: "Sales data for chart uses separate function with try/catch"
    reason: "Raw SQL with conditional store filter cannot be interpolated inline"
    alternatives: ["Use Prisma groupBy", "Use conditional raw SQL"]

metrics:
  duration: "7 minutes"
  completed: "2026-02-03"
  tasks_completed: 2
  tasks_total: 2
---

## One-liner

Created getFilteredDashboardStats service with consistent date/store filter application to all dashboard metrics.

## What Was Done

### Task 1: Create dashboard-stats.ts (9e0853c)
- Created `/src/lib/dashboard-stats.ts` (485 lines)
- Exported `getFilteredDashboardStats` function
- Implemented `DashboardFilters` interface (storeId, startDate, endDate)
- Implemented `DashboardStats` interface with all returned fields
- Helper function `buildDateWhere()` for consistent date range filtering
- Helper function `buildBaseWhere()` combining store and date filters
- Helper function `getSalesDataForChart()` for raw SQL grouping

All order queries use `baseWhere`:
- totalOrders, pendingOrders, validatedOrders, shipped, delivered
- Channel-specific: shopifyOrders, trendyolOrders, trendyolPending
- pendingOrders/validatedOrders include `invoice: null` for accurate "De Procesat"

Non-date-filtered queries:
- stores (for dropdown)
- recentOrders (last 5)
- lowStockProducts

### Task 2: Update dashboard page (be22094)
- Removed inline `getStats()` function
- Imported `getFilteredDashboardStats` from `@/lib/dashboard-stats`
- Updated all stat cards to use filtered data
- Renamed "Vanzari Azi" to "Vanzari" (reflects selected period)
- Replaced "ROAS Ads" card with "Facturi emise" card
- Removed Ads stats from Quick Stats section
- Removed AI Insights section
- Updated channel stats to use correct field names
- DashboardCharts receives salesData from filtered stats
- Stores overview uses simplified stores array

## Commit Summary

| Task | Commit | Message |
|------|--------|---------|
| 1 | 9e0853c | feat(07.3-02): create dashboard-stats.ts with filtered queries |
| 2 | be22094 | feat(07.3-02): update dashboard page to use filtered stats |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

1. **Build passes:** Compiled successfully with no type errors
2. **Export verified:** `getFilteredDashboardStats` exported from dashboard-stats.ts
3. **Line count:** 485 lines (exceeds 100 minimum)
4. **Import verified:** page.tsx imports and uses getFilteredDashboardStats
5. **No hardcoded dates:** grep found no `startOfDay`, `endOfDay`, or `new Date()` in page.tsx

## Key Patterns Established

### Filter Builder Pattern
```typescript
function buildBaseWhere(filters: DashboardFilters) {
  const where: Record<string, unknown> = {};
  if (filters.storeId && filters.storeId !== "all") {
    where.storeId = filters.storeId;
  }
  where[dateField] = buildDateWhere(filters.startDate, filters.endDate);
  return where;
}
```

### "De Procesat" Definition
Orders that need action = PENDING or VALIDATED status AND not yet invoiced:
```typescript
prisma.order.count({
  where: {
    ...baseWhere,
    status: "PENDING",
    invoice: null, // No invoice created yet
  },
})
```

## Next Phase Readiness

**Ready for 07.3-03:** Dashboard now has consistent filtered data. Next plan can add:
- InfoTooltip explanations on each card
- Clickable navigation with filter propagation
- Additional metric cards (Returns)

**Blockers:** None

**Dependencies resolved:**
- getFilteredDashboardStats available for import
- Filters properly applied to all visible metrics
- No Ads or AI sections to remove (already done)
