---
phase: 07.3-dashboard-rework
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(dashboard)/dashboard/page.tsx
  - src/lib/dashboard-stats.ts
autonomous: true

must_haves:
  truths:
    - "All stat cards show data filtered by current date range and store"
    - "Vanzari Azi shows sales for selected date range, not hardcoded today"
    - "De Procesat shows PENDING + VALIDATED orders for selected filters"
    - "Expediate shows shipped orders matching selected filters"
    - "Channel stats (Shopify/Trendyol) respect date and store filters"
  artifacts:
    - path: "src/lib/dashboard-stats.ts"
      provides: "getFilteredDashboardStats function with consistent filter application"
      min_lines: 100
      exports: ["getFilteredDashboardStats"]
  key_links:
    - from: "src/app/(dashboard)/dashboard/page.tsx"
      to: "src/lib/dashboard-stats.ts"
      via: "import getFilteredDashboardStats"
      pattern: "import.*getFilteredDashboardStats.*from.*dashboard-stats"
    - from: "src/lib/dashboard-stats.ts"
      to: "prisma"
      via: "database queries with filters"
      pattern: "prisma\\.(order|awb|invoice)\\.(count|findMany|aggregate)"
---

<objective>
Fix metric calculations so all dashboard cards respect the global date range and store filters consistently.

Purpose: Currently cards show global metrics (unfiltered) while the chart is store-filtered. This creates confusion. After this plan, changing filters will update ALL numbers consistently.

Output: Refactored stats logic in dedicated module, all cards using filtered data
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.3-dashboard-rework/07.3-RESEARCH.md

# Current implementation
@src/app/(dashboard)/dashboard/page.tsx

# Database client
@src/lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard-stats.ts with filtered queries</name>
  <files>src/lib/dashboard-stats.ts</files>
  <action>
Create new service file for dashboard statistics with consistent filtering:

1. Import prisma from "@/lib/db"
2. Import date-fns for date manipulation: startOfDay, endOfDay, parseISO

3. Define DashboardFilters interface:
   ```typescript
   interface DashboardFilters {
     storeId?: string;
     startDate?: string; // YYYY-MM-DD format
     endDate?: string;   // YYYY-MM-DD format
   }
   ```

4. Define DashboardStats interface with all returned fields (match current getStats return type)

5. Create helper function buildDateWhere(startDate, endDate):
   - If both dates provided: { gte: startOfDay(parseISO(startDate)), lte: endOfDay(parseISO(endDate)) }
   - If only startDate: { gte: startOfDay(parseISO(startDate)) }
   - If neither: default to today (startOfDay(new Date()), endOfDay(new Date()))
   - Use UTC consistently to avoid timezone issues

6. Create helper function buildBaseWhere(filters):
   - Combines storeId filter (if provided and not "all")
   - Combines date filter using buildDateWhere
   - Returns Prisma where clause object

7. Create async function getFilteredDashboardStats(filters: DashboardFilters):
   - Build baseWhere using helper
   - Run all queries with baseWhere applied:

     a. Order counts (ALL should use baseWhere):
        - totalOrders: count with baseWhere
        - pendingOrders: count with { ...baseWhere, status: "PENDING" }
        - validatedOrders: count with { ...baseWhere, status: "VALIDATED" }
        - validationFailed: count with { ...baseWhere, status: "VALIDATION_FAILED" }
        - invoiced: count with { ...baseWhere, status: "INVOICED" }
        - shipped: count with { ...baseWhere, status: "SHIPPED" }
        - delivered: count with { ...baseWhere, status: "DELIVERED" }

     b. Sales aggregate:
        - totalSales: aggregate sum of totalPrice with baseWhere
        - orderCount: count with baseWhere (same as totalOrders)

     c. Channel-specific (apply source filter + baseWhere):
        - shopifyOrders: count with { ...baseWhere, source: "shopify" }
        - shopifyRevenue: aggregate sum with { ...baseWhere, source: "shopify" }
        - trendyolOrders: count with { ...baseWhere, source: "trendyol" }
        - trendyolRevenue: aggregate sum with { ...baseWhere, source: "trendyol" }
        - trendyolPending: count with { ...baseWhere, source: "trendyol", status: { in: ["PENDING", "VALIDATED"] } }

     d. Invoices issued (filtered by issuedAt date, not createdAt):
        - todayInvoices: count with { status: "issued", issuedAt: dateWhere }

     e. Store list (no filter - need all stores for dropdown):
        - stores: findMany active stores with order count

     f. Recent orders (no date filter, just last 5):
        - recentOrders: findMany take 5, orderBy createdAt desc
        - Apply storeId filter if provided

     g. Low stock products (no date filter):
        - lowStockProducts: findMany where stockQuantity <= 5

   - Use Promise.all for parallel execution
   - Return structured object matching current stats shape

8. Export getFilteredDashboardStats as named export

IMPORTANT: Do NOT include Ads stats (adsSpend, adsRevenue, adsROAS) - Ads section is being removed in Plan 05.
IMPORTANT: Do NOT include AI insights count - AI section is being removed in Plan 05.
  </action>
  <verify>
Run: grep -n "export.*getFilteredDashboardStats" src/lib/dashboard-stats.ts
File should exist and export the function.
  </verify>
  <done>dashboard-stats.ts created with getFilteredDashboardStats applying filters to all queries consistently</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard page to use filtered stats</name>
  <files>src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
Refactor dashboard page to use the new filtered stats service:

1. Remove the entire getStats function from page.tsx (it's now in dashboard-stats.ts)

2. Import getFilteredDashboardStats from "@/lib/dashboard-stats"

3. Update DashboardPage function:
   - Parse searchParams for startDate, endDate, store
   - Call getFilteredDashboardStats({ storeId: store, startDate, endDate })
   - Await the result

4. Update stat card values to use filtered data:
   - "Vanzari Azi" -> rename to "Vanzari" (it's not just today anymore)
     - value: stats.totalSales
     - description: Update to show order count + date range context

   - "De procesat" stays same logic but now filtered:
     - value: stats.pendingOrders + stats.validatedOrders

   - "Expediate" stays same but now filtered:
     - value: stats.shipped

   - Channel stats now filtered:
     - Shopify: stats.shopifyOrders, stats.shopifyRevenue
     - Trendyol: stats.trendyolOrders, stats.trendyolRevenue

5. Update DashboardCharts props:
   - salesData still comes from stats (will be filtered in dashboard-stats.ts)
   - Remove currentStoreId prop if still passed (filter is global now)

6. Remove Ads-related stat card display:
   - Remove "ROAS Ads" card from the grid
   - Remove Quick Stats items for "Cheltuieli Ads" and "Venituri Ads"
   - (Full Ads section removal in Plan 05)

7. Keep recent orders and low stock sections (they use filtered/unfiltered data appropriately)
  </action>
  <verify>
Run: npm run build
Build should pass with no type errors.
Run: grep -n "getFilteredDashboardStats" src/app/(dashboard)/dashboard/page.tsx
Should show import and usage.
  </verify>
  <done>Dashboard page uses getFilteredDashboardStats, all visible metrics respect date/store filters</done>
</task>

</tasks>

<verification>
1. Run: npm run build - should compile without errors
2. Start dev server: npm run dev
3. Visit /dashboard with no params - should show today's data
4. Add ?startDate=2026-01-01&endDate=2026-01-31 to URL
   - Stat cards should show data for January only
5. Add ?store={someStoreId} to URL
   - Stat cards should show data for that store only
6. Combine both filters - should show intersection
7. Verify "De procesat" count changes when filters change
8. Verify "Expediate" count changes when filters change
</verification>

<success_criteria>
- All stat cards (Vanzari, De procesat, Expediate, channel stats) use filtered data
- Changing date range updates all card values
- Changing store filter updates all card values
- No Ads-related cards visible (prep for full removal)
- Build passes with no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.3-dashboard-rework/07.3-02-SUMMARY.md`
</output>
