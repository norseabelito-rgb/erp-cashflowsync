---
phase: 07.3-dashboard-rework
plan: 06
type: execute
wave: 4
depends_on: ["07.3-02", "07.3-05"]
files_modified:
  - src/lib/awb-status.ts
  - src/lib/dashboard-stats.ts
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/tracking/page.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard Expediate count matches tracking page In Tranzit count exactly"
    - "Both dashboard and tracking page use same status categorization logic"
    - "Shared getStatusCategory function exported from common location"
    - "No discrepancy between dashboard shipped and tracking in_transit"
  artifacts:
    - path: "src/lib/awb-status.ts"
      provides: "Shared AWB status categorization logic"
      exports: ["getStatusCategory", "StatusCategory"]
      min_lines: 50
  key_links:
    - from: "src/lib/dashboard-stats.ts"
      to: "src/lib/awb-status.ts"
      via: "import getStatusCategory"
      pattern: "import.*getStatusCategory.*from.*awb-status"
    - from: "src/app/(dashboard)/tracking/page.tsx"
      to: "src/lib/awb-status.ts"
      via: "import getStatusCategory"
      pattern: "import.*getStatusCategory.*from.*awb-status"
---

<objective>
Ensure dashboard "Expediate" count exactly matches tracking page "In tranzit" count by using shared status categorization logic.

Purpose: Currently dashboard counts Order.status === "SHIPPED" while tracking page categorizes AWB.currentStatus. These may produce different numbers, confusing users. This plan ensures both use the same logic.

Output: Shared awb-status.ts module, both pages using same categorization, metrics match
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.3-dashboard-rework/07.3-RESEARCH.md

# Current tracking page with status logic
@src/app/(dashboard)/tracking/page.tsx

# Dashboard stats service
@src/lib/dashboard-stats.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract status categorization to shared module</name>
  <files>src/lib/awb-status.ts</files>
  <action>
Create new shared module for AWB status categorization:

1. Create src/lib/awb-status.ts

2. Define and export StatusCategory type:
   ```typescript
   export type StatusCategory =
     | 'pending'
     | 'in_transit'
     | 'delivered'
     | 'returned'
     | 'cancelled'
     | 'deleted'
     | 'error'
     | 'unknown';
   ```

3. Copy and export getStatusCategory function from tracking/page.tsx:
   ```typescript
   export function getStatusCategory(status: string | null): StatusCategory {
     if (!status) return 'pending';

     const s = status.toLowerCase();

     // Return/refusal statuses
     if (s.includes('retur') || s.includes('refuz') || s.includes('return')) {
       return 'returned';
     }

     // In transit statuses (matches tracking page logic exactly)
     if (s.includes('tranzit') || s.includes('transit') || s.includes('livrare') ||
         s.includes('preluat') || s.includes('ridicat') || s.includes('sortare') ||
         s.includes('depozit') || s.includes('expedit')) {
       return 'in_transit';
     }

     // Delivered statuses
     if (s.includes('livrat') || s.includes('delivered') || s.includes('predat')) {
       return 'delivered';
     }

     // Cancelled statuses
     if (s.includes('anulat') || s.includes('cancelled') || s.includes('cancel')) {
       return 'cancelled';
     }

     // Deleted statuses
     if (s.includes('sters') || s.includes('deleted')) {
       return 'deleted';
     }

     // Error statuses
     if (s.includes('eroare') || s.includes('error') || s.includes('esuat') || s.includes('failed')) {
       return 'error';
     }

     // Default pending (new AWB, no status yet)
     if (s.includes('pending') || s.includes('nou') || s.includes('creat') || s === '') {
       return 'pending';
     }

     return 'unknown';
   }
   ```

4. Export category display config (for UI consistency):
   ```typescript
   export const categoryConfig: Record<StatusCategory, { label: string; color: string }> = {
     pending: { label: 'In asteptare', color: 'warning' },
     in_transit: { label: 'In tranzit', color: 'info' },
     delivered: { label: 'Livrat', color: 'success' },
     returned: { label: 'Returnat', color: 'destructive' },
     cancelled: { label: 'Anulat', color: 'neutral' },
     deleted: { label: 'Sters', color: 'neutral' },
     error: { label: 'Eroare', color: 'destructive' },
     unknown: { label: 'Necunoscut', color: 'default' },
   };
   ```
  </action>
  <verify>
Run: grep -n "export function getStatusCategory" src/lib/awb-status.ts
Should show the exported function.
  </verify>
  <done>awb-status.ts created with shared status categorization logic</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard stats to count AWBs in transit</name>
  <files>src/lib/dashboard-stats.ts</files>
  <action>
Modify dashboard stats to count shipped/in-transit based on AWB status, not Order status:

1. Import getStatusCategory from "@/lib/awb-status"

2. Change "shipped" calculation to match tracking page "in_transit":

   Current approach (counting Order.status === "SHIPPED"):
   ```typescript
   shipped: prisma.order.count({ where: { ...baseWhere, status: "SHIPPED" } }),
   ```

   New approach (counting AWBs with in_transit status):
   ```typescript
   // First, get all AWBs with date/store filter
   const awbs = await prisma.aWB.findMany({
     where: {
       createdAt: dateWhere,
       ...(storeId && { order: { storeId } }),
     },
     select: { currentStatus: true },
   });

   // Then categorize and count
   const inTransitCount = awbs.filter(
     awb => getStatusCategory(awb.currentStatus) === 'in_transit'
   ).length;
   ```

   OR use database-level filtering (more efficient):
   ```typescript
   const inTransitCount = await prisma.aWB.count({
     where: {
       createdAt: dateWhere,
       ...(storeId && { order: { storeId } }),
       OR: [
         { currentStatus: { contains: 'tranzit', mode: 'insensitive' } },
         { currentStatus: { contains: 'transit', mode: 'insensitive' } },
         { currentStatus: { contains: 'livrare', mode: 'insensitive' } },
         { currentStatus: { contains: 'preluat', mode: 'insensitive' } },
         { currentStatus: { contains: 'ridicat', mode: 'insensitive' } },
         { currentStatus: { contains: 'sortare', mode: 'insensitive' } },
         { currentStatus: { contains: 'depozit', mode: 'insensitive' } },
         { currentStatus: { contains: 'expedit', mode: 'insensitive' } },
       ],
     },
   });
   ```

3. Rename stats property from "shipped" to "inTransit" for clarity

4. Update DashboardStats interface to reflect this change:
   ```typescript
   inTransit: number; // AWBs currently in transit (matches tracking page)
   ```
  </action>
  <verify>
Run: grep -n "inTransit\|getStatusCategory" src/lib/dashboard-stats.ts
Should show both the property and import.
  </verify>
  <done>Dashboard stats now counts AWBs in transit using same logic as tracking page</done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard page to use inTransit stat</name>
  <files>src/app/(dashboard)/dashboard/page.tsx</files>
  <action>
Update dashboard page to use the renamed inTransit property:

1. Update stat property reference:
   - Change `stats.shipped` to `stats.inTransit` in the "Expediate" card value

2. Update card title (optional but recommended):
   - Consider renaming "Expediate" card title to "In Tranzit" for consistency with tracking page
   - OR keep "Expediate" but ensure description clarifies it means "in transit"

3. Update card description:
   - Change description from shipped-focused to transit-focused
   - Example: "Colete in drum spre clienti" or "AWB-uri in tranzit"

4. Update href for click navigation:
   - Ensure href goes to tracking page with in_transit status filter
   - Example: `buildFilteredHref("/tracking", { status: "in_transit" })`

5. Verify no other references to stats.shipped exist in page.tsx
  </action>
  <verify>
Run: grep -n "stats\\.shipped" src/app/(dashboard)/dashboard/page.tsx
Should return 0 lines (all references changed to inTransit).

Run: grep -n "stats\\.inTransit" src/app/(dashboard)/dashboard/page.tsx
Should show usage in "Expediate" card.
  </verify>
  <done>Dashboard page uses inTransit stat, card displays correct value</done>
</task>

<task type="auto">
  <name>Task 4: Update tracking page to use shared module</name>
  <files>src/app/(dashboard)/tracking/page.tsx</files>
  <action>
Refactor tracking page to import from shared module instead of inline definition:

1. Remove local getStatusCategory function definition (lines ~73-110)

2. Remove local StatusCategory type definition (lines ~64-71)

3. Import from shared module:
   ```typescript
   import { getStatusCategory, StatusCategory, categoryConfig } from "@/lib/awb-status";
   ```

4. If tracking page has its own categoryConfig, remove it and use the shared one

5. Verify all usages of getStatusCategory still work with import

6. Update any local type references from local StatusCategory to imported one
  </action>
  <verify>
Run: grep -n "from.*awb-status" src/app/(dashboard)/tracking/page.tsx
Should show the import statement.

Run: npm run build
Build should pass with no type errors.
  </verify>
  <done>Tracking page uses shared awb-status.ts module</done>
</task>

</tasks>

<verification>
1. Run: npm run build - should pass
2. Start dev server: npm run dev
3. Visit /tracking - note "In tranzit" count (e.g., 15)
4. Visit /dashboard with same date range - "Expediate" should show same count (15)
5. Apply date filter on dashboard, then check tracking with same filter - counts should match
6. Click "Expediate" card - should navigate to tracking page
7. Verify the in_transit count on tracking page matches what dashboard showed
</verification>

<success_criteria>
- Dashboard "Expediate" count equals tracking page "In tranzit" count
- Both use same getStatusCategory function from shared module
- No duplicate status categorization logic
- Build passes with no type errors
- Filter changes on dashboard reflect in matching tracking page counts
</success_criteria>

<output>
After completion, create `.planning/phases/07.3-dashboard-rework/07.3-06-SUMMARY.md`
</output>
