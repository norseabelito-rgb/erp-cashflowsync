---
phase: 04-flow-integrity
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/awb-service.ts
  - src/app/(dashboard)/settings/companies/page.tsx
autonomous: true

must_haves:
  truths:
    - "AWB service detects when billing company differs from store company"
    - "AWB generation warns about company mismatch but allows proceeding"
    - "Company settings page shows FanCourier credential fields"
    - "Missing FanCourier credentials show clear error message"
  artifacts:
    - path: "src/lib/awb-service.ts"
      provides: "Mismatch detection and warning"
      contains: "companyMismatch"
    - path: "src/app/(dashboard)/settings/companies/page.tsx"
      provides: "FanCourier credential inputs"
      contains: "fancourierClientId"
  key_links:
    - from: "src/lib/awb-service.ts"
      to: "src/lib/activity-log.ts"
      via: "logWarningOverride for mismatch acknowledgment"
      pattern: "logWarningOverride.*AWB_MISMATCH"
---

<objective>
Add AWB company mismatch detection and ensure FanCourier credentials are configurable per company

Purpose: Prevent AWB/Invoice company mismatches by detecting when billingCompany differs from store.company and warning the user. Also ensure each company can have its own FanCourier credentials for proper AWB routing.
Output: Enhanced awb-service.ts with mismatch detection, verified company settings UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-flow-integrity/04-CONTEXT.md
@.planning/phases/04-flow-integrity/04-RESEARCH.md
@src/lib/awb-service.ts
@src/app/(dashboard)/settings/companies/page.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mismatch detection to AWB service</name>
  <files>src/lib/awb-service.ts</files>
  <action>
  Enhance the `createAWBForOrder` function to detect and handle company mismatches:

  1. Add optional acknowledgment parameter (similar to invoice service):
  ```typescript
  interface AWBOptions {
    // ... existing options ...
    acknowledgeMismatchWarning?: boolean;
    warningAcknowledgedBy?: string;
  }
  ```

  2. After determining the company (around line 138), check for mismatch:
  ```typescript
  // Detect company mismatch
  const storeCompany = order.store?.company;
  const billingCompany = order.billingCompany;

  // Mismatch occurs when billingCompany is set and differs from store's company
  const hasMismatch = billingCompany && storeCompany &&
    billingCompany.id !== storeCompany.id;

  if (hasMismatch && !options?.acknowledgeMismatchWarning) {
    return {
      success: false,
      needsConfirmation: true,
      warning: {
        type: "AWB_MISMATCH",
        storeCompany: storeCompany.name,
        billingCompany: billingCompany.name,
        message: `AWB-ul va fi emis pe contul firmei "${company.name}" (din ${billingCompany ? 'billingCompany' : 'magazin'}). Verifică că e corect.`,
      },
    };
  }

  if (hasMismatch && options?.acknowledgeMismatchWarning) {
    await logWarningOverride({
      orderId,
      orderNumber: order.shopifyOrderNumber,
      warningType: "AWB_MISMATCH",
      warningDetails: {
        storeCompanyId: storeCompany.id,
        storeCompanyName: storeCompany.name,
        billingCompanyId: billingCompany.id,
        billingCompanyName: billingCompany.name,
        usedCompany: company.name,
      },
      acknowledgedBy: options.warningAcknowledgedBy || "unknown",
    });
  }
  ```

  3. Import logWarningOverride at top:
  ```typescript
  import { logWarningOverride, logAWBCreated } from "./activity-log";
  ```

  Note: Per CONTEXT.md, mismatch warns but allows proceeding. Not blocking.
  </action>
  <verify>
  - `npm run build` passes
  - Grep for `AWB_MISMATCH` in awb-service.ts shows detection logic
  </verify>
  <done>
  - AWB service detects when billingCompany differs from store.company
  - Returns warning with `needsConfirmation: true` if not acknowledged
  - Logs mismatch override when user proceeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and enhance company FanCourier credential fields in settings</name>
  <files>src/app/(dashboard)/settings/companies/page.tsx</files>
  <action>
  Check and enhance the company edit form to include FanCourier credentials:

  1. First, read the existing file to understand current form structure.

  2. Ensure these fields exist in the edit form (add if missing):
  - `fancourierClientId` - labeled "Client ID FanCourier"
  - `fancourierUsername` - labeled "Username FanCourier"
  - `fancourierPassword` - labeled "Parolă FanCourier" (type password)

  3. Group these fields under a section header:
  ```tsx
  <div className="space-y-4">
    <h4 className="font-medium text-sm text-muted-foreground">Credențiale FanCourier/SelfAWB</h4>

    <div className="grid gap-4 sm:grid-cols-3">
      <div className="space-y-2">
        <Label htmlFor="fancourierClientId">Client ID</Label>
        <Input
          id="fancourierClientId"
          value={editForm.fancourierClientId || ""}
          onChange={(e) => setEditForm({ ...editForm, fancourierClientId: e.target.value })}
          placeholder="Ex: 1234567"
        />
      </div>
      <div className="space-y-2">
        <Label htmlFor="fancourierUsername">Username</Label>
        <Input
          id="fancourierUsername"
          value={editForm.fancourierUsername || ""}
          onChange={(e) => setEditForm({ ...editForm, fancourierUsername: e.target.value })}
          placeholder="Ex: user@firma.ro"
        />
      </div>
      <div className="space-y-2">
        <Label htmlFor="fancourierPassword">Parolă</Label>
        <Input
          id="fancourierPassword"
          type="password"
          value={editForm.fancourierPassword || ""}
          onChange={(e) => setEditForm({ ...editForm, fancourierPassword: e.target.value })}
          placeholder="••••••••"
        />
      </div>
    </div>

    <p className="text-xs text-muted-foreground">
      Credențialele SelfAWB pentru generarea AWB-urilor pe contul acestei firme.
      Dacă nu sunt completate, AWB-urile nu pot fi generate pentru această firmă.
    </p>
  </div>
  ```

  4. Ensure the form state includes these fields and they're submitted in the save action.

  5. If credentials are already in the form, just verify they're properly labeled and grouped.
  </action>
  <verify>
  - `npm run build` passes
  - Grep for `fancourierClientId` in companies/page.tsx shows the form field
  - The page renders without errors when visiting /settings/companies
  </verify>
  <done>
  - Company settings page includes FanCourier credential fields
  - Fields are clearly labeled and grouped
  - Help text explains what the credentials are for
  </done>
</task>

<task type="auto">
  <name>Task 3: Add credential validation feedback</name>
  <files>src/app/(dashboard)/settings/companies/page.tsx</files>
  <action>
  Enhance the company settings to show clear feedback about credential status:

  1. In the company list/table view, add an indicator column showing FanCourier status:
  ```tsx
  // In the table or card showing companies
  {company.fancourierClientId && company.fancourierUsername && company.fancourierPassword ? (
    <Badge variant="outline" className="text-green-600 border-green-600">
      <Check className="w-3 h-3 mr-1" />
      FanCourier OK
    </Badge>
  ) : (
    <Badge variant="outline" className="text-amber-600 border-amber-600">
      <AlertTriangle className="w-3 h-3 mr-1" />
      Fără FanCourier
    </Badge>
  )}
  ```

  2. Import icons if not already imported:
  ```tsx
  import { Check, AlertTriangle } from "lucide-react";
  ```

  3. The badge serves as visual indicator so users know which companies can generate AWBs.

  Note: This is informational only - the actual blocking/warning happens in awb-service.ts (already implemented).
  </action>
  <verify>
  - `npm run build` passes
  - Companies page shows visual indicator for FanCourier credential status
  </verify>
  <done>
  - Company list shows clear visual indicator of FanCourier credential status
  - Users can quickly see which companies are configured for AWB generation
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `grep -n "AWB_MISMATCH" src/lib/awb-service.ts` shows mismatch detection
3. `grep -n "fancourierClientId" src/app/(dashboard)/settings/companies/page.tsx` shows form fields
4. AWB service returns warning for mismatched companies
</verification>

<success_criteria>
- AWB service detects billingCompany vs store.company mismatch
- Mismatch returns warning with `needsConfirmation: true`, not error
- Mismatch acknowledgments are logged
- Company settings page shows FanCourier credential fields
- Visual indicator shows which companies have credentials configured
</success_criteria>

<output>
After completion, create `.planning/phases/04-flow-integrity/04-02-SUMMARY.md`
</output>
