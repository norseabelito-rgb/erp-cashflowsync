---
phase: 04-flow-integrity
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-03"]
files_modified:
  - src/components/orders/transfer-warning-modal.tsx
  - src/app/(dashboard)/orders/page.tsx
  - src/app/api/invoices/issue/route.ts
autonomous: false

must_haves:
  truths:
    - "Warning modal appears when invoicing order with pending transfer"
    - "User must explicitly confirm (click button) to proceed"
    - "Confirmation sends acknowledgment flag to API"
    - "Modal shows transfer number, status, and recommendation"
  artifacts:
    - path: "src/components/orders/transfer-warning-modal.tsx"
      provides: "Confirmation modal component"
      contains: "TransferWarningModal"
    - path: "src/app/(dashboard)/orders/page.tsx"
      provides: "Modal integration in invoice flow"
      contains: "TransferWarningModal"
    - path: "src/app/api/invoices/issue/route.ts"
      provides: "Acknowledgment parameter handling"
      contains: "acknowledgeTransferWarning"
  key_links:
    - from: "src/app/(dashboard)/orders/page.tsx"
      to: "/api/orders/check-transfers"
      via: "fetch before invoice generation"
      pattern: "fetch.*check-transfers"
    - from: "src/app/(dashboard)/orders/page.tsx"
      to: "/api/invoices/issue"
      via: "fetch with acknowledgment flag"
      pattern: "acknowledgeTransferWarning.*true"
---

<objective>
Implement transfer warning modal and wire it into the invoice generation flow

Purpose: When user attempts to generate invoices for orders with pending transfers, show a warning modal that requires explicit confirmation. This completes the user-facing portion of the transfer warning system.
Output: New TransferWarningModal component, updated orders page with modal integration, updated issue API
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-flow-integrity/04-CONTEXT.md
@.planning/phases/04-flow-integrity/04-RESEARCH.md
@.planning/phases/04-flow-integrity/04-01-SUMMARY.md
@.planning/phases/04-flow-integrity/04-03-SUMMARY.md
@src/app/(dashboard)/orders/page.tsx
@src/app/api/invoices/issue/route.ts
@src/components/ui/alert-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TransferWarningModal component</name>
  <files>src/components/orders/transfer-warning-modal.tsx</files>
  <action>
  Create a new modal component using existing AlertDialog pattern:

  ```typescript
  "use client";

  import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
  } from "@/components/ui/alert-dialog";
  import { AlertTriangle } from "lucide-react";

  interface TransferInfo {
    orderId: string;
    orderNumber: string;
    transferNumber: string;
    transferStatus: string;
  }

  interface TransferWarningModalProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    transfers: TransferInfo[];
    onConfirm: () => void;
    onCancel: () => void;
    isLoading?: boolean;
  }

  export function TransferWarningModal({
    open,
    onOpenChange,
    transfers,
    onConfirm,
    onCancel,
    isLoading,
  }: TransferWarningModalProps) {
    const isSingle = transfers.length === 1;
    const transfer = transfers[0];

    return (
      <AlertDialog open={open} onOpenChange={onOpenChange}>
        <AlertDialogContent className="max-w-md">
          <AlertDialogHeader>
            <div className="flex items-center gap-2">
              <AlertTriangle className="h-5 w-5 text-amber-500" />
              <AlertDialogTitle>Atenție!</AlertDialogTitle>
            </div>
            <AlertDialogDescription className="space-y-3 text-left">
              {isSingle ? (
                <>
                  <p className="font-medium text-amber-600">
                    Transferul #{transfer.transferNumber} nu e finalizat.
                  </p>
                  <p>
                    Comanda #{transfer.orderNumber} are un transfer cu status{" "}
                    <span className="font-mono bg-muted px-1 rounded">
                      {transfer.transferStatus}
                    </span>.
                  </p>
                  <p className="text-sm">
                    Continuarea poate duce la diferențe în stoc sau facturare incorectă.
                  </p>
                </>
              ) : (
                <>
                  <p className="font-medium text-amber-600">
                    {transfers.length} comenzi au transferuri nefinalizate.
                  </p>
                  <div className="max-h-32 overflow-y-auto text-sm space-y-1">
                    {transfers.map((t) => (
                      <div key={t.orderId} className="flex justify-between">
                        <span>#{t.orderNumber}</span>
                        <span className="text-muted-foreground">
                          Transfer #{t.transferNumber} ({t.transferStatus})
                        </span>
                      </div>
                    ))}
                  </div>
                  <p className="text-sm">
                    Continuarea poate duce la diferențe în stoc sau facturare incorectă.
                  </p>
                </>
              )}
              <p className="text-sm text-muted-foreground italic">
                Recomandare: Finalizează transferurile înainte de a emite facturile.
              </p>
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel onClick={onCancel} disabled={isLoading}>
              Anulează
            </AlertDialogCancel>
            <AlertDialogAction
              onClick={onConfirm}
              disabled={isLoading}
              className="bg-amber-600 hover:bg-amber-700 focus:ring-amber-600"
            >
              {isLoading ? "Se procesează..." : "Continuă oricum"}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    );
  }
  ```

  Key aspects:
  - Uses existing AlertDialog from ui components
  - Amber/orange color scheme for warning tone (per CONTEXT.md)
  - Supports both single and multiple transfers
  - Shows specific transfer numbers and statuses
  - Clear recommendation text
  </action>
  <verify>
  - `npm run build` passes
  - File exists at src/components/orders/transfer-warning-modal.tsx
  </verify>
  <done>
  - TransferWarningModal component created
  - Supports single and multiple transfer warnings
  - Uses amber color scheme
  - Shows transfer numbers, statuses, and recommendation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update invoice issue API to accept acknowledgment</name>
  <files>src/app/api/invoices/issue/route.ts</files>
  <action>
  Modify the invoice issue endpoint to accept and pass acknowledgment flag:

  1. Update the body parsing to include acknowledgment:
  ```typescript
  const body = await request.json();
  const { orderIds, acknowledgeTransferWarning } = body;
  ```

  2. Pass options to the service call:
  ```typescript
  const result = await issueInvoiceForOrder(orderId, {
    acknowledgeTransferWarning: !!acknowledgeTransferWarning,
    warningAcknowledgedBy: session.user.name || session.user.email || session.user.id,
  });
  ```

  3. Handle the `needsConfirmation` response from the service:
  ```typescript
  for (const orderId of orderIds) {
    try {
      const result = await issueInvoiceForOrder(orderId, {
        acknowledgeTransferWarning: !!acknowledgeTransferWarning,
        warningAcknowledgedBy: session.user.name || session.user.email || session.user.id,
      });

      if (result.success) {
        issued++;
      } else if (result.needsConfirmation) {
        // Collect orders needing confirmation
        warnings.push({
          orderId,
          warning: result.warning,
        });
      } else {
        errors.push(result.error || "Eroare necunoscută");
      }
    } catch (err: any) {
      errors.push(err.message || "Eroare la procesarea comenzii");
    }
  }
  ```

  4. Return warnings in response if any:
  ```typescript
  // If we have warnings and no acknowledgment was provided, return them
  if (warnings.length > 0 && !acknowledgeTransferWarning) {
    return NextResponse.json({
      success: false,
      needsConfirmation: true,
      warnings,
      issued: 0,
    });
  }
  ```
  </action>
  <verify>
  - `npm run build` passes
  - Grep for `acknowledgeTransferWarning` in route.ts shows parameter handling
  </verify>
  <done>
  - API accepts acknowledgeTransferWarning flag
  - Passes flag and user info to service
  - Returns warnings when confirmation needed
  - Proceeds with acknowledged orders
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire modal into orders page invoice flow</name>
  <files>src/app/(dashboard)/orders/page.tsx</files>
  <action>
  Integrate the TransferWarningModal into the invoice generation flow:

  1. Add imports:
  ```typescript
  import { TransferWarningModal } from "@/components/orders/transfer-warning-modal";
  ```

  2. Add state for modal:
  ```typescript
  const [transferWarningOpen, setTransferWarningOpen] = useState(false);
  const [pendingInvoiceOrderIds, setPendingInvoiceOrderIds] = useState<string[]>([]);
  const [transferWarnings, setTransferWarnings] = useState<any[]>([]);
  ```

  3. Modify the invoice generation function (find existing handleIssueInvoice or similar):
  ```typescript
  async function handleIssueInvoices(orderIds: string[], acknowledged = false) {
    setIsProcessing(true);
    try {
      const response = await fetch("/api/invoices/issue", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderIds,
          acknowledgeTransferWarning: acknowledged,
        }),
      });

      const data = await response.json();

      if (data.needsConfirmation && data.warnings?.length > 0) {
        // Store the order IDs and show warning modal
        setPendingInvoiceOrderIds(orderIds);
        setTransferWarnings(
          data.warnings.map((w: any) => ({
            orderId: w.orderId,
            orderNumber: w.warning?.orderNumber || "?",
            transferNumber: w.warning?.transferNumber || "?",
            transferStatus: w.warning?.transferStatus || "?",
          }))
        );
        setTransferWarningOpen(true);
        return;
      }

      // Success or regular errors
      if (data.success) {
        toast({
          title: "Succes",
          description: `${data.issued} factură(i) emisă(e)`,
        });
        // Refresh the list
        refetch();
      } else {
        toast({
          variant: "destructive",
          title: "Eroare",
          description: data.error || "Eroare la emiterea facturilor",
        });
      }
    } catch (error: any) {
      toast({
        variant: "destructive",
        title: "Eroare",
        description: error.message || "Eroare la emiterea facturilor",
      });
    } finally {
      setIsProcessing(false);
    }
  }

  function handleTransferWarningConfirm() {
    setTransferWarningOpen(false);
    // Retry with acknowledgment
    handleIssueInvoices(pendingInvoiceOrderIds, true);
  }

  function handleTransferWarningCancel() {
    setTransferWarningOpen(false);
    setPendingInvoiceOrderIds([]);
    setTransferWarnings([]);
  }
  ```

  4. Add the modal component in the JSX (near other modals/dialogs):
  ```tsx
  <TransferWarningModal
    open={transferWarningOpen}
    onOpenChange={setTransferWarningOpen}
    transfers={transferWarnings}
    onConfirm={handleTransferWarningConfirm}
    onCancel={handleTransferWarningCancel}
    isLoading={isProcessing}
  />
  ```

  Note: The orders page is large (~2300 lines). Find the existing invoice generation logic and integrate with it. Don't replace existing functionality - enhance it.
  </action>
  <verify>
  - `npm run build` passes
  - Grep for `TransferWarningModal` in orders/page.tsx shows import and usage
  - Grep for `acknowledgeTransferWarning` in orders/page.tsx shows it's passed to API
  </verify>
  <done>
  - TransferWarningModal imported and rendered in orders page
  - Invoice generation checks for transfer warnings
  - Modal shown when warnings present
  - Confirmation retries with acknowledgment flag
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. TransferWarningModal component exists and is used
3. API accepts and handles acknowledgeTransferWarning
4. Orders page integrates modal into invoice flow

Manual verification (checkpoint):
- Select an order with pending transfer
- Click "Emite factură"
- Warning modal should appear with transfer details
- Click "Continuă oricum" - invoice should be issued
- Check ActivityLog for warning override entry
</verification>

<success_criteria>
- TransferWarningModal component exists and uses amber color scheme
- Invoice issue API accepts acknowledgment flag
- Orders page shows modal when invoicing orders with pending transfers
- Confirming modal proceeds with invoice generation
- Warning overrides are logged (verified via activity log)
</success_criteria>

<checkpoint type="human-verify">
  <what-built>Transfer warning modal integration in invoice flow</what-built>
  <how-to-verify>
  1. Navigate to /orders
  2. Find or create an order with a pending transfer
  3. Select the order and click the invoice button
  4. Verify: Warning modal appears with amber styling
  5. Verify: Modal shows transfer number and status
  6. Click "Continuă oricum"
  7. Verify: Invoice is generated
  8. Check activity log for warning override entry
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/04-flow-integrity/04-04-SUMMARY.md`
</output>
