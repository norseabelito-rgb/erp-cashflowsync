---
phase: 04-flow-integrity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/invoice-service.ts
  - src/lib/activity-log.ts
  - src/types/invoice.ts
autonomous: true

must_haves:
  truths:
    - "Invoice service returns warning (not error) when transfer is pending"
    - "User acknowledgment flag can bypass warning and proceed with invoice"
    - "Warning overrides are logged to ActivityLog with transfer details"
  artifacts:
    - path: "src/lib/invoice-service.ts"
      provides: "Warning flow for pending transfers"
      contains: "needsConfirmation"
    - path: "src/lib/activity-log.ts"
      provides: "Warning override logging helper"
      contains: "logWarningOverride"
  key_links:
    - from: "src/lib/invoice-service.ts"
      to: "src/lib/activity-log.ts"
      via: "logWarningOverride call when user acknowledges"
      pattern: "logWarningOverride.*transferId"
---

<objective>
Convert hard transfer blocking to soft warning flow with audit logging

Purpose: Instead of blocking invoice generation when a transfer is pending, the system should warn the user and allow them to proceed with explicit acknowledgment. All overrides must be logged for audit trail.
Output: Modified invoice-service.ts with warning flow, new logging helper in activity-log.ts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-flow-integrity/04-CONTEXT.md
@.planning/phases/04-flow-integrity/04-RESEARCH.md
@src/lib/invoice-service.ts
@src/lib/activity-log.ts
@src/types/prisma-enums.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify invoice-service.ts for warning-then-proceed flow</name>
  <files>src/lib/invoice-service.ts, src/types/invoice.ts</files>
  <action>
  Modify the `issueInvoiceForOrder` function to implement warning flow:

  1. Add optional parameter interface for acknowledgment:
  ```typescript
  interface InvoiceOptions {
    acknowledgeTransferWarning?: boolean;
    warningAcknowledgedBy?: string; // userId or user name
  }
  ```

  2. Update function signature:
  ```typescript
  export async function issueInvoiceForOrder(
    orderId: string,
    options?: InvoiceOptions
  ): Promise<IssueInvoiceResult>
  ```

  3. Extend the return type to include warning info:
  ```typescript
  interface IssueInvoiceResult {
    success: boolean;
    needsConfirmation?: boolean; // NEW: indicates warning needs acknowledgment
    warning?: {
      type: "TRANSFER_PENDING";
      transferNumber: string;
      transferStatus: string;
      message: string;
    };
    invoice?: { ... };
    error?: string;
    errorCode?: string;
  }
  ```

  4. Modify transfer check logic (around lines 273-281):
  - If transfer is pending AND acknowledgment NOT provided:
    - Return `{ success: false, needsConfirmation: true, warning: {...} }`
  - If transfer is pending AND acknowledgment IS provided:
    - Log the override (using new helper from Task 2)
    - Continue with invoice generation

  Use the exact Romanian message from CONTEXT.md:
  "Atenție! Transferul #{transferNumber} nu e finalizat. Risc de eroare la facturare."
  </action>
  <verify>
  - `npm run build` passes without type errors
  - Grep for `needsConfirmation` in invoice-service.ts shows the new field
  </verify>
  <done>
  - issueInvoiceForOrder accepts optional acknowledgment parameter
  - Returns `needsConfirmation: true` when transfer pending and not acknowledged
  - Proceeds with invoice when acknowledged, logs the override
  </done>
</task>

<task type="auto">
  <name>Task 2: Add warning override logging helper</name>
  <files>src/lib/activity-log.ts</files>
  <action>
  Add a new helper function for logging warning overrides:

  ```typescript
  /**
   * Helper pentru logarea când utilizatorul continuă în ciuda unui avertisment
   */
  export async function logWarningOverride(params: {
    orderId: string;
    orderNumber: string;
    warningType: "TRANSFER_PENDING" | "AWB_MISMATCH";
    warningDetails: Record<string, any>;
    acknowledgedBy: string;
  }) {
    return logActivity({
      entityType: EntityType.ORDER,
      entityId: params.orderId,
      action: ActionType.UPDATE, // Using UPDATE since WARNING_OVERRIDE not in enum
      description: params.warningType === "TRANSFER_PENDING"
        ? `Factură emisă cu transfer nefinalizat: ${params.warningDetails.transferNumber}`
        : `AWB generat cu firma diferită de facturare`,
      orderId: params.orderId,
      orderNumber: params.orderNumber,
      details: {
        warningType: params.warningType,
        acknowledgedBy: params.acknowledgedBy,
        acknowledgedAt: new Date().toISOString(),
        ...params.warningDetails,
      },
      source: "manual",
    });
  }
  ```

  Note: Using existing `ActionType.UPDATE` with descriptive details JSON instead of adding new enum value (avoids schema migration as per RESEARCH.md recommendation).
  </action>
  <verify>
  - `npm run build` passes
  - Grep for `logWarningOverride` in activity-log.ts shows the function
  </verify>
  <done>
  - logWarningOverride function exists and handles both TRANSFER_PENDING and AWB_MISMATCH warning types
  - Uses existing ActionType.UPDATE with warningType in details for filtering
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire logging into invoice service</name>
  <files>src/lib/invoice-service.ts</files>
  <action>
  Import and use the new logging helper in invoice-service.ts:

  1. Add import at top:
  ```typescript
  import { logWarningOverride, logInvoiceIssued } from "./activity-log";
  ```

  2. In the transfer check section, when user has acknowledged:
  ```typescript
  if (options?.acknowledgeTransferWarning) {
    // User acknowledged warning - log and proceed
    await logWarningOverride({
      orderId,
      orderNumber: order.shopifyOrderNumber,
      warningType: "TRANSFER_PENDING",
      warningDetails: {
        transferId: order.requiredTransferId,
        transferNumber: order.requiredTransfer?.transferNumber,
        transferStatus: order.requiredTransfer?.status,
      },
      acknowledgedBy: options.warningAcknowledgedBy || "unknown",
    });
    // Continue with invoice generation...
  }
  ```

  Ensure the log happens BEFORE the actual invoice generation so it's recorded even if invoice fails.
  </action>
  <verify>
  - Grep for `logWarningOverride` in invoice-service.ts shows the import and usage
  - `npm run build` passes
  </verify>
  <done>
  - invoice-service.ts imports logWarningOverride
  - Warning override is logged before invoice generation proceeds
  - Log includes transferId, transferNumber, transferStatus, and acknowledgedBy
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `grep -n "needsConfirmation" src/lib/invoice-service.ts` shows the warning flow
3. `grep -n "logWarningOverride" src/lib/activity-log.ts` shows the helper function
4. `grep -n "logWarningOverride" src/lib/invoice-service.ts` shows it's being used
</verification>

<success_criteria>
- Invoice service returns `needsConfirmation: true` for pending transfers without acknowledgment
- Invoice service proceeds when `acknowledgeTransferWarning: true` is provided
- All warning overrides are logged with transfer details and user who acknowledged
- Build passes without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-flow-integrity/04-01-SUMMARY.md`
</output>
