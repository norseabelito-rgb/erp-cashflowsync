---
phase: 07.7-temu-complete-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/temu.ts
  - prisma/schema.prisma
  - prisma/migrations/manual/add_temu_tables.sql
autonomous: true
user_setup:
  - service: temu
    why: "Temu Partner API access"
    env_vars:
      - name: TEMU_APP_KEY
        source: "Temu Partner Dashboard -> Developer Settings -> App Key"
      - name: TEMU_APP_SECRET
        source: "Temu Partner Dashboard -> Developer Settings -> App Secret"
      - name: TEMU_ACCESS_TOKEN
        source: "Temu Partner Dashboard -> Authorization -> Access Token (3-month expiry)"
    dashboard_config:
      - task: "Register as Temu Partner Developer"
        location: "partner.temu.com"

must_haves:
  truths:
    - "TemuClient can sign requests with MD5 signature"
    - "TemuClient can make API requests to EU endpoint"
    - "TemuStore model exists with company association"
    - "TemuOrder model exists with line items"
  artifacts:
    - path: "src/lib/temu.ts"
      provides: "TemuClient class with MD5 signing"
      exports: ["TemuClient", "TemuConfig", "TemuApiResponse", "createTemuClientFromStore"]
      min_lines: 100
    - path: "prisma/schema.prisma"
      provides: "TemuStore, TemuOrder, TemuOrderItem models"
      contains: "model TemuStore"
    - path: "prisma/migrations/manual/add_temu_tables.sql"
      provides: "SQL migration for Temu tables"
      min_lines: 50
  key_links:
    - from: "src/lib/temu.ts"
      to: "prisma TemuStore"
      via: "createTemuClientFromStore factory"
      pattern: "createTemuClientFromStore"
---

<objective>
Create TemuClient API library with MD5 signature authentication and add Temu database models (TemuStore, TemuOrder, TemuOrderItem) following the established TrendyolStore pattern.

Purpose: Foundation for all Temu API interactions. The TemuClient handles the unique MD5 signature requirement, and the database models enable multi-company, multi-store Temu integration.

Output: Working TemuClient class that can sign requests, plus Prisma models for TemuStore, TemuOrder, TemuOrderItem ready for migration.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.7-temu-complete-integration/07.7-RESEARCH.md

# Pattern reference
@src/lib/trendyol.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemuClient with MD5 Signature</name>
  <files>src/lib/temu.ts</files>
  <action>
Create TemuClient class with MD5 signature authentication for Temu Partner API.

1. Define types:
   - TemuConfig: { appKey, appSecret, accessToken, baseUrl? }
   - TemuApiResponse<T>: { success, data?, error?, errorCode?, errorMsg? }
   - TemuOrderData, TemuOrderLine for order responses
   - TemuProductData for product operations

2. Implement TemuClient class:
   - Constructor takes TemuConfig, defaults baseUrl to EU endpoint
   - Private generateSignature(params):
     - Sort keys alphabetically
     - Concatenate key+value pairs (no separators)
     - Wrap with appSecret: `${appSecret}${paramString}${appSecret}`
     - MD5 hash using crypto.createHash('md5')
     - Return UPPERCASE hex string
   - Private request<T>(methodType, data):
     - Build params: { type: methodType, app_key, access_token, timestamp, data_type: 'JSON', data: JSON.stringify(data) }
     - Generate signature and add to params
     - POST to baseUrl with Content-Type: application/x-www-form-urlencoded
     - Parse response and return TemuApiResponse

3. Add convenience methods:
   - getOrders(options: { pageNumber, pageSize, startTime?, endTime? })
   - getOrderDetail(orderId: string)
   - updateTracking(orderId: string, trackingNumber: string, carrierCode: string)
   - getProducts(options: { pageNumber, pageSize })

4. Create factory function createTemuClientFromStore:
   - Takes store object with appKey, appSecret, accessToken, region
   - Maps region to baseUrl (EU, US, GLOBAL)
   - Returns new TemuClient instance

Use Node.js built-in crypto for MD5 - do NOT add external dependencies.
Follow TrendyolClient pattern for structure but adapt for Temu's unique auth.
  </action>
  <verify>
Run: `npx tsc --noEmit src/lib/temu.ts`
Verify no TypeScript errors and all exports are available.
  </verify>
  <done>
TemuClient class exists with generateSignature, request, getOrders, getOrderDetail, updateTracking methods.
Factory function createTemuClientFromStore maps region to endpoint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TemuStore and TemuOrder Models to Schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add TemuStore, TemuOrder, and TemuOrderItem models to Prisma schema following TrendyolStore pattern exactly.

1. Add TemuStore model (after TrendyolStore section):
   ```prisma
   model TemuStore {
     id                String   @id @default(cuid())
     name              String   // "Temu EU", "Temu DE"
     appKey            String   @unique @map("app_key")
     appSecret         String   @map("app_secret")
     accessToken       String   @map("access_token")
     accessTokenExpiry DateTime @map("access_token_expiry") // 3-month expiration
     webhookSecret     String?  @map("webhook_secret")
     region            String   @default("EU") // EU, US, GLOBAL
     currencyRate      Decimal? @map("currency_rate") @db.Decimal(10, 4)
     invoiceSeriesName String?  @map("invoice_series_name") // Oblio series

     // Company association
     companyId String  @map("company_id")
     company   Company @relation(fields: [companyId], references: [id])

     isActive  Boolean  @default(true) @map("is_active")
     createdAt DateTime @default(now()) @map("created_at")
     updatedAt DateTime @updatedAt @map("updated_at")

     // Relations
     orders TemuOrder[]

     @@index([companyId])
     @@map("temu_stores")
   }
   ```

2. Add TemuOrder model:
   ```prisma
   model TemuOrder {
     id              String   @id @default(cuid())
     temuOrderId     String   @unique @map("temu_order_id")
     temuOrderNumber String   @map("temu_order_number")
     orderDate       DateTime @map("order_date")
     status          String   // Temu order statuses

     // Customer info
     customerName    String  @map("customer_name")
     customerEmail   String? @map("customer_email")
     customerPhone   String? @map("customer_phone")
     customerAddress String  @map("customer_address") @db.Text

     // Financials
     totalPrice Decimal @map("total_price") @db.Decimal(10, 2)
     currency   String  @default("EUR")

     // Link to main Order (after sync)
     orderId String? @map("order_id")
     order   Order?  @relation(fields: [orderId], references: [id])

     // Link to TemuStore
     temuStoreId String?    @map("temu_store_id")
     temuStore   TemuStore? @relation(fields: [temuStoreId], references: [id])

     // Invoice/Tracking status
     invoiceSentToTemu Boolean   @default(false) @map("invoice_sent_to_temu")
     invoiceSentAt     DateTime? @map("invoice_sent_at")
     invoiceSendError  String?   @map("invoice_send_error")

     trackingSentToTemu Boolean   @default(false) @map("tracking_sent_to_temu")
     trackingSentAt     DateTime? @map("tracking_sent_at")
     trackingSendError  String?   @map("tracking_send_error")

     // Line items
     lineItems TemuOrderItem[]

     createdAt DateTime @default(now()) @map("created_at")
     updatedAt DateTime @updatedAt @map("updated_at")

     @@index([orderId])
     @@index([temuStoreId])
     @@map("temu_orders")
   }
   ```

3. Add TemuOrderItem model:
   ```prisma
   model TemuOrderItem {
     id          String    @id @default(cuid())
     temuOrderId String    @map("temu_order_id")
     temuOrder   TemuOrder @relation(fields: [temuOrderId], references: [id], onDelete: Cascade)

     goodsId  String  @map("goods_id")
     skuId    String  @map("sku_id")
     title    String
     quantity Int
     price    Decimal @db.Decimal(10, 2)

     // Mapping to local products
     localSku        String?        @map("local_sku")
     masterProductId String?        @map("master_product_id")
     masterProduct   MasterProduct? @relation(fields: [masterProductId], references: [id])
     isMapped        Boolean        @default(false) @map("is_mapped")

     @@index([temuOrderId])
     @@map("temu_order_items")
   }
   ```

4. Add relation to Company model:
   - Add `temuStores TemuStore[]` to Company model

5. Add relation to Order model:
   - Add `temuOrder TemuOrder?` to Order model (after trendyolOrder)

6. Add relation to MasterProduct:
   - Add `temuOrderItems TemuOrderItem[]` to MasterProduct model
  </action>
  <verify>
Run: `npx prisma validate`
Verify schema is valid with no errors.
  </verify>
  <done>
TemuStore, TemuOrder, TemuOrderItem models exist in schema.
Relations to Company, Order, MasterProduct are defined.
Schema validates without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Manual SQL Migration</name>
  <files>prisma/migrations/manual/add_temu_tables.sql</files>
  <action>
Create manual SQL migration for Temu tables following existing pattern (e.g., add_trendyol_stores.sql).

1. Create temu_stores table:
   - All columns from TemuStore model
   - Foreign key to companies table
   - Index on company_id
   - Unique constraint on app_key

2. Create temu_orders table:
   - All columns from TemuOrder model
   - Foreign keys to orders and temu_stores tables
   - Indexes on order_id, temu_store_id
   - Unique constraint on temu_order_id

3. Create temu_order_items table:
   - All columns from TemuOrderItem model
   - Foreign key to temu_orders table
   - Foreign key to master_products table (nullable)
   - Index on temu_order_id

Add header comment: "Temu Integration Tables - Apply with: psql $DATABASE_URL -f add_temu_tables.sql"

Include IF NOT EXISTS checks for idempotent application.
  </action>
  <verify>
Verify SQL syntax is valid:
`cat prisma/migrations/manual/add_temu_tables.sql | head -100`
  </verify>
  <done>
SQL migration file exists with all three Temu tables.
Tables have proper foreign keys, indexes, and constraints.
Script is idempotent with IF NOT EXISTS checks.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Prisma validates: `npx prisma validate`
3. TemuClient exports: `grep -E "export (class|function|interface)" src/lib/temu.ts`
4. SQL migration complete: `wc -l prisma/migrations/manual/add_temu_tables.sql` (should be 50+ lines)
</verification>

<success_criteria>
- TemuClient class with MD5 signature generation
- Factory function createTemuClientFromStore
- TemuStore, TemuOrder, TemuOrderItem models in Prisma schema
- Manual SQL migration ready for staging/production
- No TypeScript or Prisma validation errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.7-temu-complete-integration/07.7-01-SUMMARY.md`
</output>
