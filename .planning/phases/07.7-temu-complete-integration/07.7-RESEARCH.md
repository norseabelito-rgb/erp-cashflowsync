# Phase 7.7: Temu Complete Integration - Research

**Researched:** 2026-02-05
**Domain:** Temu Partner API Integration, Multi-Channel ERP Architecture
**Confidence:** MEDIUM (API documentation not directly accessible; patterns derived from third-party sources and existing codebase)

## Summary

This phase implements complete Temu sales channel integration by replicating the established TrendyolStore pattern. The codebase already has mature multi-channel support with Shopify and Trendyol, including a placeholder Temu tab in the Orders page (Phase 7.4). The Temu Partner API uses OAuth with access_token (3-month expiration) and MD5 signature authentication, with the EU endpoint at `https://openapi-b-eu.temu.com/openapi/router`.

Key technical challenges are:
1. **MD5 Signature Generation**: Unlike Trendyol's Basic Auth, Temu requires request signing with MD5 hash
2. **API Method Structure**: Temu uses `bg.` prefixed method types (e.g., `bg.local.goods.sku.list.query`, `bg.order.*`)
3. **Rate Limiting**: 20 requests/second per app_key requires careful coordination
4. **Product Identifiers**: Goods ID (product) + SKU ID (variant) system differs from Trendyol's barcode-based approach

The integration reuses existing patterns: TemuStore model (like TrendyolStore), order sync to main Order table with `source='temu'`, invoice series linkage, and AWB generation with company credentials.

**Primary recommendation:** Create TemuClient class following TrendyolClient patterns but with MD5 signature auth, then replicate the full TrendyolStore infrastructure (model, order sync, invoice service, AWB service) for Temu.

## Standard Stack

The established libraries/tools for this domain:

### Core (Existing - No New Dependencies)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Node.js crypto | built-in | MD5 signature generation | Native, no external dependency |
| @prisma/client | ^5.10.2 | Database ORM | Existing TemuStore model pattern |
| next | 14.1.3 | API routes | Existing /api/temu routes |
| @tanstack/react-query | existing | Data fetching | Already used throughout |

### Supporting (No new dependencies needed)
| Library | Purpose | When to Use |
|---------|---------|-------------|
| existing invoice-service.ts | Invoice generation | Extend for Temu orders |
| existing stock.ts | Stock movements | processStockForOrder already handles any source |

### Alternative: Unofficial SDK
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Custom TemuClient | temu-sdk (npm) | US only, no EU support - **do not use** |

**Installation:** No new packages needed. Use built-in Node.js crypto for MD5.

## Architecture Patterns

### Recommended Project Structure
```
src/
├── lib/
│   ├── temu.ts                    # NEW: TemuClient class with MD5 signing
│   ├── temu-order-sync.ts         # NEW: Sync Temu orders to main Order table
│   ├── temu-invoice.ts            # NEW: Send invoice links to Temu
│   ├── temu-awb.ts                # NEW: Send tracking numbers to Temu
│   └── temu-product-push.ts       # NEW: Push products to Temu
├── app/api/temu/
│   ├── route.ts                   # NEW: Main Temu API endpoint
│   ├── stores/route.ts            # NEW: CRUD for TemuStore
│   ├── stores/[id]/route.ts       # NEW: Individual store operations
│   └── webhook/route.ts           # NEW: Temu order webhooks
├── app/(dashboard)/temu/
│   ├── page.tsx                   # NEW: Temu products page (like /trendyol)
│   ├── orders/page.tsx            # NEW: Temu orders detail page
│   ├── mapping/page.tsx           # NEW: Category mapping (if applicable)
│   └── publish/page.tsx           # NEW: Product publishing
└── components/
    ├── orders/temu-placeholder.tsx  # EXISTS: Replace with real content
    └── settings/TemuStoresTab.tsx   # NEW: Like TrendyolStoresTab
```

### Pattern 1: TemuClient with MD5 Signature
**What:** API client that signs all requests with MD5 hash
**When to use:** All Temu API calls
**Example:**
```typescript
// Source: Derived from Temu authorization documentation
import crypto from "crypto";

interface TemuConfig {
  appKey: string;
  appSecret: string;
  accessToken: string;
  baseUrl?: string; // Default: https://openapi-b-eu.temu.com/openapi/router
}

export class TemuClient {
  private config: TemuConfig;
  private baseUrl: string;

  constructor(config: TemuConfig) {
    this.config = config;
    this.baseUrl = config.baseUrl || "https://openapi-b-eu.temu.com/openapi/router";
  }

  /**
   * Generate MD5 signature for Temu API
   * Process: Sort params alphabetically, wrap with appSecret, MD5 hash, uppercase
   */
  private generateSignature(params: Record<string, string>): string {
    // 1. Sort keys alphabetically and concatenate key=value pairs
    const sortedKeys = Object.keys(params).sort();
    const paramString = sortedKeys
      .map(key => `${key}${params[key]}`)
      .join("");

    // 2. Wrap with appSecret
    const preSign = `${this.config.appSecret}${paramString}${this.config.appSecret}`;

    // 3. MD5 hash and uppercase
    return crypto.createHash("md5").update(preSign).digest("hex").toUpperCase();
  }

  async request<T>(
    methodType: string, // e.g., "bg.order.list.get"
    data: Record<string, any> = {}
  ): Promise<TemuApiResponse<T>> {
    const timestamp = Math.floor(Date.now() / 1000).toString();

    // Base parameters required for all requests
    const params: Record<string, string> = {
      type: methodType,
      app_key: this.config.appKey,
      access_token: this.config.accessToken,
      timestamp,
      data_type: "JSON",
      data: JSON.stringify(data),
    };

    // Generate signature
    params.sign = this.generateSignature(params);

    const response = await fetch(this.baseUrl, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(params).toString(),
    });

    const result = await response.json();
    return this.parseResponse(result);
  }
}
```

### Pattern 2: TemuStore Model (Replicate TrendyolStore)
**What:** Database model linking Temu account to company/invoice series
**When to use:** Multi-company, multi-store Temu support
**Schema addition:**
```prisma
// In schema.prisma - following TrendyolStore pattern exactly
model TemuStore {
  id                String   @id @default(cuid())
  name              String   // "Temu EU", "Temu DE"
  appKey            String   @unique @map("app_key")
  appSecret         String   @map("app_secret")
  accessToken       String   @map("access_token")
  accessTokenExpiry DateTime @map("access_token_expiry") // 3-month expiration
  webhookSecret     String   @map("webhook_secret") // For webhook verification
  region            String   @default("EU") // EU, US, GLOBAL
  currencyRate      Decimal? @map("currency_rate") @db.Decimal(10, 4)
  invoiceSeriesName String?  @map("invoice_series_name") // Oblio series name

  // Company association
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders TemuOrder[]

  @@index([companyId])
  @@map("temu_stores")
}

model TemuOrder {
  id              String   @id @default(cuid())
  temuOrderId     String   @unique @map("temu_order_id") // External Temu order ID
  temuOrderNumber String   @map("temu_order_number")
  orderDate       DateTime @map("order_date")
  status          String   // Temu order statuses

  // Customer info
  customerName    String   @map("customer_name")
  customerEmail   String?  @map("customer_email")
  customerPhone   String?  @map("customer_phone")
  customerAddress String   @map("customer_address") @db.Text

  // Financials
  totalPrice Decimal @map("total_price") @db.Decimal(10, 2)
  currency   String  @default("EUR")

  // Temu-specific
  goodsId    String?  @map("goods_id") // Product ID in Temu
  skuId      String?  @map("sku_id")   // Variant ID in Temu

  // Link to main Order (after sync)
  orderId String? @map("order_id")
  order   Order?  @relation(fields: [orderId], references: [id])

  // Link to TemuStore
  temuStoreId String?    @map("temu_store_id")
  temuStore   TemuStore? @relation(fields: [temuStoreId], references: [id])

  // Invoice/Tracking status (like TrendyolOrder)
  invoiceSentToTemu Boolean   @default(false) @map("invoice_sent_to_temu")
  invoiceSentAt     DateTime? @map("invoice_sent_at")
  invoiceSendError  String?   @map("invoice_send_error")

  trackingSentToTemu Boolean   @default(false) @map("tracking_sent_to_temu")
  trackingSentAt     DateTime? @map("tracking_sent_at")
  trackingSendError  String?   @map("tracking_send_error")

  // Line items
  lineItems TemuOrderItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([orderId])
  @@index([temuStoreId])
  @@map("temu_orders")
}

model TemuOrderItem {
  id          String    @id @default(cuid())
  temuOrderId String    @map("temu_order_id")
  temuOrder   TemuOrder @relation(fields: [temuOrderId], references: [id])

  goodsId     String    @map("goods_id") // Temu product ID
  skuId       String    @map("sku_id")   // Temu variant ID
  title       String
  quantity    Int
  price       Decimal   @db.Decimal(10, 2)

  // Mapping to local products
  localSku        String?        @map("local_sku")
  masterProductId String?        @map("master_product_id")
  masterProduct   MasterProduct? @relation(fields: [masterProductId], references: [id])
  isMapped        Boolean        @default(false) @map("is_mapped")

  @@map("temu_order_items")
}
```

### Pattern 3: Order Sync to Main Order Table (source='temu')
**What:** Sync TemuOrder records to unified Order table
**When to use:** After Temu order import, for unified invoice/AWB workflow
**Example:**
```typescript
// Source: Following trendyol-order-sync.ts pattern exactly
export async function syncTemuOrderToMainOrder(
  temuOrder: TemuOrderWithItems,
  temuStore: TemuStoreForSync
): Promise<Order> {
  // 1. Find or create virtual Store for Temu
  const store = await findOrCreateTemuVirtualStore(temuStore);

  // 2. Check if Order already exists
  const existingOrder = await prisma.order.findFirst({
    where: {
      shopifyOrderId: temuOrder.temuOrderId,
      source: "temu",  // KEY: Use source='temu'
    },
  });

  if (existingOrder) {
    // Update status only
    return updateOrderFromTemu(existingOrder, temuOrder);
  }

  // 3. Create new Order with billingCompanyId from TemuStore
  const order = await prisma.order.create({
    data: {
      shopifyOrderId: temuOrder.temuOrderId,
      shopifyOrderNumber: temuOrder.temuOrderNumber,
      source: "temu",  // KEY: Mark as Temu order
      storeId: store.id,
      billingCompanyId: temuStore.companyId, // Invoice company
      // ... rest of order data mapping
    },
  });

  // 4. Link TemuOrder to Order
  await prisma.temuOrder.update({
    where: { id: temuOrder.id },
    data: { orderId: order.id, temuStoreId: temuStore.id },
  });

  return order;
}
```

### Pattern 4: Invoice Series from TemuStore (Like TrendyolStore)
**What:** Use TemuStore.invoiceSeriesName for Oblio invoice series
**When to use:** Invoice generation for Temu orders
**Example:**
```typescript
// Source: Extend existing invoice-service.ts logic
// In invoice-service.ts, add Temu priority before Trendyol check:
if (order.source === "temu") {
  const temuOrder = await prisma.temuOrder.findFirst({
    where: { orderId: order.id },
    include: { temuStore: true },
  });

  if (temuOrder?.temuStore?.invoiceSeriesName) {
    oblioSeriesName = temuOrder.temuStore.invoiceSeriesName;
    seriesSource = "temu_store";
    useOblioNumbering = true;
    console.log(`[Invoice] Using Temu store series: ${oblioSeriesName}`);
  }
}
```

### Anti-Patterns to Avoid
- **Hardcoding credentials**: Always use TemuStore model, not environment variables
- **Skipping signature verification**: Every request MUST be signed with MD5
- **Ignoring rate limits**: 20 req/sec limit requires request queuing for batch operations
- **Direct API calls without TemuClient**: All Temu API calls should go through TemuClient class
- **Mixing EU/US endpoints**: EU region uses `openapi-b-eu.temu.com`, never use US endpoint

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| MD5 hashing | Custom implementation | Node.js crypto.createHash('md5') | Native, secure, tested |
| Invoice series resolution | Custom lookup | Extend existing invoice-service.ts | Already handles edge cases, Oblio integration |
| Stock movements | Temu-specific stock code | processStockForOrder in stock.ts | Already handles any order source |
| AWB tracking flow | Custom Temu AWB | Extend existing AWB service with TemuStore lookup | Company credentials already handled |
| Multi-store UI | New store management | Replicate TrendyolStoresTab component | Consistent UX, already tested |
| Order status mapping | New status system | Extend internalOrderStatus mechanism | Already supports multi-channel |

**Key insight:** The codebase has mature multi-channel support. Temu integration should replicate TrendyolStore patterns exactly, not invent new approaches.

## Common Pitfalls

### Pitfall 1: MD5 Signature Generation Order
**What goes wrong:** API returns "invalid signature" errors
**Why it happens:** Parameters must be sorted alphabetically before concatenation
**How to avoid:**
```typescript
// CORRECT:
const sortedKeys = Object.keys(params).sort();
const paramString = sortedKeys.map(key => `${key}${params[key]}`).join("");
const preSign = `${appSecret}${paramString}${appSecret}`;
const sign = crypto.createHash("md5").update(preSign).digest("hex").toUpperCase();

// WRONG (not sorted, lowercase):
const paramString = Object.entries(params).map(([k,v]) => `${k}${v}`).join("");
const sign = crypto.createHash("md5").update(paramString).digest("hex");
```
**Warning signs:** "Invalid signature" errors in API responses

### Pitfall 2: Access Token Expiration
**What goes wrong:** API suddenly stops working after 3 months
**Why it happens:** Temu access tokens expire after 3 months
**How to avoid:**
1. Store `accessTokenExpiry` in TemuStore model
2. Check expiry before each request
3. Alert admin when token is within 7 days of expiry
4. Document refresh flow (manual re-authorization required)
**Warning signs:** TemuStore.accessTokenExpiry approaching current date

### Pitfall 3: Product ID Confusion (Goods ID vs SKU ID)
**What goes wrong:** Wrong products linked to orders
**Why it happens:** Temu uses dual identifiers - Goods ID (product) and SKU ID (variant)
**How to avoid:**
1. Store BOTH goodsId and skuId in TemuOrderItem
2. Map using composite key (goodsId + skuId) to MasterProduct
3. For product push, generate both IDs correctly
**Warning signs:** Order items don't match expected products

### Pitfall 4: Rate Limiting (20 req/sec)
**What goes wrong:** API returns 429 Too Many Requests
**Why it happens:** Batch operations exceed 20 requests/second limit
**How to avoid:**
1. Implement request queue with throttling
2. For batch operations (product push, order sync), add delays
3. Use batch endpoints where available (if Temu supports them)
```typescript
// Simple rate limiter
const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));
for (const item of items) {
  await processItem(item);
  await sleep(60); // 60ms delay = max ~16 req/sec (safe margin)
}
```
**Warning signs:** 429 errors in production logs

### Pitfall 5: EU vs US Endpoint Confusion
**What goes wrong:** Orders from wrong region or API failures
**Why it happens:** Different Temu regions have different endpoints
**How to avoid:**
1. Store `region` in TemuStore model
2. Always use TemuStore.region to select endpoint
3. EU: `https://openapi-b-eu.temu.com/openapi/router`
4. US: `https://openapi-b-us.temu.com/openapi/router`
5. Global (Mexico/Japan): `https://openapi-b-global.temu.com/openapi/router`
**Warning signs:** Cross-region data mixing

## Code Examples

Verified patterns from existing codebase (adapted for Temu):

### TemuClient Factory Function
```typescript
// Source: Following createTrendyolClientFromStore pattern
export function createTemuClientFromStore(store: {
  appKey: string;
  appSecret: string;
  accessToken: string;
  region: string;
}): TemuClient {
  const baseUrls: Record<string, string> = {
    EU: "https://openapi-b-eu.temu.com/openapi/router",
    US: "https://openapi-b-us.temu.com/openapi/router",
    GLOBAL: "https://openapi-b-global.temu.com/openapi/router",
  };

  return new TemuClient({
    appKey: store.appKey,
    appSecret: store.appSecret,
    accessToken: store.accessToken,
    baseUrl: baseUrls[store.region] || baseUrls.EU,
  });
}
```

### Order Sync Pattern (Temu Adaptation)
```typescript
// Source: Adapted from trendyol-order-sync.ts
export async function syncTemuOrdersForStore(
  store: TemuStoreForSync,
  options?: {
    startDate?: Date;
    endDate?: Date;
    onProgress?: (current: number, total: number) => void;
  }
): Promise<{ synced: number; created: number; updated: number; errors: string[] }> {
  const result = { synced: 0, created: 0, updated: 0, errors: [] as string[] };

  const client = createTemuClientFromStore(store);

  // Temu API method for order list (adjust based on actual API)
  const ordersResponse = await client.request<{ orders: TemuOrderData[] }>(
    "bg.order.list.get",
    {
      pageNumber: 1,
      pageSize: 100,
      startTime: options?.startDate?.getTime(),
      endTime: options?.endDate?.getTime(),
    }
  );

  if (!ordersResponse.success) {
    result.errors.push(ordersResponse.error || "Failed to fetch orders");
    return result;
  }

  for (const orderData of ordersResponse.data?.orders || []) {
    try {
      const wasCreated = await syncSingleTemuOrder(orderData, store.id);
      if (wasCreated) result.created++;
      else result.updated++;
      result.synced++;
    } catch (error: any) {
      result.errors.push(`Order ${orderData.orderNumber}: ${error.message}`);
    }
  }

  return result;
}
```

### Send Tracking to Temu (Following AWB Pattern)
```typescript
// Source: Adapted from trendyol-awb.ts
export async function sendTrackingToTemu(
  orderId: string,
  awbNumber: string,
  carrier: string
): Promise<{ success: boolean; error?: string }> {
  const temuOrder = await prisma.temuOrder.findFirst({
    where: { orderId },
    include: { temuStore: true },
  });

  if (!temuOrder) {
    return { success: true }; // Not a Temu order
  }

  if (!temuOrder.temuStore) {
    return { success: false, error: "No TemuStore configured" };
  }

  const client = createTemuClientFromStore(temuOrder.temuStore);

  // Temu API method for tracking update (adjust based on actual API)
  const result = await client.request<void>(
    "bg.shipment.tracking.update",
    {
      orderId: temuOrder.temuOrderId,
      trackingNumber: awbNumber,
      carrierCode: mapCarrierToTemuCode(carrier),
    }
  );

  if (result.success) {
    await prisma.temuOrder.update({
      where: { id: temuOrder.id },
      data: {
        trackingSentToTemu: true,
        trackingSentAt: new Date(),
        trackingSendError: null,
      },
    });
  } else {
    await prisma.temuOrder.update({
      where: { id: temuOrder.id },
      data: { trackingSendError: result.error },
    });
  }

  return result;
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Single-channel (Shopify) | Multi-channel (Shopify + Trendyol + Temu) | Phase 7.1-7.4 | Order.source field, ChannelTabs |
| Settings-based credentials | Store-based credentials (TrendyolStore) | Phase 7.1 | Multi-company support |
| Hardcoded invoice series | Store.invoiceSeriesName | Phase 7.2 | Per-channel Oblio series |
| No stock movements on returns | processStockReturnForOrder | Recent | Stock increases on Temu returns |

**Deprecated/outdated:**
- TemuPlaceholder component: Replace with real Temu orders display
- Temu tab showing "Urmaza sa fie implementat": Replace with working orders list

## Open Questions

Things that couldn't be fully resolved:

1. **Exact Temu API Method Names**
   - What we know: Methods use `bg.` prefix (e.g., `bg.order.list.get`)
   - What's unclear: Exact method names for orders, products, tracking updates
   - Recommendation: Access partner.temu.com documentation with actual Temu account, or use temu-js-sdk source as reference

2. **Temu Webhook Format**
   - What we know: Webhooks exist for order updates
   - What's unclear: Exact payload format, signature verification method
   - Recommendation: Implement generic webhook handler, log payloads, adapt based on actual data

3. **Product Category/Attribute Mapping**
   - What we know: Temu has category system (like Trendyol)
   - What's unclear: Whether attributes are required for product push
   - Recommendation: Start with basic product push (title, price, stock), add attribute mapping in later iteration

4. **Currency Handling**
   - What we know: Temu EU likely uses EUR
   - What's unclear: Whether multi-currency orders exist
   - Recommendation: Store original currency in TemuOrder, use TemuStore.currencyRate for RON conversion if needed

## Sources

### Primary (HIGH confidence)
- Codebase analysis: src/lib/trendyol.ts, trendyol-order-sync.ts, trendyol-invoice.ts, trendyol-awb.ts
- Codebase analysis: prisma/schema.prisma (TrendyolStore model pattern)
- Codebase analysis: src/lib/invoice-service.ts (invoice series resolution)
- Codebase analysis: src/lib/stock.ts (stock movement patterns)
- Codebase analysis: src/components/orders/channel-tabs.tsx, temu-placeholder.tsx

### Secondary (MEDIUM confidence)
- [Hemi Temu Technical Scope](https://help.useresponse.com/hemi/knowledge-base/article/marketplaces-temu-technical-scope-temu-authorization) - Authentication, endpoints, signature generation
- [Sellercloud Temu Integration](https://help.sellercloud.com/omnichannel-ecommerce/temu-account-integration/) - Feature scope (orders, inventory, tracking)
- [GitHub temu-js-sdk](https://github.com/AlienLlama0/temu-js-sdk) - API client structure (US only)

### Tertiary (LOW confidence)
- [API2Cart Temu Guide](https://api2cart.com/api-technology/temu-api/) - General integration patterns
- Official partner documentation requires JS and authentication - not directly accessible

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Using existing codebase patterns, no new dependencies
- Architecture: HIGH - Direct replication of TrendyolStore pattern
- API specifics: MEDIUM - MD5 signature and endpoints confirmed, exact methods need validation
- Pitfalls: MEDIUM - Derived from documentation and similar API patterns

**Research date:** 2026-02-05
**Valid until:** 2026-03-05 (30 days - Temu API may update, documentation is sparse)
