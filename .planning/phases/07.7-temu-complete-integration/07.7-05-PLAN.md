---
phase: 07.7-temu-complete-integration
plan: 05
type: execute
wave: 3
depends_on: ["07.7-02", "07.7-03"]
files_modified:
  - src/app/api/temu/orders/route.ts
  - src/app/api/temu/sync/route.ts
  - src/components/orders/temu-orders-list.tsx
  - src/app/(dashboard)/orders/page.tsx
autonomous: true

must_haves:
  truths:
    - "Temu orders appear in Orders page Temu tab"
    - "Temu tab shows real order data, not placeholder"
    - "Orders can be synced from Temu via sync button"
    - "Order list shows Temu-specific columns"
  artifacts:
    - path: "src/app/api/temu/orders/route.ts"
      provides: "Temu orders API endpoint"
      exports: ["GET"]
      min_lines: 50
    - path: "src/app/api/temu/sync/route.ts"
      provides: "Temu order sync endpoint"
      exports: ["POST"]
      min_lines: 40
    - path: "src/components/orders/temu-orders-list.tsx"
      provides: "Temu orders list component"
      min_lines: 150
  key_links:
    - from: "src/components/orders/temu-orders-list.tsx"
      to: "/api/temu/orders"
      via: "useSWR fetch"
      pattern: "/api/temu/orders"
    - from: "src/app/(dashboard)/orders/page.tsx"
      to: "TemuOrdersList"
      via: "import and render"
      pattern: "TemuOrdersList"
---

<objective>
Replace Temu placeholder with real Temu orders list, create API endpoints for order fetching and sync, and integrate into the Orders page Temu tab.

Purpose: Enable users to view and manage Temu orders through the existing Orders page interface, replacing the placeholder with functional order management.

Output: Working Temu tab in Orders page showing real orders with sync capability.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.7-temu-complete-integration/07.7-02-SUMMARY.md
@.planning/phases/07.7-temu-complete-integration/07.7-03-SUMMARY.md

# Pattern reference
@src/app/api/trendyol/orders/route.ts
@src/components/orders/temu-placeholder.tsx
@src/app/(dashboard)/orders/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Temu Orders API Endpoints</name>
  <files>src/app/api/temu/orders/route.ts, src/app/api/temu/sync/route.ts</files>
  <action>
Create API endpoints for fetching and syncing Temu orders.

1. Create src/app/api/temu/orders/route.ts:

   GET handler:
   - Permission check: orders.view
   - Query params: page, limit, status, storeId, startDate, endDate, search
   - Fetch Order records where source = 'temu'
   - Include: lineItems, invoice, awb, temuOrder (with temuStore)
   - Support filtering by:
     - status (OrderStatus)
     - storeId (filter by virtual store or temuStoreId)
     - date range (createdAt between startDate and endDate)
     - search (order number, customer name, phone)
   - Return paginated response with totalCount

   ```typescript
   export async function GET(request: NextRequest) {
     const session = await getServerSession(authOptions);
     if (!session?.user) {
       return NextResponse.json({ error: "Neautorizat" }, { status: 401 });
     }

     // Permission check
     const permissions = await getUserPermissions(session.user.id);
     if (!permissions.includes("orders.view")) {
       return NextResponse.json({ error: "Acces interzis" }, { status: 403 });
     }

     const { searchParams } = new URL(request.url);
     const page = parseInt(searchParams.get("page") || "1");
     const limit = parseInt(searchParams.get("limit") || "50");
     const status = searchParams.get("status");
     const storeId = searchParams.get("storeId");
     const startDate = searchParams.get("startDate");
     const endDate = searchParams.get("endDate");
     const search = searchParams.get("search");

     const where: any = { source: "temu" };

     if (status) where.status = status;
     if (startDate && endDate) {
       where.createdAt = {
         gte: new Date(startDate),
         lte: new Date(endDate),
       };
     }
     if (search) {
       where.OR = [
         { shopifyOrderNumber: { contains: search, mode: "insensitive" } },
         { customerFirstName: { contains: search, mode: "insensitive" } },
         { customerLastName: { contains: search, mode: "insensitive" } },
         { customerPhone: { contains: search } },
       ];
     }

     const [orders, totalCount] = await Promise.all([
       prisma.order.findMany({
         where,
         include: {
           lineItems: true,
           invoice: true,
           awb: true,
           temuOrder: { include: { temuStore: true } },
         },
         orderBy: { createdAt: "desc" },
         skip: (page - 1) * limit,
         take: limit,
       }),
       prisma.order.count({ where }),
     ]);

     return NextResponse.json({
       orders,
       pagination: {
         page,
         limit,
         totalCount,
         totalPages: Math.ceil(totalCount / limit),
       },
     });
   }
   ```

2. Create src/app/api/temu/sync/route.ts:

   POST handler:
   - Permission check: orders.create or orders.edit
   - Body params: storeId (optional - sync specific store or all)
   - Call syncTemuOrdersForStore for each active TemuStore
   - Return sync results: { synced, created, updated, errors }

   ```typescript
   export async function POST(request: NextRequest) {
     const session = await getServerSession(authOptions);
     if (!session?.user) {
       return NextResponse.json({ error: "Neautorizat" }, { status: 401 });
     }

     const permissions = await getUserPermissions(session.user.id);
     if (!permissions.includes("orders.create") && !permissions.includes("orders.edit")) {
       return NextResponse.json({ error: "Acces interzis" }, { status: 403 });
     }

     const body = await request.json().catch(() => ({}));
     const { storeId, startDate, endDate } = body;

     // Get stores to sync
     const stores = await prisma.temuStore.findMany({
       where: {
         isActive: true,
         ...(storeId ? { id: storeId } : {}),
       },
       include: { company: true },
     });

     if (stores.length === 0) {
       return NextResponse.json({
         success: true,
         message: "Niciun magazin Temu configurat",
         results: [],
       });
     }

     const results = [];
     for (const store of stores) {
       const result = await syncTemuOrdersForStore(store, {
         startDate: startDate ? new Date(startDate) : undefined,
         endDate: endDate ? new Date(endDate) : undefined,
       });
       results.push({ storeId: store.id, storeName: store.name, ...result });
     }

     return NextResponse.json({
       success: true,
       results,
     });
   }
   ```
  </action>
  <verify>
Run: `npx tsc --noEmit src/app/api/temu/orders/route.ts src/app/api/temu/sync/route.ts`
Verify no TypeScript errors.
  </verify>
  <done>
GET /api/temu/orders returns paginated Temu orders.
POST /api/temu/sync triggers order sync from Temu API.
Both endpoints have permission checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TemuOrdersList Component</name>
  <files>src/components/orders/temu-orders-list.tsx</files>
  <action>
Create TemuOrdersList component to replace TemuPlaceholder, following existing order list patterns.

1. Component structure:
   - Use useSWR to fetch /api/temu/orders with query params
   - State for filters (status, dateRange, search)
   - State for pagination (page, limit)
   - State for syncing (isSyncing boolean)

2. Header section:
   - Title: "Comenzi Temu"
   - Sync button with loading state
   - Last sync info (if available)

3. Filter bar:
   - Search input (order number, customer)
   - Status filter dropdown
   - Date range picker (reuse existing DateRangePicker if available)
   - Store filter (if multiple TemuStores)

4. Orders table:
   - Columns: Nr. Comanda, Data, Client, Produse, Total, Status, Factura, AWB, Actiuni
   - Show TemuStore name if multiple stores
   - Row click opens order detail (reuse existing OrderDetailDialog)
   - Actions: same as Trendyol/Shopify (factura, AWB, etc.)

5. Pagination:
   - Page numbers
   - Items per page selector
   - Total count display

6. Empty state:
   - If no orders and not loading: show message with sync button
   - Use EmptyState component if available

7. Sync functionality:
   - Click sync button calls POST /api/temu/sync
   - Show toast on success/error
   - Mutate SWR cache after sync

Use Romanian labels without diacritics.
Follow existing components/orders patterns for consistency.
  </action>
  <verify>
Run: `npx tsc --noEmit src/components/orders/temu-orders-list.tsx`
Verify no TypeScript errors.
  </verify>
  <done>
TemuOrdersList component renders order table.
Filters work for status, date range, search.
Sync button triggers order sync.
Pagination works correctly.
Empty state shows when no orders.
  </done>
</task>

<task type="auto">
  <name>Task 3: Replace Placeholder in Orders Page</name>
  <files>src/app/(dashboard)/orders/page.tsx</files>
  <action>
Replace TemuPlaceholder with TemuOrdersList in the Orders page.

1. Update imports:
   - Remove or comment out: `import { TemuPlaceholder } from "@/components/orders/temu-placeholder"`
   - Add: `import { TemuOrdersList } from "@/components/orders/temu-orders-list"`

2. Find the conditional rendering for Temu tab (search for "TemuPlaceholder" or "channelTab === 'temu'").

3. Replace TemuPlaceholder with TemuOrdersList:
   ```tsx
   {channelTab === "temu" && (
     <TemuOrdersList
       filters={{
         status: statusFilter,
         startDate: dateRange?.from,
         endDate: dateRange?.to,
         search: searchQuery,
       }}
     />
   )}
   ```

4. Ensure global filters (date range, status, search) are passed to TemuOrdersList if they exist in the Orders page.

5. Test that tab switching works correctly:
   - Shopify tab shows Shopify orders
   - Trendyol tab shows Trendyol orders
   - Temu tab shows Temu orders (not placeholder)
  </action>
  <verify>
Run dev server and navigate to /orders?tab=temu
Verify TemuOrdersList renders instead of placeholder.
  </verify>
  <done>
Orders page imports TemuOrdersList.
Temu tab renders TemuOrdersList component.
Placeholder component no longer shown.
Global filters passed to TemuOrdersList.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. API responds: `curl http://localhost:3000/api/temu/orders` (returns orders or 401)
3. UI works:
   - Navigate to /orders?tab=temu
   - See orders list (or empty state if no orders)
   - Click sync button
   - Filters change displayed orders
</verification>

<success_criteria>
- Temu orders API returns paginated orders
- Sync API triggers order sync from Temu
- TemuOrdersList replaces placeholder in Orders page
- Filters and pagination work correctly
- Sync button syncs orders and refreshes list
</success_criteria>

<output>
After completion, create `.planning/phases/07.7-temu-complete-integration/07.7-05-SUMMARY.md`
</output>
