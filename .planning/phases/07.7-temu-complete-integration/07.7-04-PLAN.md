---
phase: 07.7-temu-complete-integration
plan: 04
type: execute
wave: 2
depends_on: ["07.7-01"]
files_modified:
  - src/lib/temu-awb.ts
  - src/lib/awb-service.ts
autonomous: true

must_haves:
  truths:
    - "Tracking numbers are sent to Temu after AWB creation"
    - "TemuOrder.trackingSentToTemu is set to true after success"
    - "AWB generation uses TemuStore.companyId for credentials"
    - "Errors are logged and stored in TemuOrder.trackingSendError"
  artifacts:
    - path: "src/lib/temu-awb.ts"
      provides: "Send tracking to Temu service"
      exports: ["sendTrackingToTemu", "mapCarrierToTemuCode"]
      min_lines: 60
    - path: "src/lib/awb-service.ts"
      provides: "Extended AWB service with Temu tracking"
      contains: "sendTrackingToTemu"
  key_links:
    - from: "src/lib/temu-awb.ts"
      to: "TemuClient"
      via: "createTemuClientFromStore"
      pattern: "createTemuClientFromStore"
    - from: "src/lib/awb-service.ts"
      to: "src/lib/temu-awb.ts"
      via: "import sendTrackingToTemu"
      pattern: "sendTrackingToTemu"
---

<objective>
Create Temu AWB tracking service that sends tracking numbers to Temu after AWB creation, following the established trendyol-awb.ts pattern. Integrate with AWB service for automatic tracking sends.

Purpose: Enable automatic tracking number updates to Temu when AWBs are created for Temu orders, improving customer experience and order tracking visibility.

Output: Working sendTrackingToTemu function integrated into AWB creation flow.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.7-temu-complete-integration/07.7-01-SUMMARY.md

# Pattern reference
@src/lib/trendyol-awb.ts
@src/lib/awb-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Temu AWB Tracking Service</name>
  <files>src/lib/temu-awb.ts</files>
  <action>
Create temu-awb.ts following trendyol-awb.ts pattern.

1. Import dependencies:
   ```typescript
   import prisma from "@/lib/db";
   import { createTemuClientFromStore, TemuApiResponse } from "@/lib/temu";
   ```

2. Implement carrier code mapping:
   ```typescript
   const CARRIER_MAP: Record<string, string> = {
     "fancourier": "FANCOURIER",
     "fan_courier": "FANCOURIER",
     "fan courier": "FANCOURIER",
     "dhl": "DHL",
     "ups": "UPS",
     "fedex": "FEDEX",
     "gls": "GLS",
     "dpd": "DPD",
     "cargus": "CARGUS",
     "sameday": "SAMEDAY",
   };

   export function mapCarrierToTemuCode(carrier: string): string {
     const normalized = carrier.toLowerCase().trim();
     return CARRIER_MAP[normalized] || carrier.toUpperCase();
   }
   ```

3. Implement sendTrackingToTemu:
   ```typescript
   export async function sendTrackingToTemu(
     orderId: string,
     awbNumber: string,
     carrier: string = "FAN COURIER"
   ): Promise<{ success: boolean; error?: string }> {
     try {
       // Find TemuOrder for this Order
       const temuOrder = await prisma.temuOrder.findFirst({
         where: { orderId },
         include: { temuStore: true },
       });

       // Not a Temu order - silently succeed
       if (!temuOrder) {
         return { success: true };
       }

       // No TemuStore configured
       if (!temuOrder.temuStore) {
         console.log(`[Temu AWB] No TemuStore for order ${orderId}`);
         return { success: true }; // Non-blocking
       }

       // Already sent
       if (temuOrder.trackingSentToTemu) {
         console.log(`[Temu AWB] Tracking already sent for ${temuOrder.temuOrderNumber}`);
         return { success: true };
       }

       // Create client and send tracking
       const client = createTemuClientFromStore(temuOrder.temuStore);
       const carrierCode = mapCarrierToTemuCode(carrier);

       console.log(`[Temu AWB] Sending tracking ${awbNumber} (${carrierCode}) for order ${temuOrder.temuOrderNumber}`);

       // Temu API call - adjust method name based on actual API
       const result = await client.updateTracking(
         temuOrder.temuOrderId,
         awbNumber,
         carrierCode
       );

       if (result.success) {
         await prisma.temuOrder.update({
           where: { id: temuOrder.id },
           data: {
             trackingSentToTemu: true,
             trackingSentAt: new Date(),
             trackingSendError: null,
           },
         });
         console.log(`[Temu AWB] Tracking sent successfully for ${temuOrder.temuOrderNumber}`);
         return { success: true };
       } else {
         const errorMsg = result.error || "Unknown error";
         await prisma.temuOrder.update({
           where: { id: temuOrder.id },
           data: { trackingSendError: errorMsg },
         });
         console.error(`[Temu AWB] Failed to send tracking: ${errorMsg}`);
         return { success: false, error: errorMsg };
       }
     } catch (error: any) {
       const errorMsg = error.message || "Unknown error";
       console.error(`[Temu AWB] Exception sending tracking: ${errorMsg}`);

       // Try to update error in database
       try {
         await prisma.temuOrder.updateMany({
           where: { orderId },
           data: { trackingSendError: errorMsg },
         });
       } catch (dbError) {
         console.error(`[Temu AWB] Failed to log error to DB: ${dbError}`);
       }

       return { success: false, error: errorMsg };
     }
   }
   ```

4. Add retry function for failed sends:
   ```typescript
   export async function retryFailedTemuTrackingSends(): Promise<{
     retried: number;
     succeeded: number;
     failed: number;
   }> {
     const result = { retried: 0, succeeded: 0, failed: 0 };

     // Find orders with tracking errors that have AWB
     const failedOrders = await prisma.temuOrder.findMany({
       where: {
         trackingSentToTemu: false,
         trackingSendError: { not: null },
         order: {
           awb: { awbNumber: { not: null } },
         },
       },
       include: {
         order: { include: { awb: true } },
         temuStore: true,
       },
       take: 50, // Limit batch size
     });

     for (const temuOrder of failedOrders) {
       if (!temuOrder.order?.awb?.awbNumber) continue;

       result.retried++;
       const sendResult = await sendTrackingToTemu(
         temuOrder.orderId!,
         temuOrder.order.awb.awbNumber,
         "FAN COURIER"
       );

       if (sendResult.success) {
         result.succeeded++;
       } else {
         result.failed++;
       }
     }

     return result;
   }
   ```
  </action>
  <verify>
Run: `npx tsc --noEmit src/lib/temu-awb.ts`
Verify no TypeScript errors.
  </verify>
  <done>
sendTrackingToTemu function sends AWB number to Temu.
mapCarrierToTemuCode maps FanCourier to Temu carrier code.
TemuOrder.trackingSentToTemu updated on success.
Errors logged to TemuOrder.trackingSendError.
retryFailedTemuTrackingSends enables batch retries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Temu Tracking into AWB Service</name>
  <files>src/lib/awb-service.ts</files>
  <action>
Add Temu tracking send to AWB creation flow, following the pattern used for Trendyol.

1. Add import at top of file:
   ```typescript
   import { sendTrackingToTemu } from "@/lib/temu-awb";
   ```

2. Find the section where tracking is sent to Trendyol (search for "sendTrackingToTrendyol" or similar).

3. Add Temu tracking send after Trendyol (non-blocking pattern):
   ```typescript
   // Send tracking to Temu (non-blocking)
   if (order.source === "temu") {
     sendTrackingToTemu(order.id, awbNumber, "FAN COURIER")
       .then(result => {
         if (!result.success) {
           console.error(`[AWB] Failed to send Temu tracking: ${result.error}`);
         }
       })
       .catch(error => {
         console.error(`[AWB] Temu tracking send error: ${error.message}`);
       });
   }
   ```

4. If there's no explicit Trendyol tracking in awb-service.ts, find the AWB creation success point and add:
   ```typescript
   // After AWB created successfully:
   // Non-blocking tracking sends to marketplaces
   if (order.source === "trendyol") {
     // Existing Trendyol code if any
   }
   if (order.source === "temu") {
     sendTrackingToTemu(order.id, createdAwb.awbNumber, "FAN COURIER")
       .then(result => {
         if (!result.success) {
           console.error(`[AWB] Temu tracking failed: ${result.error}`);
         }
       })
       .catch(console.error);
   }
   ```

Note: Use non-blocking pattern (fire-and-forget with .then/.catch) so AWB creation succeeds even if Temu API fails.
  </action>
  <verify>
Run: `npx tsc --noEmit src/lib/awb-service.ts`
Verify no TypeScript errors and import is present.
  </verify>
  <done>
AWB service imports sendTrackingToTemu.
Tracking sent to Temu after AWB creation for source='temu' orders.
Non-blocking pattern ensures AWB creation succeeds regardless of Temu API.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Export check: `grep "sendTrackingToTemu" src/lib/temu-awb.ts src/lib/awb-service.ts`
3. Integration test:
   - Create AWB for a Temu order (after full integration)
   - Check TemuOrder.trackingSentToTemu is true (or trackingSendError has message if API failed)
</verification>

<success_criteria>
- sendTrackingToTemu function works with TemuClient
- Carrier code mapping handles FanCourier
- AWB service calls sendTrackingToTemu for Temu orders
- Non-blocking pattern prevents AWB creation failures
- Error tracking via TemuOrder.trackingSendError
</success_criteria>

<output>
After completion, create `.planning/phases/07.7-temu-complete-integration/07.7-04-SUMMARY.md`
</output>
