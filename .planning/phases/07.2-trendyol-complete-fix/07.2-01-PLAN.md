---
phase: 07.2-trendyol-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/trendyol/batch-status/route.ts
  - src/app/(dashboard)/trendyol/publish/page.tsx
  - src/lib/trendyol-batch-status.ts
autonomous: true

must_haves:
  truths:
    - "User can see batch request status after publishing products"
    - "User can see detailed rejection reasons for failed products"
    - "Batch status auto-refreshes until complete"
  artifacts:
    - path: "src/app/api/trendyol/batch-status/route.ts"
      provides: "Batch status checking endpoint"
      exports: ["GET"]
    - path: "src/lib/trendyol-batch-status.ts"
      provides: "Batch status checking utilities"
      exports: ["checkBatchStatus", "parseBatchErrors"]
    - path: "src/app/(dashboard)/trendyol/publish/page.tsx"
      provides: "Batch status UI with error display"
      contains: "BatchStatusDialog"
  key_links:
    - from: "src/app/(dashboard)/trendyol/publish/page.tsx"
      to: "/api/trendyol/batch-status"
      via: "useQuery with refetchInterval"
      pattern: "fetch.*batch-status"
    - from: "src/app/api/trendyol/batch-status/route.ts"
      to: "TrendyolClient.getBatchRequestResult"
      via: "API call"
      pattern: "getBatchRequestResult"
---

<objective>
Add batch status verification UI to Trendyol publish page so users can see why products are rejected.

Purpose: Currently users publish products and see "batch ID returned" but never know if products were accepted or rejected by Trendyol. This causes confusion and wasted time.
Output: Batch status dialog showing processing state, success/failure per product, and detailed rejection reasons.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/trendyol.ts
@src/app/api/trendyol/route.ts
@src/app/(dashboard)/trendyol/publish/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batch status library and API endpoint</name>
  <files>
    src/lib/trendyol-batch-status.ts
    src/app/api/trendyol/batch-status/route.ts
  </files>
  <action>
Create src/lib/trendyol-batch-status.ts with:
- `checkBatchStatus(batchRequestId: string, storeId?: string)` - calls TrendyolClient.getBatchRequestResult
- `parseBatchErrors(batchResult)` - extracts human-readable error messages from Trendyol's response
- Types: BatchStatusResult, BatchItem, BatchError

Create src/app/api/trendyol/batch-status/route.ts:
- GET endpoint accepting `batchRequestId` query param
- Optional `storeId` param to determine which TrendyolStore credentials to use
- Returns { status: "IN_PROGRESS" | "COMPLETED" | "FAILED", items: BatchItem[], errors: BatchError[] }
- Use TrendyolStore credentials if storeId provided, fall back to Settings credentials

Use existing TrendyolClient.getBatchRequestResult() - do NOT duplicate the API call logic.
The endpoint already exists at /api/trendyol with action=batch-status but it needs to be more user-friendly.
  </action>
  <verify>
curl "http://localhost:3000/api/trendyol/batch-status?batchRequestId=test-123" returns JSON with status field
  </verify>
  <done>
API endpoint returns structured batch status with parsed error messages
  </done>
</task>

<task type="auto">
  <name>Task 2: Add BatchStatusDialog to publish page</name>
  <files>
    src/app/(dashboard)/trendyol/publish/page.tsx
  </files>
  <action>
Add to the publish page:

1. State for tracking active batch:
   - `activeBatchId: string | null`
   - `batchDialogOpen: boolean`

2. After successful publishMutation, set activeBatchId and open dialog

3. Create BatchStatusDialog component (inline or extracted):
   - Shows "Se proceseaza..." with spinner while IN_PROGRESS
   - Auto-refreshes every 3 seconds using useQuery with refetchInterval
   - Stops refreshing when status is COMPLETED or FAILED
   - Shows success count and failure count
   - Lists failed products with their rejection reasons in a scrollable list
   - Close button

4. Update the publish button click handler to open the dialog after publish

Use existing Dialog component from @/components/ui/dialog.
Use existing toast for quick notifications.
Use existing Badge component to show status (success=green, failed=red, processing=yellow).
  </action>
  <verify>
1. Run `npm run dev`
2. Go to /trendyol/publish
3. Verify BatchStatusDialog can be opened (may need to mock a batch ID)
4. TypeScript compiles without errors
  </verify>
  <done>
Publish page shows batch status dialog with auto-refresh and error display
  </done>
</task>

<task type="auto">
  <name>Task 3: Store batch ID in MasterProduct for tracking</name>
  <files>
    src/app/api/trendyol/route.ts
  </files>
  <action>
Update the publish products action in route.ts:

1. After successful batch submission, store the batchRequestId in the MasterProduct records:
   - Add field to Prisma update: `trendyolBatchId: batchRequestId`
   - This allows tracking which batch each product was part of

2. Return the batchRequestId in the API response so the UI can track it

Note: MasterProduct already has trendyolStatus field. We'll use trendyolBatchId for tracking.
If trendyolBatchId field doesn't exist on MasterProduct, just skip storing it and return batchRequestId in response only.

Check schema.prisma for existing fields before deciding approach.
  </action>
  <verify>
POST to /api/trendyol with action=publish returns { success: true, batchRequestId: "..." }
  </verify>
  <done>
Publish endpoint returns batchRequestId for UI to track batch status
  </done>
</task>

</tasks>

<verification>
1. Publish a product to Trendyol
2. See batch status dialog appear automatically
3. Wait for status to change from IN_PROGRESS to COMPLETED/FAILED
4. If product rejected, see clear error message explaining why
</verification>

<success_criteria>
- Batch status dialog shows after publishing
- Auto-refresh works (3 second interval)
- Success/failure counts displayed
- Rejection reasons visible and readable
- Dialog closes cleanly
- No console errors
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-trendyol-complete-fix/07.2-01-SUMMARY.md`
</output>
