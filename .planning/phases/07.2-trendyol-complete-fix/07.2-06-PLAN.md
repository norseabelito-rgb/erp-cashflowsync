---
phase: 07.2-trendyol-fix
plan: 06
type: execute
wave: 2
depends_on: ["07.2-02"]
files_modified:
  - src/app/api/trendyol/category-suggest/route.ts
  - src/lib/trendyol-category-ai.ts
  - src/app/(dashboard)/trendyol/mapping/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can get AI-based category suggestions for a product"
    - "Suggestions show confidence score and reasoning"
    - "User can accept suggestion with one click"
  artifacts:
    - path: "src/app/api/trendyol/category-suggest/route.ts"
      provides: "AI category suggestion endpoint"
      exports: ["POST"]
    - path: "src/lib/trendyol-category-ai.ts"
      provides: "AI category matching logic"
      exports: ["suggestTrendyolCategory"]
    - path: "src/app/(dashboard)/trendyol/mapping/page.tsx"
      provides: "Suggest button and suggestion UI"
      contains: "SuggestCategoryButton"
  key_links:
    - from: "src/app/(dashboard)/trendyol/mapping/page.tsx"
      to: "/api/trendyol/category-suggest"
      via: "fetch POST"
      pattern: "category-suggest"
    - from: "src/lib/trendyol-category-ai.ts"
      to: "@anthropic-ai/sdk"
      via: "AI completion"
      pattern: "getAnthropicClient"
---

<objective>
Add AI-based category suggestion to reduce manual mapping overhead.

Purpose: Users spend significant time finding the right Trendyol category for products. AI can suggest likely matches based on product title and description.
Output: "Sugereaza Categorie" button that uses Claude to suggest category with confidence score.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-trendyol-complete-fix/07.2-02-SUMMARY.md
@src/lib/ai.ts
@src/app/(dashboard)/trendyol/mapping/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI category suggestion library</name>
  <files>
    src/lib/trendyol-category-ai.ts
  </files>
  <action>
Create src/lib/trendyol-category-ai.ts following the pattern from src/lib/ai.ts:

```typescript
import { getAnthropicClient } from "@/lib/ai";

interface CategorySuggestion {
  categoryId: number;
  categoryName: string;
  categoryPath: string;
  confidence: number;  // 0-100
  reasoning: string;
}

export async function suggestTrendyolCategory(
  productTitle: string,
  productDescription: string | null,
  availableCategories: Array<{ id: number; name: string; fullPath: string }>
): Promise<CategorySuggestion | null> {
  const client = await getAnthropicClient();

  // Limit categories to prevent context overflow - send top 500 most relevant
  const categoriesForPrompt = availableCategories.slice(0, 500);

  const systemPrompt = `Esti un expert in clasificarea produselor pentru marketplace-uri.
Analizezi titlul si descrierea unui produs si gasesti categoria Trendyol cea mai potrivita.

IMPORTANT:
- Raspunde DOAR in format JSON valid
- categoryId trebuie sa fie din lista de categorii disponibile
- confidence intre 0-100 (100 = sigur, sub 50 = incert)
- reasoning explicand DE CE aceasta categorie`;

  const userPrompt = `Gaseste categoria Trendyol potrivita pentru:

Titlu: ${productTitle}
Descriere: ${productDescription || "(fara descriere)"}

Categorii disponibile (id | cale):
${categoriesForPrompt.map(c => `${c.id} | ${c.fullPath}`).join("\n")}

Raspunde in JSON:
{
  "categoryId": <number>,
  "categoryName": "<name>",
  "categoryPath": "<full path>",
  "confidence": <0-100>,
  "reasoning": "<explicatie>"
}`;

  try {
    const response = await client.messages.create({
      model: "claude-sonnet-4-20250514",  // Use fast model for suggestions
      max_tokens: 500,
      system: systemPrompt,
      messages: [{ role: "user", content: userPrompt }],
    });

    const content = response.content[0];
    if (content.type !== "text") return null;

    const parsed = JSON.parse(content.text);
    return {
      categoryId: parsed.categoryId,
      categoryName: parsed.categoryName,
      categoryPath: parsed.categoryPath,
      confidence: parsed.confidence,
      reasoning: parsed.reasoning,
    };
  } catch (error: any) {
    console.error("[Trendyol AI] Category suggestion failed:", error.message);
    return null;
  }
}
```

Use getAnthropicClient from existing ai.ts - don't create new client initialization.
  </action>
  <verify>
TypeScript compiles: npx tsc --noEmit
grep "suggestTrendyolCategory" src/lib/trendyol-category-ai.ts
  </verify>
  <done>
AI category suggestion library created using existing Anthropic patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Create category suggestion API endpoint</name>
  <files>
    src/app/api/trendyol/category-suggest/route.ts
  </files>
  <action>
Create src/app/api/trendyol/category-suggest/route.ts:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import prisma from "@/lib/db";
import { hasPermission } from "@/lib/permissions";
import { suggestTrendyolCategory } from "@/lib/trendyol-category-ai";
import { TrendyolClient, flattenCategories } from "@/lib/trendyol";

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: "Neautorizat" }, { status: 401 });
    }

    const canEdit = await hasPermission(session.user.id, "trendyol.edit");
    if (!canEdit) {
      return NextResponse.json({ error: "Nu ai permisiunea necesara" }, { status: 403 });
    }

    const { productId } = await request.json();

    if (!productId) {
      return NextResponse.json({ error: "productId este obligatoriu" }, { status: 400 });
    }

    // Load product
    const product = await prisma.masterProduct.findUnique({
      where: { id: productId },
    });

    if (!product) {
      return NextResponse.json({ error: "Produs negasit" }, { status: 404 });
    }

    // Load Trendyol categories
    const settings = await prisma.settings.findUnique({ where: { id: "default" } });
    const client = new TrendyolClient({
      supplierId: "",
      apiKey: "",
      apiSecret: "",
    });

    const categoriesResult = await client.getCategories(settings?.trendyolStoreFrontCode || undefined);
    if (!categoriesResult.success) {
      return NextResponse.json({ error: "Nu s-au putut incarca categoriile" }, { status: 500 });
    }

    const flatCategories = flattenCategories(categoriesResult.data || []);

    // Get AI suggestion
    const suggestion = await suggestTrendyolCategory(
      product.title,
      product.description,
      flatCategories.map(c => ({
        id: c.id,
        name: c.name,
        fullPath: c.fullPath || c.name,
      }))
    );

    if (!suggestion) {
      return NextResponse.json({
        success: false,
        error: "Nu s-a putut genera sugestie. Verifica cheia API Claude in Setari.",
      });
    }

    return NextResponse.json({
      success: true,
      suggestion,
    });
  } catch (error: any) {
    console.error("[Trendyol] Category suggest error:", error);
    return NextResponse.json({
      error: error.message || "Eroare la generarea sugestiei",
    }, { status: 500 });
  }
}
```
  </action>
  <verify>
curl -X POST "http://localhost:3000/api/trendyol/category-suggest" -d '{"productId":"test"}' returns JSON
  </verify>
  <done>
API endpoint accepts productId and returns AI category suggestion
  </done>
</task>

<task type="auto">
  <name>Task 3: Add suggestion UI to mapping page</name>
  <files>
    src/app/(dashboard)/trendyol/mapping/page.tsx
  </files>
  <action>
Add category suggestion feature to the mapping page:

1. Add state for suggestion:
```typescript
const [suggestion, setSuggestion] = useState<{
  categoryId: number;
  categoryName: string;
  categoryPath: string;
  confidence: number;
  reasoning: string;
} | null>(null);
const [suggesting, setSuggesting] = useState(false);
```

2. Add mutation for getting suggestion:
```typescript
const suggestMutation = useMutation({
  mutationFn: async (productId: string) => {
    const res = await fetch("/api/trendyol/category-suggest", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ productId }),
    });
    return res.json();
  },
  onSuccess: (data) => {
    if (data.success && data.suggestion) {
      setSuggestion(data.suggestion);
      toast({
        title: "Sugestie generata",
        description: `${data.suggestion.categoryName} (${data.suggestion.confidence}% incredere)`,
      });
    } else {
      toast({
        title: "Eroare",
        description: data.error || "Nu s-a putut genera sugestia",
        variant: "destructive",
      });
    }
  },
});
```

3. Add "Sugereaza Categorie" button next to category selector:
```tsx
<Button
  variant="outline"
  size="sm"
  onClick={() => suggestMutation.mutate(selectedProduct.id)}
  disabled={suggestMutation.isPending || !selectedProduct}
>
  {suggestMutation.isPending ? (
    <Loader2 className="h-4 w-4 animate-spin mr-2" />
  ) : (
    <Sparkles className="h-4 w-4 mr-2" />
  )}
  Sugereaza Categorie
</Button>
```

4. Show suggestion when available:
```tsx
{suggestion && (
  <Card className="mt-4 border-primary/50">
    <CardHeader className="pb-2">
      <CardTitle className="text-sm flex items-center gap-2">
        <Sparkles className="h-4 w-4" />
        Sugestie AI
        <Badge variant={suggestion.confidence >= 70 ? "default" : "secondary"}>
          {suggestion.confidence}% incredere
        </Badge>
      </CardTitle>
    </CardHeader>
    <CardContent>
      <p className="font-medium">{suggestion.categoryPath}</p>
      <p className="text-sm text-muted-foreground mt-1">{suggestion.reasoning}</p>
      <Button
        className="mt-3"
        size="sm"
        onClick={() => {
          // Apply the suggestion - set category ID
          handleCategorySelect(suggestion.categoryId);
          setSuggestion(null);
        }}
      >
        Aplica Sugestia
      </Button>
    </CardContent>
  </Card>
)}
```

Import Sparkles from lucide-react.
  </action>
  <verify>
1. npm run dev
2. Go to /trendyol/mapping
3. Select a product
4. See "Sugereaza Categorie" button
5. Click button (requires AI API key configured)
6. TypeScript compiles without errors
  </verify>
  <done>
Mapping page has AI suggestion button with confidence display and one-click apply
  </done>
</task>

</tasks>

<verification>
1. Go to /trendyol/mapping
2. Select a product without category
3. Click "Sugereaza Categorie"
4. Wait for AI suggestion (may take 2-5 seconds)
5. See suggestion with confidence and reasoning
6. Click "Aplica Sugestia"
7. Category is applied to product
</verification>

<success_criteria>
- AI suggestion library created
- API endpoint returns suggestions with confidence
- UI shows suggestion button
- Suggestion displays category path, confidence, reasoning
- One-click apply sets the category
- Graceful error handling if AI API not configured
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-trendyol-complete-fix/07.2-06-SUMMARY.md`
</output>
