---
phase: 07.2-trendyol-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/trendyol/attributes/route.ts
  - src/app/(dashboard)/trendyol/mapping/page.tsx
  - src/app/api/trendyol/route.ts
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "User can select valid attribute values for each required category attribute"
    - "Attribute selections are saved per product"
    - "Products are published with real attribute values (not placeholders)"
  artifacts:
    - path: "src/app/api/trendyol/attributes/route.ts"
      provides: "Attribute value CRUD for products"
      exports: ["GET", "POST"]
    - path: "src/app/(dashboard)/trendyol/mapping/page.tsx"
      provides: "UI for mapping category attributes"
      contains: "AttributeSelector"
    - path: "prisma/schema.prisma"
      provides: "trendyolAttributeValues field on MasterProduct"
      contains: "trendyolAttributeValues"
  key_links:
    - from: "src/app/(dashboard)/trendyol/mapping/page.tsx"
      to: "/api/trendyol/attributes"
      via: "fetch POST to save mappings"
      pattern: "fetch.*attributes"
    - from: "src/app/api/trendyol/route.ts"
      to: "product.trendyolAttributeValues"
      via: "read saved attributes"
      pattern: "trendyolAttributeValues"
---

<objective>
Fix category attribute mapping so products can be published with valid attribute values.

Purpose: Current code uses `attributeValues?.[0]?.id` as placeholder which Trendyol rejects. Users need to explicitly select valid attribute values for their products.
Output: Attribute mapping UI in the mapping page, persisted selections, and correct attribute usage during publish.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-trendyol-complete-fix/07.2-RESEARCH.md
@src/lib/trendyol.ts
@src/app/api/trendyol/route.ts
@src/app/(dashboard)/trendyol/mapping/page.tsx
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trendyolAttributeValues field to MasterProduct</name>
  <files>
    prisma/schema.prisma
  </files>
  <action>
Add to the MasterProduct model:
```prisma
trendyolAttributeValues Json?  @map("trendyol_attribute_values")
// Format: { [attributeId: number]: { attributeValueId?: number, customValue?: string } }
```

This stores the user's attribute selections per product. Using JSON for flexibility - no need for a separate mapping table since attributes are tied to category and rarely change.

After editing schema:
- Run `npx prisma generate` to update the client
- Do NOT run db push - we'll handle migration separately

Note: If the field already exists, skip this task. Check schema first.
  </action>
  <verify>
npx prisma generate succeeds without errors
grep "trendyolAttributeValues" prisma/schema.prisma returns the field
  </verify>
  <done>
MasterProduct model has trendyolAttributeValues Json field
  </done>
</task>

<task type="auto">
  <name>Task 2: Create attribute mapping API endpoint</name>
  <files>
    src/app/api/trendyol/attributes/route.ts
  </files>
  <action>
Create src/app/api/trendyol/attributes/route.ts:

GET handler:
- Query param: productId
- Returns product's current trendyolAttributeValues and the category's required attributes
- If product has trendyolCategoryId, fetch category attributes from Trendyol API
- Merge saved values with required attributes for UI display

POST handler:
- Body: { productId, attributeValues: { [attrId]: { attributeValueId?, customValue? } } }
- Validate that all required attributes have values
- Update MasterProduct.trendyolAttributeValues
- Return success with updated product

Use existing hasPermission for "trendyol.edit" permission check.
Use existing TrendyolClient.getCategoryAttributes() to fetch attribute definitions.
  </action>
  <verify>
curl -X POST "http://localhost:3000/api/trendyol/attributes" -d '{"productId":"test","attributeValues":{}}' returns JSON response
  </verify>
  <done>
API endpoint saves and retrieves attribute mappings per product
  </done>
</task>

<task type="auto">
  <name>Task 3: Add attribute mapping UI to mapping page</name>
  <files>
    src/app/(dashboard)/trendyol/mapping/page.tsx
  </files>
  <action>
Enhance the mapping page to show attribute mapping for selected products:

1. When a product is selected (or when mapping category), show required attributes section:
   - Title: "Atribute Obligatorii"
   - List each required attribute with:
     - Label (attribute name)
     - Select dropdown with attributeValues options
     - "Custom value" input if attribute.allowCustom is true

2. Add "Salveaza Atribute" button that:
   - POSTs to /api/trendyol/attributes
   - Shows toast on success/failure

3. Display validation state:
   - Green check if all required attributes mapped
   - Red X if missing required attributes
   - Show which attributes are missing

Use existing Select component from @/components/ui/select.
Use existing Card component for the attributes section.
Use existing toast for feedback.

The mapping page already handles category selection - add attributes as a subsection after category is mapped.
  </action>
  <verify>
1. npm run dev
2. Go to /trendyol/mapping
3. Select a product with a mapped category
4. See required attributes section appear
5. TypeScript compiles without errors
  </verify>
  <done>
Mapping page shows attribute selectors for required category attributes
  </done>
</task>

<task type="auto">
  <name>Task 4: Use saved attributes in publish flow</name>
  <files>
    src/app/api/trendyol/route.ts
  </files>
  <action>
Update the publish products action (search for "action === 'publish'"):

1. Find the current attribute mapping code (around line 565-569):
```typescript
// OLD CODE - REMOVE THIS:
const attributes = requiredAttrs.map(attr => ({
  attributeId: attr.attribute?.id || attr.id,
  attributeValueId: attr.attributeValues?.[0]?.id || null,
})).filter(a => a.attributeValueId);
```

2. Replace with code that uses saved trendyolAttributeValues:
```typescript
// NEW CODE:
const savedAttrs = product.trendyolAttributeValues as Record<string, { attributeValueId?: number; customValue?: string }> || {};
const attributes = requiredAttrs.map(attr => {
  const attrId = attr.attribute?.id || attr.id;
  const saved = savedAttrs[attrId.toString()];
  if (!saved) return null;
  return {
    attributeId: attrId,
    attributeValueId: saved.attributeValueId || undefined,
    customAttributeValue: saved.customValue || undefined,
  };
}).filter(Boolean);
```

3. Add validation before publish:
   - If any required attribute is missing, return error with list of missing attributes
   - Don't publish products with incomplete attributes

4. Return clear error message: "Produsul X nu are atributele obligatorii configurate: [list]"
  </action>
  <verify>
1. Try to publish a product without attributes mapped
2. See clear error message about missing attributes
3. Map the attributes in the mapping page
4. Publish again - should succeed (or fail for other reasons)
  </verify>
  <done>
Publish flow uses saved attribute values instead of placeholders
  </done>
</task>

</tasks>

<verification>
1. Go to /trendyol/mapping
2. Select a product with mapped category
3. See required attributes section
4. Select values for each required attribute
5. Save attributes
6. Go to /trendyol/publish
7. Publish the product
8. No "Invalid attribute value" errors from Trendyol
</verification>

<success_criteria>
- Schema has trendyolAttributeValues field
- Attribute mapping UI shows all required attributes
- User can select values from dropdown
- Selections persist after save
- Publish uses saved values (not placeholders)
- Missing attributes show clear error before publish
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-trendyol-complete-fix/07.2-02-SUMMARY.md`
</output>
