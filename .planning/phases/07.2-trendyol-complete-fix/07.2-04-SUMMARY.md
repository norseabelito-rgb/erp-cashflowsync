---
phase: 07.2-trendyol-fix
plan: 04
subsystem: trendyol-integration
tags: [trendyol, order-sync, multi-company, billing]

dependency_graph:
  requires: [07.2-01, 07.2-02, 07.2-03]
  provides: [multi-company-order-sync, trendyolstore-billing-resolution]
  affects: [trendyol-webhook, order-processing]

tech_stack:
  added: []
  patterns: [TrendyolStore-based-company-resolution]

key_files:
  created: []
  modified:
    - src/lib/trendyol-order-sync.ts
    - src/app/api/trendyol/webhook/[storeId]/route.ts

decisions:
  - id: "07.2-04-01"
    choice: "TrendyolStoreForSync type exported for cross-module use"
    reason: "Webhook handler needs same type as order sync"
  - id: "07.2-04-02"
    choice: "trendyolStoreId set on TrendyolOrder during sync"
    reason: "Ensures all orders are linked to their TrendyolStore for multi-store support"
  - id: "07.2-04-03"
    choice: "Virtual store company updated if TrendyolStore company changes"
    reason: "Keeps virtual Store in sync with TrendyolStore configuration"

metrics:
  duration: "~5 minutes"
  completed: "2026-02-01"
---

# Phase 07.2 Plan 04: Fix Order Sync to Use TrendyolStore.companyId

Multi-company order sync with TrendyolStore-based billing company resolution.

## One-Liner

Refactored order sync to use TrendyolStore.companyId instead of Settings.trendyolCompanyId for proper multi-store billing.

## What Was Done

### Task 1: Refactor order sync to use TrendyolStore

**Files modified:**
- `src/lib/trendyol-order-sync.ts`

**Changes:**
1. Added `TrendyolStoreForSync` type export for type-safe store data
2. Renamed `findOrCreateTrendyolStore` to `findOrCreateTrendyolVirtualStore`
3. Changed function signature from `Settings` to `TrendyolStoreForSync`
4. Virtual store creation now uses `trendyolStore.companyId`
5. Virtual store updates company if it changed
6. Order creation uses `trendyolStore.companyId` for `billingCompanyId`
7. Updated `syncAllTrendyolOrdersToMain` to include TrendyolStore in query
8. Removed all `(settings as any).trendyolCompanyId` references

**Commit:** `dfbeef7` feat(07.2-04): refactor order sync to use TrendyolStore for company

### Task 2: Update webhook to pass TrendyolStore to sync

**Files modified:**
- `src/app/api/trendyol/webhook/[storeId]/route.ts`

**Changes:**
1. Import `TrendyolStoreForSync` type
2. Update `processWebhookEvent` to accept `TrendyolStoreForSync` type
3. Pass `store` object directly to `syncTrendyolOrderToMainOrder`
4. Remove Settings dependency from OrderCreated handler
5. Log company info in sync success message

**Commit:** `702bf97` feat(07.2-04): update webhook to pass TrendyolStore to sync

### Task 3: Find and update ALL callers

**Callers found:**
1. **Definition:** `src/lib/trendyol-order-sync.ts:167` - function definition
2. **Internal caller:** `src/lib/trendyol-order-sync.ts:336` - `syncAllTrendyolOrdersToMain()` (updated in Task 1)
3. **Webhook caller:** `src/app/api/trendyol/webhook/[storeId]/route.ts:218` (updated in Task 2)

**Result:** All callers updated to use TrendyolStore instead of Settings.

## Verification Results

| Criterion | Status |
|-----------|--------|
| syncTrendyolOrderToMainOrder accepts TrendyolStore parameter | PASS |
| No references to Settings.trendyolCompanyId in sync flow | PASS |
| Order.billingCompanyId set from TrendyolStore.companyId | PASS |
| Virtual Store.companyId matches TrendyolStore.companyId | PASS |
| Webhook passes TrendyolStore to sync | PASS |
| syncAllTrendyolOrdersToMain passes TrendyolStore | PASS |

## Deviations from Plan

None - plan executed exactly as written.

## Key Patterns Established

### TrendyolStore-based Company Resolution
```typescript
// OLD (deprecated):
const companyId = (settings as any).trendyolCompanyId;

// NEW (multi-company):
billingCompanyId: trendyolStore.companyId,
```

### Type-safe Store Data
```typescript
export type TrendyolStoreForSync = {
  id: string;
  name: string;
  supplierId: string;
  companyId: string;
  storeFrontCode: string;
  company: { id: string; name: string } | null;
};
```

## Impact

1. **Multi-company Support:** Orders now correctly use the TrendyolStore's company for billing
2. **Virtual Store Sync:** Virtual stores stay in sync with TrendyolStore company configuration
3. **Type Safety:** `TrendyolStoreForSync` type ensures consistent data across modules
4. **Audit Trail:** Logs now include company info for debugging

## Next Phase Readiness

- Multi-company order sync working
- Ready for testing with multiple TrendyolStores
- No blockers identified
