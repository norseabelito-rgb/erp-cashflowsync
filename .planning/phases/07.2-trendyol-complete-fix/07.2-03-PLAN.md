---
phase: 07.2-trendyol-fix
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - src/lib/invoice-service.ts
  - src/lib/trendyol-order-sync.ts
autonomous: true

must_haves:
  truths:
    - "Trendyol orders use TrendyolStore.invoiceSeriesName for invoice generation"
    - "Each TrendyolStore can have its own invoice series"
    - "Invoice series resolution logs which source was used"
  artifacts:
    - path: "src/lib/invoice-service.ts"
      provides: "Invoice series override for Trendyol orders"
      contains: "trendyol_store"
    - path: "src/lib/trendyol-order-sync.ts"
      provides: "Links TrendyolStore to synced orders"
      contains: "trendyolStoreId"
  key_links:
    - from: "src/lib/invoice-service.ts"
      to: "prisma.trendyolOrder"
      via: "lookup by orderId"
      pattern: "trendyolOrder.*include.*trendyolStore"
    - from: "src/lib/invoice-service.ts"
      to: "TrendyolStore.invoiceSeriesName"
      via: "series override"
      pattern: "invoiceSeriesName"
---

<objective>
Integrate TrendyolStore.invoiceSeriesName into invoice generation flow.

Purpose: TrendyolStore model has invoiceSeriesName field but it's never used. Each Trendyol account (store) should be able to have its own invoice series for proper multi-company invoicing.
Output: Invoice service checks for TrendyolStore invoice series before falling back to standard resolution.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-trendyol-complete-fix/07.2-RESEARCH.md
@src/lib/invoice-service.ts
@src/lib/trendyol-order-sync.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TrendyolStore invoice series resolution to invoice-service.ts</name>
  <files>
    src/lib/invoice-service.ts
  </files>
  <action>
Modify issueInvoiceForOrder() to check for TrendyolStore invoice series:

1. Find the series resolution section (around line 399-431, after comment "// 6. DeterminÄƒm seria de facturare")

2. Add a new priority BEFORE the existing Priority 1 (oblioSeriesName din store):

```typescript
// Priority 0: TrendyolStore invoice series (for Trendyol orders)
if (order.source === "trendyol") {
  const trendyolOrder = await prisma.trendyolOrder.findFirst({
    where: { orderId: order.id },
    include: { trendyolStore: true },
  });

  if (trendyolOrder?.trendyolStore?.invoiceSeriesName) {
    oblioSeriesName = trendyolOrder.trendyolStore.invoiceSeriesName;
    seriesSource = "trendyol_store" as any; // Add to union type
    useOblioNumbering = true;
    console.log(`[Invoice] Folosesc seria TrendyolStore: ${oblioSeriesName} (${trendyolOrder.trendyolStore.name})`);
  }
}
```

3. Update the seriesSource type (find the type definition around line 406):
```typescript
let seriesSource: "oblio_direct" | "store" | "company_default" | "trendyol_store" = "company_default";
```

4. Update the logging at line ~489 to handle the new source:
```typescript
console.log(`Sursa serie: ${seriesSource}${seriesSource === "trendyol_store" ? ` (${trendyolOrder?.trendyolStore?.name})` : ""}`);
```

This ensures Trendyol orders use their TrendyolStore's configured series, while other orders use the existing logic.
  </action>
  <verify>
TypeScript compiles without errors: `npx tsc --noEmit`
grep "trendyol_store" src/lib/invoice-service.ts returns matches
  </verify>
  <done>
Invoice service checks TrendyolStore.invoiceSeriesName for Trendyol orders
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure TrendyolStore is linked during order sync</name>
  <files>
    src/lib/trendyol-order-sync.ts
  </files>
  <action>
Verify and fix the order sync to properly link TrendyolStore:

1. Check if syncTrendyolOrderToMainOrder properly sets trendyolStoreId on TrendyolOrder

2. The function currently receives Settings but TrendyolOrder needs trendyolStoreId.
   Update to accept optional TrendyolStore or storeId:

```typescript
export async function syncTrendyolOrderToMainOrder(
  trendyolOrder: TrendyolOrderWithItems,
  settings: Settings,
  trendyolStoreId?: string  // NEW: Optional store ID
): Promise<Order> {
```

3. When creating/updating TrendyolOrder, set trendyolStoreId if provided:
```typescript
await prisma.trendyolOrder.update({
  where: { id: trendyolOrder.id },
  data: {
    orderId: order.id,
    trendyolStoreId: trendyolStoreId || undefined,
  },
});
```

4. Check the webhook handler (src/app/api/trendyol/webhook/[storeId]/route.ts) to ensure it passes the storeId when calling sync.

If the webhook already extracts storeId from the URL, verify it's being passed through.
  </action>
  <verify>
1. grep "trendyolStoreId" src/lib/trendyol-order-sync.ts returns matches
2. Check that TrendyolOrder records have trendyolStoreId populated
  </verify>
  <done>
Order sync links TrendyolOrder to TrendyolStore via trendyolStoreId
  </done>
</task>

<task type="auto">
  <name>Task 3: Update webhook to pass storeId to sync</name>
  <files>
    src/app/api/trendyol/webhook/[storeId]/route.ts
  </files>
  <action>
Ensure the webhook handler passes storeId when syncing orders:

1. The webhook receives storeId from the URL path ([storeId])
2. Find where it calls syncTrendyolOrderToMainOrder
3. Pass the storeId as the third parameter

Example update:
```typescript
// Before (if exists):
await syncTrendyolOrderToMainOrder(trendyolOrder, settings);

// After:
await syncTrendyolOrderToMainOrder(trendyolOrder, settings, storeId);
```

Also ensure TrendyolOrder is created with trendyolStoreId in the webhook handler if it creates orders directly before syncing.

Check the webhook handler logic - it may already handle this correctly based on Phase 7.1 implementation.
  </action>
  <verify>
grep "syncTrendyolOrderToMainOrder.*storeId" in webhook route
Or verify TrendyolOrder.trendyolStoreId is set in the create/update logic
  </verify>
  <done>
Webhook passes storeId to sync function so TrendyolStore is linked to orders
  </done>
</task>

</tasks>

<verification>
1. Configure a TrendyolStore with invoiceSeriesName
2. Create or sync a Trendyol order
3. Generate invoice for the order
4. Verify console logs show "Folosesc seria TrendyolStore: [series]"
5. Invoice is created with the TrendyolStore's series (not the default company series)
</verification>

<success_criteria>
- Invoice service has "trendyol_store" series source option
- Trendyol orders lookup their TrendyolStore for invoice series
- Console logging shows which series source was used
- TrendyolOrder.trendyolStoreId is populated during sync
- Invoice generation works with TrendyolStore series
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-trendyol-complete-fix/07.2-03-SUMMARY.md`
</output>
