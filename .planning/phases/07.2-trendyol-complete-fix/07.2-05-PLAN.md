---
phase: 07.2-trendyol-fix
plan: 05
type: execute
wave: 2
depends_on: ["07.2-03", "07.2-04"]
files_modified:
  - src/app/api/orders/process-all/route.ts
  - src/lib/trendyol-invoice.ts
  - src/lib/trendyol-awb.ts
autonomous: false

must_haves:
  truths:
    - "Bulk process generates invoices for Trendyol orders using correct company"
    - "Bulk process generates AWBs for Trendyol orders"
    - "Invoice and AWB are sent back to Trendyol after generation"
  artifacts:
    - path: "src/app/api/orders/process-all/route.ts"
      provides: "Bulk process with Trendyol support"
      contains: "trendyolOrder"
    - path: "src/lib/trendyol-invoice.ts"
      provides: "Invoice send to Trendyol"
      contains: "sendInvoiceToTrendyol"
    - path: "src/lib/trendyol-awb.ts"
      provides: "AWB tracking send to Trendyol"
      contains: "sendTrackingToTrendyol"
  key_links:
    - from: "src/app/api/orders/process-all/route.ts"
      to: "sendInvoiceToTrendyol"
      via: "post-invoice hook"
      pattern: "sendInvoiceToTrendyol"
    - from: "src/app/api/orders/process-all/route.ts"
      to: "sendTrackingToTrendyol"
      via: "post-AWB hook"
      pattern: "sendTrackingToTrendyol"
---

<objective>
Verify and fix bulk process flow for Trendyol orders.

Purpose: Bulk process (factura + AWB) should work seamlessly for Trendyol orders, using correct company/series and sending data back to Trendyol.
Output: End-to-end bulk processing works for mixed Shopify + Trendyol order selections.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-trendyol-complete-fix/07.2-03-SUMMARY.md
@.planning/phases/07.2-trendyol-complete-fix/07.2-04-SUMMARY.md
@src/app/api/orders/process-all/route.ts
@src/lib/trendyol-invoice.ts
@src/lib/trendyol-awb.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify invoice flow for Trendyol orders</name>
  <files>
    src/app/api/orders/process-all/route.ts
    src/lib/trendyol-invoice.ts
  </files>
  <action>
Verify the bulk process flow properly handles Trendyol orders:

1. Check process-all/route.ts:
   - Confirm it loads trendyolOrder relation (it does based on earlier read)
   - After invoice generation success, check if it calls sendInvoiceToTrendyol

2. Check src/lib/trendyol-invoice.ts exists and has sendInvoiceToTrendyol function

3. If sendInvoiceToTrendyol is not called after invoice success in process-all:
```typescript
// After successful invoice generation
if (invoiceResult.success && order.source === "trendyol" && order.trendyolOrder) {
  try {
    const { sendInvoiceToTrendyol } = await import("@/lib/trendyol-invoice");
    await sendInvoiceToTrendyol(order.trendyolOrder, invoiceResult);
    console.log(`[Process All] Invoice sent to Trendyol for order ${order.shopifyOrderNumber}`);
  } catch (trendyolError: any) {
    // Non-blocking - log but don't fail the process
    console.warn(`[Process All] Failed to send invoice to Trendyol: ${trendyolError.message}`);
  }
}
```

4. Ensure the invoice service uses TrendyolStore.invoiceSeriesName (verified by Plan 03)
  </action>
  <verify>
grep "sendInvoiceToTrendyol" src/app/api/orders/process-all/route.ts returns matches
grep "trendyolOrder" src/app/api/orders/process-all/route.ts shows it's being used
  </verify>
  <done>
Bulk process calls sendInvoiceToTrendyol after successful invoice generation
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify AWB flow for Trendyol orders</name>
  <files>
    src/app/api/orders/process-all/route.ts
    src/lib/trendyol-awb.ts
  </files>
  <action>
Verify AWB generation and Trendyol tracking sync:

1. Check process-all/route.ts:
   - After AWB generation success, check if it calls sendTrackingToTrendyol

2. Check src/lib/trendyol-awb.ts exists and has sendTrackingToTrendyol function

3. If sendTrackingToTrendyol is not called after AWB success in process-all:
```typescript
// After successful AWB generation
if (awbResult.success && order.source === "trendyol" && order.trendyolOrder) {
  try {
    const { sendTrackingToTrendyol } = await import("@/lib/trendyol-awb");
    await sendTrackingToTrendyol(order.trendyolOrder, awbResult.awbNumber);
    console.log(`[Process All] Tracking sent to Trendyol for order ${order.shopifyOrderNumber}`);
  } catch (trendyolError: any) {
    // Non-blocking - log but don't fail the process
    console.warn(`[Process All] Failed to send tracking to Trendyol: ${trendyolError.message}`);
  }
}
```

4. Ensure tracking update uses TrendyolClient.updateTrackingNumber with correct cargo provider
  </action>
  <verify>
grep "sendTrackingToTrendyol" src/app/api/orders/process-all/route.ts returns matches
grep "trendyolOrder" src/lib/trendyol-awb.ts shows it handles Trendyol orders
  </verify>
  <done>
Bulk process calls sendTrackingToTrendyol after successful AWB generation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
End-to-end bulk process flow for Trendyol orders:
1. Invoice generated using TrendyolStore.invoiceSeriesName
2. Invoice sent to Trendyol
3. AWB generated using TrendyolStore's company credentials
4. Tracking number sent to Trendyol
  </what-built>
  <how-to-verify>
1. Go to /orders page
2. Select a Trendyol order (should show source indicator)
3. Click "Proceseaza" (bulk process)
4. Verify:
   - Invoice generated with correct series (check console for "Folosesc seria TrendyolStore")
   - AWB generated successfully
   - No errors in console
   - Order status updates
5. Optional: Check Trendyol seller dashboard to confirm invoice link and tracking received

If you don't have a Trendyol order available:
- Create a test order by manually inserting into TrendyolOrder table
- Or mock the order.source === "trendyol" check
  </how-to-verify>
  <resume-signal>Type "approved" if bulk process works, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Select Trendyol order in bulk process
2. Process completes successfully
3. Invoice uses TrendyolStore series
4. AWB generated with correct company credentials
5. Trendyol receives invoice link and tracking (check logs)
</verification>

<success_criteria>
- Bulk process handles Trendyol orders without errors
- Invoice uses correct series from TrendyolStore
- AWB uses correct company credentials
- sendInvoiceToTrendyol called (non-blocking)
- sendTrackingToTrendyol called (non-blocking)
- Mixed Shopify+Trendyol selections process correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-trendyol-complete-fix/07.2-05-SUMMARY.md`
</output>
