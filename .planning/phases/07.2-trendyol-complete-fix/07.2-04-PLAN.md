---
phase: 07.2-trendyol-fix
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/lib/trendyol-order-sync.ts
  - src/app/api/trendyol/webhook/[storeId]/route.ts
autonomous: true

must_haves:
  truths:
    - "Trendyol orders use TrendyolStore.companyId for billing company"
    - "Order.billingCompanyId matches TrendyolStore.companyId (not Settings.trendyolCompanyId)"
    - "Store resolution uses TrendyolStore instead of creating virtual stores from Settings"
  artifacts:
    - path: "src/lib/trendyol-order-sync.ts"
      provides: "Multi-company order sync"
      contains: "trendyolStore.companyId"
    - path: "src/app/api/trendyol/webhook/[storeId]/route.ts"
      provides: "Webhook with TrendyolStore lookup"
      contains: "trendyolStore"
  key_links:
    - from: "src/lib/trendyol-order-sync.ts"
      to: "TrendyolStore.companyId"
      via: "company resolution"
      pattern: "trendyolStore\\.companyId"
    - from: "src/lib/trendyol-order-sync.ts"
      to: "Order.billingCompanyId"
      via: "company assignment"
      pattern: "billingCompanyId.*companyId"
---

<objective>
Fix order sync to use TrendyolStore.companyId instead of Settings.trendyolCompanyId.

Purpose: Current code uses global Settings.trendyolCompanyId which breaks multi-company support. Each TrendyolStore should determine the billing company for its orders.
Output: Order sync properly uses TrendyolStore.companyId for company resolution.
</objective>

<execution_context>
@/Users/stefanpanaite/.claude/get-shit-done/workflows/execute-plan.md
@/Users/stefanpanaite/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-trendyol-complete-fix/07.2-RESEARCH.md
@src/lib/trendyol-order-sync.ts
@src/app/api/trendyol/webhook/[storeId]/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor order sync to use TrendyolStore</name>
  <files>
    src/lib/trendyol-order-sync.ts
  </files>
  <action>
Refactor syncTrendyolOrderToMainOrder to use TrendyolStore instead of Settings:

1. Change the function signature to accept TrendyolStore:
```typescript
export async function syncTrendyolOrderToMainOrder(
  trendyolOrder: TrendyolOrderWithItems,
  trendyolStore: {
    id: string;
    name: string;
    supplierId: string;
    companyId: string;
    storeFrontCode: string;
    company: { id: string; name: string } | null;
  }
): Promise<Order> {
```

2. Remove references to Settings and (settings as any).trendyolCompanyId

3. Update findOrCreateTrendyolStore to use TrendyolStore data:
```typescript
export async function findOrCreateTrendyolVirtualStore(trendyolStore: {
  id: string;
  name: string;
  supplierId: string;
  companyId: string;
}): Promise<Store> {
  const shopifyDomain = `trendyol-${trendyolStore.supplierId}`;

  let store = await prisma.store.findFirst({
    where: { shopifyDomain },
  });

  if (!store) {
    store = await prisma.store.create({
      data: {
        name: trendyolStore.name,
        shopifyDomain,
        accessToken: "",
        isActive: true,
        companyId: trendyolStore.companyId,  // Use TrendyolStore's company
      },
    });
  } else if (store.companyId !== trendyolStore.companyId) {
    // Update company if changed
    store = await prisma.store.update({
      where: { id: store.id },
      data: { companyId: trendyolStore.companyId },
    });
  }

  return store;
}
```

4. Update order creation to use TrendyolStore.companyId:
```typescript
const order = await prisma.order.create({
  data: {
    // ...existing fields
    storeId: store.id,
    billingCompanyId: trendyolStore.companyId,  // NOT settings.trendyolCompanyId
    // ...rest
  },
});
```

5. Keep backward compatibility by checking if old Settings-based call is used:
```typescript
// If someone calls with Settings (old way), log deprecation warning
if ('trendyolSupplierId' in arg) {
  console.warn('[Trendyol Sync] DEPRECATED: Use TrendyolStore instead of Settings');
  // Convert Settings to TrendyolStore-like object for backward compat
}
```
  </action>
  <verify>
grep "trendyolStore.companyId" src/lib/trendyol-order-sync.ts returns matches
grep "settings as any" src/lib/trendyol-order-sync.ts returns NO matches (removed)
  </verify>
  <done>
Order sync uses TrendyolStore.companyId instead of Settings.trendyolCompanyId
  </done>
</task>

<task type="auto">
  <name>Task 2: Update webhook to pass TrendyolStore to sync</name>
  <files>
    src/app/api/trendyol/webhook/[storeId]/route.ts
  </files>
  <action>
Update the webhook handler to load and pass TrendyolStore:

1. The webhook already has storeId from the URL path
2. Load TrendyolStore at the start of order processing:
```typescript
const trendyolStore = await prisma.trendyolStore.findUnique({
  where: { id: storeId },
  include: { company: true },
});

if (!trendyolStore) {
  console.error(`[Trendyol Webhook] Store not found: ${storeId}`);
  return NextResponse.json({ error: "Store not found" }, { status: 404 });
}
```

3. Pass TrendyolStore to syncTrendyolOrderToMainOrder:
```typescript
// OLD:
await syncTrendyolOrderToMainOrder(trendyolOrderRecord, settings);

// NEW:
await syncTrendyolOrderToMainOrder(trendyolOrderRecord, {
  id: trendyolStore.id,
  name: trendyolStore.name,
  supplierId: trendyolStore.supplierId,
  companyId: trendyolStore.companyId,
  storeFrontCode: trendyolStore.storeFrontCode,
  company: trendyolStore.company,
});
```

4. Remove dependency on Settings for company resolution in the webhook.
   Settings may still be needed for other config but NOT for companyId.
  </action>
  <verify>
grep "trendyolStore" src/app/api/trendyol/webhook/\\[storeId\\]/route.ts shows TrendyolStore being loaded and passed
  </verify>
  <done>
Webhook loads TrendyolStore and passes it to sync function
  </done>
</task>

<task type="auto">
  <name>Task 3: Update manual sync to use TrendyolStore</name>
  <files>
    src/app/api/trendyol/orders/route.ts
  </files>
  <action>
Check and update the manual sync endpoint (if it exists):

1. Find the sync action in /api/trendyol/orders or /api/trendyol route
2. If it calls syncTrendyolOrderToMainOrder with Settings, update to use TrendyolStore

Example update:
```typescript
// When syncing orders from a specific store
const storeId = searchParams.get("storeId");
if (storeId) {
  const trendyolStore = await prisma.trendyolStore.findUnique({
    where: { id: storeId },
    include: { company: true },
  });

  if (!trendyolStore) {
    return NextResponse.json({ error: "Store not found" }, { status: 404 });
  }

  // Use TrendyolStore for sync
  await syncTrendyolOrderToMainOrder(order, {
    id: trendyolStore.id,
    name: trendyolStore.name,
    supplierId: trendyolStore.supplierId,
    companyId: trendyolStore.companyId,
    storeFrontCode: trendyolStore.storeFrontCode,
    company: trendyolStore.company,
  });
}
```

3. If there's a sync button on the orders page, ensure it passes storeId

If no manual sync endpoint exists or if it already works correctly, document that in the summary.
  </action>
  <verify>
grep -r "syncTrendyolOrderToMainOrder" src/app/api/ shows all callers passing TrendyolStore
  </verify>
  <done>
All sync callers pass TrendyolStore instead of Settings
  </done>
</task>

</tasks>

<verification>
1. Have two TrendyolStores configured with different companyIds
2. Receive webhook from each store
3. Check created Order.billingCompanyId matches the TrendyolStore's companyId
4. Verify logs show company coming from TrendyolStore not Settings
</verification>

<success_criteria>
- syncTrendyolOrderToMainOrder accepts TrendyolStore parameter
- No references to Settings.trendyolCompanyId in sync flow
- Order.billingCompanyId set from TrendyolStore.companyId
- Virtual Store.companyId matches TrendyolStore.companyId
- Webhook passes TrendyolStore to sync
- Manual sync (if exists) passes TrendyolStore
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-trendyol-complete-fix/07.2-04-SUMMARY.md`
</output>
