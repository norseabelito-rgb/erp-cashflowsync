# Phase 7.2: Trendyol Complete Fix - Research

**Researched:** 2026-02-01
**Domain:** Trendyol API Integration, Multi-Company Invoicing, Category Attribute Mapping
**Confidence:** HIGH

## Summary

This phase addresses critical issues in the existing Trendyol integration identified during the audit. The codebase already has a functioning TrendyolStore model with `companyId` and `invoiceSeriesName` fields, but these are not properly utilized in the order sync and invoice generation flows. Product publishing fails due to placeholder attribute values that Trendyol rejects, and batch status checking lacks UI feedback.

The key technical challenges are:
1. **Attribute Validation**: Trendyol requires valid attribute values for each category - the current code uses `attributeValues?.[0]?.id` as a placeholder which gets rejected
2. **Multi-Company Support**: TrendyolStore.companyId exists but order sync uses Settings.trendyolCompanyId instead
3. **Invoice Series Per Store**: TrendyolStore.invoiceSeriesName exists but invoice-service.ts ignores it for Trendyol orders
4. **Batch Status UI**: getBatchRequestResult endpoint exists but no UI displays rejection reasons

**Primary recommendation:** Fix attribute mapping first (TRND-02) as it's blocking product publishing, then fix multi-company/invoice series in parallel (TRND-03, TRND-04), and add batch status checking UI (TRND-05).

## Standard Stack

The established libraries/tools for this domain:

### Core (Already in use)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @anthropic-ai/sdk | ^0.30.1 | AI-based category suggestions | Already integrated in src/lib/ai.ts |
| prisma | ^5.10.2 | Database ORM | Existing TrendyolStore, MasterProduct models |
| next | 14.1.3 | API routes | Existing /api/trendyol routes |

### Supporting (No new dependencies needed)
| Library | Purpose | When to Use |
|---------|---------|-------------|
| existing TrendyolClient | API calls | All Trendyol API operations |
| existing invoice-service.ts | Invoice generation | Already handles Oblio integration |

### No Additional Dependencies Needed
This phase builds on existing infrastructure. No new npm packages required.

## Architecture Patterns

### Recommended Project Structure
```
src/
├── lib/
│   ├── trendyol.ts              # Existing - TrendyolClient class
│   ├── trendyol-order-sync.ts   # FIX: Use TrendyolStore.companyId
│   ├── trendyol-invoice.ts      # FIX: Use TrendyolStore.invoiceSeriesName
│   ├── trendyol-stock-sync.ts   # Existing - Already uses TrendyolStore
│   ├── trendyol-attributes.ts   # NEW: Category attribute mapping logic
│   ├── trendyol-batch-status.ts # NEW: Batch status checking & error display
│   └── trendyol-category-ai.ts  # NEW: AI-based category suggestions
├── app/api/trendyol/
│   ├── route.ts                 # FIX: Attribute mapping in publishProducts
│   ├── batch-status/route.ts    # NEW: Batch status checking endpoint
│   ├── category-suggest/route.ts # NEW: AI category suggestion endpoint
│   └── attributes/route.ts      # NEW: Category attribute CRUD
```

### Pattern 1: TrendyolStore-Based Company Resolution
**What:** Always resolve company from TrendyolStore, not global Settings
**When to use:** Order sync, invoice generation, any Trendyol operation
**Example:**
```typescript
// Source: Identified from codebase analysis - fix pattern
// WRONG (current): Uses Settings.trendyolCompanyId
const companyId = (settings as any).trendyolCompanyId;

// CORRECT: Use TrendyolStore.companyId from the order
const trendyolOrder = await prisma.trendyolOrder.findFirst({
  where: { orderId },
  include: { trendyolStore: { include: { company: true } } },
});
const companyId = trendyolOrder?.trendyolStore?.companyId;
```

### Pattern 2: Invoice Series Override for Trendyol
**What:** TrendyolStore.invoiceSeriesName takes precedence over store/company default
**When to use:** Invoice generation for Trendyol orders
**Example:**
```typescript
// Source: Extension of existing invoice-service.ts logic
// In invoice-service.ts, before standard series resolution:
if (order.source === "trendyol") {
  const trendyolOrder = await prisma.trendyolOrder.findFirst({
    where: { orderId: order.id },
    include: { trendyolStore: true },
  });
  if (trendyolOrder?.trendyolStore?.invoiceSeriesName) {
    oblioSeriesName = trendyolOrder.trendyolStore.invoiceSeriesName;
    seriesSource = "trendyol_store";
    useOblioNumbering = true;
  }
}
```

### Pattern 3: Category Attribute Persistence
**What:** Store mapped attributes per product-category combination
**When to use:** Product publishing to Trendyol
**Schema addition:**
```prisma
// In schema.prisma - extend MasterProduct
model MasterProduct {
  // ... existing fields
  trendyolCategoryId      Int?
  trendyolAttributeValues Json?  // Store validated attribute mappings
}

// Or create a new mapping table for flexibility
model TrendyolAttributeMapping {
  id                String   @id @default(cuid())
  masterProductId   String
  masterProduct     MasterProduct @relation(fields: [masterProductId], references: [id])
  categoryId        Int
  attributeId       Int
  attributeValueId  Int?     // Null if custom value
  customValue       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([masterProductId, attributeId])
}
```

### Anti-Patterns to Avoid
- **Using Settings.trendyolCompanyId**: This breaks multi-company support. Always use TrendyolStore.companyId
- **Placeholder attribute values**: Never use `attributeValues?.[0]?.id` - requires explicit mapping
- **Fire-and-forget batch requests**: Always track batch status and display errors to user
- **Blocking operations on Trendyol API failures**: Keep non-blocking for invoice/AWB sends

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| AI category matching | Custom string matching | Anthropic API (existing pattern in ai.ts) | Better semantic understanding |
| Invoice series resolution | Custom lookup | Extend existing getInvoiceSeriesForCompany() | Already handles edge cases |
| Batch status polling | Custom setInterval | React Query with refetch interval | Already using @tanstack/react-query |
| Error display | Custom modal | Existing toast system | Consistent UX |

**Key insight:** The codebase already has patterns for AI integration, invoice series resolution, and error handling. Extend existing code rather than building parallel systems.

## Common Pitfalls

### Pitfall 1: Trendyol Category Attribute Validation
**What goes wrong:** Products get rejected with "Invalid attribute value" errors
**Why it happens:** Current code uses first available attribute value as placeholder:
```typescript
// BAD CODE (current in route.ts line ~565-569):
const attributes = requiredAttrs.map(attr => ({
  attributeId: attr.attribute?.id || attr.id,
  attributeValueId: attr.attributeValues?.[0]?.id || null,  // PLACEHOLDER!
})).filter(a => a.attributeValueId);
```
**How to avoid:**
1. Fetch category attributes when category is selected
2. Require user to map each required attribute before publishing
3. Validate all required attributes have proper values before API call
**Warning signs:** Batch status returns with failureReasons array containing "attribute" errors

### Pitfall 2: TrendyolStore Not Linked to TrendyolOrder
**What goes wrong:** Orders created before TrendyolStore model don't have trendyolStoreId
**Why it happens:** Legacy orders imported without store association
**How to avoid:**
1. When syncing orders, always lookup TrendyolStore by supplierId
2. Update existing orders to link to correct TrendyolStore
3. Add migration to backfill trendyolStoreId for existing orders
**Warning signs:** `trendyolOrder.trendyolStore` returns null for some orders

### Pitfall 3: Invoice Series Name vs Oblio Series
**What goes wrong:** Invoice created but with wrong series
**Why it happens:** TrendyolStore.invoiceSeriesName should match an Oblio series name exactly
**How to avoid:**
1. Validate invoiceSeriesName against Oblio API series list
2. Show dropdown of valid Oblio series when configuring TrendyolStore
3. Test invoice creation after configuration
**Warning signs:** Oblio API returns "Series not found" error

### Pitfall 4: Batch Status Not Being Checked
**What goes wrong:** Products appear "published" in UI but never appear on Trendyol
**Why it happens:** Batch ID saved to MasterProduct but status never polled
**How to avoid:**
1. Poll batch status after publishing (with timeout)
2. Update MasterProduct.trendyolStatus based on batch result
3. Show clear error messages from failureReasons array
**Warning signs:** trendyolStatus stays "pending" indefinitely

### Pitfall 5: Stock Sync Direction Confusion
**What goes wrong:** Stock levels don't match between systems
**Why it happens:** Bi-directional sync without clear source of truth
**How to avoid:**
1. Define ERP as master for stock
2. Only sync FROM ERP TO Trendyol (never reverse)
3. Log stock mismatches for investigation
**Warning signs:** Stock decreases on Trendyol but not in ERP (manual Trendyol sales)

## Code Examples

Verified patterns from the existing codebase:

### Batch Status Checking
```typescript
// Source: Existing getBatchRequestResult in trendyol.ts
async getBatchRequestResult(batchRequestId: string): Promise<TrendyolApiResponse<{
  status: string;
  items?: Array<{
    status: string;
    failureReasons?: string[];
  }>;
}>> {
  return this.request(
    `/integration/product/sellers/${this.config.supplierId}/products/batch-requests/${batchRequestId}`
  );
}

// Usage pattern for UI feedback:
const checkBatchStatus = async (batchId: string): Promise<BatchStatusResult> => {
  const result = await client.getBatchRequestResult(batchId);
  if (!result.success) return { status: 'error', error: result.error };

  const data = result.data;
  if (data?.status === 'COMPLETED') {
    const failed = data.items?.filter(i => i.status !== 'SUCCESS') || [];
    if (failed.length > 0) {
      return {
        status: 'partial_failure',
        errors: failed.flatMap(f => f.failureReasons || ['Unknown error']),
      };
    }
    return { status: 'success' };
  }
  return { status: 'pending' };
};
```

### AI Category Suggestion (Following existing ai.ts pattern)
```typescript
// Source: Pattern from existing src/lib/ai.ts
export async function suggestTrendyolCategory(
  productTitle: string,
  productDescription: string,
  availableCategories: Array<{ id: number; name: string; fullPath: string }>
): Promise<{ categoryId: number; confidence: number; reasoning: string }> {
  const client = await getAnthropicClient();
  const settings = await getAISettings();

  const systemPrompt = `You are an e-commerce category mapping expert.
Given a product title and description, suggest the most appropriate Trendyol category.
Return ONLY valid JSON with categoryId, confidence (0-100), and reasoning.`;

  const userPrompt = `Product: "${productTitle}"
Description: "${productDescription?.substring(0, 500) || 'N/A'}"

Available categories (JSON):
${JSON.stringify(availableCategories.slice(0, 50), null, 2)}

Respond in JSON: { "categoryId": number, "confidence": number, "reasoning": "string" }`;

  const response = await client.messages.create({
    model: settings?.aiModel || "claude-sonnet-4-20250514",
    max_tokens: 500,
    messages: [{ role: "user", content: userPrompt }],
    system: systemPrompt,
  });

  // Parse and validate response
  const content = response.content?.[0];
  if (!content || content.type !== "text") {
    throw new Error("Invalid AI response");
  }

  const parsed = JSON.parse(content.text.trim());
  return parsed;
}
```

### TrendyolStore-Based Order Sync (Fix Pattern)
```typescript
// Source: Fix for trendyol-order-sync.ts findOrCreateTrendyolStore
export async function findOrCreateTrendyolStore(
  supplierId: string
): Promise<Store & { trendyolStore?: TrendyolStore }> {
  // First, find TrendyolStore by supplierId
  const trendyolStore = await prisma.trendyolStore.findFirst({
    where: { supplierId, isActive: true },
    include: { company: true },
  });

  if (!trendyolStore) {
    throw new Error(`No TrendyolStore configured for supplierId: ${supplierId}`);
  }

  // Find or create virtual Store linked to TrendyolStore's company
  const storeName = `Trendyol ${trendyolStore.storeFrontCode}`;
  const shopifyDomain = `trendyol-${supplierId}`;

  let store = await prisma.store.findFirst({
    where: { shopifyDomain },
  });

  if (!store) {
    store = await prisma.store.create({
      data: {
        name: storeName,
        shopifyDomain,
        accessToken: "",
        isActive: true,
        companyId: trendyolStore.companyId,  // USE TrendyolStore.companyId!
      },
    });
  }

  return { ...store, trendyolStore };
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Settings.trendyolCompanyId | TrendyolStore.companyId | Phase 7.1 schema added | Must fix all usages |
| Placeholder attributes | User-mapped attributes | Identified as bug | Blocking product push |
| No batch status UI | Poll and display errors | Standard practice | User visibility |

**Deprecated/outdated:**
- Settings.trendyolSupplierId/trendyolApiKey: Should migrate to TrendyolStore model
- syncTrendyolOrders() using Settings: Should use TrendyolStore credentials

## Open Questions

Things that couldn't be fully resolved:

1. **Attribute Mapping Persistence Approach**
   - What we know: Need to store user-selected attribute values per product
   - What's unclear: Whether to add JSON field to MasterProduct or create separate TrendyolAttributeMapping table
   - Recommendation: Start with JSON field (simpler), migrate to table if complexity grows

2. **Stock Sync Direction for Manual Trendyol Sales**
   - What we know: Some products may sell directly on Trendyol platform (not via ERP)
   - What's unclear: Whether to detect and import these or ignore them
   - Recommendation: Log stock mismatches, don't auto-sync from Trendyol (ERP is master)

3. **Webhook Retry Strategy Specifics**
   - What we know: TRND-08 requires retry, logging, error recovery
   - What's unclear: Trendyol's webhook retry policy, recommended delay between retries
   - Recommendation: Implement exponential backoff (1s, 2s, 4s, max 3 retries)

## Sources

### Primary (HIGH confidence)
- Codebase analysis: src/lib/trendyol.ts, trendyol-order-sync.ts, trendyol-invoice.ts
- Codebase analysis: src/lib/invoice-service.ts (invoice series resolution logic)
- Codebase analysis: src/lib/ai.ts (AI integration pattern with Anthropic)
- Codebase analysis: prisma/schema.prisma (TrendyolStore model with companyId, invoiceSeriesName)

### Secondary (MEDIUM confidence)
- [Trendyol Developers Portal](https://developers.trendyol.com/en/) - Product API structure, batch requests
- [Trendyol Product Create V2](https://developers.trendyol.com/en/docs/trendyol-marketplace/Product%20Create%20V2/urun-yaratma) - Attribute requirements

### Tertiary (LOW confidence)
- [ChannelEngine Trendyol Guide](https://support.channelengine.com/hc/en-us/articles/24668731865117-Trendyol-Europe-marketplace-guide) - General integration patterns

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Using existing codebase patterns
- Architecture: HIGH - Extending existing Trendyol modules
- Pitfalls: HIGH - Identified from actual code analysis and audit findings
- AI integration: HIGH - Exact pattern exists in ai.ts

**Research date:** 2026-02-01
**Valid until:** 2026-03-01 (30 days - Trendyol API is stable)
