# Analiză Completă ERP CashFlowSync
**Data:** 2026-01-23
**Analiză efectuată de:** Claude Opus 4.5

---

## CONSTRÂNGERE CRITICĂ

> **DATELE DIN BAZA DE DATE NU SE ȘTERG NICIODATĂ**
> - Se pot adăuga coloane noi
> - Se pot modifica tipuri de date (cu migrare sigură)
> - Se pot adăuga indecși sau constraint-uri
> - **NU** se execută `DELETE`, `DROP TABLE`, `TRUNCATE`
> - Toate migrările vor folosi `IF NOT EXISTS`

---

## Decizii de Business Confirmate

| Aspect | Decizie | Detalii |
|--------|---------|---------|
| **Flow comenzi** | Flexibil | Normal: Shopify → PENDING → VALIDATED → INVOICED → AWB_CREATED → SHIPPED → DELIVERED. Excepție: AWB fără factură permis. |
| **Deducere stoc** | La emitere factură | AWB fără factură doar REZERVĂ stocul, nu deduce |
| **Default store access** | PERMIT | Userii fără restricții văd toate store-urile (intenționat) |
| **Numerotare facturi** | STRICT CONTINUĂ | Gap-uri inacceptabile - necesită fix urgent |
| **Facturis** | MASTER pentru serii | Seriile se creează/gestionează în Facturis, ERP doar face mapping |
| **Invoice + AWB fail** | Retry manual | Comanda rămâne INVOICED, userul reîncearcă AWB |
| **Bulk processing** | 3 butoane | Doar facturi / Doar AWB / Ambele |
| **Comenzi manuale** | Full create + sync | Creare completă cu selectare magazin, sync înapoi la Shopify |
| **PICKING/PACKED** | De implementat | Pentru tracking warehouse |
| **Companii** | 2-3 firme | Cu serii de facturare separate pe fiecare |

---

## Probleme Identificate

### 1. FLOW COMENZI (Order Processing)

#### P1.1 - Race Condition la Webhook-uri Shopify
- **Fișier:** `src/app/api/webhooks/shopify/route.ts`
- **Linie:** 33-74
- **Problema:** Dacă primești 2 webhook-uri simultan pentru aceeași comandă, poate crea duplicate sau pierde date
- **Impact:** CRITIC
- **Fix:** Adăugare lock pe procesarea comenzii

#### P1.2 - LineItems se șterg și recrează la fiecare update
- **Fișier:** `src/lib/shopify.ts`
- **Linie:** 584-632
- **Problema:** La update comandă, LineItems existente sunt șterse și recreate
- **Impact:** MEDIU (race conditions la updates concurente)
- **Fix:** Upsert în loc de delete+create

#### P1.3 - State Machine incomplet pentru comenzi
- **Fișier:** `src/types/prisma-enums.ts`
- **Linie:** 5-20
- **Problema:**
  - Status-urile `PICKING` și `PACKED` definite dar nefolosite
  - Nu există validare care să prevină tranziții ilegale
  - Comanda poate reveni din CANCELLED la alte statusuri
- **Impact:** MEDIU
- **Fix:** Implementare PICKING/PACKED + validare tranziții

#### P1.4 - Invoice + AWB nu sunt atomice
- **Fișier:** `src/app/api/orders/process-all/route.ts`
- **Linie:** 107-179
- **Problema:** Dacă factura se creează OK dar AWB eșuează, comanda rămâne în stare inconsistentă
- **Impact:** MEDIU (conform deciziei: retry manual e acceptat)
- **Fix:** Nu necesită - comportament acceptat

---

### 2. FACTURARE ȘI SERII

#### P2.1 - Race Condition la Numerele de Factură ⚠️ CRITIC
- **Fișier:** `src/lib/invoice-series.ts`
- **Linie:** 18-54
- **Problema:** Două request-uri simultane pot obține același număr de factură
- **Impact:** CRITIC (duplicate invoice numbers)
- **Fix:**
  - Adăugare `UNIQUE(invoiceSeriesId, invoiceNumber)` în DB
  - Pessimistic locking cu `FOR UPDATE`

#### P2.2 - Rollback Număr Factură în Afara Tranzacției
- **Fișier:** `src/lib/invoice-service.ts`
- **Linie:** 485-486
- **Problema:** Dacă rollback-ul eșuează, numărul se pierde permanent
- **Impact:** ÎNALT (gap-uri în numerotare - inacceptabil)
- **Fix:** Wrap rollback în tranzacție

#### P2.3 - Upsert în loc de Create pentru Facturi
- **Fișier:** `src/lib/invoice-service.ts`
- **Linie:** 105
- **Problema:** Folosește `upsert` ceea ce poate suprascrie facturi existente silențios
- **Impact:** MEDIU
- **Fix:** Verificare explicită dacă factura există

#### P2.4 - Anulare Factură - Inconsistență
- **Fișier:** `src/app/api/invoices/[id]/cancel/route.ts`
- **Linie:** 79-117
- **Problema:** Dacă Facturis anulează OK dar update-ul DB eșuează, stare inconsistentă
- **Impact:** ÎNALT
- **Fix:** Tranzacție + retry logic

#### P2.5 - Timeout Facturis poate cauza duplicate
- **Fișier:** `src/lib/facturis.ts`
- **Problema:** Dacă Facturis creează factura dar răspunsul timeout-ează, ERP crede că a eșuat
- **Impact:** MEDIU
- **Fix:** Idempotency key la Facturis

#### P2.6 - Confuzie Serii Facturare / Facturis
- **Problema:** Nu e o implementare completă. User preferă ca seriile să fie master în Facturis.
- **Impact:** ÎNALT (problemă activă raportată de user)
- **Fix:** Refactorizare - ERP doar referă seria din Facturis, nu gestionează numere local

---

### 3. STOC ȘI INVENTAR

#### P3.1 - Race Condition Multi-Warehouse Sync
- **Fișier:** `src/lib/inventory-stock.ts`
- **Linie:** 925-933, 1012-1020
- **Problema:** După fiecare deducere componentă, recalculează totalul - interleave la requests concurente
- **Impact:** ÎNALT
- **Fix:** Sync o singură dată la final, nu per componentă

#### P3.2 - Deducere Stoc fără Tranzacție (Simple Items)
- **Fișier:** `src/lib/inventory-stock.ts`
- **Linie:** 276-294
- **Problema:** Articolele simple se deduc fără `$transaction`
- **Impact:** MEDIU (audit trail incomplet dacă crash)
- **Fix:** Wrap în tranzacție

#### P3.3 - Câmp Greșit în Sync Stock
- **Fișier:** `src/app/api/stock/sync/route.ts`
- **Linie:** 32-36
- **Problema:** Folosește `item.quantity` dar câmpul corect e `currentStock`
- **Impact:** MEDIU (returnează undefined)
- **Fix:** Schimbare în `currentStock`

#### P3.4 - Query Greșit în Stock Transfer Service
- **Fișier:** `src/lib/stock-transfer-service.ts`
- **Linie:** 80-100
- **Problema:** Caută `masterProductId` pe InventoryItem dar câmpul nu există
- **Impact:** MEDIU (query returnează gol)
- **Fix:** Corectare query

#### P3.5 - Articole Composite fără Rețetă
- **Fișier:** `src/lib/inventory-stock.ts`
- **Linie:** 97-100
- **Problema:** Se poate marca articol ca composite fără să aibă rețetă
- **Impact:** JOS
- **Fix:** Validare la creare/marcare composite

#### P3.6 - Sync Total Stock în Afara Tranzacției
- **Fișier:** `src/app/api/inventory-items/stock-adjustment/route.ts`
- **Linie:** 152
- **Problema:** Ajustare în tranzacție, sync în afară
- **Impact:** MEDIU
- **Fix:** Include sync în tranzacție

---

### 4. SECURITATE ȘI MULTI-TENANT

#### P4.1 - DEFAULT PERMIT pentru Store Access
- **Fișier:** `src/lib/permissions.ts`
- **Linie:** 336-341
- **Problema:** Userii fără UserStoreAccess au acces la TOATE store-urile
- **Impact:** N/A - INTENȚIONAT (confirmat de user)
- **Fix:** Nu necesită

#### P4.2 - Lipsă Validare Store în API Orders
- **Fișier:** `src/app/api/orders/route.ts`
- **Linie:** 20-114
- **Problema:** Verifică doar `orders.view`, nu verifică acces la store
- **Impact:** MEDIU (dar default permit e intenționat)
- **Fix:** Opțional - filtru pe stores dacă userul are restricții

#### P4.3 - Lipsă Validare Store în Order Detail
- **Fișier:** `src/app/api/orders/[id]/route.ts`
- **Linie:** 10-50
- **Problema:** Oricine cu ID-ul comenzii poate vedea detalii
- **Impact:** MEDIU
- **Fix:** Similar P4.2

#### P4.4 - Lipsă Validare Store în API Invoices
- **Fișier:** `src/app/api/invoices/route.ts`
- **Linie:** 19-64
- **Problema:** Returnează facturi din toate store-urile fără verificare
- **Impact:** MEDIU
- **Fix:** Similar P4.2

#### P4.5 - Store Sync fără Autentificare ⚠️ DE INVESTIGAT
- **Fișier:** `src/app/api/stores/[id]/sync/route.ts`
- **Problema:** Nu are `getServerSession()` sau `hasPermission()`
- **Impact:** CRITIC sau INTENȚIONAT (de verificat)
- **Fix:** De investigat cum e folosit

#### P4.6 - Intercompany Settlement fără Validare Company
- **Fișier:** `src/lib/intercompany-service.ts`
- **Linie:** 238-323
- **Problema:** User cu `intercompany.generate` poate genera settlement pentru orice companie
- **Impact:** MEDIU
- **Fix:** Validare company access

---

### 5. ALTE PROBLEME

#### P5.1 - N+1 Query în Picking List
- **Fișier:** `src/app/api/orders/process-all/route.ts`
- **Linie:** 361-371
- **Problema:** Query individual pentru fiecare MasterProduct
- **Impact:** JOS (performance)
- **Fix:** Batch load

#### P5.2 - AWB cu status Error în Picking List
- **Fișier:** `src/app/api/orders/process-all/route.ts`
- **Linie:** 236
- **Problema:** Nu verifică dacă AWB are status error
- **Impact:** JOS
- **Fix:** Adăugare verificare

#### P5.3 - ProcessingError nu se curăță
- **Fișier:** `src/app/api/orders/process-all/route.ts`
- **Linie:** 123-150
- **Problema:** Se creează la fiecare eroare, nu se șterge la retry
- **Impact:** JOS (database bloat)
- **Fix:** Cleanup logic

#### P5.4 - OAuth State în Memorie
- **Fișier:** `src/lib/ads-oauth-state.ts`
- **Problema:** States stocate în globalThis Map, se pierd la restart
- **Impact:** JOS
- **Fix:** Persistare în DB sau Redis

#### P5.5 - Invoice Sync nu face nimic
- **Fișier:** `src/lib/sync-service.ts`
- **Linie:** 640-682
- **Problema:** Funcția doar loghează, nu sincronizează
- **Impact:** JOS (funcționalitate lipsă)
- **Fix:** Implementare sau documentare că nu e posibil

---

## Funcționalități Lipsă (Raportate de User)

### F1 - Nu se poate adăuga comandă manuală din UI
- **Cerință:** Creare comandă completă (client, produse, adresă, magazin)
- **Extra:** Comanda trebuie să apară și în Shopify
- **Prioritate:** ÎNALTĂ

### F2 - Bulk Processing Incomplet
- **Cerință:** 3 butoane separate:
  1. Emite doar Facturi
  2. Creează doar AWB
  3. Procesează Tot (factură + AWB)
- **Status actual:** Doar "Procesează Tot"
- **Prioritate:** ÎNALTĂ

---

## Priorități Recomandate

### URGENT (de făcut imediat)
1. **P2.1** - Race condition numere factură (CRITIC)
2. **P2.6** - Refactorizare serii Facturis (problemă activă)
3. **P4.5** - Investigare store sync endpoint

### ÎNALT (săptămâna aceasta)
4. **P2.2** - Rollback în tranzacție
5. **F1** - Adăugare comandă manuală
6. **F2** - Bulk processing separat
7. **P3.1** - Race condition multi-warehouse

### MEDIU (curând)
8. **P1.3** - Implementare PICKING/PACKED
9. **P2.4** - Anulare factură atomică
10. **P3.2, P3.3, P3.4** - Fixes stoc minore

### JOS (când e timp)
11. **P5.1-P5.5** - Performance și cleanup

---

## Fișiere Cheie pentru Modificări

```
src/lib/invoice-series.ts        # Race condition numere (P2.1)
src/lib/invoice-service.ts       # Rollback, upsert (P2.2, P2.3)
src/lib/inventory-stock.ts       # Stock race conditions (P3.1, P3.2)
src/lib/facturis.ts              # Integrare Facturis
src/app/api/orders/route.ts      # List orders
src/app/api/orders/process-all/  # Bulk processing
src/app/api/stores/[id]/sync/    # De investigat auth
prisma/schema.prisma             # Constraints noi
```

---

## Următorii Pași

1. **Decide** cu ce problemă începem
2. **Plan** detaliat pentru fix
3. **Implementare** cu teste
4. **Verificare** că nu se șterge nimic din DB

---

*Document generat pe 2026-01-23*
