---
status: verifying
trigger: "Nu pot emite AWB-uri de pe a 2a firma (CONSTRUIM DESTINE S.R.L. / CDS). Eroare: These credentials do not match our records."
created: 2026-01-28T10:00:00Z
updated: 2026-01-28T10:20:00Z
commit: f31545e
---

## Current Focus

hypothesis: CONFIRMED - Credentialele FanCourier stocate pentru firma CDS sunt incorecte
test: Adaugat logging diagnostic + mesaj de eroare imbunatatit
expecting: User sa verifice si corecteze credentialele in Setari > Firme > CDS > FanCourier
next_action: User trebuie sa actualizeze credentialele FanCourier pentru firma CDS si sa incerce din nou

## Symptoms

expected: AWB-ul ar trebui creat cu succes pentru firma CDS (CONSTRUIM DESTINE S.R.L.)
actual: Eroare de autentificare - "These credentials do not match our records"
errors: "These credentials do not match our records." la API FanCourier
reproduction: Incercare de creare AWB pentru comanda #3660, firma CDS cu clientId 7338079
started: Functioneaza pentru prima firma, dar nu pentru a doua firma (CDS)

## Eliminated

## Evidence

- timestamp: 2026-01-28T10:05:00Z
  checked: Token caching mechanism in fancourier.ts
  found: Token cache uses clientId:username as key, separate for each company
  implication: Token mixing between companies is NOT possible - each company has its own token

- timestamp: 2026-01-28T10:06:00Z
  checked: FanCourier login flow in fancourier.ts line 79-91
  found: Uses https://api.fancourier.ro/login?username=X&password=Y (POST method)
  implication: Authentication is standard OAuth-like flow, error comes from FanCourier API

- timestamp: 2026-01-28T10:07:00Z
  checked: awb-service.ts createFanCourierClientForCompany function
  found: Creates FanCourierAPI instance with company.fancourierClientId, fancourierUsername, fancourierPassword
  implication: Credentials are correctly passed from Company table to FanCourier API class

- timestamp: 2026-01-28T10:08:00Z
  checked: Error message source
  found: "These credentials do not match our records" is a FanCourier API response, not generated by our code
  implication: The issue is with the credentials stored in DB for CDS company, not code logic

- timestamp: 2026-01-28T10:10:00Z
  checked: Added diagnostic logging
  found: Added console.log in fancourier.ts getToken() and awb-service.ts createAWBForOrder()
  implication: Next AWB creation attempt will show clientId and username being used, confirming correct credential selection

## Resolution

root_cause: Credentialele FanCourier stocate in baza de date pentru firma CDS (CONSTRUIM DESTINE S.R.L.) nu se potrivesc cu cele din contul FanCourier SelfAWB. Eroarea "These credentials do not match our records" vine direct de la API-ul FanCourier cand username-ul sau parola sunt incorecte. Codul functioneaza corect (prima firma merge), dar a doua firma are credentiale invalide.

fix: |
  1. Adaugat logging diagnostic pentru a afisa clientId si username folosit (fara parola):
     - fancourier.ts: log la login attempt si la login failure
     - awb-service.ts: log la selectia credentialelor din firma
  2. Imbunatatit mesajul de eroare pentru a include clientId si username, ajutand la debugging
  3. ACTIUNE UTILIZATOR NECESARA: Verificati credentialele FanCourier pentru firma CDS in:
     - Accesati Setari > Firme > CDS > tab FanCourier
     - Verificati ca Client ID, Username si Password sunt identice cu cele din contul FanCourier SelfAWB
     - Puteti folosi butonul "Test Conexiune FanCourier" pentru a verifica

verification: |
  - Log-urile vor arata ce credentiale sunt folosite la urmatoarea incercare
  - Mesajul de eroare acum include clientId si username pentru debugging mai usor
  - Dupa corectarea credentialelor in UI, AWB-ul ar trebui sa se creeze cu succes

files_changed:
  - src/lib/fancourier.ts (added diagnostic logging and improved error message)
  - src/lib/awb-service.ts (added credential logging)
